#!/usr/bin/env node
/**
 * –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —á–µ—Ä–µ–∑ WhatsApp
 * –°–∏–º—É–ª–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
 */

const config = require('./src/config');
const logger = require('./src/utils/logger').child({ module: 'test-context-scenario' });

// –¢–µ—Å—Ç–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
const TEST_PHONES = {
  newClient: '79001111111',        // –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
  returningClient: '79002222222',  // –í–µ—Ä–Ω—É–≤—à–∏–π—Å—è –∫–ª–∏–µ–Ω—Ç
  continuingDialog: '79003333333'  // –ü—Ä–æ–¥–æ–ª–∂–∞—é—â–∏–π –¥–∏–∞–ª–æ–≥
};

async function runTestScenarios() {
  logger.info('üß™ –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞...\n');
  
  console.log(`
üìã –ü–õ–ê–ù –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –ö–û–ù–¢–ï–ö–°–¢–ê

1. –ù–û–í–´–ô –ö–õ–ò–ï–ù–¢ (${TEST_PHONES.newClient})
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "–ü—Ä–∏–≤–µ—Ç"
   - –û–∂–∏–¥–∞–µ–º: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –±–µ–∑ –∏–º–µ–Ω–∏
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É"
   - –û–∂–∏–¥–∞–µ–º: –í–æ–ø—Ä–æ—Å –æ–± –∏–º–µ–Ω–∏
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä"
   - –û–∂–∏–¥–∞–µ–º: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "–ó–∞–≤—Ç—Ä–∞ –≤ 15:00"
   - –û–∂–∏–¥–∞–µ–º: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π

2. –í–ï–†–ù–£–í–®–ò–ô–°–Ø –ö–õ–ò–ï–ù–¢ (${TEST_PHONES.returningClient})
   - –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –∏–º–µ–Ω–µ–º "–ú–∞—Ä–∏—è"
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "–ü—Ä–∏–≤–µ—Ç"
   - –û–∂–∏–¥–∞–µ–º: "–ü—Ä–∏–≤–µ—Ç, –ú–∞—Ä–∏—è!" (–æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏)
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è"
   - –û–∂–∏–¥–∞–µ–º: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ª—é–±–∏–º–æ–π —É—Å–ª—É–≥–∏/–º–∞—Å—Ç–µ—Ä–∞

3. –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –î–ò–ê–õ–û–ì–ê (${TEST_PHONES.continuingDialog})
   - –°—Ü–µ–Ω–∞—Ä–∏–π –ê (–≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è):
     - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "–ü—Ä–∏–≤–µ—Ç, —Ö–æ—á—É –Ω–∞ –º–∞–Ω–∏–∫—é—Ä"
     - –ü–æ–¥–æ–∂–¥–∞—Ç—å 5 –º–∏–Ω—É—Ç
     - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "–î–∞–≤–∞–π –Ω–∞ 16:00"
     - –û–∂–∏–¥–∞–µ–º: –ë–ï–ó –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
   
   - –°—Ü–µ–Ω–∞—Ä–∏–π –ë (—á–µ—Ä–µ–∑ —Å—É—Ç–∫–∏):
     - –°–æ–∑–¥–∞—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (25+ —á–∞—Å–æ–≤)
     - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "–ü—Ä–∏–≤–µ—Ç"
     - –û–∂–∏–¥–∞–µ–º: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–º–µ–Ω–µ–º

4. –¢–ï–°–¢ –ü–†–ï–î–ü–û–ß–¢–ï–ù–ò–ô
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º–∏
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è"
   - –û–∂–∏–¥–∞–µ–º: "–í–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –ú—É–∂—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞ –∫ –°–µ—Ä–≥–µ—é?"

5. –¢–ï–°–¢ –û–ß–ò–°–¢–ö–ò –ö–û–ù–¢–ï–ö–°–¢–ê
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å: node scripts/cleanup-old-contexts.js --dry-run
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –æ—á–∏—Å—Ç–∫–∏
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π –ø–æ–º–µ—á–µ–Ω—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
`);

  console.log('\nüì± –ö–û–ú–ê–ù–î–´ –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:\n');
  
  // –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  for (const [scenario, phone] of Object.entries(TEST_PHONES)) {
    console.log(`# ${scenario}:`);
    console.log(`node test-webhook.js "${phone}" "–ü—Ä–∏–≤–µ—Ç"`);
    console.log(`node test-webhook.js "${phone}" "–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É"`);
    console.log(`node test-webhook.js "${phone}" "–ú–µ–Ω—è –∑–æ–≤—É—Ç –¢–µ—Å—Ç"`);
    console.log('');
  }
  
  console.log('üîç –ü–†–û–í–ï–†–ö–ê –ß–ï–†–ï–ó MCP:\n');
  console.log('# –í Claude Code –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã MCP:');
  console.log('@redis get_context phone:79001111111');
  console.log('@redis get_all_keys preferences:*');
  console.log('@redis get_all_keys context:*');
  console.log('');
  
  console.log('üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì:\n');
  console.log('# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:');
  console.log('ssh ai-admin-server "pm2 logs ai-admin-worker-v2 --lines 100 | grep -E \\"(preferences|context|Returning client)\\""\n');
  
  console.log('# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î:');
  console.log('@supabase query_table table:dialog_contexts limit:10\n');
  
  console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!');
}

// –ó–∞–ø—É—Å–∫
runTestScenarios();