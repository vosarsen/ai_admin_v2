// test-real-whatsapp.js
// Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ WhatsApp

require('dotenv').config();
const axios = require('axios');

// ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
const WHATSAPP_API_URL = process.env.VENOM_SERVER_URL || 'http://localhost:3001';
const SECRET_KEY = process.env.VENOM_SECRET_KEY;
const TEST_PHONE = process.env.TEST_PHONE || '79000000001'; // Ð’Ð°Ñˆ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€
const REAL_PHONE = '79266508317'; // Ð ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ð±Ð¾Ñ‚Ð°

// Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¸Ð½Ñ‚ÐµÐ½Ñ‚Ð¾Ð²
const testMessages = [
  // Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¸Ð½Ñ‚ÐµÐ½Ñ‚Ñ‹
  { message: 'ÐŸÑ€Ð¸Ð²ÐµÑ‚', expected: 'Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ' },
  { message: 'Ñ…Ð¾Ñ‡Ñƒ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ', expected: 'Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ ÑƒÑÐ»ÑƒÐ³Ð¸ Ð¸Ð»Ð¸ ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð´ÐµÑ‚Ð°Ð»Ð¸' },
  { message: 'ÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ð¾Ð¸Ñ‚ ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°?', expected: 'Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ†ÐµÐ½Ñ‹' },
  { message: 'ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾ Ð·Ð°Ð²Ñ‚Ñ€Ð°?', expected: 'Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ»Ð¾Ñ‚Ñ‹' },
  { message: 'Ð¿Ð¾ÐºÐ°Ð¶Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¼Ð°ÑÑ‚ÐµÑ€Ð¾Ð²', expected: 'Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾' },
  
  // Ð Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð½Ð°Ñ Ñ€ÐµÑ‡ÑŒ
  { message: 'Ñ‡Ðµ Ð¿Ð¾ Ñ†ÐµÐ½Ð°Ð¼ Ð½Ð° Ð±Ð¾Ñ€Ð¾Ð´Ñƒ?', expected: 'Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ†ÐµÐ½Ñ‹ Ð½Ð° Ð±Ð¾Ñ€Ð¾Ð´Ñƒ' },
  { message: 'ÐºÐ°Ð´Ð° Ð¼Ð¾Ð¶Ð½Ð° Ð¿Ñ€Ð¸Ð´Ñ‚Ð¸?', expected: 'Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ ÐºÐ¾Ð³Ð´Ð° ÑƒÐ´Ð¾Ð±Ð½Ð¾' },
  { message: 'Ð·Ð°Ð¿Ð¸ÑˆÐ¸ Ð¿Ð»Ð· Ð½Ð° ÑÑ‚Ñ€Ð¸Ð¶ÐºÑƒ', expected: 'Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸' },
  
  // Ð¡Ð»Ð¾Ð¶Ð½Ñ‹Ðµ ÐºÐµÐ¹ÑÑ‹
  { message: 'Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ðº Ð˜Ð²Ð°Ð½Ñƒ Ð½Ð° Ð·Ð°Ð²Ñ‚Ñ€Ð° Ð²ÐµÑ‡ÐµÑ€Ð¾Ð¼?', expected: 'Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÐ»Ð¾Ñ‚Ñ‹ Ð˜Ð²Ð°Ð½Ð°' },
  { message: 'ÐµÑÑ‚ÑŒ Ð²Ñ€ÐµÐ¼Ñ Ð² Ð¿ÑÑ‚Ð½Ð¸Ñ†Ñƒ ÑƒÑ‚Ñ€Ð¾Ð¼ Ð½Ð° ÑÑ‚Ñ€Ð¸Ð¶ÐºÑƒ Ð¸ Ð±Ð¾Ñ€Ð¾Ð´Ñƒ?', expected: 'Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ðµ ÑÐ»Ð¾Ñ‚Ñ‹ Ð¿ÑÑ‚Ð½Ð¸Ñ†Ñ‹' }
];

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
async function sendMessage(message) {
  try {
    console.log(`\nðŸ“¤ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼: "${message}"`);
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· API Venom Bot
    const response = await axios.post(
      `${WHATSAPP_API_URL}/api/sendText`,
      {
        phone: REAL_PHONE,
        message: message
      },
      {
        headers: {
          'Authorization': `Bearer ${SECRET_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log('âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾');
    return true;
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸:', error.message);
    return false;
  }
}

// ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
async function runRealTests() {
  console.log('ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· WhatsApp');
  console.log(`ðŸ“± ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð° Ð½Ð¾Ð¼ÐµÑ€ Ð±Ð¾Ñ‚Ð°: ${REAL_PHONE}`);
  console.log('â±ï¸  ÐœÐµÐ¶Ð´Ñƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÐ¼Ð¸ Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° 10 ÑÐµÐºÑƒÐ½Ð´\n');
  
  console.log('Ð’ÐÐ–ÐÐž: ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ WhatsApp Ð¸ ÑÐ»ÐµÐ´Ð¸Ñ‚Ðµ Ð·Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°Ð¼Ð¸ Ð±Ð¾Ñ‚Ð°!');
  console.log('ÐŸÐ¾ÑÐ»Ðµ Ñ‚ÐµÑÑ‚Ð° Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ, Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð»Ð¸ Ð±Ð¾Ñ‚ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ð» Ð¸Ð½Ñ‚ÐµÐ½Ñ‚Ñ‹.\n');
  
  // Ð–Ð´ÐµÐ¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ
  console.log('ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð´Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ñ‚ÐµÑÑ‚Ð¾Ð²...');
  await new Promise(resolve => process.stdin.once('data', resolve));
  
  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
  for (const test of testMessages) {
    const sent = await sendMessage(test.message);
    
    if (sent) {
      console.log(`ðŸ’¡ ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: ${test.expected}`);
      console.log('â³ Ð–Ð´ÐµÐ¼ 10 ÑÐµÐºÑƒÐ½Ð´ Ð¿ÐµÑ€ÐµÐ´ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼...');
      await new Promise(resolve => setTimeout(resolve, 10000));
    }
  }
  
  console.log('\nâœ… Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹!');
  console.log('ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ð±Ð¾Ñ‚Ð° Ð² WhatsApp Ð¸ Ð¾Ñ†ÐµÐ½Ð¸Ñ‚Ðµ:');
  console.log('- ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð»Ð¸ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ñ‹ Ð¸Ð½Ñ‚ÐµÐ½Ñ‚Ñ‹?');
  console.log('- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð» Ð»Ð¸ Ð±Ð¾Ñ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ [SEARCH_SLOTS], [SHOW_PRICES]?');
  console.log('- Ð‘Ñ‹Ð»Ð¸ Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ð¿Ð¾Ð»ÐµÐ·Ð½Ñ‹Ð¼Ð¸ Ð¸ Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¼Ð¸?');
}

// ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚ - Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð»Ð¾Ð³Ð¾Ð²
async function monitorLogs() {
  console.log('\nðŸ“‹ ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚ - Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð»Ð¾Ð³Ð¾Ð² Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸:');
  console.log('Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ:');
  console.log('pm2 logs ai-admin-worker-v2 --lines 100 | grep -E "(processMessage|SEARCH_SLOTS|SHOW_PRICES|CREATE_BOOKING)"');
  console.log('\nÐ­Ñ‚Ð¾ Ð¿Ð¾ÐºÐ°Ð¶ÐµÑ‚, ÐºÐ°ÐºÐ¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ Ð±Ð¾Ñ‚ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ.');
}

// Ð—Ð°Ð¿ÑƒÑÐº
if (require.main === module) {
  runRealTests()
    .then(() => monitorLogs())
    .catch(console.error);
}