# Руководство по безопасности AI Admin v2

## Обзор реализованных мер безопасности

### 1. Аутентификация между приложением и Venom-bot сервером

**Реализация:**
- Добавлена аутентификация через API ключ и подпись HMAC-SHA256
- Все запросы к venom-bot подписываются с использованием секретного ключа
- Временная метка предотвращает replay-атаки

**Конфигурация:**
```env
VENOM_API_KEY=ваш-api-ключ
VENOM_SECRET_KEY=ваш-секретный-ключ
```

### 2. Валидация подписи вебхуков

**Реализация:**
- Все входящие вебхуки проверяются на подлинность
- Используется HMAC-SHA256 подпись с временной меткой
- Отклоняются запросы старше 5 минут

**Middleware:**
- `validateWebhookSignature` - для критичных эндпоинтов
- `validateApiKey` - для API эндпоинтов

### 3. Обязательная аутентификация Redis

**Реализация:**
- Redis требует пароль в production окружении
- Автоматическая валидация конфигурации при запуске
- Безопасная фабрика для создания Redis клиентов

**Конфигурация:**
```env
REDIS_PASSWORD=сложный-пароль
```

### 4. Rate Limiting

**Реализация:**
- Защита всех API эндпоинтов от DDoS
- Разные лимиты для разных типов эндпоинтов:
  - Вебхуки: 1000 запросов за 15 минут
  - API: 100 запросов за 15 минут
  - Отправка сообщений: 20 запросов в час
- Хранение счётчиков в Redis

### 5. Управление секретами

**Реализация:**
- Встроенный менеджер секретов с шифрованием AES-256-GCM
- Поддержка мастер-ключа для шифрования
- CLI утилита для управления секретами

**Использование:**
```bash
# Генерация мастер-ключа
node scripts/manage-secrets.js generate-key

# Сохранение секрета
node scripts/manage-secrets.js set redis-password

# Получение секрета
node scripts/manage-secrets.js get redis-password
```

### 6. Circuit Breaker паттерн

**Реализация:**
- Защита от каскадных сбоев внешних сервисов
- Автоматическое отключение проблемных интеграций
- Мониторинг состояния через API

**Настройки:**
- WhatsApp: 5 ошибок, восстановление через 1 минуту
- AI Service: 3 ошибки, восстановление через 30 секунд

**Мониторинг:**
```bash
GET /api/circuit-breakers
```

## Рекомендации по безопасности

### При развёртывании:

1. **Всегда устанавливайте пароль Redis:**
   ```bash
   REDIS_PASSWORD=$(openssl rand -base64 32)
   ```

2. **Генерируйте уникальные ключи для каждого окружения:**
   ```bash
   VENOM_API_KEY=$(uuidgen)
   VENOM_SECRET_KEY=$(openssl rand -hex 32)
   MASTER_KEY=$(node scripts/manage-secrets.js generate-key)
   ```

3. **Используйте HTTPS в production:**
   - Настройте reverse proxy (nginx) с SSL
   - Перенаправляйте HTTP на HTTPS

4. **Ограничьте доступ по IP:**
   - Используйте firewall для ограничения доступа к Redis
   - Разрешите только доверенные IP для API

5. **Регулярно обновляйте зависимости:**
   ```bash
   npm audit
   npm update
   ```

### Мониторинг безопасности:

1. **Отслеживайте rate limit нарушения в логах**
2. **Мониторьте состояние Circuit Breakers**
3. **Проверяйте логи на подозрительную активность**
4. **Настройте алерты на критические ошибки**

## Контрольный список безопасности

- [ ] Установлен пароль Redis
- [ ] Сгенерированы все API ключи
- [ ] Настроен MASTER_KEY для шифрования
- [ ] Включён HTTPS в production
- [ ] Настроены правила firewall
- [ ] Проверены все переменные окружения
- [ ] Настроен мониторинг
- [ ] Создан план резервного копирования

## Обработка инцидентов

При подозрении на компрометацию:

1. **Немедленно смените все ключи**
2. **Проверьте логи на подозрительную активность**
3. **Временно заблокируйте подозрительные IP**
4. **Уведомите команду безопасности**

## Контакты

В случае обнаружения уязвимостей обращайтесь:
- Email: security@example.com
- Telegram: @security_team