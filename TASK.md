# AI Admin v2 - Task Tracker

## üìÖ Last Updated: July 28, 2025, 14:45

## üéØ Current Sprint - Phase 3: Edge Cases –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å

### ‚úÖ Completed - Critical Fixes (July 24, 2025 Evening)
- [x] **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç Supabase –≤ command-handler.js**
  - [x] –û—à–∏–±–∫–∞: supabase.from is not a function
  - [x] –†–µ—à–µ–Ω–∏–µ: –¥–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–º–ø–æ—Ä—Ç { supabase }
- [x] **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π AI**
  - [x] –î–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ –ø—Ä–æ–º–ø—Ç
  - [x] AI –±–æ–ª—å—à–µ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–æ–π –∞–Ω–∞–ª–∏–∑ –≤ –æ—Ç–≤–µ—Ç—ã
- [x] **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ targetDate is not defined**
  - [x] –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤ checkStaffSchedule
  - [x] –í–æ—Ä–∫–µ—Ä —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

### ‚úÖ Completed - CHECK_STAFF_SCHEDULE Added (July 24, 2025 Morning)
- [x] **–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ CHECK_STAFF_SCHEDULE**
  - [x] –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —á–µ—Ä–µ–∑ –ë–î
  - [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ processAIResponse
  - [x] –û–±–Ω–æ–≤–ª–µ–Ω –ø—Ä–æ–º–ø—Ç AI
- [x] **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–∫–∞–∑ —Å–ª–æ—Ç–æ–≤ –ø—Ä–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**
  - [x] –£—Å–∏–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –≤ –ø—Ä–æ–º–ø—Ç–µ
  - [x] AI –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ª–æ—Ç—ã –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –≤—Ä–µ–º—è

### ‚úÖ Completed - Rapid-Fire Protection Fixed (July 23, 2025)
- [x] **Redis-based –±–∞—Ç—á–∏–Ω–≥ –¥–ª—è rapid-fire protection**
  - [x] –°–æ–∑–¥–∞–Ω RedisBatchService
  - [x] Batch Processor worker
  - [x] –ù–æ–≤—ã–π webhook endpoint /webhook/whatsapp/batched
  - [x] –¢–µ—Å—Ç—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
  - [x] –°–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è!

### ‚úÖ Completed - YClients API Permissions Fixed (July 28, 2025)
- [x] **–†–ï–®–ï–ù–ê –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ YClients API**
  - [x] –î–æ–±–∞–≤–ª–µ–Ω –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Partner-Id: 8444`
  - [x] –í—Å–µ endpoints —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
  - [x] –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ (`POST /company/962302/clients/search`) - ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
  - [x] –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π (`GET /records/962302`) - ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
  - [x] –û—à–∏–±–∫–∞ 403 "–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–µ–π" - –ò–°–ü–†–ê–í–õ–ï–ù–ê

### üî¥ High Priority - Test Previously Blocked Functions
- [ ] **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏–∑-–∑–∞ –ø—Ä–∞–≤**
  - [ ] –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ (DELETE /record/962302/{id})
  - [ ] –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (PUT /record/962302/{id})
  - [ ] –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ (POST /clients/962302)
  - [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø–∏—Å–∏ (GET /record/962302/{id})
  - [ ] –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤–∏–∑–∏—Ç–∞ (PUT /visits/{visit_id}/{record_id})
  - [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–µ—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞
  - [ ] –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤

### üî¥ High Priority - Critical Bugs to Fix
- [ ] **Add automatic alternative slots on booking errors**
  - [ ] When booking fails, immediately show available slots
  - [ ] Format slots nicely for user
  - [ ] Test with various error scenarios
- [ ] **Fix AI time understanding**
  - [ ] AI should understand "–Ω–∞ 3" as 15:00
  - [ ] Test various time formats

### üü° Medium Priority - Testing Required
- [x] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –≤–≤–æ–¥–æ–≤**
  - [x] –û–ø–µ—á–∞—Ç–∫–∏ –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –≤ –∫–æ–º–∞–Ω–¥–∞—Ö ‚úÖ
  - [x] –ù–µ–ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚úÖ
  - [x] –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã ‚úÖ
  - [x] –°–ø–∞–º –∏ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è ‚úÖ (—Ä–µ—à–µ–Ω–æ —á–µ—Ä–µ–∑ –±–∞—Ç—á–∏–Ω–≥)
- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤**
  - [ ] –ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
  - [ ] –ó–∞–ø–∏—Å—å –Ω–∞ –Ω–µ—Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã
  - [ ] –ó–∞–ø–∏—Å—å —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –≤ –±—É–¥—É—â–µ–µ
  - [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–µ—Ä–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–∞—Ç
- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏**
  - [ ] –ü–æ—Ç–µ—Ä—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  - [ ] –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å YClients API
  - [ ] –¢–∞–π–º–∞—É—Ç—ã –∏ —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
  - [ ] –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º**
  - [ ] Fix Redis configuration (—É–±—Ä–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ö–∞–∫–∏)

### üü° Medium Priority - Phase 4: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–∑–∞ –¥–µ–Ω—å, –∑–∞ 2 —á–∞—Å–∞) ‚úÖ (July 24, 2025)
- [ ] Webhook –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å YClients –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- [ ] Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–ª–æ—Ç–æ–≤
- [ ] –ü–æ–∫–∞–∑ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ [SHOW_PORTFOLIO]
- [ ] Create integration tests for booking flow
- [ ] Add monitoring dashboard improvements

### üü¢ Low Priority - Phase 5 & 6: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- [ ] –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å YClients
- [ ] –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- [ ] API –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- [ ] –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –¥–∞—à–±–æ—Ä–¥—ã
- [ ] Add more business types to `business-types.js`
- [ ] Create admin panel for configuration

## ‚úÖ Completed Tasks

### Migration v1 ‚Üí v2 (July 2024)
- [x] Implement AI Admin v2 architecture
- [x] Replace 5-step pipeline with single AI call
- [x] Add command-based approach
- [x] Implement business type detection
- [x] Add 5-minute context caching
- [x] Update PM2 configuration to use v2 worker

### Bug Fixes
- [x] Fixed `context is not defined` error
- [x] Fixed `query.from is not a function`
- [x] Fixed table name: schedules ‚Üí staff_schedules
- [x] Fixed missing clients handling with maybeSingle()
- [x] Fixed undefined checks in sortServicesForClient
- [x] Fixed `AIService.generateResponse is not a function` - using `_callAI` instead (July 18, 2024)
- [x] Fixed Redis port 6380 issues - temporary override to 6379 (July 18, 2024)
- [x] Fixed git merge conflicts on server deployment (July 18, 2024)
- [x] Fixed "no working masters" issue - removed company_id filter from staff_schedules (July 19, 2024)
- [x] Fixed incorrect working hours (21:00 ‚Üí 22:00) (July 19, 2024)

### Optimizations
- [x] Created database indexes for performance
- [x] Added MCP Supabase integration
- [x] Optimized YClients API documentation access
- [x] Implemented Context Engineering structure
- [x] Increased schedule sync frequency from 2x to 48x daily (July 21, 2024)
- [x] Implemented smart slot filtering with 1-hour intervals (July 21, 2024)

### Features Added (July 20-22, 2025)
- [x] ServiceMatcher scoring algorithm with penalties for complex services
- [x] Relative date parsing ("–∑–∞–≤—Ç—Ä–∞", "–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞", days of week)
- [x] Automatic booking creation without confirmation when specific time provided
- [x] Fixed booking number display (correct extraction from YClients response)
- [x] Price list improvements - filtering, sorting, compact format
- [x] Staff availability sync script (sync-staff-schedules.js)
- [x] API endpoints for manual sync control
- [x] Smart slot filtering - 3 slots per time period with 1-hour gaps
- [x] Fixed unnecessary slots display when booking specific time (July 22, 2025)
- [x] CREATE_BOOKING now supports service_name parameter (July 22, 2025)
- [x] Automatic staff selection if not specified (July 22, 2025)
- [x] Automatic alternative slots display on booking errors (July 22, 2025)
- [x] Fixed YClients detailed error messages extraction (July 22, 2025)
- [x] Added error handling logging in processAIResponse (July 22, 2025)
- [x] Implemented CANCEL_BOOKING command with direct ID support (July 22, 2025)
- [x] Added CONFIRM_BOOKING command for booking confirmation (July 22, 2025)
- [x] Added MARK_NO_SHOW command for no-show marking (July 22, 2025)
- [x] Researched all YClients API methods for record management (July 22, 2025)
- [x] Created BACKLOG.md for post-MVP features (July 22, 2025)
- [x] Updated documentation with API limitations (July 22, 2025)
- [x] Implemented RESCHEDULE_BOOKING command (July 23, 2025)
- [x] Completed Phase 3 testing - all modification features ready (July 23, 2025)

### Features Added (July 25, 2025)
- [x] Booking Monitor - —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
  - [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
  - [x] WhatsApp —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º –æ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å—è—Ö
  - [x] Polling –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É —Å 30-—Å–µ–∫—É–Ω–¥–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
  - [x] PM2 –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –≤ production
  - [x] –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ troubleshooting
  - [ ] –û–∂–∏–¥–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–∞–≤ API –¥–ª—è —Ä–∞–±–æ—Ç—ã

### Features Added (July 24, 2025)
- [x] Implemented automatic reminder system
  - [x] Day-before reminders (19:00-21:00 random time)
  - [x] 2-hour before reminders
  - [x] Automatic scheduling on booking creation
  - [x] Duplicate protection via database flags
  - [x] Separate PM2 process for reminder worker
  - [x] Full WhatsApp integration
  - [x] Comprehensive logging and monitoring
- [x] Fixed automatic reminder scheduling bug
  - [x] Fixed executedCommands/commands compatibility
  - [x] Added results passing from AI Admin v2
  - [x] Added detailed logging for debugging
- [x] Removed booking ID from client messages (stored in DB instead)

### Features Added (July 22, 2025)
- [x] ServiceMatcher scoring algorithm with penalties for complex services
- [x] Relative date parsing ("–∑–∞–≤—Ç—Ä–∞", "–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞", days of week)
- [x] Automatic booking creation without confirmation when specific time provided
- [x] Fixed booking number display (correct extraction from YClients response)
- [x] Price list improvements - filtering, sorting, compact format
- [x] Staff availability sync script (sync-staff-schedules.js)
- [x] API endpoints for manual sync control
- [x] Smart slot filtering - 3 slots per time period with 1-hour gaps
- [x] Fixed unnecessary slots display when booking specific time (July 22, 2025)
- [x] CREATE_BOOKING now supports service_name parameter (July 22, 2025)
- [x] Automatic staff selection if not specified (July 22, 2025)
- [x] Automatic alternative slots display on booking errors (July 22, 2025)
- [x] Fixed YClients detailed error messages extraction (July 22, 2025)
- [x] Added error handling logging in processAIResponse (July 22, 2025)

### Features
- [x] Implemented automatic company data parsing from YClients API (July 19, 2024)
- [x] Added business type auto-detection based on company description
- [x] Made system scalable - new companies auto-configure from YClients
- [x] Implemented relative date parsing ("–∑–∞–≤—Ç—Ä–∞" ‚Üí "2025-07-21") (July 20, 2024)
- [x] Added improved service matching algorithm with penalties for complex services (July 20, 2024)

## üöÄ Status by Phases

### ‚úÖ Phase 1: –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (–ó–ê–í–ï–†–®–ï–ù–ê)
- [x] –ú–∏–≥—Ä–∞—Ü–∏—è v1 ‚Üí v2 –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- [x] –ë–∞–∑–æ–≤–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
- [x] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –±–∏–∑–Ω–µ—Å–∞
- [x] –ü–æ–∏—Å–∫ —Å–ª–æ—Ç–æ–≤ [SEARCH_SLOTS]
- [x] –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ [CREATE_BOOKING]
- [x] –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ rapid-fire –∑–∞—â–∏—Ç–∞

### ‚úÖ Phase 2: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (–ó–ê–í–ï–†–®–ï–ù–ê)
- [x] –ü–æ–∫–∞–∑ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ [SHOW_PRICES]
- [x] –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ [CANCEL_BOOKING] - —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–∞ API
- [x] –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏ [RESCHEDULE_BOOKING] - —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–∞ API
- [x] –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ/–Ω–µ—è–≤–∫–∞ - —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–∞ API
- [ ] –ü–æ–∫–∞–∑ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ [SHOW_PORTFOLIO] - –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### üîÑ Phase 3: Edge Cases –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å (–¢–ï–ö–£–©–ê–Ø)
- –°–º. —Ä–∞–∑–¥–µ–ª "Current Sprint" –≤—ã—à–µ

### üìã Phase 4: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- –°–º. —Ä–∞–∑–¥–µ–ª "Medium Priority" –≤—ã—à–µ

### üöÄ Phase 5 & 6: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –°–º. —Ä–∞–∑–¥–µ–ª "Low Priority" –≤—ã—à–µ

## üìù Technical Debt

1. **Database**
   - Missing foreign key constraints
   - No cascade delete rules
   - Incomplete migration scripts

2. **Code**
   - Some services exceed 500 lines
   - Inconsistent error handling
   - Mixed async/callback patterns

3. **Testing**
   - Low test coverage (~40%)
   - Missing integration tests
   - No performance tests

4. **Documentation**
   - API documentation incomplete
   - Missing deployment guide
   - No troubleshooting guide

## üêõ Known Issues

1. **ServiceMatcher**
   - –ê–ª–≥–æ—Ä–∏—Ç–º scoring –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —à—Ç—Ä–∞—Ñ—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
   - –í—Å–µ —É—Å–ª—É–≥–∏ —Å–æ —Å–ª–æ–≤–æ–º "—Å—Ç—Ä–∏–∂–∫–∞" –ø–æ–ª—É—á–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π score (130)
   - –í—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è —É—Å–ª—É–≥–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤–º–µ—Å—Ç–æ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–π

2. **Booking Flow** (Updated July 23, 2025)
   - ‚ùå **CRITICAL**: Missing staff_id when creating booking
   - ‚ùå AI uses `staff_id: "last"` but code doesn't handle it
   - ‚ùå No automatic alternative slots shown on booking errors
   - ‚úÖ FIXED: Wrong parameter order in getAvailableSlots
   - –û—à–∏–±–∫–∞ "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é —É—Å–ª—É–≥—É"
   - lastSearch —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—É—é –ø–∞—Ä—É service_id + staff_id

3. **Rapid-Fire Batching** (Critical - July 23, 2025)
   - ‚ùå **CRITICAL**: –ë–∞—Ç—á–∏ –∏—Å—á–µ–∑–∞—é—Ç –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞ –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - ‚ùå –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–µ—Ä—è—é—Ç—Å—è
   - ‚ùå TTL –∫–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏ –∏ —Ç–∞–π–º–∞—É—Ç–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ –æ—Ç–ª–∞–¥–∫–∏, –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —É—Å–ª—É–≥–∞-–º–∞—Å—Ç–µ—Ä –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏

3. **Performance**
   - High latency to Supabase from Russia (150-200ms)
   - Context loading can be slow for busy salons
   - No connection pooling

4. **Configuration**
   - Redis port hardcoded with temporary hacks (6380 ‚Üí 6379)

   - Need separate configs for local vs production

5. **YClients API Permissions** (‚úÖ FIXED July 28, 2025)
   - ‚úÖ **–ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê** - –¥–æ–±–∞–≤–ª–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Partner-Id: 8444`
   - ‚úÖ –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É (`POST company/962302/clients/search`) - –†–ê–ë–û–¢–ê–ï–¢
   - ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–ø–∏—Å–µ–π (`GET records/962302`) - –†–ê–ë–û–¢–ê–ï–¢
   - ‚è≥ –¢—Ä–µ–±—É–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
     - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ (`POST clients/962302`)
     - –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (`DELETE record/962302/{id}`)
     - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø–∏—Å–∏ (`GET record/962302/{id}`)
     - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (`PUT record/962302/{id}`)
     - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤–∏–∑–∏—Ç–∞ (`PUT visits/{visit_id}/{record_id}`)
   - **–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏:
     ```
     Authorization: Bearer cfjbs9dpuseefh8ed5cp, User 16e0dffa0d71350dcb83381e03e7af29
     X-Partner-Id: 8444
     ```

6. **Reliability**
   - WhatsApp session can expire
   - No automatic reconnection
   - Queue can get stuck on errors

6. **UX**
   - Error messages not user-friendly
   - No typing indicators
   - Limited formatting options
   - Prices not showing correctly (format issues)

## üìä Metrics to Track

- Average response time
- Daily active users
- Booking conversion rate
- Error rate by type
- Cache hit ratio
- Worker memory usage

## üîÑ Update History

- **2024-07-20**: Added relative date parsing, improved ServiceMatcher (issues remain)
- **2024-07-19**: Implemented auto-parsing from YClients, fixed working hours
- **2024-07-16**: Added Context Engineering structure
- **2024-07-13**: Completed v1 ‚Üí v2 migration
- **2024-07-11**: Fixed database sync issues
- **2024-07-10**: Initial v2 architecture implementation