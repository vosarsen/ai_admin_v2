#!/usr/bin/env node
/**
 * Update Tax Comparison Sheet with 2025-2026 Tax Reform (v2 - fixed formulas)
 */

const { google } = require('googleapis');
const path = require('path');

const SPREADSHEET_ID = '1c3TSGl9It3byKuH1RCKU1ijVV3soPLLefC36Y82rlGg';
const CREDENTIALS_PATH = path.join(__dirname, '../../config/google-service-account.json');

async function main() {
  const auth = new google.auth.GoogleAuth({
    keyFile: CREDENTIALS_PATH,
    scopes: ['https://www.googleapis.com/auth/spreadsheets'],
  });
  const sheets = google.sheets({ version: 'v4', auth });

  console.log('üîß –û–±–Ω–æ–≤–ª—è–µ–º Tax_Comparison (v2 - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ñ–æ—Ä–º—É–ª—ã)...\n');

  await sheets.spreadsheets.values.clear({
    spreadsheetId: SPREADSHEET_ID,
    range: 'Tax_Comparison!A:Z',
  });

  // Simplified structure with correct row references
  const data = [
    // Row 1-4: Header
    ['üìä –ù–ê–õ–û–ì–û–í–´–ï –†–ï–ñ–ò–ú–´ 2025-2026 (—Å —É—á—ë—Ç–æ–º —Ä–µ—Ñ–æ—Ä–º—ã)', '', '', '', '', '', ''],
    ['–û–±–Ω–æ–≤–ª–µ–Ω–æ: 27.11.2025', '', '–†–µ–≥–∏–æ–Ω: –ú–û', '', '', '', ''],
    [''],

    // Row 4-14: Key changes
    ['üö® –ö–õ–Æ–ß–ï–í–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø 2026', '', '', '', '', '', ''],
    ['–ü–∞—Ä–∞–º–µ—Ç—Ä', '2025', '2026', '–í–ª–∏—è–Ω–∏–µ', '', '', ''],
    ['–ù–î–° –ø–æ—Ä–æ–≥ –£–°–ù', '60 –º–ª–Ω‚ÇΩ', '20 –º–ª–Ω‚ÇΩ', '–ü—Ä–∏ >20–ú ‚Üí –ù–î–° 5%', '', '', ''],
    ['–í–∑–Ω–æ—Å—ã –ò–ü —Ñ–∏–∫—Å', '53 658‚ÇΩ', '57 390‚ÇΩ', "'+7%", '', '', ''],
    ['–í–∑–Ω–æ—Å—ã –ò–ü –º–∞–∫—Å', '300 888‚ÇΩ', '321 818‚ÇΩ', "'+7%", '', '', ''],
    ['IT —Å—Ç—Ä–∞—Ö. –≤–∑–Ω–æ—Å—ã', '7,6%', '15%', "'+97%!", '', '', ''],
    ['–õ–∏–º–∏—Ç –£–°–ù', '265,8–ú‚ÇΩ', '490,5–ú‚ÇΩ', '–£–≤–µ–ª–∏—á–µ–Ω', '', '', ''],
    ['–ù–î–§–õ –¥–∏–≤–∏–¥. –ø–æ—Ä–æ–≥', '5 –º–ª–Ω‚ÇΩ', '2,4 –º–ª–Ω‚ÇΩ', '15% —Ä–∞–Ω—å—à–µ', '', '', ''],
    [''],

    // Row 13-24: Base params
    ['‚ïê‚ïê‚ïê –ë–ê–ó–û–í–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ ‚ïê‚ïê‚ïê', '', '', '', '', '', ''],
    ['–ü–∞—Ä–∞–º–µ—Ç—Ä', '–ò–ü –£–°–ù 6%', '–ò–ü –£–°–ù 15%', '–û–û–û –£–°–ù 6%', '–û–û–û IT 1%', '–û–û–û –û–°–ù–û', ''],
    ['–°—Ç–∞–≤–∫–∞', '6%', '15%', '6%', '1%', '20%', ''],
    ['–ù–î–° 2025', '–ù–µ—Ç (<60–ú)', '–ù–µ—Ç (<60–ú)', '–ù–µ—Ç (<60–ú)', '–ù–µ—Ç (<60–ú)', '20%', ''],
    ['–ù–î–° 2026', '5% (>20–ú)', '5% (>20–ú)', '5% (>20–ú)', '5% (>20–ú)', '22%', ''],
    ['–í–∑–Ω–æ—Å—ã –ò–ü', '57 390‚ÇΩ+1%', '57 390‚ÇΩ+1%', '‚Äî', '‚Äî', '‚Äî', ''],
    ['–ù–î–§–õ –≤—ã–≤–æ–¥', '0%', '0%', '13-15%', '13-15%', '13-15%', ''],
    ['–õ–∏–º–∏—Ç 2026', '490,5–ú‚ÇΩ', '490,5–ú‚ÇΩ', '490,5–ú‚ÇΩ', '490,5–ú‚ÇΩ', '‚àû', ''],
    [''],

    // Rows 23-28: Input data (index 22-27)
    ['‚ïê‚ïê‚ïê –î–ê–ù–ù–´–ï –ò–ó SCALING ‚ïê‚ïê‚ïê', '', '', '', '', '', ''],  // Row 23
    ['–°–∞–ª–æ–Ω–æ–≤', '=Parameters!B4', '', '', '', '', ''],       // Row 24
    ['MRR/–º–µ—Å', '=Scaling!B3', '', '', '', '', ''],          // Row 25
    ['–í—ã—Ä—É—á–∫–∞/–≥–æ–¥', '=B25*12', '', '', '', '', ''],          // Row 26 (B25=MRR)
    ['–†–∞—Å—Ö–æ–¥—ã/–≥–æ–¥', '=(Scaling!H3+Scaling!I3)*12', '', '', '', '', ''], // Row 27
    [''],                                                     // Row 28

    // Rows 29-43: 2025 calculation (index 28-42)
    ['‚ïê‚ïê‚ïê –†–ê–°–ß–Å–¢ 2025 (–±–µ–∑ –ù–î–°) ‚ïê‚ïê‚ïê', '', '', '', '', '', ''], // Row 29
    ['–°—Ç–∞—Ç—å—è', '–ò–ü –£–°–ù 6%', '–ò–ü –£–°–ù 15%', '–û–û–û –£–°–ù 6%', '–û–û–û IT 1%', '–û–û–û –û–°–ù–û', ''], // Row 30
    ['–í—ã—Ä—É—á–∫–∞', '=B26', '=B31', '=B31', '=B31', '=B31', ''],   // Row 31 (B26=–í—ã—Ä—É—á–∫–∞/–≥–æ–¥)
    ['–†–∞—Å—Ö–æ–¥—ã', '=B27', '=B32', '=B32', '=B32', '=B32', ''],   // Row 32 (B27=–†–∞—Å—Ö–æ–¥—ã/–≥–æ–¥)
    ['–ù–∞–ª–æ–≥', '=B31*0,06', '=MAX((C31-C32)*0,15;C31*0,01)', '=D31*0,06', '=E31*0,01', '=(F31-F32)*0,2', ''], // Row 33
    ['–í–∑–Ω–æ—Å—ã –ò–ü', '=MIN(53658+MAX(0;(B31-300000)*0,01);300888)', '=B34', '0', '0', '0', ''], // Row 34
    ['–í—ã—á–µ—Ç 50%', '=MIN(B33;B34*0,5)', '0', '0', '0', '0', ''], // Row 35
    ['–ù–∞–ª–æ–≥ –∏—Ç–æ–≥–æ', '=B33-B35', '=C33', '=D33', '=E33', '=F33', ''], // Row 36
    ['–ü—Ä–∏–±—ã–ª—å', '=B31-B32-B36-B34', '=C31-C32-C36-C34', '=D31-D32-D36', '=E31-E32-E36', '=F31-F32-F36', ''], // Row 37
    ['–ù–î–§–õ 13%', '0', '0', '=D37*0,13', '=E37*0,13', '=F37*0,13', ''], // Row 38
    ['–ë—É—Ö–≥–∞–ª—Ç–µ—Ä', '0', '12000', '80000', '80000', '150000', ''], // Row 39
    ['–ù–∞–≥—Ä—É–∑–∫–∞', '=B36+B34+B38+B39', '=C36+C34+C38+C39', '=D36+D38+D39', '=E36+E38+E39', '=F36+F38+F39', ''], // Row 40
    ['–ù–∞ —Ä—É–∫–∏', '=B31-B40', '=C31-C40', '=D31-D40', '=E31-E40', '=F31-F40', ''], // Row 41
    ['% –Ω–∞–≥—Ä—É–∑–∫–∏', '=B40/B31', '=C40/C31', '=D40/D31', '=E40/E31', '=F40/F31', ''], // Row 42
    [''],                                                     // Row 43

    // Rows 44-58: 2026 calculation with VAT (index 43-57)
    ['‚ïê‚ïê‚ïê –†–ê–°–ß–Å–¢ 2026 (–ù–î–° 5% –ø—Ä–∏ >20–ú) ‚ïê‚ïê‚ïê', '', '', '', '', '', ''], // Row 44
    ['–°—Ç–∞—Ç—å—è', '–ò–ü –£–°–ù 6%', '–ò–ü –£–°–ù 15%', '–û–û–û –£–°–ù 6%', '–û–û–û IT 1%', '–û–û–û –û–°–ù–û', ''], // Row 45
    ['–í—ã—Ä—É—á–∫–∞', '=B26', '=B46', '=B46', '=B46', '=B46', ''],   // Row 46 (B26=–í—ã—Ä—É—á–∫–∞/–≥–æ–¥)
    ['–†–∞—Å—Ö–æ–¥—ã', '=B27', '=B47', '=B47', '=B47', '=B47', ''],   // Row 47 (B27=–†–∞—Å—Ö–æ–¥—ã/–≥–æ–¥)
    ['–ù–∞–ª–æ–≥', '=B46*0,06', '=MAX((C46-C47)*0,15;C46*0,01)', '=D46*0,06', '=E46*0,01', '=(F46-F47)*0,2', ''], // Row 48
    ['–í–∑–Ω–æ—Å—ã –ò–ü', '=MIN(57390+MAX(0;(B46-300000)*0,01);321818)', '=B49', '0', '0', '0', ''], // Row 49
    ['–í—ã—á–µ—Ç 50%', '=MIN(B48;B49*0,5)', '0', '0', '0', '0', ''], // Row 50
    ['–ù–∞–ª–æ–≥ –∏—Ç–æ–≥–æ', '=B48-B50', '=C48', '=D48', '=E48', '=F48', ''], // Row 51
    ['–ù–î–° 5%', '=IF(B46>20000000;B46*0,05;0)', '=IF(C46>20000000;C46*0,05;0)', '=IF(D46>20000000;D46*0,05;0)', '=IF(E46>20000000;E46*0,05;0)', '=F46*0,22', ''], // Row 52
    ['–ü—Ä–∏–±—ã–ª—å', '=B46-B47-B51-B49-B52', '=C46-C47-C51-C49-C52', '=D46-D47-D51-D52', '=E46-E47-E51-E52', '=F46-F47-F51-F52', ''], // Row 53
    ['–ù–î–§–õ', '0', '0', '=IF(D53>2400000;D53*0,15;D53*0,13)', '=IF(E53>2400000;E53*0,15;E53*0,13)', '=IF(F53>2400000;F53*0,15;F53*0,13)', ''], // Row 54
    ['–ë—É—Ö–≥–∞–ª—Ç–µ—Ä', '0', '12000', '80000', '80000', '150000', ''], // Row 55
    ['–ù–∞–≥—Ä—É–∑–∫–∞', '=B51+B49+B52+B54+B55', '=C51+C49+C52+C54+C55', '=D51+D52+D54+D55', '=E51+E52+E54+E55', '=F51+F52+F54+F55', ''], // Row 56
    ['–ù–∞ —Ä—É–∫–∏', '=B46-B56', '=C46-C56', '=D46-D56', '=E46-E56', '=F46-F56', ''], // Row 57
    ['% –Ω–∞–≥—Ä—É–∑–∫–∏', '=B56/B46', '=C56/C46', '=D56/D46', '=E56/E46', '=F56/F46', ''], // Row 58
    [''],                                                     // Row 59

    // Rows 60-65: Comparison (index 58-63)
    ['‚ïê‚ïê‚ïê –°–†–ê–í–ù–ï–ù–ò–ï 2025 vs 2026 ‚ïê‚ïê‚ïê', '', '', '', '', '', ''], // Row 60
    ['–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å', '–ò–ü –£–°–ù 6%', '–ò–ü –£–°–ù 15%', '–û–û–û –£–°–ù 6%', '–û–û–û IT 1%', '–û–û–û –û–°–ù–û', ''], // Row 61
    ['–ù–∞–≥—Ä—É–∑–∫–∞ 2025', '=B42', '=C42', '=D42', '=E42', '=F42', ''], // Row 62 (Row 42 = % –Ω–∞–≥—Ä—É–∑–∫–∏ 2025)
    ['–ù–∞–≥—Ä—É–∑–∫–∞ 2026', '=B58', '=C58', '=D58', '=E58', '=F58', ''], // Row 63 (Row 58 = % –Ω–∞–≥—Ä—É–∑–∫–∏ 2026)
    ['Œî –†–æ—Å—Ç', '=B63-B62', '=C63-C62', '=D63-D62', '=E63-E62', '=F63-F62', ''], // Row 64
    [''],                                                     // Row 65

    // Rows 66-67: Best option (index 64-65)
    ['üèÜ –õ–£–ß–®–ò–ô 2025', '=IF(B41=MAX($B41:$F41);"‚úÖ";"")', '=IF(C41=MAX($B41:$F41);"‚úÖ";"")', '=IF(D41=MAX($B41:$F41);"‚úÖ";"")', '=IF(E41=MAX($B41:$F41);"‚úÖ";"")', '=IF(F41=MAX($B41:$F41);"‚úÖ";"")', ''], // Row 66 (Row 41 = –ù–∞ —Ä—É–∫–∏ 2025)
    ['üèÜ –õ–£–ß–®–ò–ô 2026', '=IF(B57=MAX($B57:$F57);"‚úÖ";"")', '=IF(C57=MAX($B57:$F57);"‚úÖ";"")', '=IF(D57=MAX($B57:$F57);"‚úÖ";"")', '=IF(E57=MAX($B57:$F57);"‚úÖ";"")', '=IF(F57=MAX($B57:$F57);"‚úÖ";"")', ''], // Row 67 (Row 57 = –ù–∞ —Ä—É–∫–∏ 2026)
    [''],

    // Row 67-77: Scenarios
    ['‚ïê‚ïê‚ïê –°–¶–ï–ù–ê–†–ò–ò –ü–û –°–ê–õ–û–ù–ê–ú (2026) ‚ïê‚ïê‚ïê', '', '', '', '', '', ''],
    ['–°–∞–ª–æ–Ω–æ–≤', '–í—ã—Ä—É—á–∫–∞/–≥–æ–¥', '–ù–î–° 5%?', '–£–°–ù 6%', '–í–∑–Ω–æ—Å—ã –ò–ü', '–ù–∞–≥—Ä—É–∑–∫–∞', '% –Ω–∞–≥—Ä—É–∑–∫–∏'],
    ['5', '3 000 000‚ÇΩ', '‚ùå –ù–µ—Ç', '180 000‚ÇΩ', '84 390‚ÇΩ', '264 390‚ÇΩ', '8,8%'],
    ['20', '12 000 000‚ÇΩ', '‚ùå –ù–µ—Ç', '720 000‚ÇΩ', '174 390‚ÇΩ', '894 390‚ÇΩ', '7,5%'],
    ['30', '18 000 000‚ÇΩ', '‚ùå –ù–µ—Ç', '1 080 000‚ÇΩ', '234 390‚ÇΩ', '1 314 390‚ÇΩ', '7,3%'],
    ['33 ‚ö†Ô∏è', '19 800 000‚ÇΩ', '‚ùå –ù–µ—Ç', '1 188 000‚ÇΩ', '252 390‚ÇΩ', '1 440 390‚ÇΩ', '7,3%'],
    ['34 üö®', '20 400 000‚ÇΩ', '‚úÖ 1 020 000‚ÇΩ', '1 224 000‚ÇΩ', '258 390‚ÇΩ', '2 502 390‚ÇΩ', '12,3%'],
    ['50', '30 000 000‚ÇΩ', '‚úÖ 1 500 000‚ÇΩ', '1 800 000‚ÇΩ', '321 818‚ÇΩ', '3 621 818‚ÇΩ', '12,1%'],
    ['100', '60 000 000‚ÇΩ', '‚úÖ 3 000 000‚ÇΩ', '3 600 000‚ÇΩ', '321 818‚ÇΩ', '6 921 818‚ÇΩ', '11,5%'],
    [''],
    ['‚ö†Ô∏è –ü–û–†–û–ì –ù–î–°: 33 —Å–∞–ª–æ–Ω–∞ (20–ú‚ÇΩ) ‚Äî –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ +5% –ù–î–°!', '', '', '', '', '', ''],
    [''],

    // Row 80-88: Recommendations
    ['‚ïê‚ïê‚ïê –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò ‚ïê‚ïê‚ïê', '', '', '', '', '', ''],
    ['–≠—Ç–∞–ø', '–í—ã—Ä—É—á–∫–∞', '–†–µ–∂–∏–º', '% –Ω–∞–≥—Ä—É–∑–∫–∏', '–ù–î–°', '–î–µ–π—Å—Ç–≤–∏–µ', ''],
    ['MVP 2025', '<20–ú‚ÇΩ', '–ò–ü –£–°–ù 6%', '~7-8%', '‚ùå', '‚úÖ –†–∞–±–æ—Ç–∞–µ–º', ''],
    ['–†–æ—Å—Ç 2026', '20-60–ú‚ÇΩ', '–ò–ü –£–°–ù 6%', '~12%', '‚úÖ 5%', '‚ö†Ô∏è –í–Ω–µ–¥—Ä–∏—Ç—å –ù–î–°', ''],
    ['–ú–∞—Å—à—Ç–∞–±', '>60–ú‚ÇΩ', '–ò–ü –£–°–ù 6%', '~11-12%', '‚úÖ 5%', '‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ', ''],
    ['–ü–∞—Ä—Ç–Ω—ë—Ä', '–õ—é–±–∞—è', '–û–û–û IT 1%', '~14%', '‚úÖ 5%', '‚ö†Ô∏è –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–æ–ª–∏', ''],
    [''],

    // Row 89-95: Risks
    ['‚ïê‚ïê‚ïê –†–ò–°–ö–ò ‚ïê‚ïê‚ïê', '', '', '', '', '', ''],
    ['–†–∏—Å–∫', '–¢—Ä–∏–≥–≥–µ—Ä', '–í–ª–∏—è–Ω–∏–µ', '–ú–∏—Ç–∏–≥–∞—Ü–∏—è', '', '', ''],
    ['–ù–î–° 5%', '–í—ã—Ä—É—á–∫–∞ >20–ú‚ÇΩ', "'+5% –Ω–∞–≥—Ä—É–∑–∫–∏", '–ó–∞–ª–æ–∂–∏—Ç—å –≤ —Ü–µ–Ω—ã', '', '', ''],
    ['–û—Ç–º–µ–Ω–∞ IT 1% –ú–û', '–ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ü–†–§', "'+5% –Ω–∞–ª–æ–≥", '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥', '', '', ''],
    ['–†–æ—Å—Ç –≤–∑–Ω–æ—Å–æ–≤ –ò–ü', '–ï–∂–µ–≥–æ–¥–Ω–æ', "'+7%/–≥–æ–¥", '–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', '', '', ''],
    ['–ù–î–§–õ 15%', '–î–∏–≤–∏–¥–µ–Ω–¥—ã >2,4–ú', "'+2%", '–†–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å', '', '', ''],
  ];

  await sheets.spreadsheets.values.update({
    spreadsheetId: SPREADSHEET_ID,
    range: 'Tax_Comparison!A1',
    valueInputOption: 'USER_ENTERED',
    requestBody: { values: data },
  });

  console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${data.length} —Å—Ç—Ä–æ–∫`);

  // Formatting
  const sheetInfo = await sheets.spreadsheets.get({ spreadsheetId: SPREADSHEET_ID });
  const taxSheet = sheetInfo.data.sheets.find(s => s.properties.title === 'Tax_Comparison');
  const sheetId = taxSheet.properties.sheetId;

  await sheets.spreadsheets.batchUpdate({
    spreadsheetId: SPREADSHEET_ID,
    requestBody: {
      requests: [
        { updateDimensionProperties: {
          range: { sheetId, dimension: 'COLUMNS', startIndex: 0, endIndex: 1 },
          properties: { pixelSize: 180 }, fields: 'pixelSize'
        }},
        { updateDimensionProperties: {
          range: { sheetId, dimension: 'COLUMNS', startIndex: 1, endIndex: 7 },
          properties: { pixelSize: 120 }, fields: 'pixelSize'
        }},
        { updateSheetProperties: {
          properties: { sheetId, gridProperties: { frozenColumnCount: 1 }},
          fields: 'gridProperties.frozenColumnCount'
        }},
        // Format percentages - Row 42 (% –Ω–∞–≥—Ä—É–∑–∫–∏ 2025) = index 41
        { repeatCell: {
          range: { sheetId, startRowIndex: 41, endRowIndex: 43, startColumnIndex: 1, endColumnIndex: 6 },
          cell: { userEnteredFormat: { numberFormat: { type: 'PERCENT', pattern: '0,0%' }}},
          fields: 'userEnteredFormat.numberFormat'
        }},
        // Format percentages - Row 58 (% –Ω–∞–≥—Ä—É–∑–∫–∏ 2026) = index 57
        { repeatCell: {
          range: { sheetId, startRowIndex: 57, endRowIndex: 59, startColumnIndex: 1, endColumnIndex: 6 },
          cell: { userEnteredFormat: { numberFormat: { type: 'PERCENT', pattern: '0,0%' }}},
          fields: 'userEnteredFormat.numberFormat'
        }},
        // Format percentages - Rows 62-64 (Comparison section) = index 61-63
        { repeatCell: {
          range: { sheetId, startRowIndex: 61, endRowIndex: 65, startColumnIndex: 1, endColumnIndex: 6 },
          cell: { userEnteredFormat: { numberFormat: { type: 'PERCENT', pattern: '0,0%' }}},
          fields: 'userEnteredFormat.numberFormat'
        }},
      ]
    },
  });

  console.log('‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ');
  console.log('\nüîó https://docs.google.com/spreadsheets/d/' + SPREADSHEET_ID);
}

main().catch(err => {
  console.error('‚ùå –û—à–∏–±–∫–∞:', err.message);
  process.exit(1);
});
