# Руководство по тестированию AI Admin v2

## Подготовка к тестированию

### 1. Настройка окружения

1. Скопируйте тестовую конфигурацию:
```bash
cp .env.test .env
```

2. Убедитесь, что заполнены все необходимые переменные:
- `YCLIENTS_BEARER_TOKEN` - токен вашего барбершопа
- `YCLIENTS_USER_TOKEN` - пользовательский токен
- `DEEPSEEK_API_KEY` - ключ AI сервиса
- `SUPABASE_URL` и `SUPABASE_KEY` - доступ к БД

### 2. Запуск сервисов

```bash
# Запустить Redis
redis-server

# Запустить Venom-bot (в отдельном терминале)
cd /path/to/venom-bot
npm start

# Запустить API сервер (в отдельном терминале)
npm run dev

# Запустить воркеры (в отдельном терминале)
npm run worker
```

### 3. Подключение WhatsApp

1. Откройте Venom-bot интерфейс: http://localhost:3001
2. Отсканируйте QR-код с телефона 89686484488
3. Дождитесь статуса "Connected"

## Запуск тестов

### Unit тесты
```bash
# Запустить все unit тесты
npm test

# Запустить с покрытием
npm run test:coverage

# Запустить в режиме наблюдения
npm run test:watch
```

### E2E тесты

1. **Запустите мониторинг** (в отдельном терминале):
```bash
npm run test:monitor
```

2. **Запустите E2E тесты**:
```bash
npm run test:e2e
```

3. **Наблюдайте за выполнением** в мониторе и логах

### Полное тестирование
```bash
# Unit + E2E тесты
npm run test:full
```

## Тестовые сценарии

### 1. Простое бронирование
- Приветствие
- Запрос на запись
- Выбор даты и времени
- Подтверждение

### 2. Бронирование с выбором мастера
- Запрос конкретного мастера
- Выбор услуги
- Выбор времени из предложенных

### 3. Отмена записи
- Запрос на отмену
- Подтверждение отмены

### 4. Получение информации
- Список услуг
- Цены
- Адрес и часы работы

## Очистка после тестов

```bash
# Очистить все тестовые данные
npm run test:cleanup
```

Это удалит:
- Тестовые записи в YClients
- Данные из Redis
- Записи в Supabase

## Отладка

### Просмотр логов
```bash
# API сервер
pm2 logs ai-admin-api

# Воркеры
pm2 logs ai-admin-worker

# Venom-bot
pm2 logs venom
```

### Проверка состояния
- Health check: http://localhost:3000/health
- Circuit breakers: http://localhost:3000/api/circuit-breakers
- Queue metrics: http://localhost:3000/api/metrics

## Частые проблемы

### WhatsApp не подключается
1. Проверьте статус Venom-bot
2. Переподключите телефон через QR-код
3. Проверьте интернет-соединение

### Тесты падают с timeout
1. Увеличьте задержки между сообщениями
2. Проверьте нагрузку на YClients API
3. Убедитесь, что AI сервис отвечает

### Не удаляются тестовые данные
1. Проверьте права доступа к API
2. Убедитесь в правильности тестового номера
3. Проверьте подключение к БД

## Рекомендации

1. **Запускайте тесты в нерабочее время** - чтобы не мешать реальным клиентам
2. **Используйте отдельный тестовый номер** - для изоляции от продакшена
3. **Мониторьте нагрузку** - следите за rate limits YClients API
4. **Делайте паузы между тестами** - дайте системе обработать запросы
5. **Всегда очищайте данные** - запускайте cleanup после тестов