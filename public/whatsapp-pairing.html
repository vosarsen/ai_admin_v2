<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ - AI Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .company-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .method-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .method-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .method-btn.active {
            background: #f0f7ff;
            border-color: #667eea;
            color: #667eea;
        }

        .method-btn:hover {
            border-color: #667eea;
        }

        .method-content {
            display: none;
        }

        .method-content.active {
            display: block;
        }

        /* QR Code Section */
        .qr-container {
            text-align: center;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        #qrcode {
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            display: inline-block;
        }

        .qr-instructions {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 10px;
            color: #856404;
        }

        /* Pairing Code Section */
        .pairing-form {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pairing-code-display {
            display: none;
            text-align: center;
            padding: 30px;
            background: #f0f7ff;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .pairing-code-display.active {
            display: block;
        }

        .code-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 5px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .instructions {
            background: #e7f5ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .instructions h3 {
            color: #0c63e4;
            margin-bottom: 15px;
        }

        .instructions ol {
            text-align: left;
            padding-left: 20px;
            color: #495057;
        }

        .instructions li {
            margin-bottom: 10px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .countdown {
            display: inline-block;
            padding: 5px 10px;
            background: #ffc107;
            color: white;
            border-radius: 5px;
            font-weight: bold;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ WhatsApp –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h1>
            <div class="company-info" id="companyInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="content">
            <!-- Method Selector -->
            <div class="method-selector">
                <div class="method-btn active" onclick="selectMethod('qr')">
                    üì± QR –ö–æ–¥
                </div>
                <div class="method-btn" onclick="selectMethod('pairing')">
                    üî¢ –ö–æ–¥ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è
                </div>
            </div>

            <!-- QR Code Method -->
            <div id="qr-method" class="method-content active">
                <div class="qr-container">
                    <div id="qrcode">
                        <div class="loading"></div>
                        <p style="margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ QR –∫–æ–¥–∞...</p>
                    </div>
                </div>

                <div class="instructions">
                    <h3>–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å:</h3>
                    <ol>
                        <li>–û—Ç–∫—Ä–æ–π—Ç–µ WhatsApp –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ</li>
                        <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –°–≤—è–∑–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</li>
                        <li>–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–≤—è–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"</li>
                        <li>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥</li>
                    </ol>
                </div>
            </div>

            <!-- Pairing Code Method -->
            <div id="pairing-method" class="method-content">
                <div class="pairing-form" id="pairingForm">
                    <div class="form-group">
                        <label for="phoneNumber">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ WhatsApp:</label>
                        <input
                            type="tel"
                            id="phoneNumber"
                            placeholder="79001234567"
                            pattern="[0-9]{11}"
                            required
                        >
                    </div>
                    <button class="btn" onclick="requestPairingCode()">
                        –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è
                    </button>
                </div>

                <div class="pairing-code-display" id="pairingCodeDisplay">
                    <h3>–í–∞—à –∫–æ–¥ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è:</h3>
                    <div class="code-value" id="codeValue">----</div>
                    <p>–í–≤–µ–¥–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ WhatsApp</p>
                    <span class="countdown" id="countdown">60</span>
                </div>

                <div class="instructions">
                    <h3>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–¥:</h3>
                    <ol>
                        <li>–û—Ç–∫—Ä–æ–π—Ç–µ WhatsApp –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ</li>
                        <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –°–≤—è–∑–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</li>
                        <li>–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–≤—è–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"</li>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ "–ü—Ä–∏–≤—è–∑–∞—Ç—å —Å –ø–æ–º–æ—â—å—é –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"</li>
                        <li>–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–æ–¥</li>
                    </ol>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        // Get company ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const companyId = urlParams.get('company') || '962302';
        const apiUrl = window.location.origin;

        let qrCodeInstance = null;
        let statusCheckInterval = null;
        let countdownInterval = null;
        let currentMethod = 'qr';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCompanyInfo();
            checkConnectionStatus();
            if (currentMethod === 'qr') {
                loadQRCode();
            }
        });

        // Load company info
        async function loadCompanyInfo() {
            try {
                const response = await fetch(`${apiUrl}/api/companies/${companyId}`);
                const data = await response.json();

                document.getElementById('companyInfo').innerHTML = `
                    <strong>${data.title || '–ö–æ–º–ø–∞–Ω–∏—è ' + companyId}</strong><br>
                    ID: ${companyId}
                `;
            } catch (error) {
                document.getElementById('companyInfo').textContent = `–ö–æ–º–ø–∞–Ω–∏—è ${companyId}`;
            }
        }

        // Select connection method
        function selectMethod(method) {
            currentMethod = method;

            // Update buttons
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.method-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${method}-method`).classList.add('active');

            // Load content for selected method
            if (method === 'qr') {
                loadQRCode();
            }
        }

        // Load QR Code
        async function loadQRCode() {
            try {
                const response = await fetch(`${apiUrl}/webhook/whatsapp/baileys/qr/${companyId}`);
                const data = await response.json();

                if (data.qr) {
                    // Clear existing QR code
                    document.getElementById('qrcode').innerHTML = '';

                    // Generate new QR code
                    qrCodeInstance = new QRCode(document.getElementById('qrcode'), {
                        text: data.qr,
                        width: 256,
                        height: 256,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    // Check for rate limit warning
                    if (data.qrAttempts >= 3) {
                        showStatus('warning', `‚ö†Ô∏è –ú–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫ QR (${data.qrAttempts}). –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–¥ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è.`);
                    }

                    // Start status checking
                    startStatusCheck();
                } else if (data.error) {
                    if (data.error.includes('linking')) {
                        showStatus('error', '‚ùå –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–¥ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ 30-60 –º–∏–Ω—É—Ç.');
                        selectMethod('pairing');
                    } else {
                        showStatus('error', `–û—à–∏–±–∫–∞: ${data.error}`);
                    }
                }
            } catch (error) {
                showStatus('error', `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ QR: ${error.message}`);
            }
        }

        // Request Pairing Code
        async function requestPairingCode() {
            const phoneNumber = document.getElementById('phoneNumber').value;

            if (!phoneNumber || phoneNumber.length < 10) {
                showStatus('error', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                return;
            }

            // Disable form
            document.getElementById('pairingForm').style.display = 'none';
            showStatus('info', '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–¥ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è...');

            try {
                const response = await fetch(`${apiUrl}/api/whatsapp/sessions/${companyId}/pairing-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber })
                });

                const data = await response.json();

                if (data.success && data.pairingCode) {
                    // Show pairing code
                    document.getElementById('codeValue').textContent = data.pairingCode;
                    document.getElementById('pairingCodeDisplay').classList.add('active');

                    // Start countdown
                    startCountdown(60);

                    // Start status checking
                    startStatusCheck();

                    showStatus('success', `‚úÖ –ö–æ–¥ –ø–æ–ª—É—á–µ–Ω! –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –≤ WhatsApp –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ +${phoneNumber}`);
                } else {
                    throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥');
                }
            } catch (error) {
                showStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);

                // Show form again
                document.getElementById('pairingForm').style.display = 'block';

                // Check for rate limit
                if (error.message.includes('rate')) {
                    showStatus('warning', '‚è≥ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 –º–∏–Ω—É—Ç.');
                }
            }
        }

        // Start countdown timer
        function startCountdown(seconds) {
            let remaining = seconds;

            countdownInterval = setInterval(() => {
                remaining--;
                document.getElementById('countdown').textContent = remaining;

                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('pairingCodeDisplay').classList.remove('active');
                    document.getElementById('pairingForm').style.display = 'block';
                    showStatus('warning', '‚è±Ô∏è –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥.');
                }
            }, 1000);
        }

        // Check connection status
        async function checkConnectionStatus() {
            try {
                const response = await fetch(`${apiUrl}/webhook/whatsapp/baileys/status/${companyId}`);
                const data = await response.json();

                if (data.connected) {
                    showStatus('success', '‚úÖ WhatsApp —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');

                    // Clear intervals
                    if (statusCheckInterval) clearInterval(statusCheckInterval);
                    if (countdownInterval) clearInterval(countdownInterval);

                    // Show success state
                    setTimeout(() => {
                        window.location.href = `/dashboard?company=${companyId}`;
                    }, 3000);
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
        }

        // Start periodic status checking
        function startStatusCheck() {
            if (statusCheckInterval) clearInterval(statusCheckInterval);

            statusCheckInterval = setInterval(() => {
                checkConnectionStatus();
            }, 2000);
        }

        // Show status message
        function showStatus(type, message) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (statusCheckInterval) clearInterval(statusCheckInterval);
            if (countdownInterval) clearInterval(countdownInterval);
        });
    </script>
</body>
</html>