# Webhook Notifications System

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WhatsApp —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏, –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–ª–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–µ–π, —Å–¥–µ–ª–∞–Ω–Ω—ã—Ö –≤–Ω–µ –±–æ—Ç–∞ (—á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É, –æ—Ñ–ª–∞–π–Ω –≤ —Å–∞–ª–æ–Ω–µ).

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å** - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞–ø–∏—Å–∏
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏** - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–º, —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
- **–û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è

### 2. –£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –¥–ª—è –∑–∞–ø–∏—Å–µ–π, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –±–æ—Ç–∞
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ–¥–∞–≤–Ω—é—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –¥–∞–∂–µ –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏ –≤ –∫–µ—à–µ

### 3. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–∏–¥–∫–∞—Ö
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞—á–µ—Ä–∫–Ω—É—Ç—É—é —Å—Ç–∞—Ä—É—é —Ü–µ–Ω—É –∏ –Ω–æ–≤—É—é —Ü–µ–Ω—É
- –§–æ—Ä–º–∞—Ç: `üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ~2000 —Ä—É–±~ 1000 —Ä—É–± (—Å–∫–∏–¥–∫–∞ 50%)`

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### Endpoint
```
POST /webhook/yclients
```

### –§–æ—Ä–º–∞—Ç webhook –æ—Ç YClients
```json
{
  "company_id": 962302,
  "resource": "record",
  "status": "create|update|delete",
  "resource_id": 1213336367,
  "data": {
    "id": 1213336367,
    "datetime": "2025-08-21T16:00:00+03:00",
    "client": {
      "name": "–ê—Ä—Å–µ–Ω",
      "phone": "+79686484488"
    },
    "services": [{
      "title": "–ú–£–ñ–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê",
      "cost": 1000,
      "first_cost": 2000,
      "discount": 50
    }],
    "staff": {
      "name": "–ë–∞—Ä–∏"
    }
  }
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π

#### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (record.created)
```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ–∑–¥–∞–Ω–∞ –ª–∏ –∑–∞–ø–∏—Å—å –±–æ—Ç–æ–º
if (comment.includes('AI Admin') || comment.includes('WhatsApp')) {
  return; // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚úÖ *–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã!*

üìÖ 21 –∞–≤–≥—É—Å—Ç–∞ –≤ 14:30
üíá –ú–£–ñ–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê
üë§ –ú–∞—Å—Ç–µ—Ä: –ë–∞—Ä–∏
üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ~2000 —Ä—É–±~ 1000 —Ä—É–± (—Å–∫–∏–¥–∫–∞ 50%)
üìç –ú–∞–ª–∞—Ö–æ–≤–∫–∞, –Æ–∂–Ω–∞—è —É–ª–∏—Ü–∞, 38

–î–ª—è –æ—Ç–º–µ–Ω—ã –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –∑–¥–µ—Å—å üëá
```

#### 2. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (record.updated)
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–∞–∂–µ –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏ –≤ –∫–µ—à–µ
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (–≤—Ä–µ–º—è, –º–∞—Å—Ç–µ—Ä, —É—Å–ª—É–≥–∞)
- –í–∫–ª—é—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∫–∏–¥–∫–µ

#### 3. –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ (record.deleted)
- –ò—â–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –∫–µ—à–µ, –µ—Å–ª–∏ –Ω–µ—Ç –≤ webhook –¥–∞–Ω–Ω—ã—Ö
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã
1. **webhook_events** - –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö webhook —Å–æ–±—ã—Ç–∏–π
2. **booking_notifications** - –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
3. **appointments_cache** - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
   - `created_by_bot` - —Ñ–ª–∞–≥ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
   - `client_phone` - —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç:
scripts/database/create-all-webhook-tables.sql
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ YClients

### –í–∞—Ä–∏–∞–Ω—Ç 1: YClients Marketplace (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ developers.yclients.com
2. –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook URL: `https://46.149.70.219/webhook/yclients`
4. –í—ã–±—Ä–∞—Ç—å —Å–æ–±—ã—Ç–∏—è: record.created, record.updated, record.deleted

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫—É YClients
1. –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è webhooks
2. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å URL –∏ —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π
3. –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Test endpoint
```bash
# –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ —Å–æ —Å–∫–∏–¥–∫–æ–π
curl -X POST "https://46.149.70.219/webhook/yclients/test" \
  -k \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "79686484488",
    "eventType": "record.created",
    "service": "–ú–£–ñ–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê",
    "master": "–ë–∞—Ä–∏",
    "datetime": "2025-08-21 14:30",
    "cost": 1000,
    "clientName": "–ê—Ä—Å–µ–Ω"
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
pm2 logs ai-admin-api | grep webhook

# –ò–ª–∏ —á–µ—Ä–µ–∑ MCP
@logs logs_search service:ai-admin-api pattern:webhook
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 24 —á–∞—Å–∞
```sql
-- Webhook —Å–æ–±—ã—Ç–∏—è
SELECT * FROM webhook_stats_24h;

-- –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
SELECT * FROM notification_stats_24h;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```sql
SELECT * FROM booking_notifications 
ORDER BY created_at DESC 
LIMIT 10;
```

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

1. **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** (`finances_operation`) –ø–æ–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è
2. **Foreign key constraint** –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –∫—ç—à –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
3. **–î–≤–∞ webhook endpoint'–∞** - —Å—Ç–∞—Ä—ã–π –≤ `yclients-integration.js` –∏ –Ω–æ–≤—ã–π –≤ `webhooks/yclients.js` (–æ–±–∞ —Ä–∞–±–æ—Ç–∞—é—Ç)

## Troubleshooting

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ YClients
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ webhook —Å–æ–±—ã—Ç–∏–π
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ –ù–ï —á–µ—Ä–µ–∑ –±–æ—Ç–∞
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞

### –û—à–∏–±–∫–∞ "Unknown event type"
- –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–µ–π
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç webhook (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å resource/status)

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É webhook_events –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ event_id
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ YClients –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ webhook

## –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
2. [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –Ω–µ—É–¥–∞—á–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫
3. [ ] –î–æ–±–∞–≤–∏—Ç—å webhook –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤–∏–∑–∏—Ç–∞ (–ø—Ä–∏—à–µ–ª/–Ω–µ –ø—Ä–∏—à–µ–ª)
4. [ ] –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
5. [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π