# Webhook –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –§–∏–Ω–∞–ª—å–Ω–∞—è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WhatsApp —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏, –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–ª–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–µ–π —á–µ—Ä–µ–∑ YClients (–Ω–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞). –≠—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –≤—Å—é –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –≤ WhatsApp.

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π
- **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏** (`record.created`) - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏** (`record.updated`) - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- **–û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏** (`record.deleted`) - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ

### 2. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ YClients
YClients –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
```json
{
  "resource": "record",
  "status": "create/update/delete",
  "data": { ... }
}
```

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ–≥–æ –≤ –Ω–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.

### 3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–∏–¥–æ–∫
–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–∫–∏–¥–∫–∏ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:
- –ó–∞—á–µ—Ä–∫–Ω—É—Ç–∞—è —Å—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞
- –ù–æ–≤–∞—è —Ü–µ–Ω–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π
- –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏

–ü—Ä–∏–º–µ—Ä: `üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ~2000 —Ä—É–±~ 1000 —Ä—É–± (—Å–∫–∏–¥–∫–∞ 50%)`

### 4. –£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ "AI Admin", "WhatsApp"
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–∞–≤–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –±–æ—Ç–µ (5 –º–∏–Ω—É—Ç)
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ event_id

## –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –î–≤–∞ webhook endpoint'–∞
**–û–ø–∏—Å–∞–Ω–∏–µ**: –°—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ –¥–≤–∞ endpoint'–∞ –¥–ª—è webhook:
- `/webhook/yclients` (—Å—Ç–∞—Ä—ã–π, –≤ yclients-integration.js)
- `/webhook/yclients/events` (–Ω–æ–≤—ã–π, –≤ webhooks/yclients.js)

**–†–µ—à–µ–Ω–∏–µ**: –û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ä—ã–π endpoint –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ YClients.

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å
**–û–ø–∏—Å–∞–Ω–∏–µ**: –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ —Å–∏—Å—Ç–µ–º–∞ –∏—Å–∫–∞–ª–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é –≤ –∫–µ—à–µ, –Ω–æ –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª–∞ –µ—ë –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π.

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–∞–∂–µ –±–µ–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –≤ –∫–µ—à–µ.

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∫–∏–¥–∫–∞—Ö
**–û–ø–∏—Å–∞–Ω–∏–µ**: –í —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã—Ö —Å–∫–∏–¥–∫–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–∏–¥–æ–∫ —Å –∑–∞—á–µ—Ä–∫–Ω—É—Ç–æ–π —Å—Ç–∞—Ä–æ–π —Ü–µ–Ω–æ–π.

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã
1. **webhook_events** - –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö webhook —Å–æ–±—ã—Ç–∏–π
2. **booking_notifications** - –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
3. **appointments_cache** - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞

### SQL —Å–∫—Ä–∏–ø—Ç
–ü–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü: `scripts/database/create-all-webhook-tables.sql`

## –ü—Ä–∏–º–µ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å —Å–æ —Å–∫–∏–¥–∫–æ–π
```
‚úÖ *–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã!*

üìÖ 21 –∞–≤–≥—É—Å—Ç–∞ –≤ 14:30
üíá –ú–£–ñ–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê
üë§ –ú–∞—Å—Ç–µ—Ä: –ë–∞—Ä–∏
üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ~2000 —Ä—É–±~ 1000 —Ä—É–± (—Å–∫–∏–¥–∫–∞ 50%)
üìç –ú–∞–ª–∞—Ö–æ–≤–∫–∞, –Æ–∂–Ω–∞—è —É–ª–∏—Ü–∞, 38

–î–ª—è –æ—Ç–º–µ–Ω—ã –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –∑–¥–µ—Å—å üëá
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
```
üìù *–í–∞—à–∞ –∑–∞–ø–∏—Å—å –∏–∑–º–µ–Ω–µ–Ω–∞*

üìÖ 21 –∞–≤–≥—É—Å—Ç–∞ –≤ 16:00
üíá –ú–£–ñ–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê
üë§ –ú–∞—Å—Ç–µ—Ä: –ë–∞—Ä–∏
üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 2000 —Ä—É–±
üìç –ú–∞–ª–∞—Ö–æ–≤–∫–∞, –Æ–∂–Ω–∞—è —É–ª–∏—Ü–∞, 38

–ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã - –ø–∏—à–∏—Ç–µ!
```

### –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏
```
‚ùå *–í–∞—à–∞ –∑–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞*

–ë—ã–ª–∞ –Ω–∞: 21 –∞–≤–≥—É—Å—Ç–∞ –≤ 16:00
–£—Å–ª—É–≥–∞: –ú–£–ñ–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê

–•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è? –ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ!
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### YClients Webhook URL
```
https://46.149.70.219/webhook/yclients
```

### Environment Variables
```bash
YCLIENTS_WEBHOOK_SECRET=your_secret  # –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ —Å–æ —Å–∫–∏–¥–∫–æ–π
```bash
curl -X POST "https://46.149.70.219/webhook/yclients/test" \
  -k \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "79686484488",
    "eventType": "record.created",
    "service": "–ú–£–ñ–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê",
    "master": "–ë–∞—Ä–∏",
    "datetime": "2025-08-21 14:30",
    "cost": 1000,
    "first_cost": 2000,
    "discount": 50,
    "clientName": "–ê—Ä—Å–µ–Ω"
  }'
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
pm2 logs ai-admin-api | grep webhook

# –ß–µ—Ä–µ–∑ SSH
ssh root@46.149.70.219 "pm2 logs ai-admin-api --lines 50 | grep webhook"
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 24 —á–∞—Å–∞
SELECT * FROM webhook_stats_24h;
SELECT * FROM notification_stats_24h;

-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
SELECT * FROM booking_notifications ORDER BY created_at DESC LIMIT 10;
```

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **Foreign key constraint** - –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ appointments_cache –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–∞—Ç—å –æ—à–∏–±–∫–∞, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ —Ä–∞–≤–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è)

2. **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** - webhook —Ç–∏–ø–∞ `finances_operation` –ø–æ–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è

## –ò—Ç–æ–≥–∏

–°–∏—Å—Ç–µ–º–∞ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞. –û–Ω–∞ —É—Å–ø–µ—à–Ω–æ:
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç webhook –æ—Ç YClients
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WhatsApp —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∫–∏–¥–∫–∞—Ö
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π (—Å–æ–∑–¥–∞–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ, –æ—Ç–º–µ–Ω–∞)
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π