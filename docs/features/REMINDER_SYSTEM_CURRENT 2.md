# –°–∏—Å—Ç–µ–º–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π AI Admin v2

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤ production
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 23 —Å–µ–Ω—Ç—è–±—Ä—è 2025
**–°–µ—Ä–≤–∏—Å**: booking-monitor

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –∑–∞–ø–∏—Å—è—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å `booking-monitor`, –∫–æ—Ç–æ—Ä—ã–π:
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –≤ YClients
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ –¥–µ–Ω—å –∏ –∑–∞ 2 —á–∞—Å–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–∫–ª–æ–Ω–µ–Ω–∏—è —É—Å–ª—É–≥ –∏ –∏–º—ë–Ω –º–∞—Å—Ç–µ—Ä–æ–≤
- –í—ã–±–∏—Ä–∞–µ—Ç –∏–∑ 40 —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
YClients API
     ‚Üì
booking-monitor (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
     ‚Üì
–ê–Ω–∞–ª–∏–∑ –∑–∞–ø–∏—Å–µ–π –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –∏ —Å–µ–≥–æ–¥–Ω—è
     ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∏ —É—Å–ª–æ–≤–∏–π
     ‚îú‚îÄ‚îÄ 19:00-21:00 –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è ‚Üí –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ –¥–µ–Ω—å
     ‚îî‚îÄ‚îÄ –ó–∞ 2 —á–∞—Å–∞ –¥–æ –∑–∞–ø–∏—Å–∏ ‚Üí –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 2 —á–∞—Å–∞
           ‚Üì
     –í—ã–±–æ—Ä —Å–ª—É—á–∞–π–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞
           ‚Üì
     –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–π
           ‚Üì
     WhatsApp (Baileys)
           ‚Üì
     booking_notifications (–ë–î)
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (—á–∞—Å—Ç—å booking-monitor)
BOOKING_MONITOR_ENABLED=true

# –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø–∏—Å–µ–π (–º—Å)
BOOKING_MONITOR_INTERVAL=60000  # 1 –º–∏–Ω—É—Ç–∞

# WhatsApp —Å–µ—Ä–≤–∏—Å
BAILEYS_SERVICE_URL=http://localhost:3003
```

### PM2 –ø—Ä–æ—Ü–µ—Å—Å
```javascript
{
  name: 'ai-admin-booking-monitor',
  script: './src/workers/booking-monitor-worker.js',
  instances: 1,
  exec_mode: 'fork'
}
```

## üìù –¢–∏–ø—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

### 1. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ –¥–µ–Ω—å (day_before)

**–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è**:
- –í–µ—á–µ—Ä–æ–º –Ω–∞–∫–∞–Ω—É–Ω–µ –¥–Ω—è –∑–∞–ø–∏—Å–∏
- –°–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É 19:00 –∏ 21:00
- –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ –∑–∞–ø–∏—Å–∏ –±–æ–ª—å—à–µ 24 —á–∞—Å–æ–≤

**–ü—Ä–∏–º–µ—Ä—ã —à–∞–±–ª–æ–Ω–æ–≤**:
```
–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä, {name}! –ù–∞–ø–æ–º–∏–Ω–∞–µ–º –æ –∑–∞–ø–∏—Å–∏ –Ω–∞ {service} –∑–∞–≤—Ç—Ä–∞ –≤ {time} ‚ú®
–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, {name}! –ó–∞–≤—Ç—Ä–∞ –≤ {time} –∂–¥—ë–º –≤–∞—Å –Ω–∞ {service} üåü
{name}, –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í—Å—ë –≤ —Å–∏–ª–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞? {service} –≤ {time} ü§ù
```

### 2. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 2 —á–∞—Å–∞ (reminder_2hours)

**–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è**:
- –†–æ–≤–Ω–æ –∑–∞ 2 —á–∞—Å–∞ –¥–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∏
- –¢–æ–ª—å–∫–æ –≤ –¥–µ–Ω—å –∑–∞–ø–∏—Å–∏
- –ë–æ–ª–µ–µ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π —Ç–æ–Ω

**–ü—Ä–∏–º–µ—Ä—ã —à–∞–±–ª–æ–Ω–æ–≤**:
```
–ù–∞–ø–æ–º–∏–Ω–∞–µ–º: —Å–µ–≥–æ–¥–Ω—è –≤ {time} —É –≤–∞—Å –∑–∞–ø–∏—Å—å –Ω–∞ {service}.
–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {name}! –ß–µ—Ä–µ–∑ 2 —á–∞—Å–∞ {staff} –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –í–∞—Å –Ω–∞ {service}.
–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –û—Å—Ç–∞–ª–æ—Å—å 2 —á–∞—Å–∞ –¥–æ –∑–∞–ø–∏—Å–∏ –Ω–∞ {service} –≤ {time}.
```

## üî§ –°–∏—Å—Ç–µ–º–∞ —Å–∫–ª–æ–Ω–µ–Ω–∏–π

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫–ª–æ–Ω–µ–Ω–∏–π –≤ –ë–î

–ö–∞–∂–¥–∞—è —É—Å–ª—É–≥–∞ –∏ –º–∞—Å—Ç–µ—Ä –∏–º–µ—é—Ç –ø–æ–ª–µ `declensions` –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:

```json
{
  "nominative": "–º—É–∂—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞",        // —á—Ç–æ?
  "genitive": "–º—É–∂—Å–∫–æ–π —Å—Ç—Ä–∏–∂–∫–∏",          // —á–µ–≥–æ?
  "dative": "–º—É–∂—Å–∫–æ–π —Å—Ç—Ä–∏–∂–∫–µ",            // —á–µ–º—É?
  "accusative": "–º—É–∂—Å–∫—É—é —Å—Ç—Ä–∏–∂–∫—É",        // —á—Ç–æ?
  "instrumental": "–º—É–∂—Å–∫–æ–π —Å—Ç—Ä–∏–∂–∫–æ–π",     // —á–µ–º?
  "prepositional": "–º—É–∂—Å–∫–æ–π —Å—Ç—Ä–∏–∂–∫–µ",     // –æ —á—ë–º?
  "prepositional_na": "–º—É–∂—Å–∫—É—é —Å—Ç—Ä–∏–∂–∫—É",  // –Ω–∞ —á—Ç–æ?
  "prepositional_u": "—É –°–µ—Ä–≥–µ—è"           // —É –∫–æ–≥–æ? (–¥–ª—è –º–∞—Å—Ç–µ—Ä–æ–≤)
}
```

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–π

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –Ω—É–∂–Ω—ã–π –ø–∞–¥–µ–∂:

| –ö–æ–Ω—Ç–µ–∫—Å—Ç | –ü–∞–¥–µ–∂ | –ü—Ä–∏–º–µ—Ä |
|----------|-------|--------|
| –Ω–∞ {service} | prepositional_na | –Ω–∞ –º—É–∂—Å–∫—É—é —Å—Ç—Ä–∏–∂–∫—É |
| –ø—Ä–æ {service} | accusative | –ø—Ä–æ –º—É–∂—Å–∫—É—é —Å—Ç—Ä–∏–∂–∫—É |
| –¥–æ {service} | genitive | –¥–æ –º—É–∂—Å–∫–æ–π —Å—Ç—Ä–∏–∂–∫–∏ |
| —É {staff} | prepositional_u | —É –°–µ—Ä–≥–µ—è |
| –ú–∞—Å—Ç–µ—Ä {staff} | nominative | –º–∞—Å—Ç–µ—Ä –°–µ—Ä–≥–µ–π |

## üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ booking_notifications

```sql
CREATE TABLE booking_notifications (
  id UUID PRIMARY KEY,
  yclients_record_id TEXT NOT NULL,
  phone TEXT NOT NULL,
  notification_type TEXT NOT NULL,  -- 'reminder_day_before', 'reminder_2hours'
  message TEXT,                      -- –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  sent_at TIMESTAMP NOT NULL,
  company_id INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

```javascript
// –ü–æ–ª—É—á–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
const { data: sentReminders } = await supabase
  .from('booking_notifications')
  .select('notification_type, sent_at')
  .eq('yclients_record_id', recordId)
  .in('notification_type', ['reminder_day_before', 'reminder_2hours'])
  .gte('sent_at', yesterday);
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
# –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
pm2 status ai-admin-booking-monitor

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
pm2 logs ai-admin-booking-monitor --lines 100

# –¢–æ–ª—å–∫–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
pm2 logs ai-admin-booking-monitor | grep reminder
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î
```sql
-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
SELECT
  notification_type,
  phone,
  sent_at,
  LEFT(message, 100) as message_preview
FROM booking_notifications
WHERE notification_type LIKE 'reminder%'
ORDER BY sent_at DESC
LIMIT 20;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º
SELECT
  DATE(sent_at) as date,
  notification_type,
  COUNT(*) as count
FROM booking_notifications
WHERE notification_type LIKE 'reminder%'
GROUP BY DATE(sent_at), notification_type
ORDER BY date DESC;
```

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å booking-monitor**:
   ```bash
   pm2 status ai-admin-booking-monitor
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WhatsApp**:
   ```bash
   pm2 logs ai-admin-booking-monitor | grep -E "(ECONNREFUSED|Circuit)"
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Baileys**:
   ```bash
   grep BAILEYS_SERVICE_URL /opt/ai-admin/.env
   ```

4. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å**:
   ```bash
   pm2 restart ai-admin-booking-monitor
   ```

### –î—É–±–ª–∏–∫–∞—Ç—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑:
1. –ü—Ä–æ–≤–µ—Ä–∫—É `booking_notifications` –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
2. –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –≤—Ä–µ–º–µ–Ω–∏ (–≤–µ—á–µ—Ä –¥–ª—è day_before, 2 —á–∞—Å–∞ –¥–ª—è reminder_2hours)

–ï—Å–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è:
```sql
-- –ù–∞–π—Ç–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã
SELECT
  yclients_record_id,
  notification_type,
  COUNT(*) as count,
  MIN(sent_at) as first_sent,
  MAX(sent_at) as last_sent
FROM booking_notifications
WHERE sent_at > NOW() - INTERVAL '1 day'
GROUP BY yclients_record_id, notification_type
HAVING COUNT(*) > 1;
```

## üìö –§–∞–π–ª—ã —Å–∏—Å—Ç–µ–º—ã

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `src/services/booking-monitor/index.js` | –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ |
| `src/services/reminder/templates.js` | 40 —à–∞–±–ª–æ–Ω–æ–≤ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π |
| `src/workers/booking-monitor-worker.js` | PM2 –≤–æ—Ä–∫–µ—Ä |
| `src/integrations/whatsapp/client.js` | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Baileys |

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã

1. **–ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å** - –≤—Å—ë –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ, –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
2. **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞** - —Å–∫–ª–æ–Ω–µ–Ω–∏—è –∏–∑ –ë–î
3. **–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ** - 40 —à–∞–±–ª–æ–Ω–æ–≤, –Ω–µ –Ω–∞–¥–æ–µ–¥–∞–µ—Ç
4. **–ò—Å—Ç–æ—Ä–∏—è** - –≤—Å–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
5. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
6. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Baileys –∏–∑ –∫–æ—Ä–æ–±–∫–∏

## üö´ –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å

1. **–ù–ï –∑–∞–ø—É—Å–∫–∞—Ç—å** —Å—Ç–∞—Ä—ã–µ reminder-worker –∏–ª–∏ reminder-worker-v2
2. **–ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å** –Ω–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
3. **–ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** BullMQ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
4. **–ù–ï –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å** message-worker –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

–í—Å—è –ª–æ–≥–∏–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –≤ booking-monitor!

---

üìå **–í–∞–∂–Ω–æ**: –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ä–∞–±–æ—á—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ—Å–ª–µ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏ 23.09.2025. –í—Å–µ —Å—Ç–∞—Ä—ã–µ —Å–∏—Å—Ç–µ–º—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π —É–¥–∞–ª–µ–Ω—ã.