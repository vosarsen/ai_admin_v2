# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ —É—Å–ª—É–≥

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   User Message  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         SmartServiceMatcher              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 1. Query Preprocessor              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Ç–∞            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è                   ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ               ‚ñº                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 2. Query Expander                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - –°–∏–Ω–æ–Ω–∏–º—ã                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - –ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—è                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è               ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ               ‚ñº                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 3. Multi-Strategy Searcher         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Pattern Matching              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Fuzzy Search                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Semantic Search (future)      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ               ‚ñº                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 4. Scoring Engine                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Base Score                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Context Boost                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - History Boost                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - ML Predictions (future)       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ               ‚ñº                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ 5. Result Processor                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Deduplication                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Ranking                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    - Grouping                      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ Ranked Services ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üì¶ –ú–æ–¥—É–ª–∏ –∏ –∏—Ö –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å

### 1. Query Preprocessor
```javascript
class QueryPreprocessor {
  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∏ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
   * @param {string} query - –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @returns {ProcessedQuery}
   */
  process(query) {
    return {
      original: query,
      normalized: this.normalize(query),      // Lowercase, trim, etc
      tokens: this.tokenize(query),           // ["–¥–µ—Ç—Å–∫–∞—è", "—Å—Ç—Ä–∏–∂–∫–∞"]
      intent: this.detectIntent(query),       // "price_check" | "book" | "info"
      entities: this.extractEntities(query),  // {service: "—Å—Ç—Ä–∏–∂–∫–∞", age: "–¥–µ—Ç—Å–∫–∞—è"}
      language: this.detectLanguage(query)    // "ru" | "en"
    };
  }
  
  normalize(query) {
    return query
      .toLowerCase()
      .replace(/[^\w–∞-—è—ë\s]/gi, ' ')  // –£–±–∏—Ä–∞–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã
      .replace(/\s+/g, ' ')            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–±–µ–ª—ã
      .trim();
  }
  
  tokenize(query) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä –∏–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫—É natural
    return query.split(/\s+/).filter(t => t.length > 2);
  }
  
  detectIntent(query) {
    const intents = {
      price: ['—Å–∫–æ–ª—å–∫–æ', '—Ü–µ–Ω–∞', '—Å—Ç–æ–∏—Ç', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', '–ø—Ä–∞–π—Å'],
      book: ['–∑–∞–ø–∏—Å–∞—Ç—å', '–∑–∞–ø–∏—Å—å', '—Ö–æ—á—É', '–º–æ–∂–Ω–æ'],
      info: ['–∫–∞–∫–∏–µ', '–µ—Å—Ç—å', '–¥–æ—Å—Ç—É–ø–Ω–æ', '—Ä–∞–±–æ—Ç–∞–µ—Ç']
    };
    
    for (const [intent, keywords] of Object.entries(intents)) {
      if (keywords.some(k => query.includes(k))) {
        return intent;
      }
    }
    return 'unknown';
  }
}
```

### 2. Query Expander
```javascript
class QueryExpander {
  constructor() {
    this.synonyms = require('../config/synonyms.json');
    this.morphology = new MorphologyAnalyzer();
  }
  
  /**
   * –†–∞—Å—à–∏—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏ –∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏
   * @param {ProcessedQuery} processed
   * @returns {ExpandedQuery}
   */
  expand(processed) {
    const expanded = new Set(processed.tokens);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω–æ–Ω–∏–º—ã
    for (const token of processed.tokens) {
      const syns = this.findSynonyms(token);
      syns.forEach(s => expanded.add(s));
      
      // –î–æ–±–∞–≤–ª—è–µ–º –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
      const forms = this.morphology.getAllForms(token);
      forms.forEach(f => expanded.add(f));
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ—Å—Ç–∞–≤–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã
    const compounds = this.expandCompounds(processed.normalized);
    compounds.forEach(c => expanded.add(c));
    
    return {
      ...processed,
      expandedTokens: Array.from(expanded),
      searchQueries: this.generateSearchQueries(expanded)
    };
  }
  
  findSynonyms(word) {
    const synonyms = [];
    for (const [key, values] of Object.entries(this.synonyms)) {
      if (key === word || values.includes(word)) {
        synonyms.push(key, ...values);
      }
    }
    return synonyms;
  }
  
  expandCompounds(query) {
    const compounds = {
      '–¥–µ—Ç—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞': ['–¥–µ—Ç—Å–∫–∞—è', '—Å—Ç—Ä–∏–∂–∫–∞', '—Ä–µ–±–µ–Ω–æ–∫', '–¥–µ—Ç–∏'],
      '–º—É–∂—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞': ['–º—É–∂—Å–∫–∞—è', '—Å—Ç—Ä–∏–∂–∫–∞', '–±–∞—Ä–±–µ—Ä'],
      '–∂–µ–Ω—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞': ['–∂–µ–Ω—Å–∫–∞—è', '—Å—Ç—Ä–∏–∂–∫–∞', '–¥–∞–º—Å–∫–∞—è']
    };
    
    const result = [];
    for (const [compound, parts] of Object.entries(compounds)) {
      if (query.includes(compound)) {
        result.push(...parts);
      }
    }
    return result;
  }
}
```

### 3. Multi-Strategy Searcher
```javascript
class MultiStrategySearcher {
  constructor(services) {
    this.services = services;
    this.buildIndices();
  }
  
  buildIndices() {
    // –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    this.invertedIndex = new Map();
    
    for (const service of this.services) {
      const tokens = this.tokenize(service.title);
      for (const token of tokens) {
        if (!this.invertedIndex.has(token)) {
          this.invertedIndex.set(token, new Set());
        }
        this.invertedIndex.get(token).add(service.id);
      }
    }
    
    // –¢—Ä–∏–≥—Ä–∞–º–º–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è fuzzy search
    this.trigramIndex = this.buildTrigramIndex();
  }
  
  /**
   * –ü–æ–∏—Å–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
   * @param {ExpandedQuery} query
   * @returns {SearchResults}
   */
  search(query) {
    const results = new Map(); // serviceId -> score
    
    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    const exactMatches = this.exactMatch(query);
    exactMatches.forEach(id => results.set(id, 100));
    
    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –ü–æ–∏—Å–∫ –ø–æ —Ç–æ–∫–µ–Ω–∞–º
    const tokenMatches = this.tokenSearch(query);
    tokenMatches.forEach(({id, score}) => {
      const current = results.get(id) || 0;
      results.set(id, Math.max(current, score));
    });
    
    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 3: Fuzzy matching
    const fuzzyMatches = this.fuzzySearch(query);
    fuzzyMatches.forEach(({id, score}) => {
      const current = results.get(id) || 0;
      results.set(id, current + score * 0.5); // –£–º–µ–Ω—å—à–∞–µ–º –≤–µ—Å fuzzy
    });
    
    // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 4: –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    const patternMatches = this.patternSearch(query);
    patternMatches.forEach(({id, score}) => {
      const current = results.get(id) || 0;
      results.set(id, current + score * 0.7);
    });
    
    return this.convertToServices(results);
  }
  
  tokenSearch(query) {
    const results = [];
    const queryTokens = new Set(query.expandedTokens);
    
    for (const service of this.services) {
      const serviceTokens = new Set(this.tokenize(service.title));
      const intersection = new Set([...queryTokens].filter(x => serviceTokens.has(x)));
      
      if (intersection.size > 0) {
        const score = (intersection.size / queryTokens.size) * 80;
        results.push({id: service.id, score});
      }
    }
    
    return results;
  }
}
```

### 4. Scoring Engine
```javascript
class ScoringEngine {
  constructor() {
    this.weights = {
      exact: 100,
      category: 80,
      synonym: 70,
      partial: 50,
      fuzzy: 40,
      history: 35,
      popular: 30,
      context: 25,
      recent: 20,
      priceRange: 15
    };
  }
  
  /**
   * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å–∫–æ—Ä –¥–ª—è —É—Å–ª—É–≥–∏
   * @param {Service} service
   * @param {ExpandedQuery} query
   * @param {Context} context
   * @returns {number} score
   */
  score(service, query, context) {
    let totalScore = 0;
    const factors = [];
    
    // –ë–∞–∑–æ–≤—ã–π —Å–∫–æ—Ä –æ—Ç –ø–æ–∏—Å–∫–∞
    if (service.searchScore) {
      totalScore += service.searchScore;
      factors.push({type: 'search', score: service.searchScore});
    }
    
    // –ë–æ–Ω—É—Å –∑–∞ –∏—Å—Ç–æ—Ä–∏—é –∫–ª–∏–µ–Ω—Ç–∞
    if (context.client?.history) {
      const historyScore = this.scoreByHistory(service, context.client.history);
      totalScore += historyScore;
      if (historyScore > 0) {
        factors.push({type: 'history', score: historyScore});
      }
    }
    
    // –ë–æ–Ω—É—Å –∑–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å
    const popularityScore = this.scoreByPopularity(service);
    if (popularityScore > 0) {
      totalScore += popularityScore;
      factors.push({type: 'popularity', score: popularityScore});
    }
    
    // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –±–æ–Ω—É—Å—ã
    const contextScore = this.scoreByContext(service, context);
    if (contextScore > 0) {
      totalScore += contextScore;
      factors.push({type: 'context', score: contextScore});
    }
    
    // –®—Ç—Ä–∞—Ñ—ã
    const penalties = this.calculatePenalties(service, context);
    totalScore -= penalties;
    
    // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    if (process.env.DEBUG_SCORING) {
      console.log(`Service: ${service.title}`, {
        totalScore,
        factors,
        penalties
      });
    }
    
    return Math.max(0, totalScore);
  }
  
  scoreByHistory(service, history) {
    let score = 0;
    
    // –ß–∞—Å—Ç–æ –∑–∞–∫–∞–∑—ã–≤–∞–µ–º–∞—è —É—Å–ª—É–≥–∞
    const bookingCount = history.filter(h => h.serviceId === service.id).length;
    if (bookingCount > 3) score += this.weights.history;
    if (bookingCount > 5) score += 10; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–Ω—É—Å
    
    // –ù–µ–¥–∞–≤–Ω–æ –∑–∞–∫–∞–∑—ã–≤–∞–ª
    const lastBooking = history.find(h => h.serviceId === service.id);
    if (lastBooking) {
      const daysSince = (Date.now() - lastBooking.date) / (1000 * 60 * 60 * 24);
      if (daysSince < 7) score += this.weights.recent;
    }
    
    return score;
  }
  
  scoreByContext(service, context) {
    let score = 0;
    
    // –í—Ä–µ–º—è —Å—É—Ç–æ–∫
    const hour = new Date().getHours();
    if (hour < 10 && service.duration <= 30) {
      score += 10; // –£—Ç—Ä–æ–º –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é—Ç –±—ã—Å—Ç—Ä—ã–µ —É—Å–ª—É–≥–∏
    }
    
    // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏
    const day = new Date().getDay();
    if ((day === 5 || day === 6) && service.category === 'complex') {
      score += 15; // –í –≤—ã—Ö–æ–¥–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
    }
    
    // –ü–æ–ª –∫–ª–∏–µ–Ω—Ç–∞
    if (context.client?.gender === 'male' && service.title.includes('–º—É–∂—Å–∫')) {
      score += 20;
    }
    
    return score;
  }
  
  calculatePenalties(service, context) {
    let penalty = 0;
    
    // –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—É
    if (context.client?.gender === 'male' && service.title.includes('–∂–µ–Ω—Å–∫')) {
      penalty += 50;
    }
    
    // –°–ª–∏—à–∫–æ–º –¥–æ—Ä–æ–≥–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
    if (context.client?.averageCheck && service.price > context.client.averageCheck * 2) {
      penalty += 20;
    }
    
    return penalty;
  }
}
```

### 5. Feedback Learner
```javascript
class FeedbackLearner {
  constructor(redis) {
    this.redis = redis;
    this.PATTERN_KEY = 'search:patterns';
    this.SUCCESS_KEY = 'search:success';
  }
  
  /**
   * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  async recordChoice(query, shownServices, selectedService, context) {
    const pattern = {
      query: query.normalized,
      tokens: query.tokens,
      selectedId: selectedService?.id,
      shownIds: shownServices.map(s => s.id),
      position: shownServices.findIndex(s => s.id === selectedService?.id),
      timestamp: Date.now(),
      context: {
        clientId: context.client?.id,
        timeOfDay: new Date().getHours(),
        dayOfWeek: new Date().getDay()
      }
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω
    await this.redis.zadd(
      this.PATTERN_KEY,
      Date.now(),
      JSON.stringify(pattern)
    );
    
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω—ã—Ö –≤—ã–±–æ—Ä–æ–≤
    if (selectedService) {
      const key = `${this.SUCCESS_KEY}:${query.normalized}:${selectedService.id}`;
      await this.redis.incr(key);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–µ–ª—å –∫–∞–∂–¥—ã–µ 100 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    const count = await this.redis.zcard(this.PATTERN_KEY);
    if (count % 100 === 0) {
      await this.updateModel();
    }
  }
  
  /**
   * –ü–æ–ª—É—á–∞–µ—Ç boost –¥–ª—è —É—Å–ª—É–≥–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏
   */
  async getBoost(query, serviceId) {
    const key = `${this.SUCCESS_KEY}:${query}:${serviceId}`;
    const count = await this.redis.get(key) || 0;
    
    // –õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è —à–∫–∞–ª–∞, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≤–µ—à–∏–≤–∞—Ç—å
    return Math.min(Math.log(count + 1) * 10, 50);
  }
  
  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –≤–µ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
   */
  async updateModel() {
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    const patterns = await this.redis.zrevrange(
      this.PATTERN_KEY,
      0,
      999,
      'WITHSCORES'
    );
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
    const stats = this.analyzePatterns(patterns);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    await this.updateWeights(stats);
    
    // –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    logger.info('Model updated', stats);
  }
}
```

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏–Ω–æ–Ω–∏–º–æ–≤
```json
{
  "synonyms": {
    "—Å—Ç—Ä–∏–∂–∫–∞": ["–ø–æ–¥—Å—Ç—Ä–∏—á—å—Å—è", "–ø–æ—Å—Ç—Ä–∏—á—å—Å—è", "–ø–æ–¥—Å—Ç—Ä–∏—á—å", "—Å—Ç—Ä–∏—á—å"],
    "–¥–µ—Ç—Å–∫–∞—è": ["—Ä–µ–±–µ–Ω–æ–∫", "–¥–µ—Ç–∏", "–¥–µ—Ç—Å–∫–∏–π", "–º–∞–ª—ã—à", "—à–∫–æ–ª—å–Ω–∏–∫"],
    "–±–æ—Ä–æ–¥–∞": ["–±–æ—Ä–æ–¥–∫–∞", "—É—Å—ã", "–±–∞–∫–µ–Ω–±–∞—Ä–¥—ã"],
    "–±—ã—Å—Ç—Ä–æ": ["—Å—Ä–æ—á–Ω–æ", "—ç–∫—Å–ø—Ä–µ—Å—Å", "–±—ã—Å—Ç—Ä–∞—è"],
    "–Ω–µ–¥–æ—Ä–æ–≥–æ": ["–¥–µ—à–µ–≤–æ", "–±—é–¥–∂–µ—Ç–Ω–æ", "—ç–∫–æ–Ω–æ–º", "–¥–µ—à–µ–≤–ª–µ"]
  },
  
  "categories": {
    "children": {
      "patterns": ["–¥–µ—Ç—Å–∫", "—Ä–µ–±–µ–Ω", "–º–∞–ª—ã—à", "—à–∫–æ–ª—å–Ω"],
      "boost": ["–î–ï–¢–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê", "–û–¢–ï–¶ + –°–´–ù"],
      "reduce": ["–ú–£–ñ–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê", "–°–¢–†–ò–ñ–ö–ê –ú–ê–®–ò–ù–ö–û–ô"]
    }
  },
  
  "stopwords": ["—É", "–≤", "–Ω–∞", "–∏", "–∏–ª–∏", "–¥–ª—è", "—Å", "–ø–æ"],
  
  "weights": {
    "exact": 100,
    "synonym": 80,
    "category": 70,
    "partial": 50,
    "history": 40,
    "popular": 30
  }
}
```

### –°—Ö–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
```javascript
// Redis —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
{
  // –ö—ç—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
  "search:cache:{query_hash}": {
    "services": [...],
    "timestamp": 1234567890,
    "ttl": 3600
  },
  
  // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –≤—ã–±–æ—Ä–∞
  "search:patterns": [
    {
      "query": "–¥–µ—Ç—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞",
      "selected": 73,
      "position": 0,
      "timestamp": 1234567890
    }
  ],
  
  // –°—á–µ—Ç—á–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
  "search:success:–¥–µ—Ç—Å–∫–∞—è:73": 15,
  "search:success:—Å—Ç—Ä–∏–∂–∫–∞:42": 120,
  
  // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
  "client:79001234567:preferences": {
    "favoriteServices": [42, 73],
    "averageCheck": 2500,
    "lastVisit": 1234567890
  }
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã
```javascript
describe('SmartServiceMatcher', () => {
  describe('Query Preprocessing', () => {
    it('should normalize query correctly', () => {
      const query = "  –î–ï–¢–°–ö–ê–Ø  —Å—Ç—Ä–∏–∂–∫–∞??? ";
      const processed = preprocessor.process(query);
      expect(processed.normalized).toBe("–¥–µ—Ç—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞");
      expect(processed.tokens).toEqual(["–¥–µ—Ç—Å–∫–∞—è", "—Å—Ç—Ä–∏–∂–∫–∞"]);
    });
    
    it('should detect intent', () => {
      expect(preprocessor.detectIntent("—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç")).toBe("price");
      expect(preprocessor.detectIntent("—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è")).toBe("book");
    });
  });
  
  describe('Synonym Expansion', () => {
    it('should expand with synonyms', () => {
      const expanded = expander.expand({tokens: ["–ø–æ–¥—Å—Ç—Ä–∏—á—å—Å—è"]});
      expect(expanded.expandedTokens).toContain("—Å—Ç—Ä–∏–∂–∫–∞");
    });
  });
  
  describe('Scoring', () => {
    it('should boost favorite services', () => {
      const service = {id: 42, title: "–°—Ç—Ä–∏–∂–∫–∞"};
      const context = {client: {favoriteServices: [42]}};
      const score = scorer.score(service, {}, context);
      expect(score).toBeGreaterThan(50);
    });
  });
});
```

### Integration —Ç–µ—Å—Ç—ã
```javascript
describe('End-to-end service search', () => {
  it('should find children haircut', async () => {
    const matcher = new SmartServiceMatcher(services);
    const results = await matcher.match("–¥–µ—Ç—Å–∫–∞—è —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", context);
    
    expect(results[0].title).toBe("–î–ï–¢–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê");
    expect(results[0].price).toBe(1800);
  });
  
  it('should personalize for returning client', async () => {
    const context = {
      client: {
        history: [
          {serviceId: 73, date: Date.now() - 86400000}
        ]
      }
    };
    
    const results = await matcher.match("—Å—Ç—Ä–∏–∂–∫–∞", context);
    expect(results[0].id).toBe(73); // –î–µ—Ç—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞
  });
});
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
```javascript
class SearchMetrics {
  constructor(prometheus) {
    this.metrics = {
      searchLatency: new prometheus.Histogram({
        name: 'service_search_duration_seconds',
        help: 'Service search duration in seconds',
        buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5]
      }),
      
      searchAccuracy: new prometheus.Gauge({
        name: 'service_search_accuracy',
        help: 'Percentage of searches with correct first result'
      }),
      
      cacheHitRate: new prometheus.Gauge({
        name: 'service_search_cache_hit_rate',
        help: 'Cache hit rate for service searches'
      }),
      
      userSatisfaction: new prometheus.Gauge({
        name: 'service_search_satisfaction',
        help: 'User satisfaction score (position of selected item)'
      })
    };
  }
  
  recordSearch(query, results, selected, duration) {
    this.metrics.searchLatency.observe(duration);
    
    const position = results.findIndex(r => r.id === selected?.id);
    if (position === 0) {
      this.metrics.searchAccuracy.inc();
    }
    
    if (position >= 0) {
      this.metrics.userSatisfaction.set(1 / (position + 1));
    }
  }
}
```

## üöÄ –ü–ª–∞–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

### –≠—Ç–∞–ø 1: Canary deployment (1 –¥–µ–Ω—å)
1. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ 5% —Ç—Ä–∞—Ñ–∏–∫–∞
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ 24 —á–∞—Å–∞
3. –°—Ä–∞–≤–Ω–∏—Ç—å —Å baseline

### –≠—Ç–∞–ø 2: A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1 –Ω–µ–¥–µ–ª—è)
1. 50/50 split –º–µ–∂–¥—É —Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
2. –°–æ–±—Ä–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ
3. –ü—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –æ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏

### –≠—Ç–∞–ø 3: Full rollout (1 –¥–µ–Ω—å)
1. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å 100% —Ç—Ä–∞—Ñ–∏–∫–∞
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø–µ—Ä–≤—ã–µ 48 —á–∞—Å–æ–≤
3. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å rollback –ø–ª–∞–Ω

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –í–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–æ–∏—Å–∫–∞
SMART_SEARCH_ENABLED=true

# –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
SEARCH_LOG_LEVEL=info

# Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
SEARCH_REDIS_URL=redis://localhost:6379/2

# –í–µ—Å–∞ –¥–ª—è —Å–∫–æ—Ä–∏–Ω–≥–∞ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å)
SEARCH_WEIGHT_EXACT=100
SEARCH_WEIGHT_SYNONYM=80
SEARCH_WEIGHT_HISTORY=40

# ML features (future)
SEARCH_ML_ENABLED=false
SEARCH_ML_MODEL_PATH=/models/search_v1.pkl
```

---

**–í–µ—Ä—Å–∏—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏**: 1.0
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 16.08.2025
**–°—Ç–∞—Ç—É—Å**: Draft