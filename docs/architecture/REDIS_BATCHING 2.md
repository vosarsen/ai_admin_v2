# Redis Batching System Documentation

> ‚ö†Ô∏è **–í–ê–ñ–ù–û**: –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç Redis –±–∞—Ç—á–∏–Ω–≥ –∏–º–µ–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ production. –°–º. [REDIS_BATCHING_INVESTIGATION.md](REDIS_BATCHING_INVESTIGATION.md) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.

## –°—Ç–∞—Ç—É—Å: üî¥ –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –í PRODUCTION

### –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ë–∞—Ç—á–∏ –∏—Å—á–µ–∑–∞—é—Ç –∏–∑ Redis –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. Batch processor –Ω–µ –≤–∏–¥–∏—Ç –±–∞—Ç—á–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ API —Å–µ—Ä–≤–µ—Ä–æ–º
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ rapid-fire —Å–æ–æ–±—â–µ–Ω–∏—è

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —á–µ—Ä–µ–∑ `/webhook/whatsapp` –¥–æ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã.

## –û–±–∑–æ—Ä
–°–∏—Å—Ç–µ–º–∞ –±–∞—Ç—á–∏–Ω–≥–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è rapid-fire —Å–æ–æ–±—â–µ–Ω–∏–π (—Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —á–∞—Å—Ç—è–º–∏) –≤ –æ–¥–Ω–æ —Ü–µ–ª–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
1. **API Webhook** (`/webhook/whatsapp/batched`) - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –±–∞—Ç—á
2. **Redis Batch Service** - —É–ø—Ä–∞–≤–ª—è–µ—Ç –±–∞—Ç—á–∞–º–∏ –≤ Redis
3. **Batch Processor** - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –±–∞—Ç—á–∏
4. **Message Queue** - –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö
```
WhatsApp ‚Üí Venom Bot ‚Üí API /webhook/whatsapp/batched ‚Üí Redis Batch ‚Üí Batch Processor ‚Üí Message Queue ‚Üí Worker v2 ‚Üí AI ‚Üí Response
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–∞—Ç—á–∏–Ω–≥–∞
- `batchTimeout`: 10000ms (10 —Å–µ–∫—É–Ω–¥) - –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- `maxBatchSize`: 10 - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –±–∞—Ç—á–µ
- `defaultTTL`: 60 —Å–µ–∫—É–Ω–¥ - –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –±–∞—Ç—á–∞ –≤ Redis
- `checkInterval`: 1000ms - —á–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞—Ç—á–µ–π

### Redis –∫–ª—é—á–∏
- `rapid-fire:{phone}` - —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –±–∞—Ç—á–∞
- `last-msg:{phone}` - timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

## –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
1. –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ `/webhook/whatsapp/batched`
2. –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ Redis —Å–ø–∏—Å–æ–∫ `rapid-fire:{phone}`
3. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `last-msg:{phone}` —Å —Ç–µ–∫—É—â–∏–º timestamp
4. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è TTL –¥–ª—è –æ–±–æ–∏—Ö –∫–ª—é—á–µ–π

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞—Ç—á–∞
1. Batch Processor –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –±–∞—Ç—á–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
   - –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏ `maxBatchSize`
   - –ü—Ä–æ—à–ª–æ –ª–∏ `batchTimeout` —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
3. –ï—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:
   - –°–æ–æ–±—â–µ–Ω–∏—è –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ
   - –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ –≤ –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –ë–∞—Ç—á —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ Redis

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ë–∞—Ç—á–∏ –∏—Å—á–µ–∑–∞—é—Ç –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–°–∏–º–ø—Ç–æ–º**: –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ç–∞–π–º–∞—É—Ç–∞ –±–∞—Ç—á —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ Redis –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–°—Ç–∞—Ç—É—Å**: –í –ø—Ä–æ—Ü–µ—Å—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- **Workaround**: –ù–µ—Ç

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏
- `ai-admin-batch-processor` - –æ—Å–Ω–æ–≤–Ω—ã–µ –ª–æ–≥–∏ –±–∞—Ç—á-–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
- –ö–ª—é—á–µ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
  - `Processing batch for {phone}` - –±–∞—Ç—á –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
  - `Batch for {phone} approaching timeout` - –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ —Ç–∞–π–º–∞—É—Ç—É
  - `Batch processed successfully` - —É—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

### –ú–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ pending –±–∞—Ç—á–µ–π
- –†–∞–∑–º–µ—Ä –±–∞—Ç—á–µ–π
- –í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è –±–∞—Ç—á–µ–π

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Å—Ç—è–º–∏ –≤ WhatsApp:
   ```
   –ü—Ä–∏–≤–µ—Ç
   –º–æ–∂–Ω–æ
   –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
   –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É
   –∑–∞–≤—Ç—Ä–∞?
   ```
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–∞—Ç—á-–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
3. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—ä–µ–¥–∏–Ω–∏–ª–∏—Å—å

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MCP WhatsApp –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:
```javascript
mcp__whatsapp__send_message(phone, "—á–∞—Å—Ç—å 1")
mcp__whatsapp__send_message(phone, "—á–∞—Å—Ç—å 2")
// –∏ —Ç.–¥.
```

## Troubleshooting

### –ë–∞—Ç—á –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
3. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –±–∞—Ç—á-–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∑–∞–ø—É—â–µ–Ω
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TTL –∫–ª—é—á–µ–π –≤ Redis

### –°–æ–æ–±—â–µ–Ω–∏—è —Ç–µ—Ä—è—é—Ç—Å—è
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint `/webhook/whatsapp/batched`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ API –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –±–∞—Ç—á
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è
1. –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions
2. –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ Grafana
3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
4. –†–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞—Ç—á–µ–π