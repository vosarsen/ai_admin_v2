# 🔄 Система синхронизации YClients → Supabase

## 📋 Оглавление
- [Обзор](#обзор)
- [Архитектура](#архитектура)
- [Модули синхронизации](#модули-синхронизации)
- [Производительность](#производительность)
- [Настройка и использование](#настройка-и-использование)
- [Мониторинг и отладка](#мониторинг-и-отладка)
- [Решение проблем](#решение-проблем)

## 🎯 Обзор

Система синхронизации обеспечивает автоматический перенос данных из CRM YClients в базу данных Supabase для работы AI-ассистента барбершопа.

### Ключевые особенности:
- ✅ **Полностью автоматическая** - работает по расписанию без участия человека
- ⚡ **Оптимизированная производительность** - 22 секунды для 1400+ клиентов
- 🔄 **Модульная архитектура** - отдельные модули для каждой сущности
- 📊 **Умная синхронизация** - обновляет только измененные данные
- 🛡️ **Отказоустойчивость** - обработка ошибок и повторные попытки

## 🏗️ Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                         YClients API                         │
└────────────────────────────┬────────────────────────────────┘
                             │
                    ┌────────▼────────┐
                    │  sync-manager.js │
                    │   (Координатор)  │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
┌───────▼──────┐    ┌────────▼──────┐    ┌───────▼──────┐
│ clients-sync │    │ services-sync │    │  staff-sync  │
│ (optimized)  │    │               │    │              │
└───────┬──────┘    └────────┬──────┘    └───────┬──────┘
        │                    │                    │
        └────────────────────┼────────────────────┘
                             │
                    ┌────────▼────────┐
                    │    Supabase     │
                    │   PostgreSQL    │
                    └─────────────────┘
```

## 📦 Модули синхронизации

### 1. sync-manager.js
**Главный координатор** всей системы синхронизации.

```javascript
// Расписание синхронизации (Moscow time UTC+3)
{
  services: '0 1 * * *',     // 01:00 - Услуги (раз в день)
  staff: '0 2 * * *',        // 02:00 - Мастера (раз в день)  
  clients: '0 3 * * *',      // 03:00 - Клиенты (раз в день)
  schedules: '0 */4 * * *',  // Каждые 4 часа - Расписания
  company: '0 0 * * 0'       // 00:00 воскресенье - Компания (раз в неделю)
}
```

**Основные функции:**
- Инициализация всех модулей синхронизации
- Управление расписанием cron-задач
- Координация последовательности синхронизации
- Обработка ошибок и логирование

### 2. clients-sync-optimized.js ⚡
**Оптимизированная синхронизация клиентов** с пакетной обработкой.

**Особенности:**
- **Пакетная обработка** по 50 клиентов за запрос
- **Ускорение в 16 раз** (с 6 минут до 22 секунд)
- Автоматический расчет уровней лояльности
- Синхронизация финансовых данных (`sold_amount` → `total_spent`)

**Синхронизируемые поля:**
- Персональные данные (имя, телефон, email)
- Финансовые показатели (total_spent, visit_count)
- История визитов
- Уровень лояльности (VIP, Gold, Silver, Bronze, New)
- Средний чек

### 3. services-sync.js
**Синхронизация услуг** барбершопа.

**Синхронизирует:**
- Названия и описания услуг
- Цены и длительность
- Категории услуг
- Связь с мастерами

### 4. staff-sync.js
**Синхронизация мастеров** с фильтрацией активных сотрудников.

**Особенности:**
- **Фильтрация только активных** (не уволенных и не скрытых)
- Автоматическая деактивация старых записей
- Синхронизация специализаций и рейтингов

**Синхронизирует:**
- Имена и контакты мастеров
- Специализации и должности
- Рейтинги и статусы
- Аватары и описания

### 5. schedules-sync.js
**Синхронизация расписаний** мастеров на 30 дней вперед.

**Синхронизирует:**
- Рабочие дни и часы
- Доступные слоты для записи
- Занятость мастеров

### 6. company-info-sync.js
**Синхронизация информации о компании**.

**Синхронизирует:**
- Название и адрес
- Контактные данные
- Часы работы
- Настройки бизнеса

## ⚡ Производительность

### До оптимизации:
- **1422 клиента**: ~6 минут
- **10000 клиентов**: ~40 минут (прогноз)
- **Проблема**: Последовательная обработка каждого клиента

### После оптимизации:
- **1422 клиента**: 22 секунды ✨
- **10000 клиентов**: ~2.5 минуты (прогноз)
- **Решение**: Пакетная обработка по 50 записей

### Сравнение производительности:
```
Операция                   | До         | После      | Ускорение
---------------------------|------------|------------|----------
1 клиент                   | 250ms      | 15ms       | 16x
100 клиентов               | 25 сек     | 1.5 сек    | 16x
1000 клиентов              | 4.2 мин    | 15 сек     | 16x
10000 клиентов             | 42 мин     | 2.5 мин    | 16x
```

## 🚀 Настройка и использование

### Переменные окружения (.env)
```bash
# YClients API
YCLIENTS_BEARER_TOKEN=your_bearer_token
YCLIENTS_USER_TOKEN=your_user_token
YCLIENTS_COMPANY_ID=962302

# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your_service_key

# Синхронизация
SYNC_CLIENT_VISITS=false  # Синхронизировать историю визитов
```

### Ручной запуск синхронизации

```bash
# Полная синхронизация всех данных
node scripts/manual-sync.js

# Синхронизация только клиентов
node scripts/manual-sync.js clients

# Синхронизация только услуг
node scripts/manual-sync.js services

# Синхронизация только мастеров
node scripts/manual-sync.js staff

# Синхронизация только расписаний
node scripts/manual-sync.js schedules

# Проверка статуса
node scripts/manual-sync.js status
```

### Автоматический запуск

Синхронизация запускается автоматически при старте сервера:

```javascript
// src/index.js
const { getSyncManager } = require('./sync/sync-manager');

async function startServer() {
  const syncManager = getSyncManager();
  await syncManager.initialize(); // Запуск автоматической синхронизации
}
```

### API endpoints для управления

```bash
# Проверить статус синхронизации
GET /api/sync/status

# Запустить синхронизацию расписаний
POST /api/sync/schedules

# Запустить полную синхронизацию (требует API ключ)
POST /api/sync/full
```

## 📊 Мониторинг и отладка

### Проверка статуса синхронизации
```bash
node scripts/check-sync-status.js
```

Вывод:
```
📊 Статус менеджера:
  Инициализирован: ✅
  Выполняется сейчас: ⏸️
  Запланированных задач: 5

⏰ Расписание синхронизации (Moscow time):
  services: 0 1 * * * (01:00 каждый день)
  staff: 0 2 * * * (02:00 каждый день)
  clients: 0 3 * * * (03:00 каждый день)
  schedules: 0 */4 * * * (Каждые 4 часа)
  company: 0 0 * * 0 (00:00 по воскресеньям)
```

### Проверка статистики клиентов
```bash
node check-client-stats.js
```

Вывод:
```
📊 СТАТИСТИКА КЛИЕНТОВ ПОСЛЕ СИНХРОНИЗАЦИИ
==================================================
Всего клиентов: 1424
С покупками (total_spent > 0): 1222 (86%)
Без покупок: 202

💎 Распределение по уровням лояльности:
  VIP: 4 клиентов
  Gold: 25 клиентов
  Silver: 96 клиентов
  Bronze: 240 клиентов
  New: 857 клиентов
```

### Логирование

Все модули используют единую систему логирования:

```javascript
const logger = require('../utils/logger').child({ module: 'module-name' });

// Уровни логирования
logger.info('Информационное сообщение');
logger.debug('Отладочное сообщение');
logger.warn('Предупреждение');
logger.error('Ошибка', { error: error.message });
```

Просмотр логов на сервере:
```bash
# Все логи
pm2 logs ai-admin-api

# Только ошибки
pm2 logs ai-admin-api --err

# Последние 100 строк
pm2 logs ai-admin-api --lines 100
```

## 🔧 Решение проблем

### Проблема: Синхронизация работает медленно

**Симптомы:** Синхронизация занимает более 5 минут

**Решение:** 
1. Убедитесь, что используется `clients-sync-optimized.js`, а не `clients-sync.js`
2. Проверьте настройку `BATCH_SIZE` (оптимально 50)
3. Проверьте сетевую задержку до YClients API

### Проблема: Данные не синхронизируются

**Симптомы:** После синхронизации данные не обновляются

**Проверки:**
1. Проверьте токены YClients в .env файле
2. Убедитесь что sync-manager инициализирован при старте
3. Проверьте логи на наличие ошибок

### Проблема: Дубликаты данных

**Симптомы:** Одни и те же клиенты появляются несколько раз

**Решение:**
Проверьте уникальные индексы в базе данных:
```sql
-- Должен быть уникальный индекс
CREATE UNIQUE INDEX clients_yclients_id_company_id_key 
ON clients(yclients_id, company_id);
```

### Проблема: Неправильные финансовые данные

**Симптомы:** total_spent показывает 0 для клиентов с покупками

**Решение:**
YClients API возвращает поле `sold_amount`, а не `spent`. Убедитесь что используется правильное маппинг:
```javascript
const totalSpent = client.sold_amount || client.spent || 0;
```

## 📈 Метрики и KPI

### Целевые показатели:
- **Время синхронизации**: < 1 минута для 2000 клиентов
- **Успешность**: > 99% успешных синхронизаций
- **Актуальность**: Данные не старше 24 часов
- **Покрытие**: 100% активных клиентов синхронизированы

### Мониторинг производительности:
```javascript
// В каждом модуле синхронизации
const startTime = Date.now();
// ... синхронизация ...
const duration = Date.now() - startTime;
logger.info(`✅ Sync completed in ${duration}ms`);
```

## 🔐 Безопасность

1. **Токены хранятся в переменных окружения** - никогда не коммитятся в репозиторий
2. **Ограничение частоты запросов** - задержки между API вызовами
3. **Валидация данных** - проверка типов перед сохранением
4. **Логирование без чувствительных данных** - токены не попадают в логи

## 🚦 Roadmap

### Планируемые улучшения:
- [ ] Инкрементальная синхронизация (только измененные записи)
- [ ] Webhook-интеграция для real-time обновлений
- [ ] Метрики в Prometheus/Grafana
- [ ] Параллельная загрузка страниц клиентов
- [ ] Кэширование неизменяемых данных (услуги, мастера)
- [ ] Резервное копирование перед синхронизацией

## 📚 Дополнительные ресурсы

- [YClients API Documentation](YCLIENTS_API.md)
- [Supabase Schema](docs/database-schema.md)
- [Troubleshooting Guide](docs/TROUBLESHOOTING.md)
- [Development Diary](docs/development-diary/)

---

*Последнее обновление: 6 августа 2025*
*Версия системы: 2.0 (оптимизированная)*