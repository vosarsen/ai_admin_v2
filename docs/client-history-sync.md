# Синхронизация истории клиентов из YClients

## Обзор

Система синхронизации истории визитов позволяет загружать полную историю посещений клиентов из YClients в локальную базу данных Supabase. Это обеспечивает персонализацию обслуживания и умные рекомендации.

## Архитектура

### Компоненты

1. **ClientRecordsSync** (`src/sync/client-records-sync.js`)
   - Основной модуль синхронизации записей
   - Использует endpoint `/records/{company_id}` 
   - Поддерживает фильтрацию по клиенту

2. **ClientVisitsSync** (`src/sync/client-visits-sync.js`)  
   - Альтернативный модуль (использует `/clients/visits/search`)
   - В текущей версии не работает из-за особенностей API

3. **UniversalYclientsSync** (`scripts/universal-yclients-sync.js`)
   - Интегрирует синхронизацию истории в общий процесс
   - Поддерживает настройки и лимиты

4. **SyncManager** (`src/sync/sync-manager.js`)
   - Управляет автоматической синхронизацией
   - Запускает синхронизацию по расписанию

## Конфигурация

### Файл: `src/config/sync-config.js`

```javascript
CLIENTS: {
  // Включить синхронизацию истории
  SYNC_VISIT_HISTORY: false, // по умолчанию выключено
  
  // Максимум клиентов за один запуск
  MAX_VISITS_SYNC_PER_RUN: 100,
  
  // Синхронизировать только недавних клиентов (дней)
  SYNC_RECENT_DAYS: 0, // 0 = все клиенты
  
  // Минимум визитов для синхронизации
  MIN_VISITS_TO_SYNC: 1
}
```

### Переменные окружения

```bash
# Включить синхронизацию истории
SYNC_CLIENT_VISITS=true

# Лимит клиентов за запуск
MAX_VISITS_SYNC_PER_RUN=100

# Только клиенты за последние N дней
SYNC_RECENT_DAYS=90

# Минимум визитов
MIN_VISITS_TO_SYNC=2
```

## Использование

### 1. Ручная синхронизация конкретного клиента

```bash
# По телефону
node scripts/test-client-records-sync.js +79686484488
```

### 2. Синхронизация всех клиентов

```bash
# Проверка статистики (dry run)
node scripts/sync-all-visits.js --dry-run

# Синхронизация первых 10 клиентов
node scripts/sync-all-visits.js --limit 10

# Полная синхронизация
node scripts/sync-all-visits.js
```

### 3. Автоматическая синхронизация

Включается автоматически при запуске SyncManager:
- Выполняется 2 раза в день (04:00 и 14:00)
- Синхронизирует до 100 клиентов за раз
- Соблюдает API лимиты YClients

## Данные в базе

### Таблица `clients`

После синхронизации обновляются поля:
- `visit_count` - количество визитов
- `visit_history` - массив с историей визитов
- `last_services` - последние 5 услуг
- `total_spent` - общая сумма
- `average_bill` - средний чек
- `loyalty_level` - уровень лояльности (New/Bronze/Silver/Gold/VIP)
- `first_visit_date` - дата первого визита
- `last_visit_date` - дата последнего визита

### Пример данных visit_history:

```json
[
  {
    "date": "2024-05-10",
    "services": ["СТРИЖКА + МОДЕЛИРОВАНИЕ БОРОДЫ"],
    "staff": "Али",
    "cost": 2500,
    "status": "attended",
    "attendance": 1
  },
  {
    "date": "2024-05-26", 
    "services": ["СТРИЖКА + МОДЕЛИРОВАНИЕ БОРОДЫ"],
    "staff": "Сергей",
    "cost": 2500,
    "status": "attended",
    "attendance": 1
  }
]
```

## API лимиты

YClients API имеет следующие ограничения:
- 200 запросов в минуту
- 5 запросов в секунду

Система автоматически соблюдает эти лимиты:
- Задержка 300мс между запросами истории
- Максимум 100 клиентов за запуск
- Автоматические повторы при ошибках

## Расчет времени

Примерное время синхронизации:
- 1 клиент ≈ 0.5 секунды
- 100 клиентов ≈ 50 секунд
- 1000 клиентов ≈ 8-10 минут

## Мониторинг

### Логи синхронизации

```bash
# Просмотр логов
pm2 logs ai-admin-api | grep "Visit history"

# Статистика синхронизации
node scripts/universal-yclients-sync.js status
```

### Метрики в базе

```sql
-- Клиенты с синхронизированной историей
SELECT COUNT(*) FROM clients 
WHERE visit_history IS NOT NULL 
AND array_length(visit_history, 1) > 0;

-- Статистика по уровням лояльности
SELECT loyalty_level, COUNT(*) 
FROM clients 
GROUP BY loyalty_level;
```

## Персонализация на основе истории

После синхронизации AI бот может:

1. **Персональные приветствия**
   - "Здравствуйте, Арсен! Рад снова вас видеть!"
   - "Давно не виделись! Как обычно к Бари?"

2. **Умные рекомендации**
   - Предлагать последние услуги
   - Рекомендовать любимых мастеров
   - Напоминать о регулярности визитов

3. **Контекстная информация**
   - "Ваш последний визит был 5 дней назад"
   - "Вы у нас уже 5-й раз, спасибо за доверие!"
   - "Как Silver клиент, вы имеете скидку 10%"

## Troubleshooting

### Проблема: API не возвращает историю

Возможные причины:
- Неверный client_id
- Нет прав на чтение записей
- Клиент без истории визитов

Решение:
```bash
# Проверить конкретного клиента
DEBUG=ai-admin:* node scripts/test-client-records-sync.js +79001234567
```

### Проблема: Превышен лимит API

Симптомы: 429 ошибки, "Too many requests"

Решение:
- Уменьшить MAX_VISITS_SYNC_PER_RUN
- Увеличить задержки в конфигурации
- Запускать синхронизацию реже

### Проблема: Долгая синхронизация

Решение:
- Использовать SYNC_RECENT_DAYS для фильтрации
- Увеличить MIN_VISITS_TO_SYNC
- Разбить на несколько запусков с --limit

## Безопасность

- История хранится только в локальной БД
- Данные не передаются третьим лицам
- Используется для улучшения сервиса
- Соответствует политике конфиденциальности