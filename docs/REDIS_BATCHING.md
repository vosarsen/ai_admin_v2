# Redis Batching System Documentation

## Обзор
Система батчинга предназначена для объединения rapid-fire сообщений (сообщений, отправленных частями) в одно целое сообщение перед обработкой.

## Архитектура

### Компоненты
1. **API Webhook** (`/webhook/whatsapp/batched`) - принимает сообщения и добавляет в батч
2. **Redis Batch Service** - управляет батчами в Redis
3. **Batch Processor** - периодически проверяет и обрабатывает готовые батчи
4. **Message Queue** - очередь для обработки объединенных сообщений

### Поток данных
```
WhatsApp → Venom Bot → API /webhook/whatsapp/batched → Redis Batch → Batch Processor → Message Queue → Worker v2 → AI → Response
```

## Конфигурация

### Параметры батчинга
- `batchTimeout`: 10000ms (10 секунд) - время ожидания после последнего сообщения
- `maxBatchSize`: 10 - максимальное количество сообщений в батче
- `defaultTTL`: 60 секунд - время жизни батча в Redis
- `checkInterval`: 1000ms - частота проверки батчей

### Redis ключи
- `rapid-fire:{phone}` - список сообщений батча
- `last-msg:{phone}` - timestamp последнего сообщения

## Алгоритм работы

### Добавление сообщения
1. Сообщение приходит на `/webhook/whatsapp/batched`
2. Добавляется в Redis список `rapid-fire:{phone}`
3. Обновляется `last-msg:{phone}` с текущим timestamp
4. Обновляется TTL для обоих ключей

### Обработка батча
1. Batch Processor проверяет все батчи каждую секунду
2. Для каждого батча проверяется:
   - Достигнут ли `maxBatchSize`
   - Прошло ли `batchTimeout` с последнего сообщения
3. Если условия выполнены:
   - Сообщения объединяются в одно
   - Создается задача в очереди сообщений
   - Батч удаляется из Redis

## Известные проблемы

### 1. Батчи исчезают без обработки
- **Симптом**: При достижении таймаута батч удаляется из Redis без обработки
- **Статус**: В процессе исправления
- **Workaround**: Нет

### 2. Логирование
- Добавлено детальное логирование для отладки
- Все критические моменты логируются

## Мониторинг

### Логи
- `ai-admin-batch-processor` - основные логи батч-процессора
- Ключевые сообщения:
  - `Processing batch for {phone}` - батч обрабатывается
  - `Batch for {phone} approaching timeout` - приближение к таймауту
  - `Batch processed successfully` - успешная обработка

### Метрики
- Количество pending батчей
- Размер батчей
- Время простоя батчей

## Тестирование

### Ручное тестирование
1. Отправить сообщение частями в WhatsApp:
   ```
   Привет
   можно
   записаться
   на стрижку
   завтра?
   ```
2. Проверить логи батч-процессора
3. Убедиться что сообщения объединились

### Автоматическое тестирование
Использовать MCP WhatsApp для отправки тестовых сообщений:
```javascript
mcp__whatsapp__send_message(phone, "часть 1")
mcp__whatsapp__send_message(phone, "часть 2")
// и т.д.
```

## Troubleshooting

### Батч не обрабатывается
1. Проверить логи на наличие ошибок
2. Проверить Redis подключение
3. Убедиться что батч-процессор запущен
4. Проверить TTL ключей в Redis

### Сообщения теряются
1. Проверить что используется правильный endpoint `/webhook/whatsapp/batched`
2. Проверить логи API на предмет добавления в батч
3. Проверить очередь сообщений

## Будущие улучшения
1. Атомарные операции для предотвращения race conditions
2. Метрики и мониторинг в Grafana
3. Настраиваемые таймауты для разных типов сообщений
4. Резервное сохранение батчей