# Performance Advisor - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ Supabase

## –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
- **1 –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–µ–∫—Å** –Ω–∞ foreign key
- **49 –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤** (—Å–æ–∑–¥–∞–Ω—ã, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)

## –í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å

### –ü–æ—á–µ–º—É –∏–Ω–¥–µ–∫—Å—ã –ø–æ–∫–∞–∑–∞–Ω—ã –∫–∞–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ?
1. **–ú–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î** - –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ç–∞–±–ª–∏—Ü –ø—É—Å—Ç—ã–µ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –º–∞–ª–æ –∑–∞–ø–∏—Å–µ–π
2. **PostgreSQL –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä** –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç full table scan –ø—Ä–∏ –º–∞–ª–æ–º –æ–±—ä–µ–º–µ –¥–∞–Ω–Ω—ã—Ö
3. **–ò–Ω–¥–µ–∫—Å—ã –Ω–∞—á–Ω—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è** –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω–µ—Ç –±–æ–ª—å—à–µ (–æ–±—ã—á–Ω–æ >1000 –∑–∞–ø–∏—Å–µ–π)

### –°—Ç–æ–∏—Ç –ª–∏ —É–¥–∞–ª—è—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã?
**–ù–ï–¢!** –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–¥–∞–ª—è—Ç—å —ç—Ç–∏ –∏–Ω–¥–µ–∫—Å—ã, –ø–æ—Ç–æ–º—É —á—Ç–æ:
- –û–Ω–∏ —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è –±—É–¥—É—â–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –ù–∞—á–Ω—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ —Ä–æ—Å—Ç–µ –¥–∞–Ω–Ω—ã—Ö
- –£–¥–∞–ª–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–æ—Ä–æ–∂–µ, —á–µ–º –∏—Ö —Ö—Ä–∞–Ω–µ–Ω–∏–µ
- –ó–∞–Ω–∏–º–∞—é—Ç –º–∏–Ω–∏–º—É–º –º–µ—Å—Ç–∞ –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –î–æ–±–∞–≤–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–µ–∫—Å (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

```sql
-- –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –¥–ª—è foreign key –≤ —Ç–∞–±–ª–∏—Ü–µ visits
CREATE INDEX IF NOT EXISTS idx_visits_client_id 
ON public.visits(client_id);
```

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ**: Foreign key –±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞ –º–æ–∂–µ—Ç —Å–∏–ª—å–Ω–æ –∑–∞–º–µ–¥–ª–∏—Ç—å:
- –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Ç–∞–±–ª–∏—Ü—ã (clients)
- JOIN –æ–ø–µ—Ä–∞—Ü–∏–∏ –º–µ–∂–¥—É visits –∏ clients
- –ü—Ä–æ–≤–µ—Ä–∫—É —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

### 2. –û—Å—Ç–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

–ù–µ —É–¥–∞–ª—è–π—Ç–µ "–Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ" –∏–Ω–¥–µ–∫—Å—ã, –æ–Ω–∏ –Ω—É–∂–Ω—ã –¥–ª—è:

#### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- `idx_clients_phone_company` - –ø–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
- `idx_services_company_active` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Å–ª—É–≥
- `idx_staff_company_active` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤
- `idx_dialog_contexts_user` - –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–æ–≤

#### –î–ª—è –±—É–¥—É—â–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- `idx_bookings_*` - –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –ø–æ –∑–∞–ø–∏—Å—è–º (–∫–æ–≥–¥–∞ –Ω–∞—á–Ω—É—Ç—Å—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
- `idx_appointments_cache_*` - –∫—ç—à —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
- `idx_clients_ai_*` - AI –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤

–ß–µ—Ä–µ–∑ –º–µ—Å—è—Ü —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan as index_scans,
    idx_tup_read as tuples_read,
    idx_tup_fetch as tuples_fetched,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

### 4. –ö–æ–≥–¥–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è—Ç—å –∏–Ω–¥–µ–∫—Å—ã?

–£–¥–∞–ª—è–π—Ç–µ –∏–Ω–¥–µ–∫—Å –¢–û–õ–¨–ö–û –µ—Å–ª–∏:
- –ü—Ä–æ—à–ª–æ >3 –º–µ—Å—è—Ü–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã
- –í —Ç–∞–±–ª–∏—Ü–µ >10,000 –∑–∞–ø–∏—Å–µ–π
- idx_scan = 0 (–Ω–∏ —Ä–∞–∑—É –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è)
- –ò–Ω–¥–µ–∫—Å –∑–∞–Ω–∏–º–∞–µ—Ç >100MB –º–µ—Å—Ç–∞
- –ï—Å—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π –∏–Ω–¥–µ–∫—Å —Å —Ç–µ–º–∏ –∂–µ –∫–æ–ª–æ–Ω–∫–∞–º–∏

## –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∏–Ω–¥–µ–∫—Å–∞

```sql
-- fix-missing-index.sql
-- –î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–µ–∫—Å –¥–ª—è foreign key

CREATE INDEX IF NOT EXISTS idx_visits_client_id 
ON public.visits(client_id);

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∏–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–Ω
SELECT 
    indexname,
    indexdef
FROM pg_indexes
WHERE schemaname = 'public' 
    AND tablename = 'visits'
    AND indexname = 'idx_visits_client_id';
```

## –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –°–µ–π—á–∞—Å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å `idx_visits_client_id` - –∏—Å–ø—Ä–∞–≤–∏—Ç –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
2. ‚úÖ –û—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –∫–∞–∫ –µ—Å—Ç—å

### –ß–µ—Ä–µ–∑ 1 –º–µ—Å—è—Ü:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤
2. –û—Ü–µ–Ω–∏—Ç—å –∫–∞–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã –Ω–∞—á–∞–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
3. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —è–≤–Ω–æ –ª–∏—à–Ω–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤

### –ß–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞:
1. –ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –∏–Ω–¥–µ–∫—Å–æ–≤
2. –£–¥–∞–ª–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã —Å 0 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –ø—Ä–∏ –æ–±—ä–µ–º–µ –¥–∞–Ω–Ω—ã—Ö >10k –∑–∞–ø–∏—Å–µ–π
3. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã based on slow query log

## –í–∞–∂–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```sql
-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º
SELECT 
    schemaname,
    tablename,
    n_live_tup as live_rows,
    n_dead_tup as dead_rows,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY n_live_tup DESC;

-- –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
SELECT
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) AS indexes_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–¢–µ–∫—É—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ Performance Advisor –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã!**

- 49 "–Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö" –∏–Ω–¥–µ–∫—Å–æ–≤ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ë–î —Å –º–∞–ª—ã–º –æ–±—ä–µ–º–æ–º –¥–∞–Ω–Ω—ã—Ö
- –û–Ω–∏ –Ω–∞—á–Ω—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ —Ä–æ—Å—Ç–µ –¥–∞–Ω–Ω—ã—Ö
- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å –¥–ª—è foreign key –≤ visits

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
1. üü¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ)
2. üü° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å OK)
3. üîµ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ –±—É–¥—É—â–µ–º)