# Cache Optimization Guide

## –û–±–∑–æ—Ä

–õ–æ–∫–∞–ª—å–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å AI Admin v2, —Å–Ω–∏–∂–∞—è –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ —É—Å–∫–æ—Ä—è—è –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –£—Ä–æ–≤–Ω–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   AI Admin v2   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Cached Data     ‚îÇ  ‚Üê In-memory cache (node-cache)
‚îÇ    Loader       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Data Loader    ‚îÇ  ‚Üê Database queries
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Supabase     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2. –¢–∏–ø—ã –∫—ç—à–µ–π

- **context** (TTL: 5 –º–∏–Ω) - –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø–æ–ª–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã
- **company** (TTL: 10 –º–∏–Ω) - –î–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–π
- **services** (TTL: 15 –º–∏–Ω) - –£—Å–ª—É–≥–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª
- **clients** (TTL: 10 –º–∏–Ω) - –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–æ–≤
- **slots** (TTL: 2 –º–∏–Ω) - –°–ª–æ—Ç—ã –¥–ª—è –∑–∞–ø–∏—Å–∏ –∏ —Ç–µ–∫—É—â–∏–µ –∑–∞–ø–∏—Å–∏

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `cached-data-loader` –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è:

```javascript
const cachedDataLoader = require('./modules/cached-data-loader');

// –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ë–î (~200ms)
const context = await cachedDataLoader.loadFullContext(phone, companyId);

// –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã - –∏–∑ –∫—ç—à–∞ (~5ms)
const contextAgain = await cachedDataLoader.loadFullContext(phone, companyId);
```

### 2. Cache-aside –ø–∞—Ç—Ç–µ—Ä–Ω

–î–ª—è –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `getOrSet`:

```javascript
const result = await localCache.getOrSet(
  'services',                    // —Ç–∏–ø –∫—ç—à–∞
  `custom:${companyId}`,        // –∫–ª—é—á
  async () => {                 // —Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
    return await loadFromDB();
  },
  600                           // TTL –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
);
```

### 3. –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤–∞–∂–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à:

```javascript
// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
cachedDataLoader.invalidateCache('client', clientId, companyId);

// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ (–∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Å–ª–æ—Ç—ã)
cachedDataLoader.invalidateCache('booking', bookingId, companyId);

// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏ (–æ—á–∏—â–∞–µ—Ç –≤–µ—Å—å –∫—ç—à)
cachedDataLoader.invalidateCache('company', companyId);
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### 1. API endpoints

```bash
# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞
curl -H "X-API-Key: your-key" http://localhost:3000/api/cache/stats

# –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à
curl -X POST -H "X-API-Key: your-key" http://localhost:3000/api/cache/flush

# –û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø –∫—ç—à–∞
curl -X POST -H "X-API-Key: your-key" \
  -H "Content-Type: application/json" \
  -d '{"cacheType": "services"}' \
  http://localhost:3000/api/cache/flush

# –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—É—â–Ω–æ—Å—Ç—å
curl -X POST -H "X-API-Key: your-key" \
  -H "Content-Type: application/json" \
  -d '{"entityType": "client", "entityId": "123", "companyId": 962302}' \
  http://localhost:3000/api/cache/invalidate
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
node scripts/test-cache-performance.js
```

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```
üìä Testing WITHOUT cache:
  Average time: 523ms

üìä Testing WITH cache:
  Average time: 112ms
  Cached requests: 5ms

üìà Performance improvement:
  Overall: 78% faster
  Cached requests: 99% faster
  Speed up: 104x
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ò–∑–º–µ–Ω–µ–Ω–∏–µ TTL

–í `src/utils/local-cache.js`:

```javascript
// –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–∏–Ω—É—Ç)
context: new NodeCache({
  stdTTL: 300,  // –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
  // ...
}),
```

### 2. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–∞–º—è—Ç–∏

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:

```javascript
const localCache = new LocalCache({
  maxKeys: 500,  // –º–∞–∫—Å–∏–º—É–º –∫–ª—é—á–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1000)
  // ...
});
```

## Best Practices

### 1. –ß—Ç–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å

‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞—Ç—å:**
- –°—Ç–∞—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∫–æ–º–ø–∞–Ω–∏–∏, —É—Å–ª—É–≥–∏, –ø–µ—Ä—Å–æ–Ω–∞–ª)
- –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ü–æ–ª–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤

‚ùå **–ù–ï –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å:**
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–ª–∞—Ç–µ–∂–∏, –≤–∞–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã)
- –î–∞–Ω–Ω—ã–µ —Å –≤—ã—Å–æ–∫–æ–π —á–∞—Å—Ç–æ—Ç–æ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –¥–æ–ª–≥–∏–π —Å—Ä–æ–∫

### 2. –ü—Ä–∞–≤–∏–ª–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏

1. **–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏** - –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫—ç—à–∏
2. **–ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö** - –Ω–µ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å)
3. **–ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ TTL

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–ª–µ–¥–∏—Ç–µ –∑–∞ –º–µ—Ç—Ä–∏–∫–∞–º–∏:
- **Hit Rate** > 70% - —Ö–æ—Ä–æ—à–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å
- **Memory Usage** - –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å –ª–∏–º–∏—Ç—ã
- **Evictions** - –º–Ω–æ–≥–æ evictions = –Ω—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å TTL –∏–ª–∏ –ª–∏–º–∏—Ç—ã

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–∏–∑–∫–∏–π hit rate

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–≤–µ–ª–∏—á—å—Ç–µ TTL –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–∫—É –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–ª—é—á–∏

### –ü—Ä–æ–±–ª–µ–º–∞: –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–º–µ–Ω—å—à–∏—Ç–µ TTL
2. –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ maxKeys
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–±–ª–µ–º–∞: –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
2. –£–º–µ–Ω—å—à–∏—Ç–µ TTL –¥–ª—è –∏–∑–º–µ–Ω—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. –î–æ–±–∞–≤—å—Ç–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π

## –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–° –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã —Å–ª–µ–¥—É—é—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:

- **–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**: 500ms ‚Üí 5ms (100x faster –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö)
- **–û–±—â–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: —É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 75-85%
- **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î**: —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 80-90%
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å**: —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤ 3-4 —Ä–∞–∑–∞