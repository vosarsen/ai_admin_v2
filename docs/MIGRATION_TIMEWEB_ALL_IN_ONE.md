# План миграции: Всё на Timeweb Cloud

**Дата:** 2025-10-31
**Решение:** Единый провайдер - Timeweb Cloud
**Требование:** 152-ФЗ обязателен

---

## 🎯 Решение: Application + Database на Timeweb Cloud

```
┌─────────────────────────────────────────────────┐
│         TIMEWEB CLOUD - ЕДИНАЯ ПЛАТФОРМА        │
│         📍 Россия (Москва/СПб)                  │
│         💰 ~4,000-5,000₽/мес                    │
│                                                 │
├─────────────────────────────────────────────────┤
│  1️⃣ Облачный сервер VPS (приложение)          │
│     • 8 vCPU cores                              │
│     • 16 GB RAM                                 │
│     • 160 GB NVMe SSD                           │
│     • Безлимитный трафик                        │
│     • DDoS защита L3-L4 (опция +450₽)          │
│     • Публичный IP включен                      │
│     • ~2,500-3,500₽/мес*                        │
├─────────────────────────────────────────────────┤
│  2️⃣ Managed PostgreSQL (база данных)           │
│     • Managed Database (DBaaS)                  │
│     • Point-in-Time Recovery                    │
│     • Автоматические бэкапы                     │
│     • WAL-G backup система                      │
│     • Prometheus мониторинг                     │
│     • ~1,500₽/мес                               │
└─────────────────────────────────────────────────┘

✅ 152-ФЗ: Соответствует (оба сервера в РФ)
✅ Единая панель управления
✅ Минимальная латентность app↔DB (<5ms)
```

*Точную стоимость VPS нужно уточнить в калькуляторе timeweb.cloud/prices

---

## 💡 Почему "Всё на Timeweb" - лучший выбор

### ✅ Преимущества

#### 1. **Единая платформа**
- Одна панель управления для всего
- Единый биллинг (один счет, одна оплата)
- Не нужно управлять двумя провайдерами
- Упрощенный документооборот (один договор)

#### 2. **Упрощенная техподдержка**
- Одна точка контакта (support@timeweb.com)
- Проблемы решаются быстрее
- Не перекидывают между провайдерами
- Единый SLA для app + DB

#### 3. **Минимальная сетевая латентность**
- App и DB в **одном датацентре**
- Латентность: <5ms (vs 10-20ms между провайдерами)
- Более быстрые запросы к БД
- Лучшая производительность приложения

#### 4. **Упрощенное масштабирование**
- Увеличить ресурсы в одной панели
- Единый мониторинг app + DB
- Легче планировать нагрузку
- Прозрачная аналитика затрат

#### 5. **Бесплатное тестирование**
- ✅ **3 дня бесплатного теста** любой конфигурации
- Можно протестировать перед оплатой
- Проверить производительность
- Оценить удобство интерфейса

#### 6. **Возможные скидки**
- Лояльность одному провайдеру
- Можно договориться о корпоративной скидке
- Специальные условия для стартапов

#### 7. **Соответствие 152-ФЗ**
- Оба сервера в РФ (Москва/СПб)
- Персональные данные не покидают страну
- Упрощенная отчетность (один провайдер)

---

## ⚠️ Возможные недостатки

### 1. **Vendor Lock-in**
- Зависимость от одного провайдера
- Если Timeweb упадет - нет ни app, ни DB
- **Митигация:** Регулярные бэкапы, plan B готов

### 2. **Неизвестная производительность VPS**
- AdminVPS известен хорошими отзывами
- Timeweb VPS нужно тестировать
- **Митигация:** 3 дня бесплатного теста!

### 3. **История повышения цен**
- Timeweb повысил цены в 2024 (1.5-3x)
- Может повысить снова в будущем
- **Митигация:** Фиксированные цены на год, миграция возможна

### 4. **Меньше гибкости**
- Нельзя выбрать "лучший VPS + лучший DB"
- Привязка к одной экосистеме
- **Митигация:** Timeweb предлагает всё нужное

---

## 📊 Сравнение вариантов

| Параметр | Timeweb (всё) | AdminVPS + Timeweb | Yandex Cloud |
|----------|---------------|-------------------|--------------|
| **VPS** | ~2,500-3,500₽ | 2,749₽ | ~3,000₽ |
| **PostgreSQL** | ~1,500₽ | ~1,500₽ | ~4,500₽ |
| **ИТОГО/мес** | **~4,000-5,000₽** | **4,249₽** | **~7,500₽** |
| **Провайдеров** | 1 | 2 | 1 |
| **Латентность app↔DB** | <5ms | 10-20ms | <5ms |
| **Управление** | Очень просто | Средне | Сложно |
| **152-ФЗ** | ✅ РФ | ✅ РФ | ✅ РФ |
| **Бесплатный тест** | ✅ 3 дня | ⚠️ Нет | ⚠️ Нет |
| **Рекомендация** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |

**Вывод:** Timeweb (всё) - оптимальный выбор по соотношению цена/удобство/производительность.

---

## 🚀 План миграции на Timeweb Cloud

### Timeline: 6-8 недель

```
┌─────────────────────────────────────────────────┐
│ Неделя 1: Подготовка и тестирование             │
├─────────────────────────────────────────────────┤
│ • День 1-2: Регистрация, создание тестового VPS │
│ • День 3-5: Тестирование производительности     │
│ • День 6-7: Создание PostgreSQL, тест связки    │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ Неделя 2: Миграция приложения                   │
├─────────────────────────────────────────────────┤
│ • Настройка production VPS                      │
│ • Копирование Baileys sessions                  │
│ • Настройка .env (Supabase временно)            │
│ • Запуск приложения, тестирование               │
│ • Переключение DNS                              │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ Неделя 3-4: Разработка Database Adapter         │
├─────────────────────────────────────────────────┤
│ • Код Database Adapter (dual-database)          │
│ • Unit тесты, интеграционные тесты              │
│ • Локальное тестирование                        │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ Неделя 5-6: Миграция БД (dual-write)            │
├─────────────────────────────────────────────────┤
│ • Экспорт схемы из Supabase                     │
│ • Применение схемы в Timeweb PostgreSQL         │
│ • Миграция данных                               │
│ • Dual-write режим (запись в обе, чтение из SB) │
│ • Валидация синхронизации 7 дней                │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ Неделя 7: Dual-read режим                       │
├─────────────────────────────────────────────────┤
│ • Переключение на dual-read                     │
│ • Запись в обе БД, чтение из Timeweb            │
│ • Тестирование производительности               │
│ • Мониторинг 7 дней                             │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ Неделя 8: Финальный переход                     │
├─────────────────────────────────────────────────┤
│ • Переход на только Timeweb PostgreSQL          │
│ • Отключение Supabase                           │
│ • Мониторинг стабильности                       │
│ • Оптимизация производительности                │
└─────────────────────────────────────────────────┘
```

---

## 📋 Детальный план действий

### Этап 1: Регистрация и тестирование (Неделя 1)

#### Шаг 1.1: Регистрация на Timeweb Cloud

```bash
# 1. Зайти на https://timeweb.cloud/
# 2. Создать аккаунт
# 3. Подтвердить email/телефон
# 4. Пополнить баланс (минимум 500₽ для теста)
```

#### Шаг 1.2: Создать тестовый VPS

**Конфигурация для теста:**
```
CPU: 4 vCPU (для начала, потом увеличить)
RAM: 8 GB
Диск: 80 GB NVMe SSD
ОС: Ubuntu 22.04 LTS
ЦОД: Москва или Санкт-Петербург
```

**Через панель управления:**
1. Облачные серверы → Создать сервер
2. Выбрать конфигурацию (произвольная)
3. CPU: 4, RAM: 8GB, Диск: 80GB
4. ОС: Ubuntu 22.04 LTS
5. Создать

**Стоимость теста:** ~1,200-1,500₽/мес (3 дня бесплатно)

#### Шаг 1.3: Тестирование производительности

```bash
# Подключиться к тестовому VPS
ssh root@TIMEWEB_VPS_IP

# 1. CPU тест
sysbench cpu --threads=4 --time=60 run

# 2. RAM тест
sysbench memory --threads=4 --time=60 run

# 3. Disk I/O тест
sysbench fileio --file-test-mode=seqwr --file-total-size=10G prepare
sysbench fileio --file-test-mode=seqwr --file-total-size=10G run
sysbench fileio --file-test-mode=seqwr --file-total-size=10G cleanup

# 4. Network тест (внутри Timeweb ДЦ)
# Создать второй тестовый VPS и проверить латентность
ping -c 100 SECOND_VPS_IP
```

**Ожидаемые результаты:**
- CPU: должен быть сравним с AdminVPS
- RAM: низкая латентность
- Disk I/O: >500 MB/s (NVMe SSD)
- Network внутри ДЦ: <5ms

#### Шаг 1.4: Создать Timeweb Managed PostgreSQL

```bash
# Через панель управления:
# 1. Облачные базы данных → Создать БД
# 2. Тип: PostgreSQL 15
# 3. Конфигурация: начальная (можно масштабировать)
# 4. ЦОД: ТАКОЙ ЖЕ как VPS (важно!)
# 5. Создать
```

**Получить credentials:**
```
Host: xxx.timeweb.cloud
Port: 5432
User: admin
Password: [показан в панели]
Database: default_db
```

#### Шаг 1.5: Тест связки VPS ↔ PostgreSQL

```bash
# На тестовом VPS
ssh root@TIMEWEB_VPS_IP

# Установить PostgreSQL клиент
apt update && apt install -y postgresql-client

# Подключиться к Timeweb PostgreSQL
psql -h xxx.timeweb.cloud -U admin -d default_db

# Создать тестовую таблицу
CREATE TABLE test (id SERIAL PRIMARY KEY, data TEXT);
INSERT INTO test (data) VALUES ('Hello Timeweb!');
SELECT * FROM test;

# Измерить латентность
time psql -h xxx.timeweb.cloud -U admin -d default_db -c "SELECT 1"

# Ожидаем: <10ms (внутри одного ДЦ)
```

**Критерии успешного теста:**
- ✅ VPS производительность приемлема
- ✅ PostgreSQL работает
- ✅ Латентность VPS↔PostgreSQL <10ms
- ✅ Панель управления удобна

**Если тест НЕ прошел:**
- ❌ Удалить тестовые ресурсы
- ❌ Вернуться к варианту AdminVPS + Timeweb PostgreSQL

---

### Этап 2: Миграция приложения на production VPS (Неделя 2)

#### Шаг 2.1: Создать production VPS

**Финальная конфигурация:**
```
CPU: 8 vCPU
RAM: 16 GB
Диск: 160 GB NVMe SSD
ОС: Ubuntu 22.04 LTS
ЦОД: Москва (или тот же, что у PostgreSQL)
Публичный IP: включен
DDoS защита: +450₽/мес (опционально)
```

**Стоимость:** ~2,500-3,500₽/мес (точно в калькуляторе)

#### Шаг 2.2: Настройка сервера (автоматизация)

**Создать cloud-init скрипт для Timeweb:**

```yaml
#cloud-config
# Timeweb Cloud Init для AI Admin v2

users:
  - name: ai-admin
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

packages:
  - git
  - curl
  - build-essential
  - redis-server
  - nginx
  - ufw

runcmd:
  # 1. Установка Node.js 20
  - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  - apt-get install -y nodejs

  # 2. Установка PM2
  - npm install -g pm2

  # 3. Клонирование репозитория
  - mkdir -p /opt/ai-admin
  - cd /opt/ai-admin
  - git clone https://github.com/vosarsen/ai_admin_v2.git .
  - chown -R ai-admin:ai-admin /opt/ai-admin

  # 4. Настройка Redis
  - systemctl enable redis-server
  - systemctl start redis-server

  # 5. Firewall
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 3000/tcp
  - ufw --force enable

  # 6. Создать лог
  - echo "✅ Timeweb VPS Setup Complete!" > /root/SETUP_COMPLETE.txt
```

#### Шаг 2.3: Копирование данных

```bash
# С текущего сервера на новый Timeweb VPS

# 1. Baileys sessions (КРИТИЧНО)
scp -r root@46.149.70.219:/opt/ai-admin/baileys_sessions \
    root@TIMEWEB_VPS_IP:/opt/ai-admin/

# 2. .env файл
scp root@46.149.70.219:/opt/ai-admin/.env \
    root@TIMEWEB_VPS_IP:/opt/ai-admin/.env

# 3. Установить права
ssh root@TIMEWEB_VPS_IP
chown -R ai-admin:ai-admin /opt/ai-admin
```

#### Шаг 2.4: Настройка .env

```bash
# На Timeweb VPS
ssh root@TIMEWEB_VPS_IP
cd /opt/ai-admin
nano .env
```

**Обновить:**
```bash
# Redis (local на Timeweb VPS)
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=<установить новый пароль>

# API URLs (новый IP)
API_BASE_URL=http://TIMEWEB_VPS_IP:3000
WEBHOOK_URL=http://TIMEWEB_VPS_IP:3000/webhook/whatsapp/batched

# Supabase (пока оставить)
SUPABASE_URL=...
SUPABASE_KEY=...

# Остальное из старого .env
```

#### Шаг 2.5: Сборка и запуск

```bash
# На Timeweb VPS
cd /opt/ai-admin

# Установка зависимостей
npm install --production

# Сборка
npm run build

# Запуск PM2
pm2 start ecosystem.config.js

# Проверка
pm2 status
pm2 logs --lines 50

# Автозапуск
pm2 save
pm2 startup
```

#### Шаг 2.6: Тестирование

**Через MCP (локально):**
```bash
# Обновить Redis tunnel на новый IP
ssh -L 6380:localhost:6379 root@TIMEWEB_VPS_IP -N &

# Отправить тестовое сообщение
mcp__whatsapp__send_message phone:89686484488 message:"Тест Timeweb"

# Проверить логи
ssh root@TIMEWEB_VPS_IP "pm2 logs ai-admin-worker-v2 --lines 50"
```

**Чеклист тестирования:**
- [ ] Health endpoint: `curl http://TIMEWEB_VPS_IP:3000/health`
- [ ] WhatsApp сессии работают
- [ ] Сообщения обрабатываются
- [ ] Redis работает
- [ ] Логи без критических ошибок

#### Шаг 2.7: Переключение DNS

**Если всё работает:**
```bash
# 1. Обновить DNS A-запись
# bot.yourdomain.com → TIMEWEB_VPS_IP

# 2. Остановить старый сервер (на время)
ssh root@46.149.70.219 "pm2 stop all"

# 3. Мониторинг 24 часа
ssh root@TIMEWEB_VPS_IP
pm2 monit
```

---

### Этап 3: Миграция БД на Timeweb PostgreSQL (Неделя 3-8)

**Использовать точно такой же план как в `MIGRATION_152FZ_REQUIRED.md` Этап 2:**

1. Создать production PostgreSQL на Timeweb
2. Разработать Database Adapter
3. Экспорт схемы из Supabase
4. Миграция данных
5. Dual-write режим (7 дней)
6. Dual-read режим (7 дней)
7. Переход на Timeweb PostgreSQL

**Подробности:** См. `MIGRATION_152FZ_REQUIRED.md` → Этап 2

---

## 💰 Стоимость

### Тестирование (Неделя 1)

| Ресурс | Стоимость |
|--------|-----------|
| Тестовый VPS (3 дня) | БЕСПЛАТНО |
| PostgreSQL (пробный) | БЕСПЛАТНО |
| **ИТОГО за тест** | **0₽** |

### Production (после миграции)

| Ресурс | Стоимость/мес |
|--------|---------------|
| VPS (8 CPU / 16GB / 160GB) | ~2,500-3,500₽* |
| Managed PostgreSQL | ~1,500₽ |
| DDoS защита (опция) | +450₽ |
| **ИТОГО/мес** | **~4,000-5,000₽** |

*Точную цену уточнить в калькуляторе: https://timeweb.cloud/prices

### Переходный период (2 месяца)

| Статья | Сумма |
|--------|-------|
| Timeweb VPS | ~3,000₽ × 2 = 6,000₽ |
| Timeweb PostgreSQL | 1,500₽ × 2 = 3,000₽ |
| Старый сервер (резервный) | 500₽ × 2 = 1,000₽ |
| **ИТОГО переходный** | **~10,000₽** |

---

## 🎯 Следующие шаги

### Сегодня:
1. [ ] Зарегистрироваться на https://timeweb.cloud/
2. [ ] Создать тестовый VPS (4 CPU / 8GB) - **3 дня бесплатно**
3. [ ] Создать тестовый PostgreSQL

### Завтра (если тест успешен):
4. [ ] Протестировать производительность
5. [ ] Измерить латентность VPS↔PostgreSQL
6. [ ] Принять финальное решение: Timeweb или AdminVPS+Timeweb

### Через неделю:
7. [ ] Создать production VPS + PostgreSQL на Timeweb
8. [ ] Начать миграцию приложения

---

## ✅ Критерии успеха

**После миграции должно быть:**
- ✅ 152-ФЗ: Соответствует (всё в РФ)
- ✅ Латентность app↔DB: <10ms
- ✅ Производительность: не хуже текущей
- ✅ Стоимость: ~4,000-5,000₽/мес
- ✅ Управление: единая панель
- ✅ Uptime: 99.9%+
- ✅ Managed PostgreSQL: бэкапы, мониторинг

---

## 🔙 Rollback Plan

**Если что-то пошло не так на любом этапе:**

```bash
# Быстрый откат на старый сервер (< 5 минут)
ssh root@46.149.70.219
pm2 start all

# Вернуть DNS на старый IP

# Проверить
pm2 status
```

**Timeweb VPS можно удалить без потерь:**
- Почасовая тарификация
- Платите только за использованное время
- Легко удалить через панель

---

## 📞 Поддержка Timeweb

- **Сайт:** https://timeweb.cloud/
- **Документация:** https://timeweb.cloud/docs
- **Поддержка:** https://timeweb.cloud/help
- **Email:** support@timeweb.com
- **Чат:** Онлайн-чат в панели управления

---

## Заключение

**Рекомендация:** Начать с **3-дневного бесплатного теста** Timeweb VPS.

**Если тест успешен:**
✅ Мигрировать всё на Timeweb Cloud

**Если тест НЕ успешен:**
⚠️ Вернуться к варианту AdminVPS + Timeweb PostgreSQL

**Преимущества Timeweb (всё в одном):**
1. ✅ Единая платформа (проще управление)
2. ✅ Минимальная латентность (<5ms внутри ДЦ)
3. ✅ 152-ФЗ соответствие
4. ✅ Managed PostgreSQL
5. ✅ Бесплатное тестирование 3 дня
6. ✅ Примерно та же цена (~4,000-5,000₽/мес)

**Следующий шаг:** Регистрация на https://timeweb.cloud/ и создание тестового VPS! 🚀

---

*Документ создан: 2025-10-31*
*Следующий шаг: Регистрация на Timeweb Cloud и бесплатный тест*
