# Telegram Bot Quick Reference

Быстрая справка по управлению AI Admin через Telegram бот @AI_Admin_monitor_bot

---

## 🚀 Быстрый старт

1. Открой бота: [@AI_Admin_monitor_bot](https://t.me/AI_Admin_monitor_bot)
2. Отправь `/start` - появится главное меню с кнопками
3. Нажми кнопку меню `/` - увидишь все команды

---

## 📱 Команды

### Основные

| Команда | Описание | Пример вывода |
|---------|----------|---------------|
| `/start` | Главное меню с кнопками | Меню с 8 кнопками |
| `/status` | PM2 процессы (uptime, память, рестарты) | Список всех сервисов |
| `/health` | Детальная проверка здоровья | Redis, DB, WhatsApp, Queue |

### Новые команды 🆕

| Команда | Описание | Когда использовать |
|---------|----------|-------------------|
| `/db_health` | Мониторинг Database Auth State | Проверить размер БД, TTL cleanup |
| `/stats` | Бизнес-аналитика | Узнать количество записей и клиентов |
| `/ai_metrics` | Метрики AI производительности | Проверить скорость и качество AI |

### Управление

| Команда | Описание | Пример |
|---------|----------|--------|
| `/restart [service]` | Перезапуск сервиса | `/restart api` или `/restart all` |
| `/queue` | Состояние очереди | Количество задач |
| `/logs` | Последние ошибки | 20 строк error логов |
| `/test` | Отправить тестовое сообщение | Проверка WhatsApp |

---

## 🎛️ Inline кнопки

### Главное меню

После `/start` появляются кнопки:

```
┌─────────────────────────────────┐
│  📊 Статус  │  🏥 Здоровье       │
├─────────────────────────────────┤
│  💾 DB Health │  📈 Статистика   │
├─────────────────────────────────┤
│  🤖 AI Метрики │  📨 Очередь     │
├─────────────────────────────────┤
│  📜 Логи    │  📱 Тест           │
├─────────────────────────────────┤
│         🔄 Перезапуск            │
└─────────────────────────────────┘
```

**Преимущество:** Не нужно помнить команды - всё в один клик!

---

## 📊 Примеры использования

### 1. Проверить, всё ли работает

**Быстрый способ:**
```
1. /start
2. Нажми "🏥 Здоровье"
3. Смотри статус всех компонентов
```

**Через команду:**
```
/health
```

**Результат:**
```
🏥 Здоровье системы

Общий статус: ✅ ok

Компоненты:
✅ Redis: подключен (100 ключей)
✅ База данных: подключена
✅ WhatsApp: подключен (+79936363848)
✅ Очередь: 0 задач
✅ Память: 148MB (90%)
✅ Последняя активность: 2 мин назад
```

---

### 2. Проверить Database Auth State

**Зачем:** После миграции важно следить, что TTL cleanup работает и ключи не накапливаются.

**Команда:**
```
/db_health
```

**Результат:**
```
💾 Database Auth State

✅ Всего ключей: 45
✅ Истёкших ключей: 0
🕐 Последняя активность: 2 мин назад

Статус:
✅ Отлично - размер БД оптимален
```

**Пороги:**
- `< 100` ключей - ✅ Отлично
- `100-200` - ✅ Нормально (автоочистка работает)
- `200-300` - ⚠️ Внимание (проверить TTL cleanup)
- `> 300` - 🔴 Критично (TTL cleanup сломан!)

---

### 3. Узнать сколько записей сделал AI Admin

**Команда:**
```
/stats
```

**Или через кнопки:**
```
1. /start
2. "📈 Статистика"
3. Выбери период: Сегодня / Неделя / Месяц
```

**Результат:**
```
📈 Статистика за сегодня

📅 Записей создано: 12
👤 Новых клиентов: 3

Популярные услуги:
📊 Всего услуг: 45

[Кнопки выбора периода]
```

---

### 4. Проверить производительность AI

**Команда:**
```
/ai_metrics
```

**Результат:**
```
🤖 AI Performance Metrics (24h)

⚡ Среднее время ответа: 9.42с
✅ Успешных обработок: 98.5%
📊 Всего сообщений: 156

По стадиям:
  stage1: 156
  stage2: 153
```

**Примечание:** Если показывает "Нет данных", значит логирование не настроено в `conversation_logs`.

---

### 5. Перезапустить сервис

**Через кнопки:**
```
1. /start
2. "🔄 Перезапуск"
3. Выбери сервис: API / Worker / WhatsApp / Всё
```

**Через команду:**
```
/restart api         # Перезапустить только API
/restart worker      # Перезапустить только worker
/restart whatsapp    # Перезапустить только WhatsApp
/restart all         # Перезапустить всё
```

**Результат:**
```
🔄 Перезапускаю ai-admin-api...
✅ ai-admin-api перезапущен успешно
```

---

### 6. Проверить очередь сообщений

**Команда:**
```
/queue
```

**Результат:**
```
📊 Состояние очереди:

Всего задач: 0
Ожидающих батчей: 0

Статус: ✅ Нормальная нагрузка
```

**Пороги:**
- `< 20` задач - ✅ Нормально
- `> 20` задач - ⚠️ Высокая нагрузка

---

### 7. Посмотреть последние ошибки

**Команда:**
```
/logs
```

**Результат:**
```
📜 Последние ошибки:

[Последние 20 строк error логов из PM2]

или

✅ Ошибок не найдено в последних логах
```

---

## 🔔 Автоматические алерты

Бот автоматически присылает уведомления при проблемах:

### Критичные (проверяются каждую 1 минуту)

#### WhatsApp отключен
```
🚨 КРИТИЧНО: WhatsApp отключен!

Статус: disconnected
Время: 07.10.2025, 22:00:00

Действия:
1. Проверьте логи: /logs
2. Проверьте статус: /health
3. При необходимости: /restart whatsapp

Автоматический алерт
```

**Cooldown:** 5 минут (не будет спамить чаще)

---

#### База данных недоступна
```
🔴 КРИТИЧНО: База данных недоступна!

Статус: error
Время: 07.10.2025, 22:00:00

Действия:
1. Проверьте Supabase dashboard
2. Проверьте логи: /logs
3. Возможна проблема с сетью

Автоматический алерт
```

**Cooldown:** 5 минут

---

#### Высокая нагрузка очереди
```
⚠️ Высокая нагрузка очереди!

Сообщений в очереди: 75
Порог: 50
Время: 07.10.2025, 22:00:00

Возможные причины:
• Много входящих сообщений
• Медленная обработка AI
• Проблемы с worker

Проверьте: /queue

Автоматический алерт
```

**Порог:** > 50 сообщений
**Cooldown:** 5 минут

---

### Важные (проверяются каждые 5 минут)

#### Database Keys Overflow
```
⚠️ Database Auth State: Много ключей!

Ключей в БД: 250
Порог: 200
Время: 07.10.2025, 22:00:00

Проблема:
TTL cleanup возможно не работает!

Действия:
1. Проверьте: /db_health
2. Проверьте истёкшие ключи
3. Возможно нужна ручная очистка

Автоматический алерт
```

**Порог:** > 200 ключей
**Cooldown:** 15 минут

**⚠️ Важно:** Это значит TTL cleanup сломан! Нужно проверить.

---

#### Высокое использование памяти
```
⚠️ Высокое использование памяти!

Использовано: 85%
Порог: 80%
Память: 420MB
Время: 07.10.2025, 22:00:00

Действия:
1. Проверьте статус: /status
2. Возможно нужен restart
3. Проверьте memory leaks

Автоматический алерт
```

**Порог:** > 80% памяти
**Cooldown:** 15 минут

---

#### Нет активности
```
⚠️ Нет активности!

Последнее сообщение: 45 мин назад
Порог: 30 мин
Время: 07.10.2025, 22:00:00

Возможные причины:
• Система зависла
• Нет входящих сообщений
• Проблемы с WhatsApp webhook

Проверьте: /health

Автоматический алерт
```

**Порог:** > 30 минут без сообщений
**Cooldown:** 30 минут
**Режим:** Silent (без звука)

---

### Ежедневная сводка

Каждый день в **9:00 AM МСК** приходит автоматическая сводка:

```
📊 Ежедневная сводка AI Admin

📅 Вчера (06.10.2025):
• Создано записей: 12
• Новых клиентов: 3

🔧 Система:
• Uptime: 24ч
• Статус: ✅ OK

Для деталей: /stats yesterday

Ежедневная автоматическая сводка
```

**Режим:** Silent (без звука)

---

## 🛠️ Утилиты на сервере

### Очистка очереди

Если очередь застряла, можно очистить вручную:

**1. Очистка BullMQ очереди:**
```bash
ssh -i ~/.ssh/id_ed25519_ai_admin root@46.149.70.219
cd /opt/ai-admin
node scripts/clear-queue.js
```

**2. Очистка старых Redis ключей:**
```bash
node scripts/clear-old-queue-keys.js
```

**Оба скрипта:**
- Имеют 3-секундную задержку для безопасности
- Показывают что будет удалено
- Можно отменить через Ctrl+C

---

## 📖 Дополнительная документация

- `docs/development-diary/2025-10-07-telegram-bot-upgrade-and-monitoring.md` - Полное описание апгрейда
- `docs/WHATSAPP_MONITORING_GUIDE.md` - Мониторинг WhatsApp (устарел - теперь DB)
- `docs/TELEGRAM_ALERTS_TROUBLESHOOTING.md` - Решение проблем с алертами

---

## 💡 Tips & Tricks

### Как узнать, работает ли ProactiveMonitor?

```bash
ssh -i ~/.ssh/id_ed25519_ai_admin root@46.149.70.219
pm2 logs ai-admin-telegram-bot --lines 30 | grep -i monitor
```

Должно быть:
```
info: 🔍 Starting Proactive Monitor...
info: ✅ Proactive Monitor started
```

---

### Как временно отключить алерты?

**Вариант 1:** Остановить мониторинг (не рекомендуется):
```bash
ssh -i ~/.ssh/id_ed25519_ai_admin root@46.149.70.219
pm2 stop ai-admin-telegram-bot
```

**Вариант 2:** Изменить пороги в коде (требует деплоя):
```javascript
// scripts/telegram-bot.js:822-828
this.thresholds = {
  queueSize: 100,         // Было 50, станет 100
  dbKeys: 300,            // Было 200, станет 300
  memory: 95,             // Было 80, станет 95
  noActivityMinutes: 60   // Было 30, станет 60
};
```

---

### Как проверить здоровье через curl?

```bash
curl http://localhost:3000/health | python3 -m json.tool
```

---

## 🚨 Частые вопросы

**Q: Бот не отвечает на команды**
A: Проверь, запущен ли бот: `pm2 list | grep telegram`

**Q: Получаю алерты слишком часто**
A: Проверь cooldown в коде. Возможно, проблема реальная и нужно её решить.

**Q: `/ai_metrics` показывает "Нет данных"**
A: Логирование в `conversation_logs` не настроено. Это нормально пока.

**Q: `/db_health` показывает >200 ключей**
A: TTL cleanup не работает! Проверь истёкшие ключи и настройки БД.

**Q: Как получить сводку не в 9:00, а сейчас?**
A: Используй `/stats` с выбором периода.

---

**Последнее обновление:** 7 октября 2025
