# –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤

## üìä –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

**–¶–µ–ª—å:** –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º–∏ –∏ —Ç–æ—á–Ω—ã–º–∏ –ë–ï–ó —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞

**–ü—Ä–∏–Ω—Ü–∏–ø:** –í–º–µ—Å—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é

## üîç –®–ê–ì 1: –ê–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞

### extractKeywords(message)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```javascript
function extractKeywords(message) {
  const keywords = [];

  // –ò—â–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —É—Å–ª—É–≥
  if (message.match(/—Å—Ç—Ä–∏–∂|–ø–∞—Ä–∏–∫–º–∞—Ö|—É–∫–ª–∞–¥–∫/i))
    keywords.push('—Å—Ç—Ä–∏–∂–∫–∞', '–≤–æ–ª–æ—Å—ã');

  if (message.match(/–º–∞–Ω–∏–∫|–Ω–æ–≥—Ç|–ø–µ–¥–∏–∫/i))
    keywords.push('–º–∞–Ω–∏–∫—é—Ä', '–ø–µ–¥–∏–∫—é—Ä', '–Ω–æ–≥—Ç–∏');

  if (message.match(/–¥–µ—Ç|—Ä–µ–±–µ–Ω|—Å—ã–Ω|–¥–æ—á–∫/i))
    keywords.push('–¥–µ—Ç—Å–∫–∏–π', '–¥–µ—Ç—Å–∫–∞—è');

  // –ò—â–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
  if (message.match(/—Å–µ–≥–æ–¥–Ω—è/i)) keywords.push('today');
  if (message.match(/–∑–∞–≤—Ç—Ä–∞/i)) keywords.push('tomorrow');

  return keywords;
}
```

**–ü—Ä–∏–º–µ—Ä:**
- –°–æ–æ–±—â–µ–Ω–∏–µ: "–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å —Å—ã–Ω–∞ –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞"
- –†–µ–∑—É–ª—å—Ç–∞—Ç: ['–¥–µ—Ç—Å–∫–∏–π', '–¥–µ—Ç—Å–∫–∞—è', '—Å—Ç—Ä–∏–∂–∫–∞', '–≤–æ–ª–æ—Å—ã', 'tomorrow']

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:** –ü–æ–Ω–∏–º–∞–µ–º –æ —á–µ–º –≥–æ–≤–æ—Ä–∏—Ç –∫–ª–∏–µ–Ω—Ç, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–∞–Ω–∏–∫—é—Ä –∫–æ–≥–¥–∞ —Ä–µ—á—å –æ —Å—Ç—Ä–∏–∂–∫–µ

---

## üéØ –®–ê–ì 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è

### detectIntent(message)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—á–µ—Ç –∫–ª–∏–µ–Ω—Ç

```javascript
function detectIntent(message) {
  const messageLower = message.toLowerCase();

  if (messageLower.match(/–∑–∞–ø–∏—Å–∞—Ç|—Ö–æ—á—É|–º–æ–∂–Ω–æ.*–≤—Ä–µ–º—è|—Å–≤–æ–±–æ–¥–Ω/)) {
    return 'booking';  // –ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
  }

  if (messageLower.match(/—Ü–µ–Ω|—Å—Ç–æ–∏–º|—Å—Ç–æ–∏—Ç|–ø—Ä–∞–π—Å/)) {
    return 'pricing';  // –ö–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ü–µ–Ω–∞—Ö
  }

  if (messageLower.match(/—Ä–∞–±–æ—Ç–∞–µ—Ç|–≥—Ä–∞—Ñ–∏–∫/)) {
    return 'schedule'; // –ö–ª–∏–µ–Ω—Ç –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º
  }

  if (messageLower.match(/–æ—Ç–º–µ–Ω|–ø–µ—Ä–µ–Ω–µ—Å/)) {
    return 'cancellation'; // –ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å/–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏
  }

  return 'general';
}
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Å—Ç—Ä–∏–∂–∫–∞?" ‚Üí `pricing`
- "–ú–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞?" ‚Üí `booking`
- "–†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –°–µ—Ä–≥–µ–π –≤ —Å—É–±–±–æ—Ç—É?" ‚Üí `schedule`

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:** –†–∞–∑–Ω—ã–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç —Ä–∞–∑–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –î–ª—è —Ü–µ–Ω –Ω–µ –Ω—É–∂–Ω—ã —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏, –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–µ –Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π –ø—Ä–∞–π—Å.

---

## üìä –®–ê–ì 3: –†–∞—Å—á–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ —É—Å–ª—É–≥

### calculateRelevanceScore(service, keywords, clientHistory)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –û—Ü–µ–Ω–∏–≤–∞–µ—Ç –Ω–∞—Å–∫–æ–ª—å–∫–æ —É—Å–ª—É–≥–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞ –∑–∞–ø—Ä–æ—Å—É

```javascript
function calculateRelevanceScore(service, keywords, clientHistory = []) {
  let score = 0;

  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
  if (clientHistory.includes(service.title)) {
    score += 100;  // –ö–ª–∏–µ–Ω—Ç —É–∂–µ –∑–∞–∫–∞–∑—ã–≤–∞–ª —ç—Ç—É —É—Å–ª—É–≥—É
  }

  // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
  keywords.forEach(keyword => {
    if (service.title.toLowerCase().includes(keyword)) {
      score += 50;  // –£—Å–ª—É–≥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ
    }
  });

  // 3. –ü–µ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö —É—Å–ª—É–≥
  if (service.title.includes('+')) {
    score -= 20;  // "–û–¢–ï–¶ + –°–´–ù" –º–µ–Ω–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ —á–µ–º "–î–ï–¢–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê"
  }

  // 4. –ë–æ–Ω—É—Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º —É—Å–ª—É–≥–∞–º
  if (service.popularity > 0.7) {
    score += 10;
  }

  return score;
}
```

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è "–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å —Å—ã–Ω–∞ –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É":**

| –£—Å–ª—É–≥–∞ | –ò—Å—Ç–æ—Ä–∏—è | –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ | –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è | –ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å | **–ò—Ç–æ–≥–æ** |
|--------|---------|----------------|-------------|--------------|-----------|
| –î–ï–¢–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê | +100 (–∑–∞–∫–∞–∑—ã–≤–∞–ª) | +100 (–¥–µ—Ç—Å–∫–∞—è+—Å—Ç—Ä–∏–∂–∫–∞) | 0 | +10 | **210** |
| –ú–£–ñ–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê | 0 | +50 (—Å—Ç—Ä–∏–∂–∫–∞) | 0 | +10 | **60** |
| –û–¢–ï–¶ + –°–´–ù | 0 | +50 (–¥–µ—Ç—Å–∫–∞—è) | -20 | 0 | **30** |
| –ú–ê–ù–ò–ö–Æ–† | 0 | 0 | 0 | +10 | **10** |

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—ã–±–∏—Ä–∞–µ–º –î–ï–¢–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê (–Ω–∞–∏–±–æ–ª—å—à–∏–π score)

---

## üé® –®–ê–ì 4: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ –Ω–∞–º–µ—Ä–µ–Ω–∏—é

### getContextByIntent(message, fullContext)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –í—ã–±–∏—Ä–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞

```javascript
function getContextByIntent(message, fullContext) {
  const intent = detectIntent(message);

  switch(intent) {
    case 'booking':
      // –î–ª—è –∑–∞–ø–∏—Å–∏ –Ω—É–∂–Ω—ã: —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —É—Å–ª—É–≥–∏, –º–∞—Å—Ç–µ—Ä–∞, –∏—Å—Ç–æ—Ä–∏—è
      return {
        services: getRelevantServices(message, client, services, 6), // –¢–æ–ª—å–∫–æ 6 —É—Å–ª—É–≥
        staff: fullContext.staff.filter(s => s.is_active).slice(0, 5), // –¢–æ–ª—å–∫–æ 5 –º–∞—Å—Ç–µ—Ä–æ–≤
        previousSelection: fullContext.currentSelection,
        clientHistory: client?.last_services?.slice(0, 3)
      };

    case 'pricing':
      // –î–ª—è —Ü–µ–Ω –Ω—É–∂–Ω—ã: –±–æ–ª—å—à–µ —É—Å–ª—É–≥, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      return {
        services: getRelevantServices(message, client, services, 10), // 10 —É—Å–ª—É–≥
        categories: getServiceCategories(services)
      };

    case 'schedule':
      // –î–ª—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω—É–∂–Ω—ã: –º–∞—Å—Ç–µ—Ä–∞, —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã
      return {
        staff: extractStaffName(message) ?
          [findStaff(name)] :  // –ï—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–∞—Å—Ç–µ—Ä
          fullContext.staff.slice(0, 8), // –ò–Ω–∞—á–µ –≤—Å–µ –º–∞—Å—Ç–µ—Ä–∞
        workingHours: company.working_hours
      };
  }
}
```

**–ü—Ä–∏–º–µ—Ä –¥–ª—è "–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É":**

**–ë–ï–ó –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Å—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥):**
```
–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤ –ø—Ä–æ–º–ø—Ç–µ:
- 20 —É—Å–ª—É–≥ (–≤–∫–ª—é—á–∞—è –º–∞–Ω–∏–∫—é—Ä, –ø–µ–¥–∏–∫—é—Ä, –º–∞—Å—Å–∞–∂)
- 10 –º–∞—Å—Ç–µ—Ä–æ–≤ (–≤—Å–µ)
- –ê–¥—Ä–µ—Å –∫–æ–º–ø–∞–Ω–∏–∏
- –¢–µ–ª–µ—Ñ–æ–Ω
- –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã
- –ò—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–∞
–†–∞–∑–º–µ—Ä: ~2000 —Ç–æ–∫–µ–Ω–æ–≤
```

**–° –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π (–Ω–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥):**
```
–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤ –ø—Ä–æ–º–ø—Ç–µ:
- 6 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —É—Å–ª—É–≥ (—Å—Ç—Ä–∏–∂–∫–∏)
- 5 –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤
- –ò—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–∞ (3 –ø–æ—Å–ª–µ–¥–Ω–∏–µ —É—Å–ª—É–≥–∏)
- –ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
–†–∞–∑–º–µ—Ä: ~600 —Ç–æ–∫–µ–Ω–æ–≤
```

---

## üìù –®–ê–ì 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

### –ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç

**–°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥:**
```javascript
const prompt = `
–¢—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ "${company.title}".
–£—Å–ª—É–≥–∏: ${services.slice(0, 20).map(s => s.title).join(', ')} // –í–°–ï —É—Å–ª—É–≥–∏
–ú–∞—Å—Ç–µ—Ä–∞: ${staff.map(s => s.name).join(', ')} // –í–°ÔøΩ –º–∞—Å—Ç–µ—Ä–∞
...
[500+ —Å—Ç—Ä–æ–∫ –ø—Ä–∞–≤–∏–ª –∏ –ø—Ä–∏–º–µ—Ä–æ–≤]
`;
```

**–ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥:**
```javascript
const relevantContext = getContextByIntent(message, fullContext);
const prompt = `
–°–∏—Å—Ç–µ–º–∞ –∫–æ–º–∞–Ω–¥ –¥–ª—è "${company.title}".
–ó–ê–î–ê–ß–ê: –°–æ–æ–±—â–µ–Ω–∏–µ ‚Üí JSON –∫–æ–º–∞–Ω–¥—ã

–ö–û–ù–¢–ï–ö–°–¢:
${client?.name ? `- ${client.name}` : `- ${phone}`}
${relevantContext.clientHistory ? `- –û–±—ã—á–Ω–æ: ${clientHistory.join(', ')}` : ''}
- –£—Å–ª—É–≥–∏: ${relevantContext.services.map(s => s.title).join(', ')} // –¢–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ
- –ú–∞—Å—Ç–µ—Ä–∞: ${relevantContext.staff.map(s => s.name).join(', ')} // –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ

–ü–†–ê–í–ò–õ–ê: ${getContextualRules(message)} // –¢–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

–°–û–û–ë–©–ï–ù–ò–ï: "${message}"
`;
```

---

## üé≠ –®–ê–ì 6: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ AI –∏ –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ –æ—Ç–≤–µ—Ç–∞

### selectTemplate(command, result, context)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –í—ã–±–∏—Ä–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

```javascript
function selectTemplate(command, result, context) {
  if (command === 'SEARCH_SLOTS') {
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if (result.data?.requiresServiceSelection) {
      // –ù—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å —É—Å–ª—É–≥—É
      return context.client?.last_services?.length > 0 ?
        templates.needsService.withHistory :  // –£ –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è
        templates.needsService.noHistory;      // –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
    }

    if (result.data?.slots?.length > 0) {
      // –ï—Å—Ç—å —Å–ª–æ—Ç—ã - –≤—ã–±–∏—Ä–∞–µ–º —Ñ–æ—Ä–º–∞—Ç
      if (slots.length <= 3) {
        return templates.hasSlots.compact; // –ú–∞–ª–æ —Å–ª–æ—Ç–æ–≤ - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
      }

      // –ú–Ω–æ–≥–æ —Å–ª–æ—Ç–æ–≤ - –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
      const categorized = categorizeTimeSlots(slots);
      if (onlyMorning) return templates.hasSlots.morning;
      if (onlyAfternoon) return templates.hasSlots.afternoon;
      if (onlyEvening) return templates.hasSlots.evening;
      return templates.hasSlots.mixed;
    }

    // –ù–µ—Ç —Å–ª–æ—Ç–æ–≤
    return templates.noSlots.standard;
  }
}
```

**–ü—Ä–∏–º–µ—Ä—ã –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–∞:**

| –°–∏—Ç—É–∞—Ü–∏—è | –í—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|----------|------------------|-----------|
| 3 —Å–ª–æ—Ç–∞ –Ω–∞–π–¥–µ–Ω–æ | `compact` | "–ï—Å—Ç—å –≤—Ä–µ–º—è: 10:00, 14:00, 17:00. –ö–∞–∫–æ–µ –ø–æ–¥–æ–π–¥—ë—Ç?" |
| 15 —Å–ª–æ—Ç–æ–≤ —É—Ç—Ä–æ–º | `morning` | "–£—Ç—Ä–æ–º —Å–≤–æ–±–æ–¥–Ω–æ: [—Å–ª–æ—Ç—ã]\n–ù–∞ –∫–∞–∫–æ–µ –∑–∞–ø–∏—Å–∞—Ç—å?" |
| –ù—É–∂–Ω–∞ —É—Å–ª—É–≥–∞, –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è | `withHistory` | "–ê—Ä—Å–µ–Ω, –æ–±—ã—á–Ω–æ –≤—ã –≤—ã–±–∏—Ä–∞–µ—Ç–µ: –°–¢–†–ò–ñ–ö–ê, –ë–û–†–û–î–ê.\n–ö–∞–∫—É—é —É—Å–ª—É–≥—É?" |
| –ù–µ—Ç —Å–ª–æ—Ç–æ–≤ | `noSlots` | "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –≤—Å–µ –∑–∞–Ω—è—Ç–æ." |

---

## üîß –®–ê–ì 7: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏

### renderTemplate(template, data)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ó–∞–ø–æ–ª–Ω—è–µ—Ç —à–∞–±–ª–æ–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

```javascript
function renderTemplate(template, data) {
  // –®–∞–±–ª–æ–Ω: "{{name}}, –∑–∞–ø–∏—Å–∞–ª –Ω–∞ {{service}} {{date}} –≤ {{time}}"

  // –î–∞–Ω–Ω—ã–µ:
  const data = {
    name: "–ê—Ä—Å–µ–Ω",
    service: "—Å—Ç—Ä–∏–∂–∫—É",
    date: "–∑–∞–≤—Ç—Ä–∞",
    time: "14:00"
  };

  // –†–µ–∑—É–ª—å—Ç–∞—Ç: "–ê—Ä—Å–µ–Ω, –∑–∞–ø–∏—Å–∞–ª –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞ –≤ 14:00"

  return template.replace(/\{\{(\w+)\}\}/g, (match, key) => {
    return data[key] || '';
  });
}
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**

1. **–£—Å–ª–æ–≤–Ω—ã–µ –±–ª–æ–∫–∏:**
```javascript
template = "{{?name}}{{name}}, {{/name}}–∑–∞–ø–∏—Å–∞–ª –Ω–∞ {{service}}";
// –ï—Å–ª–∏ –µ—Å—Ç—å –∏–º—è: "–ê—Ä—Å–µ–Ω, –∑–∞–ø–∏—Å–∞–ª –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É"
// –ï—Å–ª–∏ –Ω–µ—Ç –∏–º–µ–Ω–∏: "–∑–∞–ø–∏—Å–∞–ª –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É"
```

2. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```javascript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
slots = ["10:00", "14:00", "18:00"];
result = "–£—Ç—Ä–æ–º: 10:00\n–î–Ω—ë–º: 14:00\n–í–µ—á–µ—Ä–æ–º: 18:00";
```

---

## üìà –ò–¢–û–ì–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ "–î–æ" –∏ "–ü–æ—Å–ª–µ"

**–ë–´–õ–û (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥):**
```
–ü—Ä–æ–º–ø—Ç: 2000 —Ç–æ–∫–µ–Ω–æ–≤
‚îú‚îÄ‚îÄ –í—Å–µ 20 —É—Å–ª—É–≥ (–¥–∞–∂–µ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ)
‚îú‚îÄ‚îÄ –í—Å–µ 10 –º–∞—Å—Ç–µ—Ä–æ–≤
‚îú‚îÄ‚îÄ 500 —Å—Ç—Ä–æ–∫ –ø—Ä–∞–≤–∏–ª
‚îú‚îÄ‚îÄ 12 –ø—Ä–∏–º–µ—Ä–æ–≤
‚îî‚îÄ‚îÄ –ñ–µ—Å—Ç–∫–∏–µ —à–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤

–û—Ç–≤–µ—Ç: –®–∞–±–ª–æ–Ω–Ω—ã–π, –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π
–°–∫–æ—Ä–æ—Å—Ç—å: 3-4 —Å–µ–∫—É–Ω–¥—ã
–¢–æ—á–Ω–æ—Å—Ç—å: 70% (—á–∞—Å—Ç–æ –≤—ã–±–∏—Ä–∞–µ—Ç –Ω–µ —Ç–µ —É—Å–ª—É–≥–∏)
```

**–°–¢–ê–õ–û (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥):**
```
–ü—Ä–æ–º–ø—Ç: 600 —Ç–æ–∫–µ–Ω–æ–≤
‚îú‚îÄ‚îÄ 6 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —É—Å–ª—É–≥ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞)
‚îú‚îÄ‚îÄ 5 –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤
‚îú‚îÄ‚îÄ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (3-5 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ –ë–µ–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω—ã)
‚îî‚îÄ‚îÄ 30+ –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤

–û—Ç–≤–µ—Ç: –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω—ã–π
–°–∫–æ—Ä–æ—Å—Ç—å: 1.5-2 —Å–µ–∫—É–Ω–¥—ã
–¢–æ—á–Ω–æ—Å—Ç—å: 95% (–ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç —É—Å–ª—É–≥–∏)
```

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

1. **–ú–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤** = –¥–µ—à–µ–≤–ª–µ API –∑–∞–ø—Ä–æ—Å—ã
2. **–í—ã—à–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å** = —Ç–æ—á–Ω–µ–µ –æ—Ç–≤–µ—Ç—ã
3. **–ë–æ–ª—å—à–µ –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å** = –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ –¥–∏–∞–ª–æ–≥
4. **–ë—ã—Å—Ç—Ä–µ–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞** = –ª—É—á—à–µ UX

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ, ‚ùå –ù–ï –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ

### –ß—Ç–æ —É–∂–µ —Å–æ–∑–¥–∞–Ω–æ:
- ‚úÖ `context-optimizer.js` - –º–æ–¥—É–ª—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- ‚úÖ `response-templates.js` - —Å–∏—Å—Ç–µ–º–∞ —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ß—Ç–æ –ù–ï —Å–¥–µ–ª–∞–Ω–æ:
- ‚ùå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `two-stage-command-prompt.js`
- ‚ùå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `two-stage-response-prompt.js`
- ‚ùå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ production
- ‚ùå –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —É—Ç–∏–ª–∏—Ç

### –ü–æ—á–µ–º—É –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ:
1. **–¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
2. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ** - –ª—É—á—à–µ –≤–Ω–µ–¥—Ä—è—Ç—å –ø–æ —á–∞—Å—Ç—è–º —Å A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
3. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å (–ø–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

### –®–∞–≥ 1: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è context-optimizer.js
```javascript
// –í two-stage-command-prompt.js
const { getContextByIntent, getRelevantServices } = require('../utils/context-optimizer');

// –í–º–µ—Å—Ç–æ:
const servicesList = services.slice(0, 20).map(s => s.title).join(', ');

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
const relevantContext = getContextByIntent(message, context);
const servicesList = relevantContext.services.map(s => s.title).join(', ');
```

### –®–∞–≥ 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è response-templates.js
```javascript
// –í two-stage-response-prompt.js
const { generateFromTemplate } = require('../utils/response-templates');

// –í–º–µ—Å—Ç–æ 200+ —Å—Ç—Ä–æ–∫ formatCommandResults
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
const formattedResults = commandResults.map(result =>
  generateFromTemplate(result.command, result, context)
).join('\n\n');
```

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
2. –ü—Ä–æ–≥–Ω–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
3. –°—Ä–∞–≤–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π

### –®–∞–≥ 4: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ
1. –í–∫–ª—é—á–∏—Ç—å –¥–ª—è 10% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
3. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ - —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–æ 100%

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –°–µ–π—á–∞—Å | –ü–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ |
|---------|--------|------------------|
| –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤ | ~4,900 —Ç–æ–∫–µ–Ω–æ–≤ | ~2,500 —Ç–æ–∫–µ–Ω–æ–≤ |
| –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ | 9.4 —Å–µ–∫—É–Ω–¥—ã | ~5 —Å–µ–∫—É–Ω–¥ |
| –¢–æ—á–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥ | 70-80% | 95%+ |
| –í–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ | 5 —à–∞–±–ª–æ–Ω–æ–≤ | 30+ —à–∞–±–ª–æ–Ω–æ–≤ |
| –°—Ç–æ–∏–º–æ—Å—Ç—å API | $X | $X * 0.5 |

## üîß –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

–ú–æ–¥—É–ª–∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é, –Ω–æ —Ç—Ä–µ–±—É—é—Ç:
1. –ò–º–ø–æ—Ä—Ç–∞ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–º–ø—Ç—ã
2. –ó–∞–º–µ–Ω—ã —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–¥–∞ –Ω–∞ –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ—Å–æ–≤ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–∏–∑–Ω–µ—Å

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Å–∏—Å—Ç–µ–º–µ –±—ã—Ç—å **—É–º–Ω–µ–µ** –ø—Ä–∏ **–º–µ–Ω—å—à–∏—Ö –∑–∞—Ç—Ä–∞—Ç–∞—Ö**, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏!