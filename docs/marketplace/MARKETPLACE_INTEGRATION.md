# üîó YClients Marketplace Integration

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#–æ–±–∑–æ—Ä-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
3. [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
4. [–ü—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è](#–ø—Ä–æ—Ü–µ—Å—Å-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
5. [API Endpoints](#api-endpoints)
6. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
7. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
8. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∏-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
9. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
10. [–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ](#—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)

## üéØ –û–±–∑–æ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

AI Admin –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å YClients Marketplace, –ø–æ–∑–≤–æ–ª—è—è —Å–∞–ª–æ–Ω–∞–º –∫—Ä–∞—Å–æ—Ç—ã –ø–æ–¥–∫–ª—é—á–∞—Ç—å WhatsApp –±–æ—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏.

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ WhatsApp
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, —É—Å–ª—É–≥ –∏ –º–∞—Å—Ç–µ—Ä–æ–≤
- ‚úÖ –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–Ω–∞—Ö –∏ —É—Å–ª—É–≥–∞—Ö 24/7
- ‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –≤–∏–∑–∏—Ç–∞—Ö
- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å –∏ –æ—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –°–±–æ—Ä –æ—Ç–∑—ã–≤–æ–≤ –ø–æ—Å–ª–µ –≤–∏–∑–∏—Ç–∞

### URL –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:
- **Production**: https://ai-admin.app/marketplace/
- **API Base**: https://ai-admin.app/marketplace/
- **WebSocket**: wss://ai-admin.app/marketplace

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ
‚îÇ  YClients App   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   AI Admin      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   WhatsApp      ‚îÇ
‚îÇ   Marketplace   ‚îÇ     ‚îÇ   Integration   ‚îÇ     ‚îÇ     Baileys     ‚îÇ
‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚ñº                       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ
‚îÇ  YClients API   ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    Supabase     ‚îÇ     ‚îÇ  WhatsApp API   ‚îÇ
‚îÇ                 ‚îÇ     ‚îÇ    Database     ‚îÇ     ‚îÇ                 ‚îÇ
‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:
1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è**: YClients ‚Üí AI Admin ‚Üí Database
2. **QR Generation**: AI Admin ‚Üí Baileys ‚Üí WebSocket ‚Üí Client
3. **WhatsApp Connection**: Client ‚Üí QR Scan ‚Üí Baileys ‚Üí AI Admin
4. **Message Processing**: WhatsApp ‚Üí Baileys ‚Üí AI Admin ‚Üí AI Service ‚Üí YClients API

## üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. MarketplaceService (`src/services/marketplace/marketplace-service.js`)
–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π:
- –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏—è–º–∏
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è API –∫–ª—é—á–µ–π
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å YClients

### 2. BaileysManager (`src/integrations/whatsapp/baileys-manager.js`)
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ WhatsApp —Å–µ—Å—Å–∏—è–º–∏:
- Multi-tenant –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

### 3. MarketplaceSocket (`src/api/websocket/marketplace-socket.js`)
WebSocket —Å–µ—Ä–≤–µ—Ä –¥–ª—è real-time –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏:
- –ü–µ—Ä–µ–¥–∞—á–∞ QR-–∫–æ–¥–æ–≤
- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –°–æ–±—ã—Ç–∏—è WhatsApp
- Rate limiting

### 4. API Routes (`src/api/routes/marketplace.js`)
REST API endpoints:
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–ø–∞–Ω–∏–π
- –ü–æ–ª—É—á–µ–Ω–∏–µ QR-–∫–æ–¥–æ–≤
- Webhooks –æ—Ç YClients
- –°—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## üöÄ –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### –®–∞–≥ 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ
```bash
POST /marketplace/register
{
  "salon_id": 962302,
  "phone": "+79001234567",
  "email": "salon@example.com"
}
```

### –®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏ URL
```json
{
  "success": true,
  "company_id": 15,
  "salon_id": 962302,
  "api_key": "sk_...",
  "connect_url": "/marketplace/connect?token=..."
}
```

### –®–∞–≥ 3: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WhatsApp
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `connect_url`
2. –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥ WhatsApp
3. –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è callback –≤ YClients

### –®–∞–≥ 4: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
- –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `active`
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ë–æ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è

## üì° API Endpoints

### –ü—É–±–ª–∏—á–Ω—ã–µ endpoints

#### GET /marketplace/
–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **Response**: HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞

#### GET /marketplace/connect
–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WhatsApp
- **Query params**:
  - `token` - —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  - `company` - ID –∫–æ–º–ø–∞–Ω–∏–∏
  - `salon` - ID —Å–∞–ª–æ–Ω–∞
- **Response**: HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å QR-–∫–æ–¥–æ–º

#### GET /marketplace/test
–¢–µ—Å—Ç–æ–≤—ã–π endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- **Response**:
```json
{
  "success": true,
  "status": "ok",
  "endpoints": {...},
  "message": "Marketplace integration endpoints are ready"
}
```

### –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ endpoints

#### POST /marketplace/register
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
- **Body**:
```json
{
  "salon_id": 123456,
  "phone": "+79001234567",
  "email": "salon@example.com"
}
```
- **Response**:
```json
{
  "success": true,
  "company_id": 1,
  "salon_id": 123456,
  "api_key": "sk_...",
  "connect_url": "/marketplace/connect?..."
}
```

#### GET /marketplace/qr/:token
–ü–æ–ª—É—á–µ–Ω–∏–µ QR-–∫–æ–¥–∞ –¥–ª—è WhatsApp
- **Params**:
  - `token` - —Ç–æ–∫–µ–Ω —Å–µ—Å—Å–∏–∏
- **Response**:
```json
{
  "success": true,
  "qr": "data:image/png;base64,...",
  "expires_in": 20
}
```

#### GET /marketplace/status/:companyId
–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- **Params**:
  - `companyId` - ID –∫–æ–º–ø–∞–Ω–∏–∏
- **Response**:
```json
{
  "success": true,
  "company_id": 1,
  "whatsapp_connected": true,
  "whatsapp_phone": "+79001234567",
  "integration_status": "active",
  "connected_at": "2024-01-01T12:00:00Z"
}
```

#### POST /marketplace/callback
Callback –¥–ª—è YClients –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- **Body**:
```json
{
  "salon_id": 123456,
  "company_id": 1,
  "status": "connected",
  "whatsapp_phone": "+79001234567",
  "api_key": "sk_..."
}
```

#### POST /marketplace/webhook/:companyId
Webhook –¥–ª—è —Å–æ–±—ã—Ç–∏–π –æ—Ç YClients
- **Params**:
  - `companyId` - ID –∫–æ–º–ø–∞–Ω–∏–∏
- **Body**: –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç YClients

#### GET /marketplace/companies
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π (—Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á)
- **Headers**:
  - `X-API-Key` - API –∫–ª—é—á –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- **Response**:
```json
{
  "success": true,
  "stats": {
    "total": 100,
    "connected": 85
  }
}
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### JWT Authentication
- –í—Å–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã JWT —Å —Å–µ–∫—Ä–µ—Ç–æ–º –∏–∑ `JWT_SECRET`
- –°—Ä–æ–∫ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞: 24 —á–∞—Å–∞
- Payload —Å–æ–¥–µ—Ä–∂–∏—Ç `company_id` –∏ `iat`

### –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- –í—Å–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é
- SQL injection –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- XSS –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—é HTML
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤, email, ID

### Rate Limiting
- WebSocket: –º–∞–∫—Å–∏–º—É–º 5 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∑–∞ 60 —Å–µ–∫—É–Ω–¥ —Å –æ–¥–Ω–æ–≥–æ IP
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ rate limiter –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- DDoS –∑–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ nginx

### CORS –∏ Origin –ø—Ä–æ–≤–µ—Ä–∫–∞
- –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ origins –≤ production:
  - https://ai-admin.app
  - https://yclients.com
  - https://n*.yclients.com

## üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ companies
```sql
CREATE TABLE companies (
  id SERIAL PRIMARY KEY,
  company_id INTEGER,
  yclients_id INTEGER,
  title VARCHAR(255),
  phone VARCHAR(20),
  email VARCHAR(100),
  address VARCHAR(500),
  timezone VARCHAR(50) DEFAULT 'Europe/Moscow',

  -- WhatsApp –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
  whatsapp_connected BOOLEAN DEFAULT FALSE,
  whatsapp_phone VARCHAR(20),
  whatsapp_connected_at TIMESTAMPTZ,
  integration_status VARCHAR(50) DEFAULT 'pending',
  connected_at TIMESTAMPTZ,

  -- –§–ª–∞–≥–∏
  ai_enabled BOOLEAN DEFAULT TRUE,
  sync_enabled BOOLEAN DEFAULT TRUE,
  whatsapp_enabled BOOLEAN DEFAULT FALSE,

  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  raw_data JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_companies_whatsapp_connected
ON companies(whatsapp_connected)
WHERE whatsapp_connected = true;

CREATE INDEX idx_companies_whatsapp_phone
ON companies(whatsapp_phone)
WHERE whatsapp_phone IS NOT NULL;
```

### Redis —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```
marketplace:token:{token} -> companyId (TTL: 24h)
marketplace:company:{companyId}:token -> token (TTL: 24h)
marketplace:qr:{companyId} -> {generated_at, qr} (TTL: 20s)
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–í—Å–µ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:
- `‚úÖ` - —É—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `‚ùå` - –æ—à–∏–±–∫–∏
- `‚ö†Ô∏è` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- `üì±` - WhatsApp —Å–æ–±—ã—Ç–∏—è
- `üîÑ` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- `üì®` - webhooks

### –ú–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π
- –°—Ç–∞—Ç—É—Å WhatsApp —Å–µ—Å—Å–∏–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API
- Rate limit —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### PM2 –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```bash
# –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
pm2 status

# –õ–æ–≥–∏ API
pm2 logs ai-admin-api

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
pm2 monit
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
```bash
# –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
node tests/manual/test-marketplace-integration.js

# –¢–µ—Å—Ç –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
node tests/manual/test-baileys-direct.js
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ endpoints
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
curl https://ai-admin.app/marketplace/test

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)
curl -X POST https://ai-admin.app/marketplace/register \
  -H "Content-Type: application/json" \
  -d '{"salon_id": 999999}'
```

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Node.js 18+
- Redis 6+
- PostgreSQL 14+ (Supabase)
- PM2 –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
- Nginx –¥–ª—è reverse proxy
- SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
JWT_SECRET=<secure-random-string>
YCLIENTS_API_KEY=<yclients-api-key>
SUPABASE_URL=<supabase-url>
SUPABASE_KEY=<supabase-service-key>
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=<redis-password>

# WhatsApp
WHATSAPP_PROVIDER=baileys
WHATSAPP_MULTI_TENANT=true
WHATSAPP_SESSIONS_PATH=./sessions

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
NODE_ENV=production
PORT=3000
LOG_LEVEL=info
```

### –î–µ–ø–ª–æ–π –Ω–∞ production
```bash
# 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone https://github.com/vosarsen/ai_admin_v2.git
cd ai_admin_v2

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
npm install

# 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env

# 4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
node scripts/apply-whatsapp-migration.js

# 5. –ó–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PM2
pm2 start ecosystem.config.js

# 6. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Nginx
sudo cp nginx/ai-admin.conf /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/ai-admin.conf /etc/nginx/sites-enabled/
sudo nginx -s reload
```

## üîß Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: QR-–∫–æ–¥ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ Baileys manager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `pm2 logs ai-admin-api --lines 100`

### –ü—Ä–æ–±–ª–µ–º–∞: WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å JWT_SECRET –≤ .env
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ headers
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞: Callback –≤ YClients –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å YCLIENTS_API_KEY
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ webhook URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ webhook —Å–æ–±—ã—Ç–∏–π

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ WhatsApp –∫–æ–ª–æ–Ω–æ–∫ –≤ –ë–î
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: `node scripts/apply-whatsapp-migration.js`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ Supabase

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API](./MARKETPLACE_API.md)
- [–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ](./MARKETPLACE_SETUP.md)
- [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](./MARKETPLACE_SECURITY.md)
- [YClients API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../YCLIENTS_API.md)
- [Changelog](../CHANGELOG.md)

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

- Email: support@ai-admin.app
- Telegram: @ai_admin_support
- GitHub Issues: https://github.com/vosarsen/ai_admin_v2/issues

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 16 —Å–µ–Ω—Ç—è–±—Ä—è 2024*