# üõ†Ô∏è YClients Marketplace - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
2. [–ö–ª–∞—Å—Å—ã –∏ —Å–µ—Ä–≤–∏—Å—ã](#–∫–ª–∞—Å—Å—ã-–∏-—Å–µ—Ä–≤–∏—Å—ã)
3. [WebSocket –ø—Ä–æ—Ç–æ–∫–æ–ª](#websocket-–ø—Ä–æ—Ç–æ–∫–æ–ª)
4. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
5. [–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
6. [–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ](#–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –î–∏–∞–≥—Ä–∞–º–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Frontend Layer                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  connect.html  ‚îÇ  index.html  ‚îÇ  Socket.io Client        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     API Layer                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Express Router  ‚îÇ  WebSocket Server  ‚îÇ  Middleware      ‚îÇ
‚îÇ  /marketplace/*  ‚îÇ  /marketplace ns    ‚îÇ  Auth/CORS      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Service Layer                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  MarketplaceService  ‚îÇ  BaileysManager  ‚îÇ  YclientsClient‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Data Layer                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ     Supabase DB      ‚îÇ      Redis Cache     ‚îÇ   Sessions ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üì¶ –ö–ª–∞—Å—Å—ã –∏ —Å–µ—Ä–≤–∏—Å—ã

### MarketplaceService

```javascript
class MarketplaceService {
  constructor() {
    this.supabase = supabase;
    this.redis = null; // Initialized in init()
    this.yclients = new YclientsClient();
    this.baileysManager = new BaileysManager();
  }

  // –ú–µ—Ç–æ–¥—ã
  async init()                          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis
  async createOrGetCompany(salonId)     // –°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
  async fetchSalonInfo(salonId)         // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–∞–ª–æ–Ω–∞
  detectBusinessType(salonInfo)         // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –±–∏–∑–Ω–µ—Å–∞
  generateAPIKey()                       // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è API –∫–ª—é—á–∞
  async saveToken(token, companyId)     // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
  async validateToken(token, companyId) // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
  async generateQR(companyId)           // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞
  async getCompany(companyId)           // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
  async sendCallbackToYClients(data)    // –û—Ç–ø—Ä–∞–≤–∫–∞ callback
  async handleWebhook(companyId, data)  // –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook
  async updateWhatsAppStatus(...)       // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
  async getConnectionStats()            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
}
```

### BaileysManager

```javascript
class BaileysManager extends EventEmitter {
  constructor() {
    super();
    this.sessions = new Map(); // companyId -> session
    this.sessionsPath = path.join(process.cwd(), 'sessions');
  }

  // –ú–µ—Ç–æ–¥—ã
  async initializeManager()                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  async generateQRForCompany(companyId)        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR
  async createNewSession(companyId)            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
  setupEventHandlers(companyId, sock, creds)   // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
  async sendTestMessage(sock, companyId)       // –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  async sendMessage(companyId, phone, text)    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  formatPhoneNumber(phone)                     // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞
  getSessionStatus(companyId)                  // –°—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏
  async disconnectSession(companyId)           // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
  getActiveSessions()                          // –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
}
```

### MarketplaceSocket

```javascript
class MarketplaceSocket {
  constructor(io) {
    this.io = io;
    this.baileysManager = new BaileysManager();
    this.connections = new Map();     // companyId -> socket
    this.rateLimiter = new Map();    // IP -> { count, lastReset }
    this.namespace = io.of('/marketplace');
  }

  // –ú–µ—Ç–æ–¥—ã
  setupHandlers()                              // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
  async startWhatsAppConnection(socket, id)    // –ó–∞–ø—É—Å–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  async sendQRCode(socket, companyId)         // –û—Ç–ø—Ä–∞–≤–∫–∞ QR
  async startOnboarding(companyId, phone)     // –û–Ω–±–æ—Ä–¥–∏–Ω–≥
  checkRateLimit(ip)                          // –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit
  startCleanupTimer()                         // –û—á–∏—Å—Ç–∫–∞ rate limiter
  sendToCompany(companyId, event, data)       // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π
}
```

## üîå WebSocket –ø—Ä–æ—Ç–æ–∫–æ–ª

### –°–æ–±—ã—Ç–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É

#### connection
```javascript
{
  auth: {
    token: "JWT_TOKEN"  // –í headers, –Ω–µ –≤ query!
  },
  query: {
    companyId: "123",
    token: "TOKEN"      // Fallback –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  }
}
```

#### request-qr
```javascript
// –ó–∞–ø—Ä–æ—Å –Ω–æ–≤–æ–≥–æ QR-–∫–æ–¥–∞
// Payload: –Ω–µ—Ç
```

#### disconnect
```javascript
// –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
// Payload: –Ω–µ—Ç
```

### –°–æ–±—ã—Ç–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∫ –∫–ª–∏–µ–Ω—Ç—É

#### qr-update
```javascript
{
  qr: "data:image/png;base64,...",  // Base64 QR-–∫–æ–¥
  expiresIn: 20                     // –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
}
```

#### whatsapp-connected
```javascript
{
  success: true,
  phone: "+79001234567",
  companyId: 123,
  message: "WhatsApp —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!"
}
```

#### error
```javascript
{
  message: "–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏",
  code: "ERROR_CODE"  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}
```

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ö–æ–¥—ã –æ—à–∏–±–æ–∫

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | HTTP Status | –î–µ–π—Å—Ç–≤–∏–µ |
|-----|----------|-------------|----------|
| `INVALID_TOKEN` | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫—à–∏–π —Ç–æ–∫–µ–Ω | 401 | –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é |
| `RATE_LIMIT` | –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ | 429 | –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–π–º–µ—Ä –æ–∂–∏–¥–∞–Ω–∏—è |
| `QR_EXPIRED` | QR-–∫–æ–¥ –∏—Å—Ç–µ–∫ | 410 | –ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—ã–π QR |
| `CONNECTION_FAILED` | –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å WhatsApp | 500 | –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É |
| `COMPANY_NOT_FOUND` | –ö–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ | 404 | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ID |
| `REDIS_ERROR` | –û—à–∏–±–∫–∞ Redis | 503 | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback |
| `DB_ERROR` | –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö | 503 | –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫ |

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

```javascript
// Retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
async function retryWithBackoff(fn, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      const delay = Math.pow(2, i) * 1000;
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
}

// Circuit Breaker –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API
class CircuitBreaker {
  constructor(threshold = 5, timeout = 60000) {
    this.failures = 0;
    this.threshold = threshold;
    this.timeout = timeout;
    this.state = 'CLOSED';
    this.nextAttempt = Date.now();
  }

  async call(fn) {
    if (this.state === 'OPEN') {
      if (Date.now() < this.nextAttempt) {
        throw new Error('Circuit breaker is OPEN');
      }
      this.state = 'HALF_OPEN';
    }

    try {
      const result = await fn();
      this.onSuccess();
      return result;
    } catch (error) {
      this.onFailure();
      throw error;
    }
  }

  onSuccess() {
    this.failures = 0;
    this.state = 'CLOSED';
  }

  onFailure() {
    this.failures++;
    if (this.failures >= this.threshold) {
      this.state = 'OPEN';
      this.nextAttempt = Date.now() + this.timeout;
    }
  }
}
```

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### 1. Connection Pooling
```javascript
// Redis connection pool
const redisPool = {
  clients: [],
  maxClients: 10,

  async getClient() {
    if (this.clients.length > 0) {
      return this.clients.pop();
    }
    return createRedisClient();
  },

  releaseClient(client) {
    if (this.clients.length < this.maxClients) {
      this.clients.push(client);
    } else {
      client.quit();
    }
  }
};
```

#### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
```javascript
// LRU Cache –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π
class LRUCache {
  constructor(maxSize = 100) {
    this.cache = new Map();
    this.maxSize = maxSize;
  }

  get(key) {
    if (!this.cache.has(key)) return null;
    const value = this.cache.get(key);
    this.cache.delete(key);
    this.cache.set(key, value);
    return value;
  }

  set(key, value) {
    if (this.cache.has(key)) {
      this.cache.delete(key);
    } else if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    this.cache.set(key, value);
  }
}
```

#### 3. Batch Processing
```javascript
// Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook —Å–æ–±—ã—Ç–∏–π
class WebhookBatcher {
  constructor(batchSize = 10, flushInterval = 5000) {
    this.batch = [];
    this.batchSize = batchSize;
    this.flushInterval = flushInterval;
    this.timer = null;
  }

  add(webhook) {
    this.batch.push(webhook);

    if (this.batch.length >= this.batchSize) {
      this.flush();
    } else if (!this.timer) {
      this.timer = setTimeout(() => this.flush(), this.flushInterval);
    }
  }

  async flush() {
    if (this.batch.length === 0) return;

    const batch = this.batch.splice(0);
    clearTimeout(this.timer);
    this.timer = null;

    await this.processBatch(batch);
  }

  async processBatch(batch) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–∫–µ—Ç–∞ webhooks
    await Promise.all(batch.map(webhook =>
      this.processWebhook(webhook)
    ));
  }
}
```

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```javascript
// Prometheus –º–µ—Ç—Ä–∏–∫–∏
const promClient = require('prom-client');

// –°—á–µ—Ç—á–∏–∫–∏
const httpRequestDuration = new promClient.Histogram({
  name: 'marketplace_http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status']
});

const whatsappConnections = new promClient.Gauge({
  name: 'marketplace_whatsapp_connections',
  help: 'Number of active WhatsApp connections',
  labelNames: ['status']
});

const qrGenerations = new promClient.Counter({
  name: 'marketplace_qr_generations_total',
  help: 'Total number of QR code generations',
  labelNames: ['company_id']
});

// Middleware –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫
app.use((req, res, next) => {
  const start = Date.now();

  res.on('finish', () => {
    const duration = (Date.now() - start) / 1000;
    httpRequestDuration
      .labels(req.method, req.route?.path || req.path, res.statusCode)
      .observe(duration);
  });

  next();
});
```

## üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 1. Load Balancing
```nginx
upstream ai_admin_cluster {
    least_conn;
    server 127.0.0.1:3000 weight=1;
    server 127.0.0.1:3001 weight=1;
    server 127.0.0.1:3002 weight=1;
}

server {
    location /marketplace {
        proxy_pass http://ai_admin_cluster;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### 2. Redis Pub/Sub –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
```javascript
// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è WebSocket —Å–æ–±—ã—Ç–∏–π –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏
class ClusterSync {
  constructor(redis) {
    this.pub = redis.duplicate();
    this.sub = redis.duplicate();
    this.sub.subscribe('marketplace:events');
  }

  broadcast(event, data) {
    this.pub.publish('marketplace:events', JSON.stringify({
      event,
      data,
      sender: process.pid
    }));
  }

  onMessage(handler) {
    this.sub.on('message', (channel, message) => {
      const { event, data, sender } = JSON.parse(message);
      if (sender !== process.pid) {
        handler(event, data);
      }
    });
  }
}
```

#### 3. Session Affinity
```javascript
// Sticky sessions –¥–ª—è WebSocket
const sessionStore = new Map();

io.use((socket, next) => {
  const sessionId = socket.handshake.query.sessionId;

  if (sessionId && sessionStore.has(sessionId)) {
    socket.sessionId = sessionId;
  } else {
    socket.sessionId = generateSessionId();
    sessionStore.set(socket.sessionId, {
      createdAt: Date.now(),
      serverId: process.pid
    });
  }

  next();
});
```

### –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏
```javascript
// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å–µ—Å—Å–∏–π
setInterval(() => {
  const now = Date.now();
  const timeout = 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç

  for (const [companyId, session] of baileysManager.sessions) {
    if (session.status !== 'connected' &&
        now - session.createdAt > timeout) {
      baileysManager.disconnectSession(companyId);
    }
  }
}, 5 * 60 * 1000); // –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
```

#### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è CPU
```javascript
// Worker threads –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
const { Worker } = require('worker_threads');

async function processHeavyTask(data) {
  return new Promise((resolve, reject) => {
    const worker = new Worker('./workers/heavy-task.js', {
      workerData: data
    });

    worker.on('message', resolve);
    worker.on('error', reject);
    worker.on('exit', (code) => {
      if (code !== 0) {
        reject(new Error(`Worker stopped with exit code ${code}`));
      }
    });
  });
}
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∫–æ–¥–∞

### –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```javascript
const Joi = require('joi');

// –°—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
const schemas = {
  register: Joi.object({
    salon_id: Joi.number().integer().positive().required(),
    phone: Joi.string().pattern(/^\+?[1-9]\d{1,14}$/).optional(),
    email: Joi.string().email().optional()
  }),

  webhook: Joi.object({
    type: Joi.string().required(),
    data: Joi.object().required(),
    timestamp: Joi.date().iso().required()
  })
};

// Middleware –≤–∞–ª–∏–¥–∞—Ü–∏–∏
function validate(schema) {
  return (req, res, next) => {
    const { error } = schema.validate(req.body);
    if (error) {
      return res.status(400).json({
        success: false,
        error: error.details[0].message
      });
    }
    next();
  };
}
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫
```javascript
// SQL Injection –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ
const sanitizeSQL = (input) => {
  if (typeof input !== 'string') return input;
  return input.replace(/['";\\]/g, '');
};

// XSS –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ
const sanitizeHTML = (input) => {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#x27;',
    '/': '&#x2F;'
  };
  return input.replace(/[&<>"'/]/g, (char) => map[char]);
};

// CSRF –∑–∞—â–∏—Ç–∞
const csrf = require('csurf');
const csrfProtection = csrf({ cookie: true });

app.use('/marketplace/admin', csrfProtection);
```

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({
      filename: 'logs/marketplace-error.log',
      level: 'error'
    }),
    new winston.transports.File({
      filename: 'logs/marketplace-combined.log'
    })
  ]
});

// –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫ –ª–æ–≥–∞–º
logger.child = (context) => {
  return {
    info: (message, meta = {}) => {
      logger.info(message, { ...context, ...meta });
    },
    error: (message, meta = {}) => {
      logger.error(message, { ...context, ...meta });
    }
  };
};
```

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 16 —Å–µ–Ω—Ç—è–±—Ä—è 2024*