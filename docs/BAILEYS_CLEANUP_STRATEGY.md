# –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ—á–∏—Å—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ Baileys –¥–ª—è –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 23 —Å–µ–Ω—Ç—è–±—Ä—è 2025
**–í–µ—Ä—Å–∏—è Baileys**: 7.0.0-rc.3
**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**: 151 —Ñ–∞–π–ª –≤ `/opt/ai-admin/baileys_sessions/company_962302/`

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

### 1. –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (151 —Ñ–∞–π–ª)

#### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–æ —Ç–∏–ø–∞–º:
| –¢–∏–ø —Ñ–∞–π–ª–∞ | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∏—è |
|-----------|------------|------------|------------------------|
| `lid-mapping-*.json` | 60 | –ú–∞–ø–ø–∏–Ω–≥ –º–µ–∂–¥—É —Å—Ç–∞—Ä—ã–º–∏ JID –∏ –Ω–æ–≤—ã–º–∏ LID –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏ WhatsApp | ‚ùå **–ù–ï –£–î–ê–õ–Ø–¢–¨** - –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã |
| `pre-key-*.json` | 40 | –ö–ª—é—á–∏ Signal Protocol –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è | ‚ö†Ô∏è –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–ª—è—Ç—å 30-50 —à—Ç—É–∫ |
| `session-*.json` | 35 | –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ | ‚úÖ –ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—à–µ 14 –¥–Ω–µ–π |
| `sender-key-*.json` | 16 | –ö–ª—é—á–∏ –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π | ‚úÖ –ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—à–µ 3 –¥–Ω–µ–π |
| `creds.json` | 1 | –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ | ‚ùå **–ù–ò–ö–û–ì–î–ê –ù–ï –£–î–ê–õ–Ø–¢–¨** |
| `app-state-sync-*.json` | 4 | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | ‚ùå **–ù–ï –£–î–ê–õ–Ø–¢–¨** |

### 2. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç WhiskeySockets/Baileys

#### 2.1 –ß—Ç–æ —Ç–∞–∫–æ–µ LID (Local ID)
- WhatsApp –ø–µ—Ä–µ—à–µ–ª —Å —Å–∏—Å—Ç–µ–º—ã JID (Jabber ID) –Ω–∞ LID (Local ID)
- –§–∞–π–ª—ã `lid-mapping-*.json` —Å–æ–¥–µ—Ä–∂–∞—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –º–µ–∂–¥—É —Å—Ç–∞—Ä—ã–º–∏ –∏ –Ω–æ–≤—ã–º–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏
- **–£–¥–∞–ª–µ–Ω–∏–µ lid-mapping —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫**:
  - –û—à–∏–±–∫–∞–º –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø—ã
  - –ü—Ä–æ–±–ª–µ–º–∞–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
  - –í–æ–∑–º–æ–∂–Ω–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

#### 2.2 Baileys v7.0.0 - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- **`makeInMemoryStore` - –£–î–ê–õ–ï–ù** (–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ v7)
- **`experimentalStore` - –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢** (–±—ã–ª –≤ v5-v6)
- **`timeRelease` - –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢** (–±—ã–ª –≤ v5-v6)
- **`proto` - –£–ë–†–ê–ù** –∏–∑ —ç–∫—Å–ø–æ—Ä—Ç–æ–≤
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è - —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ª–∂–Ω—ã —Å–∞–º–∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

### 3. –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –ù–ï –æ—á–∏—Å—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤

#### –ü—Ä–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. **–°–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**:
   - "Consumes a lot of IO" - –∏–∑–±—ã—Ç–æ—á–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞
   - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏
   - –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏/–ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

2. **–†–∏—Å–∫–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏**:
   - –ü—Ä–∏ >180 —Ñ–∞–π–ª–∞—Ö - –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –æ—à–∏–±–∫–∏ `device_removed`
   - –ü—Ä–∏ >200 —Ñ–∞–π–ª–∞—Ö - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥, –≤–æ–∑–º–æ–∂–Ω–∞ –ø–æ—Ç–µ—Ä—è —Å–µ—Å—Å–∏–∏
   - –û—à–∏–±–∫–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: "Failed to decrypt message"
   - –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞–º–∏ WhatsApp

3. **–õ–∏–º–∏—Ç—ã WhatsApp**:
   - –ú–∞–∫—Å–∏–º—É–º 4 –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞ –æ–¥–∏–Ω –Ω–æ–º–µ—Ä
   - –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Ñ–∞–π–ª–æ–≤ –º–æ–∂–µ—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞

### 4. –ê–Ω–∞–ª–∏–∑ –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞

#### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
```javascript
// src/integrations/whatsapp/session-pool.js
const sock = makeWASocket({
    version,
    auth: {
        creds: state.creds,
        keys: makeCacheableSignalKeyStore(state.keys, pino({ level: 'silent' }))
    },
    // –ù–ï–¢ experimentalStore –∏ timeRelease - –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ v7
    printQRInTerminal: false,
    logger: pino({ level: 'error' }),
    browser: Browsers.ubuntu('Chrome'),
    // ... –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
});
```

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫:
```
/opt/ai-admin/baileys_sessions/
‚îú‚îÄ‚îÄ company_962302/     # –¢–µ–∫—É—â–∞—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ creds.json
‚îÇ   ‚îú‚îÄ‚îÄ app-state-sync-*.json
‚îÇ   ‚îú‚îÄ‚îÄ lid-mapping-*.json
‚îÇ   ‚îú‚îÄ‚îÄ pre-key-*.json
‚îÇ   ‚îú‚îÄ‚îÄ session-*.json
‚îÇ   ‚îî‚îÄ‚îÄ sender-key-*.json
‚îú‚îÄ‚îÄ company_123456/     # –ë—É–¥—É—â–∞—è –∫–æ–º–ø–∞–Ω–∏—è
‚îî‚îÄ‚îÄ company_789012/     # –ë—É–¥—É—â–∞—è –∫–æ–º–ø–∞–Ω–∏—è
```

## üéØ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

### –†–µ—à–µ–Ω–∏–µ 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ cron (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

#### 1.1 –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ `/opt/ai-admin/scripts/baileys-multitenancy-cleanup.js`

```javascript
#!/usr/bin/env node

/**
 * Baileys Multitenancy Cleanup Script
 * –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π
 *
 * –í–ê–ñ–ù–û: –ù–ï —É–¥–∞–ª—è–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã:
 * - creds.json
 * - app-state-sync-*.json
 * - lid-mapping-*.json
 */

const fs = require('fs-extra');
const path = require('path');
const logger = require('../src/utils/logger');

const BAILEYS_SESSIONS_PATH = '/opt/ai-admin/baileys_sessions';
const SESSION_MAX_AGE_DAYS = 14;
const SENDER_KEY_MAX_AGE_DAYS = 3;
const MAX_PRE_KEYS = 50;
const MIN_PRE_KEYS = 30;

class BaileysMultitenancyCleanup {
  constructor() {
    this.stats = {
      companies: 0,
      totalFilesProcessed: 0,
      totalFilesRemoved: 0,
      errors: []
    };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π –∏–∑ –ø–∞–ø–∫–∏ sessions
   */
  async getCompanies() {
    try {
      const dirs = await fs.readdir(BAILEYS_SESSIONS_PATH);
      return dirs.filter(dir => dir.startsWith('company_'));
    } catch (error) {
      logger.error('Failed to read baileys sessions directory:', error);
      return [];
    }
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª
   */
  shouldPreserve(filename, stats) {
    // –ö–†–ò–¢–ò–ß–ù–´–ï —Ñ–∞–π–ª—ã - –í–°–ï–ì–î–ê —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    if (filename === 'creds.json') return true;
    if (filename.startsWith('app-state-sync-')) return true;
    if (filename.startsWith('lid-mapping-')) return true; // –í–ê–ñ–ù–û: LID –º–∞–ø–ø–∏–Ω–≥ –Ω—É–∂–µ–Ω!

    // Session —Ñ–∞–π–ª—ã - —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—à–µ 14 –¥–Ω–µ–π
    if (filename.startsWith('session-')) {
      const ageInDays = (Date.now() - stats.mtime) / (1000 * 60 * 60 * 24);
      return ageInDays < SESSION_MAX_AGE_DAYS;
    }

    // Sender-key —Ñ–∞–π–ª—ã - —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—à–µ 3 –¥–Ω–µ–π
    if (filename.startsWith('sender-key-')) {
      const ageInDays = (Date.now() - stats.mtime) / (1000 * 60 * 60 * 24);
      return ageInDays < SENDER_KEY_MAX_AGE_DAYS;
    }

    // Pre-keys –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
    if (filename.startsWith('pre-key-')) {
      return null; // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    }

    // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    return true;
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å pre-keys, –æ—Å—Ç–∞–≤–∏–≤ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
   */
  async cleanupPreKeys(companyPath, files) {
    const preKeys = files
      .filter(f => f.name.startsWith('pre-key-'))
      .sort((a, b) => {
        const numA = parseInt(a.name.match(/pre-key-(\d+)\.json/)?.[1] || '0');
        const numB = parseInt(b.name.match(/pre-key-(\d+)\.json/)?.[1] || '0');
        return numB - numA; // –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ
      });

    if (preKeys.length <= MAX_PRE_KEYS) {
      return 0;
    }

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ, –æ—Å—Ç–∞–≤–ª—è—è MAX_PRE_KEYS –Ω–æ–≤–µ–π—à–∏—Ö
    const toRemove = preKeys.slice(MAX_PRE_KEYS);
    let removed = 0;

    for (const file of toRemove) {
      try {
        await fs.unlink(path.join(companyPath, file.name));
        removed++;
        this.stats.totalFilesRemoved++;
      } catch (error) {
        this.stats.errors.push({
          company: path.basename(companyPath),
          file: file.name,
          error: error.message
        });
      }
    }

    return removed;
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã –¥–ª—è –æ–¥–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
   */
  async cleanupCompany(companyDir) {
    const companyPath = path.join(BAILEYS_SESSIONS_PATH, companyDir);
    const companyId = companyDir.replace('company_', '');

    try {
      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
      const fileNames = await fs.readdir(companyPath);
      const files = [];

      for (const name of fileNames) {
        const filePath = path.join(companyPath, name);
        const stats = await fs.stat(filePath);
        if (stats.isFile()) {
          files.push({ name, stats });
          this.stats.totalFilesProcessed++;
        }
      }

      logger.info(`Processing company ${companyId}: ${files.length} files`);

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ —Ñ–∞–π–ª—ã
      let removedCount = 0;
      for (const file of files) {
        if (file.name.startsWith('pre-key-')) continue; // Pre-keys –æ—Ç–¥–µ–ª—å–Ω–æ

        const preserve = this.shouldPreserve(file.name, file.stats);
        if (preserve === false) {
          try {
            await fs.unlink(path.join(companyPath, file.name));
            removedCount++;
            this.stats.totalFilesRemoved++;
          } catch (error) {
            this.stats.errors.push({
              company: companyId,
              file: file.name,
              error: error.message
            });
          }
        }
      }

      // –û—á–∏—â–∞–µ–º –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ pre-keys
      const preKeysRemoved = await this.cleanupPreKeys(companyPath, files);
      removedCount += preKeysRemoved;

      logger.info(`Company ${companyId}: removed ${removedCount} files`);

      return {
        companyId,
        filesProcessed: files.length,
        filesRemoved: removedCount,
        filesRemaining: files.length - removedCount
      };

    } catch (error) {
      logger.error(`Failed to cleanup company ${companyId}:`, error);
      this.stats.errors.push({
        company: companyId,
        error: error.message
      });
      return null;
    }
  }

  /**
   * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏
   */
  async cleanup() {
    const startTime = Date.now();
    logger.info('üßπ Starting Baileys multitenancy cleanup...');

    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π
    const companies = await this.getCompanies();
    this.stats.companies = companies.length;

    if (companies.length === 0) {
      logger.warn('No companies found for cleanup');
      return this.stats;
    }

    logger.info(`Found ${companies.length} companies to process`);

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –∫–æ–º–ø–∞–Ω–∏—é
    const results = [];
    for (const company of companies) {
      const result = await this.cleanupCompany(company);
      if (result) {
        results.push(result);
      }
    }

    // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    const duration = Date.now() - startTime;
    logger.info('=' .repeat(50));
    logger.info('üìä Cleanup Summary:');
    logger.info(`  Companies processed: ${this.stats.companies}`);
    logger.info(`  Total files processed: ${this.stats.totalFilesProcessed}`);
    logger.info(`  Total files removed: ${this.stats.totalFilesRemoved}`);
    logger.info(`  Errors: ${this.stats.errors.length}`);
    logger.info(`  Duration: ${duration}ms`);
    logger.info('=' .repeat(50));

    // –î–µ—Ç–∞–ª–∏ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º
    for (const result of results) {
      logger.info(`  ${result.companyId}: ${result.filesRemaining} files remaining (removed ${result.filesRemoved})`);

      // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
      if (result.filesRemaining > 150) {
        logger.warn(`  ‚ö†Ô∏è Company ${result.companyId} still has ${result.filesRemaining} files!`);
      }
    }

    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (this.stats.errors.length > 0) {
      logger.error('Cleanup errors:');
      for (const error of this.stats.errors) {
        logger.error(`  ${error.company}/${error.file}: ${error.error}`);
      }
    }

    return this.stats;
  }
}

// –ó–∞–ø—É—Å–∫ –µ—Å–ª–∏ –≤—ã–∑–≤–∞–Ω –Ω–∞–ø—Ä—è–º—É—é
if (require.main === module) {
  const cleanup = new BaileysMultitenancyCleanup();

  // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–ª–∞–≥–∞ --dry-run
  const dryRun = process.argv.includes('--dry-run');
  if (dryRun) {
    logger.info('DRY RUN MODE - no files will be deleted');
    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º dry-run
  }

  cleanup.cleanup()
    .then(stats => {
      logger.info('‚úÖ Cleanup completed successfully');
      process.exit(0);
    })
    .catch(error => {
      logger.error('‚ùå Cleanup failed:', error);
      process.exit(1);
    });
}

module.exports = BaileysMultitenancyCleanup;
```

#### 1.2 –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron –∑–∞–¥–∞—á—É

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 –Ω–æ—á–∏
0 3 * * * /usr/bin/node /opt/ai-admin/scripts/baileys-multitenancy-cleanup.js >> /opt/ai-admin/logs/cleanup.log 2>&1
```

### –†–µ—à–µ–Ω–∏–µ 2: –£–ª—É—á—à–µ–Ω–∏–µ whatsapp-safe-monitor –¥–ª—è –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏

#### 2.1 –û–±–Ω–æ–≤–∏—Ç—å monitor –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π

```javascript
// –í whatsapp-safe-monitor.js –¥–æ–±–∞–≤–∏—Ç—å:

async checkAllCompanies() {
  const companiesPath = '/opt/ai-admin/baileys_sessions';
  const companies = await fs.readdir(companiesPath);

  for (const companyDir of companies) {
    if (!companyDir.startsWith('company_')) continue;

    const companyId = companyDir.replace('company_', '');
    const fileCount = await this.checkFileCount(companyId);

    if (fileCount > 180) {
      // –ö–†–ò–¢–ò–ß–ù–û - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
      await this.sendCriticalAlert(companyId, fileCount);
      // –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É
      await this.runEmergencyCleanup(companyId);
    } else if (fileCount > 150) {
      // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      await this.sendWarningAlert(companyId, fileCount);
    }
  }
}
```

### –†–µ—à–µ–Ω–∏–µ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

#### 3.1 Prometheus –º–µ—Ç—Ä–∏–∫–∏

```javascript
// metrics/baileys-metrics.js
const client = require('prom-client');

// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –º–µ—Ç—Ä–∏–∫–∏
const baileysFilesGauge = new client.Gauge({
  name: 'baileys_session_files_count',
  help: 'Number of files in Baileys session directory',
  labelNames: ['company_id', 'file_type']
});

// –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
setInterval(async () => {
  const companies = await getCompanies();

  for (const company of companies) {
    const fileCounts = await getFileCountsByType(company.id);

    baileysFilesGauge.set({
      company_id: company.id,
      file_type: 'lid_mapping'
    }, fileCounts.lidMapping);

    baileysFilesGauge.set({
      company_id: company.id,
      file_type: 'pre_key'
    }, fileCounts.preKey);

    // ... –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤
  }
}, 5 * 60 * 1000);
```

### –†–µ—à–µ–Ω–∏–µ 4: –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—É—é –∫–æ–º–ø–∞–Ω–∏—é –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–∏

#### 4.1 –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è —Å–µ—Å—Å–∏–π

```javascript
// rotation-strategy.js
class SessionRotationStrategy {
  async checkAndRotate(companyId) {
    const fileCount = await this.getFileCount(companyId);

    if (fileCount > 170) {
      // 1. –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
      await this.backupSession(companyId);

      // 2. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —á–∏—Å—Ç—É—é —Å–µ—Å—Å–∏—é
      const newSessionPath = await this.createCleanSession(companyId);

      // 3. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
      await this.switchToNewSession(companyId, newSessionPath);

      // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º QR –∫–æ–¥ –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      await this.sendReconnectionQR(companyId);

      logger.info(`Session rotated for company ${companyId}`);
    }
  }
}
```

## üìã –ß–µ–∫-–ª–∏—Å—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

### –î–ª—è —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ (151 —Ñ–∞–π–ª –¥–ª—è company_962302):

1. **‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å** - 151 —Ñ–∞–π–ª –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
2. **‚ö†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - alert –ø—Ä–∏ >170 —Ñ–∞–π–ª–∞—Ö
3. **üîß –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –æ—á–∏—Å—Ç–∫—É** —á–µ—Ä–µ–∑ cron
4. **üìä –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–æ—Å—Ç–∞ —Ñ–∞–π–ª–æ–≤
5. **üóÑÔ∏è –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ backup-service —Ä–∞–±–æ—Ç–∞–µ—Ç** (—É–∂–µ –∑–∞–ø—É—â–µ–Ω)

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ—Ä–æ–≥–∏:

| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ | –°—Ç–∞—Ç—É—Å | –î–µ–π—Å—Ç–≤–∏–µ |
|-------------------|--------|----------|
| < 100 | ‚úÖ –û—Ç–ª–∏—á–Ω–æ | –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å |
| 100-150 | ‚ö†Ô∏è –ù–æ—Ä–º–∞ | –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å |
| 150-170 | üî∂ –í–Ω–∏–º–∞–Ω–∏–µ | –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –æ—á–∏—Å—Ç–∫—É |
| 170-180 | üî¥ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ | –û—á–∏—Å—Ç–∫–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 24—á |
| > 180 | üíÄ –ö–†–ò–¢–ò–ß–ù–û | –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏–ª–∏ —Ä–æ—Ç–∞—Ü–∏—è |

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### –ù–ò–ö–û–ì–î–ê –Ω–µ —É–¥–∞–ª—è–π—Ç–µ:
1. **`creds.json`** - –ø–æ—Ç–µ—Ä—è = –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
2. **`app-state-sync-*.json`** - –ø–æ—Ç–µ—Ä—è = —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
3. **`lid-mapping-*.json`** - –ø–æ—Ç–µ—Ä—è = –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –≥—Ä—É–ø–ø—ã –∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º

### –ü—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –í–°–ï–ì–î–ê:
1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ Baileys –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ–¥ —Ä—É—á–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π
2. –î–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
3. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ –æ–¥–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –ø–µ—Ä–µ–¥ –º–∞—Å—Å–æ–≤—ã–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–ª–∞–≥ `--dry-run` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

## üîÆ –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è —Å —Ñ–∞–π–ª–æ–≤–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
Baileys v7 —É–±—Ä–∞–ª –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π store, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:
- PostgreSQL –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–π
- Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π
- S3 –¥–ª—è –±—ç–∫–∞–ø–æ–≤

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
–ü—Ä–∏ —Ä–æ—Å—Ç–µ –¥–æ 100+ –∫–æ–º–ø–∞–Ω–∏–π:
- –û—Ç–¥–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã Baileys –¥–ª—è –∫–∞–∂–¥—ã—Ö 10-20 –∫–æ–º–ø–∞–Ω–∏–π
- Load balancing –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏
- Kubernetes –¥–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏

### 3. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã Baileys
–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π WhatsApp Business API –ø—Ä–∏:
- –ë–æ–ª–µ–µ 50 –∫–æ–º–ø–∞–Ω–∏–π
- –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–ª–∞—Ç–∏—Ç—å –∑–∞ API

## üìö –°—Å—ã–ª–∫–∏ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏

1. [WhiskeySockets/Baileys GitHub](https://github.com/WhiskeySockets/Baileys)
2. [Baileys v7 Migration Guide](https://baileys.wiki/docs/migration/to-v7.0.0/)
3. [Signal Protocol Documentation](https://signal.org/docs/)
4. [WhatsApp Business API](https://developers.facebook.com/docs/whatsapp)

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω**: AI Admin Team
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 23 —Å–µ–Ω—Ç—è–±—Ä—è 2025
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞**: 1.0