# –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —á–∏—Å—Ç—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

## üìã –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏

### ‚úÖ –£–¥–∞–ª–µ–Ω—ã legacy —Ñ–∞–π–ª—ã:
1. **AI Admin v2:**
   - index-qwen-simple.js
   - index-with-qwen.js
   - optimized-index.js
   - index-backup.js
   - ai-provider-adapter.js
   - fixes/ (–ø–∞–ø–∫–∞ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π)

2. **Workers:**
   - index-v2-qwen.js
   - message-worker-v2-qwen.js

3. **AI Service:**
   - qwen-health-monitor.js

4. **Scripts:**
   - switch-to-qwen.sh

### ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
- ecosystem.config.js - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π index-v2.js
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ AI_PROVIDER –∏ AI_PROMPT_VERSION

## üéØ –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### Phase 1: –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –±–æ–ª—å—à–∏—Ö –º–µ—Ç–æ–¥–æ–≤ (1-2 –¥–Ω—è)
1. **–í–Ω–µ–¥—Ä–∏—Ç—å ResponseProcessor**
   - ‚úÖ –°–æ–∑–¥–∞–Ω modules/response-processor.js
   - [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ index.js
   - [ ] –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π –∫–æ–¥
   - [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã

2. **–†–∞–∑–¥–µ–ª–∏—Ç—å processMessage()**
   - [ ] –í—ã–¥–µ–ª–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
   - [ ] –í—ã–¥–µ–ª–∏—Ç—å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞
   - [ ] –í—ã–¥–µ–ª–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### Phase 2: –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ (1 –¥–µ–Ω—å)
1. **–°–æ–∑–¥–∞—Ç—å Error Handler**
   ```javascript
   class AIAdminError extends Error {
     constructor(code, message, details) {
       super(message);
       this.code = code;
       this.details = details;
     }
   }
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º**
   - Exponential backoff
   - –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏

### Phase 3: –£–ª—É—á—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç–∏ (2-3 –¥–Ω—è)
1. **–û–±–Ω–æ–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã**
   - –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
   - –î–æ–±–∞–≤–∏—Ç—å –¥–ª—è –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π
   - –ü–æ–∫—Ä—ã—Ç–∏–µ >80%

2. **–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã**
   - –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ flow –∑–∞–ø–∏—Å–∏
   - –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
   - –¢–µ—Å—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

### Phase 4: –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (1 –¥–µ–Ω—å)
1. **–î–æ–±–∞–≤–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏**
   - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø–æ —Ç–∏–ø–∞–º
   - Cache hit rate
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

2. **–°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥**
   - Grafana –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ–π web UI
   - Real-time –º–µ—Ç—Ä–∏–∫–∏
   - –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

## üìÇ –¶–µ–ª–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
src/services/ai-admin-v2/
‚îú‚îÄ‚îÄ index.js                    # –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ context-loader.js       # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ prompt-builder.js       # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ response-processor.js   # ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ command-handler.js      # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ error-handler.js        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îÇ   ‚îú‚îÄ‚îÄ metrics-collector.js    # –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫
‚îÇ   ‚îî‚îÄ‚îÄ ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏)
‚îú‚îÄ‚îÄ prompts/                    # ‚úÖ –í–µ—Ä—Å–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤
‚îú‚îÄ‚îÄ errors/                     # –ö–ª–∞—Å—Å—ã –æ—à–∏–±–æ–∫
‚îî‚îÄ‚îÄ __tests__/                  # –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
```

## üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
npm test

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä
npm run lint

# 3. –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç
git add -A
git commit -m "refactor: –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è AI Admin v2

- –í—ã–¥–µ–ª–µ–Ω ResponseProcessor –∏–∑ processAIResponse
- –£–¥–∞–ª–µ–Ω—ã legacy —Ñ–∞–π–ª—ã Qwen –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"

# 4. –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
git push origin feature/redis-context-cache
ssh root@46.149.70.219 "cd /opt/ai-admin && git pull && pm2 restart ai-admin-worker-v2"

# 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
ssh root@46.149.70.219 "pm2 logs ai-admin-worker-v2 --lines 100"
```

## ‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

1. **–†–∏—Å–∫**: –ü–æ–ª–æ–º–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
   **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å —Ç–µ—Å—Ç–∞–º–∏

2. **–†–∏—Å–∫**: –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
   **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ë–µ–Ω—á–º–∞—Ä–∫–∏ –¥–æ –∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

3. **–†–∏—Å–∫**: –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ç–µ–∫—É—â–∏–º–∏ –≤–æ—Ä–∫–µ—Ä–∞–º–∏
   **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å API

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

1. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞**: –ú–µ—Ç–æ–¥—ã <100 —Å—Ç—Ä–æ–∫
2. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ü–æ–∫—Ä—ã—Ç–∏–µ >80%
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ë–µ–∑ —É—Ö—É–¥—à–µ–Ω–∏—è
4. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å**: –õ–µ–≥—á–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
5. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –õ—É—á—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫