# Обработка реакций клиентов на напоминания

**Дата**: 25 октября 2025
**Автор**: AI Admin Development Team
**Задача**: Реализовать обработку реакций (эмодзи) от клиентов на напоминания о визитах

---

## 📋 Контекст

**Проблема:**
Когда система отправляет клиенту напоминание о визите, клиент может поставить реакцию 👍 (большой палец вверх) или другой эмодзи для подтверждения. Однако система не понимала эти реакции и начинала писать сообщения типа: _"я не могу прочитать, что вы мне отправили, Сергей. Если хотите, чтобы я что-то сделал, попросите меня записать вас или спросите когда работает Бари"_.

**Решение:**
Реализовать полноценную обработку входящих реакций от клиентов с классификацией на позитивные, негативные и нейтральные. При позитивной реакции на напоминание - автоматически подтверждать запись в YClients.

---

## 🏗️ Архитектура решения

```
[Клиент WhatsApp]
    ↓ (ставит реакцию 👍)
[Baileys SDK]
    ↓ (событие messages.reaction)
[session-pool.js]
    ↓ (emit('reaction', ...))
[baileys-service.js]
    ↓ (проксирование)
[webhook/whatsapp-reaction.js]
    ↓ (классификация + обработка)
[reminder-context-tracker] + [YClients API]
    ↓
[Обновление статуса записи + ответная реакция ❤️]
```

---

## 🔧 Реализация

### 1. Обработка события `messages.reaction` в session-pool.js

**Файл:** `src/integrations/whatsapp/session-pool.js`

Добавлен обработчик входящих реакций от клиентов:

```javascript
// Handle incoming reactions from clients
sock.ev.on('messages.reaction', async (reaction) => {
    logger.info(`👍 Reaction received for company ${companyId}:`, {
        from: reaction.key.remoteJid,
        emoji: reaction.reaction?.text,
        messageId: reaction.key.id
    });

    // Only process reactions from clients (not our own reactions)
    if (!reaction.key.fromMe && reaction.reaction) {
        logger.info(`✅ Emitting reaction event for company ${companyId}`);
        this.emit('reaction', {
            companyId,
            reaction: {
                from: reaction.key.remoteJid,
                emoji: reaction.reaction.text,
                messageId: reaction.key.id,
                timestamp: Date.now()
            }
        });
    }
});
```

**Важно:** Добавлена очистка слушателя в метод `removeSession()`:

```javascript
session.ev.removeAllListeners('messages.reaction');
```

---

### 2. Проксирование реакций в baileys-service.js

**Файл:** `scripts/baileys-service.js`

Добавлен обработчик события `reaction` для пересылки на webhook:

```javascript
pool.on('reaction', async ({ companyId: cId, reaction }) => {
    if (cId !== companyId) return;

    const from = reaction.from;
    const emoji = reaction.emoji;
    const messageId = reaction.messageId;

    logger.info(`👍 Reaction received from ${from}: ${emoji}`);

    // Forward to webhook for processing
    try {
        const axios = require('axios');
        const phone = from.replace('@s.whatsapp.net', '');

        await axios.post('http://localhost:3000/webhook/whatsapp/reaction', {
            from: phone,
            emoji: emoji,
            messageId: messageId,
            timestamp: reaction.timestamp || Date.now()
        }, {
            headers: {
                'Content-Type': 'application/json',
                'X-Source': 'baileys-service'
            }
        });

        logger.info(`✅ Reaction forwarded to webhook for processing`);
    } catch (error) {
        logger.error('Failed to forward reaction to webhook:', error.message);
    }
});
```

---

### 3. Webhook для обработки реакций

**Файл:** `src/api/webhooks/whatsapp-reaction.js`

Создан новый endpoint для обработки реакций с классификацией:

#### 3.1 Классификация реакций

```javascript
const REACTION_TYPES = {
  POSITIVE: [
    '👍', '👍🏻', '👍🏼', '👍🏽', '👍🏾', '👍🏿', // thumbs up (all skin tones)
    '❤️', '❤', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', // hearts
    '😊', '😃', '😄', '😁', '🙂', '😀', '😍', '🥰', '😘', // happy faces
    '🎉', '🎊', '✨', '⭐', '🌟', '💯', '🔥', // celebration
    '✅', '☑️', '✔️', // check marks
    '👌', '👌🏻', '👌🏼', '👌🏽', '👌🏾', '👌🏿', // OK hand
    '🤝', '🙏', '🙏🏻', '🙏🏼', '🙏🏽', '🙏🏾', '🙏🏿' // handshake, pray
  ],
  NEGATIVE: [
    '👎', '👎🏻', '👎🏼', '👎🏽', '👎🏾', '👎🏿', // thumbs down
    '😞', '😔', '😢', '😭', '😤', '😠', '😡', // sad/angry faces
    '❌', '✖️', '🚫', '⛔', // crosses/blocks
    '💔', // broken heart
    '😕', '🙁', '☹️', // confused/disappointed
  ],
  NEUTRAL: [
    '🤔', // thinking
    '😐', '😑', // neutral faces
    '🤷', '🤷‍♂️', '🤷‍♀️', // shrug
  ]
};
```

#### 3.2 Логика обработки

**Для позитивных реакций на напоминания:**
1. Отправляет ответную реакцию ❤️
2. Обновляет статус записи в YClients на "подтвержден" (attendance = 2)
3. Помечает напоминание как подтвержденное в Redis

**Для негативных реакций:**
1. Фиксирует негативную реакцию
2. Очищает контекст напоминания
3. (в будущем можно добавить предложение перенести запись)

**Для нейтральных реакций:**
1. Просто фиксирует реакцию в логах

**Для реакций не на напоминания:**
1. Логирует реакцию без дополнительных действий

---

### 4. Подключение webhook'а в API

**Файл:** `src/api/index.js`

```javascript
// Import webhook routes
const whatsappReactionWebhook = require('./webhooks/whatsapp-reaction');

// Mount webhook routes
app.use(whatsappReactionWebhook);
```

---

## 🎯 Поддерживаемые реакции

### Позитивные (подтверждение записи):
- 👍 Большой палец вверх (все оттенки кожи)
- ❤️ Сердца (все цвета)
- 😊 Счастливые лица
- 🎉 Праздничные эмодзи
- ✅ Галочки
- 👌 OK жест (все оттенки кожи)
- 🙏 Молитва/благодарность (все оттенки кожи)

### Негативные (возможное желание отменить/перенести):
- 👎 Большой палец вниз (все оттенки кожи)
- 😞 Грустные/злые лица
- ❌ Крестики
- 💔 Разбитое сердце
- 😕 Разочарование

### Нейтральные:
- 🤔 Раздумья
- 😐 Нейтральные лица
- 🤷 Пожимание плечами

---

## ✅ Преимущества решения

1. **Естественное взаимодействие**: Клиенты могут быстро подтвердить визит одним тапом (реакцией)
2. **Автоматизация**: Статус записи обновляется автоматически без участия администратора
3. **Избегание путаницы**: Система больше не пытается интерпретировать реакции как текстовые сообщения
4. **Расширяемость**: Легко добавить новые типы реакций и логику их обработки
5. **Обратная связь**: Клиент получает ответную реакцию ❤️, показывающую что система поняла подтверждение

---

## 📊 Примеры использования

### Сценарий 1: Подтверждение визита

```
[Система] → Клиенту: "Напоминаем о вашей записи завтра в 14:00 к мастеру Бари"
[Клиент] → Ставит реакцию: 👍
[Система] → Автоматически:
           1. Отправляет ❤️ в ответ
           2. Обновляет запись в YClients (attendance = 2)
           3. Логирует подтверждение
```

### Сценарий 2: Негативная реакция

```
[Система] → Клиенту: "Напоминаем о вашей записи завтра в 14:00 к мастеру Бари"
[Клиент] → Ставит реакцию: 👎
[Система] → Автоматически:
           1. Логирует негативную реакцию
           2. Очищает контекст напоминания
           (в будущем: предложить перенести запись)
```

### Сценарий 3: Реакция на обычное сообщение

```
[Клиент] → "Когда работает Бари?"
[Система] → "Бари работает завтра с 10:00 до 18:00"
[Клиент] → Ставит реакцию: 👍
[Система] → Просто логирует реакцию, не выполняет дополнительных действий
```

---

## 🧪 Тестирование

### Тестовый номер: 89686484488

**План тестирования:**

1. **Тест позитивной реакции на напоминание:**
   - Создать тестовую запись
   - Дождаться напоминания (или симулировать)
   - Поставить реакцию 👍
   - Проверить:
     - ✅ Получена ответная реакция ❤️
     - ✅ Статус записи обновлен в YClients
     - ✅ Логи показывают успешную обработку

2. **Тест негативной реакции:**
   - Создать тестовую запись
   - Дождаться напоминания
   - Поставить реакцию 👎
   - Проверить:
     - ✅ Реакция зафиксирована в логах
     - ✅ Контекст напоминания очищен

3. **Тест реакции на обычное сообщение:**
   - Отправить обычный запрос
   - Поставить реакцию 👍 на ответ
   - Проверить:
     - ✅ Реакция просто залогирована
     - ✅ Нет нежелательных побочных эффектов

---

## 🔄 Обновленные файлы

1. **src/integrations/whatsapp/session-pool.js**
   - Добавлен обработчик `messages.reaction`
   - Добавлена очистка слушателя в `removeSession()`

2. **scripts/baileys-service.js**
   - Добавлен обработчик события `reaction`
   - Проксирование на webhook

3. **src/api/webhooks/whatsapp-reaction.js** (новый файл)
   - Endpoint `/webhook/whatsapp/reaction`
   - Классификация реакций
   - Обработка контекста напоминаний
   - Интеграция с YClients API

4. **src/api/index.js**
   - Подключение webhook'а реакций

---

## 🚀 Деплой

**Команды для деплоя:**

```bash
# Локально - коммит изменений
git add -A
git commit -m "feat: добавлена обработка реакций клиентов на напоминания"

# Push на GitHub
git push origin feature/redis-context-cache

# Деплой на сервер
ssh -i ~/.ssh/id_ed25519_ai_admin root@46.149.70.219 "cd /opt/ai-admin && git pull && pm2 restart all"

# Проверка логов
ssh -i ~/.ssh/id_ed25519_ai_admin root@46.149.70.219 "pm2 logs ai-admin-worker-v2 --lines 50"
```

---

## 📝 Дальнейшие улучшения

1. **Расширенная обработка негативных реакций:**
   - Автоматическое предложение перенести запись
   - Интеграция с календарем для выбора нового времени

2. **Аналитика реакций:**
   - Сбор статистики по типам реакций
   - Dashboard с визуализацией

3. **Персонализация:**
   - Учет предпочитаемых реакций клиента
   - Адаптация ответов под стиль общения

4. **A/B тестирование:**
   - Эксперименты с разными ответными реакциями
   - Оптимизация конверсии подтверждений

---

## 🔗 Связанные документы

- `docs/development-diary/2025-10-07-reactions-restoration-and-session-pool-fixes.md` - Реализация отправки реакций
- `docs/features/CLIENT_REACTIVATION_PART6_TESTING_IMPLEMENTATION.md` - Система напоминаний
- `docs/ARCHITECTURE.md` - Общая архитектура

---

**Статус**: ✅ Реализовано, готово к тестированию
**Ветка**: feature/redis-context-cache
**Тестирование**: Запланировано на 89686484488
