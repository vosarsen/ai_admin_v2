# Исправление склонений услуг в напоминаниях

**Дата**: 30 августа 2025
**Автор**: AI Admin Development Team

## Проблема

В напоминаниях о предстоящих записях услуги отображались с неправильными падежами:
- "Запись на мужская стрижка" вместо "Запись на мужскую стрижку"
- "Завтра в 12:00 ждем вас на детская стрижка" вместо "на детскую стрижку"

Причина: при синхронизации услуг из YClients склонения не сохранялись в базе данных.

## Решение

### 1. Исправлена синхронизация услуг

В файле `src/services/declension/service-declension.js` исправлено несоответствие ключей:
- Было: `results.set(service.yclients_id, item)`
- Стало: `results.set(service.id, item)` 

Теперь при синхронизации услуг из YClients автоматически генерируются склонения.

### 2. Создан скрипт быстрого восстановления

Файл `scripts/fix-declensions-quick.js`:
- Предопределенные склонения для 13 основных услуг
- Автоматическая генерация для остальных услуг со словом "стрижка"
- Обработка всех 45 услуг за несколько секунд

### 3. Система склонений

#### Структура склонений в БД:
```json
{
  "nominative": "мужская стрижка",      // Именительный (что?)
  "genitive": "мужской стрижки",        // Родительный (чего?)
  "dative": "мужской стрижке",          // Дательный (чему?)
  "accusative": "мужскую стрижку",      // Винительный (что?)
  "instrumental": "мужской стрижкой",   // Творительный (чем?)
  "prepositional": "мужской стрижке",   // Предложный (о чём?)
  "prepositional_na": "мужской стрижке" // Предложный с НА (на чём?)
}
```

#### Использование в шаблонах:

В `src/services/reminder/templates.js`:
- "на {service}" → используется `prepositional_na`
- "про {service}" → используется `accusative`
- "до {service}" → используется `genitive`

## Файлы изменены

1. `src/services/declension/service-declension.js` - исправлена генерация склонений
2. `src/sync/services-sync.js` - интеграция склонений при синхронизации
3. `scripts/fix-declensions-quick.js` - скрипт восстановления склонений
4. `scripts/generate-declensions-for-existing.js` - скрипт генерации через AI

## Результат

✅ Все 45 услуг имеют правильные склонения
✅ Напоминания отправляются с корректными падежами
✅ Синхронизация сохраняет склонения

## Команды для восстановления

```bash
# Локально
node scripts/fix-declensions-quick.js

# На сервере
ssh root@46.149.70.219 "cd /opt/ai-admin && node scripts/fix-declensions-quick.js"
```

## Тестирование

Проверить падежи можно через базу данных:
```sql
SELECT title, declensions->>'accusative' as accusative, 
       declensions->>'prepositional_na' as prepositional_na 
FROM services 
WHERE company_id = 962302 
AND title LIKE '%СТРИЖКА%';
```