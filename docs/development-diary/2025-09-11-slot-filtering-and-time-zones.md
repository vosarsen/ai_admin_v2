# Исправление фильтрации слотов и временных зон

**Дата**: 11 сентября 2025
**Автор**: AI Assistant
**Категория**: Bugfix, Улучшение UX

## Контекст

Пользователь обнаружил несколько проблем в диалоге с ботом при записи на стрижку:
1. При запросе "вечером" бот предлагал слот в 15:30 (это день, а не вечер)
2. Слот в 15:30 имел только 30 минут свободного времени, хотя стрижка требует 60 минут
3. Не предлагались поздние вечерние слоты (21:00 и позже)
4. Дублирование сообщений об ошибке при попытке записи

## Анализ проблем

### 1. Неверное определение временных зон
**Было**:
- Утро: 9:00-12:00
- День: 12:00-17:00  
- Вечер: 17:00-21:00

**Проблема**: Слоты после 21:00 не попадали ни в одну категорию

### 2. Отсутствие фильтрации по длительности услуги
**Проблема**: YClients API возвращает слоты с `seance_length: 5400` (90 мин), но не учитывает реальную доступность времени. Слот в 15:30 с 30 минутами до следующей записи показывался как доступный для 60-минутной услуги.

### 3. Ошибка валидации при создании записи
**Симптом**: "Ошибка валидации данных" при попытке записи на слот с недостаточным временем

## Реализованное решение

### 1. Обновлены временные зоны
```javascript
const timeZones = {
  morning: { start: 0, end: 12, slots: [] },   // Утро: с начала дня до 12:00
  afternoon: { start: 12, end: 18, slots: [] }, // День: с 12:00 до 18:00
  evening: { start: 18, end: 24, slots: [] }    // Вечер: с 18:00 до конца дня
};
```

### 2. Добавлена фильтрация слотов по длительности
```javascript
const serviceDuration = service?.raw_data?.duration || 3600; // По умолчанию 60 минут

const validSlots = slots.filter(slot => {
  const slotDuration = slot.sum_length || slot.seance_length || 0;
  const isValid = slotDuration >= serviceDuration;
  
  if (!isValid) {
    logger.debug(`Filtering out slot ${slot.time}: duration ${slotDuration}s < required ${serviceDuration}s`);
  }
  
  return isValid;
});
```

## Результаты тестирования

### До исправления:
```
User: Сегодня во сколько можно постричься?
Bot: Сегодня свободно: 14:00, 14:30, 15:30. На какое время вас записать?
User: А вечером?
Bot: Вечером есть слот в 15:30. На какое время вас записать?
```

### После исправления:
```
User: Хочу записаться на стрижку сегодня вечером
Bot: Сегодня вечером на стрижку у мастера Бари свободно: 21:05, 21:30, 22:00
```

## Технические детали

### Измененные файлы:
- `src/services/ai-admin-v2/modules/command-handler.js`
  - Метод `organizeSlotsByTimeZones()` - обновлены границы временных зон
  - Метод `searchSlots()` - добавлена фильтрация по длительности услуги

### Ключевые изменения:
1. Расширены границы временных зон для корректной категоризации
2. Добавлена проверка `slotDuration >= serviceDuration` перед добавлением слота
3. К каждому слоту добавляется `required_duration` для отладки

## Уроки и выводы

1. **Важность контекста времени**: Пользователи ожидают, что "вечер" включает время после 18:00 до закрытия
2. **Валидация доступности**: Недостаточно проверять наличие слота, нужно учитывать длительность услуги
3. **API особенности**: YClients может возвращать слоты с некорректной длительностью, требуется дополнительная валидация

## Метрики улучшения

- **UX**: Пользователи теперь получают корректные предложения по времени
- **Надежность**: Исключены попытки записи на слоты с недостаточным временем
- **Производительность**: Фильтрация происходит на этапе поиска, экономя API запросы

## Связанные задачи

- [x] Исправить определение временных зон
- [x] Добавить фильтрацию по длительности услуги
- [x] Протестировать с реальными данными
- [ ] Рассмотреть возможность настройки временных зон для каждой компании