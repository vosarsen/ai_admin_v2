# Development Diary: Исправление показа слотов при указании конкретного времени (July 23, 2025)

## Контекст проблемы

Клиент Николай (+79163779444) написал серию сообщений:
- "Добрый вечер"
- "Хочу записаться на завтра"
- "На моделирование бороды"
- "в 18:30"

После батчинга эти сообщения были объединены, но AI ответил:
> "Николай, на завтра доступен мастер Бари. Проверю свободные слоты на моделирование бороды."

И показал все доступные слоты, хотя клиент УЖЕ указал конкретное время (18:30).

## Неправильное понимание проблемы

Изначально я неправильно понял проблему. Я думал, что нужно запретить показ слотов когда клиент говорит "хочу записаться на завтра". Но владелец продукта объяснил:

> "Показывать доступные слоты, когда клиент не указал время - хорошо. Это проактивно. Но показывать их, когда клиент просит записать его в конкретное время, а это время свободно и можно создать запись - это уже лишнее и не нужное"

## Реальная проблема

Когда клиент указывает КОНКРЕТНОЕ ВРЕМЯ (например "в 16:00", "в 18:30"), AI должен:
1. Использовать команду `[CREATE_BOOKING]` для создания записи
2. НЕ использовать `[SEARCH_SLOTS]` для показа слотов
3. НЕ спрашивать "на какое время вас записать?" если время уже указано

## Решение

### Попытка 1: Усиление промпта (частичный успех)
Изменили правила в промпте, но AI продолжал использовать SEARCH_SLOTS.

### Попытка 2: Критически важные правила
Добавили в промпт:
```
3. КРИТИЧЕСКИ ВАЖНО - АВТОМАТИЧЕСКАЯ ЗАПИСЬ: 
   - ЕСЛИ клиент указал КОНКРЕТНОЕ ВРЕМЯ (например: "в 15:00", "в три часа", "в 16:00") - это КОНКРЕТНОЕ ВРЕМЯ!
   - ЕСЛИ есть КОНКРЕТНОЕ ВРЕМЯ + УСЛУГА + ИМЯ клиента = ИСПОЛЬЗУЙ [CREATE_BOOKING]
   - НЕ ИСПОЛЬЗУЙ [SEARCH_SLOTS] когда клиент УЖЕ СКАЗАЛ ВРЕМЯ!
   - НЕ СПРАШИВАЙ "на какое время" если клиент УЖЕ СКАЗАЛ ВРЕМЯ!
```

### Попытка 3: Добавление примеров
Добавили явные примеры правильного и неправильного поведения:
```
Клиент: "Привет! Хочу записаться на стрижку завтра в 16:00" (клиент с именем Николай)
Ты: "Николай, записываю вас на стрижку завтра в 16:00. [CREATE_BOOKING service_name=стрижку, date=завтра, time=16:00]"

НЕПРАВИЛЬНО:
Клиент: "хочу записаться на стрижку завтра в 16:00"
Ты: "На какое время вас записать?" ❌ НЕПРАВИЛЬНО - клиент УЖЕ сказал время!
```

### Попытка 4: Приоритетная проверка в анализе намерения
Добавили в самое начало анализа намерения:
```
ПЕРВЫМ ДЕЛОМ ПРОВЕРЬ:
- Указал ли клиент КОНКРЕТНОЕ ВРЕМЯ? (например: "в 15:00", "в 16:00", "в три часа")
- Если ДА и есть УСЛУГА и ИМЯ → используй [CREATE_BOOKING], НЕ [SEARCH_SLOTS]!
```

## Результат

После всех изменений AI наконец начал правильно обрабатывать запросы с конкретным временем:

### Тест 1:
**Запрос**: "Добрый вечер! Запишите меня на стрижку завтра в 17:00"
**Результат**: ✅ AI выполнил `[CREATE_BOOKING]` вместо `[SEARCH_SLOTS]`

### Обнаруженная новая проблема:
AI не передает `staff_id` в команду CREATE_BOOKING, что приводит к ошибке:
```
Staff ID is not defined: {"params":{"date":"завтра","service_name":"стрижка","time":"17:00"},"staffId":null}
```

## Технические детали

### Что изменилось в промпте:
1. Усилено правило автоматической записи с явными инструкциями
2. Добавлены конкретные примеры с пометками "НЕПРАВИЛЬНО"
3. В анализ намерения добавлена первоочередная проверка конкретного времени
4. Многократно повторено правило НЕ ИСПОЛЬЗУЙ [SEARCH_SLOTS] когда время указано

### Файлы изменены:
- `/src/services/ai-admin-v2/index.js` - основной промпт AI

## Уроки и выводы

1. **DeepSeek AI требует очень явных и повторяющихся инструкций** - простого правила недостаточно
2. **Примеры работают лучше правил** - добавление примеров "НЕПРАВИЛЬНО" помогло
3. **Важно правильно понять требования** - изначально я решал не ту проблему
4. **Одна исправленная проблема может выявить другую** - теперь видна проблема с staff_id

## Следующие шаги

1. Исправить проблему с отсутствующим staff_id в CREATE_BOOKING
2. Добавить автоматический показ альтернативных слотов при ошибках бронирования
3. Протестировать граничные случаи (прошедшее время, нерабочие часы)

## Метрики успеха

- ✅ AI больше не показывает слоты при указании конкретного времени
- ✅ AI использует CREATE_BOOKING вместо SEARCH_SLOTS для конкретного времени
- ❌ Бронирование пока не работает из-за отсутствия staff_id