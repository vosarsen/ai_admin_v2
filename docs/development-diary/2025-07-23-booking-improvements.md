# Улучшения процесса создания записи и батчинга - 23 июля 2025

**Дата**: 23 июля 2025  
**Автор**: AI Admin Team  
**Статус**: Завершено и развернуто в production

## Контекст

В процессе тестирования системы были выявлены несколько критических проблем:

1. **Проблемы с батчингом**: Сообщения, отправленные по частям, обрабатывались по отдельности
2. **Неправильная интерпретация времени**: "в 3" интерпретировалось как 15:30 вместо 15:00
3. **Ошибки при создании записи**: Отсутствовал staff_id при определенных условиях
4. **Плохое распознавание имен**: Не распознавалось "я Арсен"
5. **Добавлена команда переноса записи**: RESCHEDULE_BOOKING для будущего использования

## Что было сделано

### 1. Исправлена проблема с таймаутом батчинга

**Проблема**: Батчи исчезали из Redis до обработки из-за неправильного соотношения TTL и timeout.

**Решение**:
- Увеличен TTL с 60 до 120 секунд
- Изменен batchTimeout с 10 секунд на 5, затем на 9 секунд по запросу пользователя
- Теперь батчи надежно сохраняются и обрабатываются

**Файл**: `src/services/redis-batch-service.js`
```javascript
this.defaultTTL = 120; // секунд - увеличиваем TTL для надежности
this.batchTimeout = 9000; // 9 секунд после последнего сообщения
```

### 2. Исправлена интерпретация времени

**Проблема**: AI интерпретировал "в 3" как 15:30 вместо 15:00.

**Решение**: Добавлены четкие инструкции в промпт:
```
ВАЖНО ПРО ВРЕМЯ:
- "в 3" = 15:00 (НЕ 15:30!)
- "в 3:30" или "в три тридцать" = 15:30
- "в половину четвертого" = 15:30
- Всегда интерпретируй "в X" как X:00, если не указаны минуты!
```

**Файл**: `src/services/ai-admin-v2/index.js`

### 3. Исправлена обработка staff_id

**Проблема 1**: Неправильный порядок параметров при вызове `getAvailableSlots`.

**Решение**: Исправлен порядок параметров:
```javascript
// Было: (companyId, staffId, date, serviceId)
// Стало: (staffId, date, serviceId, companyId)
```

**Проблема 2**: staff_id не определялся, когда клиент указывал имя мастера.

**Решение**:
- Добавлена обработка параметра `staff_name` от AI
- Добавлен поиск мастера по имени в тексте сообщения
- Добавлена проверка на наличие staff_id перед созданием записи

**Файл**: `src/services/ai-admin-v2/modules/command-handler.js`

### 4. Улучшено распознавание имен

**Проблема**: Не распознавалось "я Арсен" (без дефиса).

**Решение**:
- Добавлен новый паттерн: `/я\s+([А-ЯЁа-яё]+)(?:\s|$)/i`
- Добавлено имя "Арсен" в список распространенных имен
- Улучшен промпт с акцентом на распознавание имен в любой форме

**Файлы**: 
- `src/services/ai-admin-v2/modules/command-handler.js`
- `src/services/ai-admin-v2/index.js`

### 5. Улучшена логика создания записи

**Проблема**: AI спрашивал уточнения вместо создания записи, когда была вся информация.

**Решение**: Добавлена инструкция в промпт:
```
Если клиент хочет записаться и указал:
- Имя мастера
- Дату
- Время
- И в сообщении нет явного указания на конкретную услугу

Тогда:
1. Сохрани имя клиента если он представился
2. Выполни [SEARCH_SLOTS] для поиска слотов
3. Если слоты найдены и время доступно - СРАЗУ создай запись на базовую услугу
```

## Технические детали

### Изменения в промпте AI

1. **Распознавание имен**:
   - Добавлен пример: "Я [имя]" → сохрани имя через [SAVE_CLIENT_NAME]
   - Добавлена инструкция: "ВСЕГДА сохраняй имя клиента, если он представился в любой форме!"

2. **Создание записи**:
   - Обновлена сигнатура команды с указанием staff_name
   - Добавлены примеры использования staff_name

### Изменения в коде

1. **command-handler.js**:
   - Новый паттерн для распознавания имен
   - Поиск мастера по имени в тексте сообщения
   - Проверка наличия staff_id перед созданием записи
   - Исправлен порядок параметров getAvailableSlots

2. **redis-batch-service.js**:
   - Увеличен defaultTTL до 120 секунд
   - Изменен batchTimeout на 9000ms

## Результаты

### До исправлений:
- "привет я арсен запиши меня к бари завтра в 3" → бот спрашивал имя и услугу
- Время "в 3" создавало запись на 15:30
- Ошибки при создании записи из-за отсутствия staff_id
- Батчи не работали корректно

### После исправлений:
- Имя "Арсен" распознается сразу
- Время "в 3" правильно интерпретируется как 15:00
- Запись создается с первого раза без лишних вопросов
- Батчинг работает стабильно с таймаутом 9 секунд

## Извлеченные уроки

1. **Важность точных инструкций в промпте**: Даже небольшие уточнения могут существенно улучшить поведение AI
2. **Проверка всех параметров**: Необходимо валидировать наличие обязательных параметров перед API вызовами
3. **Гибкость в распознавании**: Пользователи могут представляться разными способами
4. **Баланс TTL и timeout**: Важно правильно настроить соотношение для стабильной работы батчинга

### 6. Добавлена команда переноса записи (RESCHEDULE_BOOKING)

**Контекст**: Необходима функциональность переноса записей на другое время.

**Решение**:
1. Добавлена новая команда в `command-handler.js`
2. Обновлен AI промпт для распознавания намерений переноса
3. Добавлена обработка результатов в `processAIResponse`

**Текущий статус**: Команда временно возвращает сообщение об ограничении API, так как требуются расширенные права YClients API.

**Файлы**:
- `src/services/ai-admin-v2/index.js` - добавлена команда в промпт
- `src/services/ai-admin-v2/modules/command-handler.js` - реализация метода rescheduleBooking
- `src/services/ai-admin-v2/index.js` - обработка результатов в processAIResponse

### 7. Реализована архитектура Redis-based батчинга

**Проблема**: Сообщения не объединялись при быстрой отправке по частям.

**Решение**:
1. Создан `RedisBatchService` для управления батчами
2. Создан отдельный worker процесс `batch-processor.js`
3. Новый webhook endpoint `/webhook/whatsapp/batched`
4. Настроен PM2 для запуска batch processor

**Ключевые компоненты**:
- `src/services/redis-batch-service.js` - сервис управления батчами
- `src/workers/batch-processor.js` - worker для обработки батчей
- `src/api/webhooks/whatsapp-batched.js` - новый webhook endpoint
- `ecosystem.config.js` - конфигурация PM2

## Результаты

### До исправлений:
- "привет я арсен запиши меня к бари завтра в 3" → бот спрашивал имя и услугу
- Время "в 3" создавало запись на 15:30
- Ошибки при создании записи из-за отсутствия staff_id
- Батчи не работали корректно
- Не было возможности переноса записей

### После исправлений:
- Имя "Арсен" распознается сразу
- Время "в 3" правильно интерпретируется как 15:00
- Запись создается с первого раза без лишних вопросов
- Батчинг работает стабильно с таймаутом 9 секунд
- Добавлена команда RESCHEDULE_BOOKING (ожидает права API)
- Redis батчинг полностью реализован и протестирован

## Извлеченные уроки

1. **Важность точных инструкций в промпте**: Даже небольшие уточнения могут существенно улучшить поведение AI
2. **Проверка всех параметров**: Необходимо валидировать наличие обязательных параметров перед API вызовами
3. **Гибкость в распознавании**: Пользователи могут представляться разными способами
4. **Баланс TTL и timeout**: Важно правильно настроить соотношение для стабильной работы батчинга
5. **Архитектурные решения**: Redis-based батчинг оказался наиболее надежным решением для production

## Следующие шаги

1. Мониторинг работы батчинга в production
2. Сбор обратной связи по улучшенному распознаванию имен
3. Возможное добавление других паттернов представления
4. Оптимизация промптов для других сценариев использования
5. Получение расширенных прав YClients API для активации команд RESCHEDULE_BOOKING, CANCEL_BOOKING и других