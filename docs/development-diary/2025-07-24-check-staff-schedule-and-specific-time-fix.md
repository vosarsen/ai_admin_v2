# 2025-07-24 - Добавление CHECK_STAFF_SCHEDULE и исправление показа слотов при конкретном времени

## Контекст

При тестировании обнаружились две критические проблемы:

1. **Показ всех слотов при указании конкретного времени**: Когда клиент писал "хочу записаться на 3 часа дня", AI использовал SEARCH_SLOTS и показывал все доступные слоты вместо того, чтобы сразу создать запись на указанное время.

2. **Неэффективная проверка доступности мастеров**: AI использовал SEARCH_SLOTS для проверки работает ли мастер, что приводило к лишним запросам к YClients API и показу ненужных слотов.

### Пример проблемного диалога:
```
Клиент: добрый день
Клиент: Завтра
Клиент: работает
Клиент: Сергей?
Клиент: хочу постричься
Клиент: у него?
Клиент: могу записаться
Клиент: например
Клиент: на 3 часа дня

Бот: Добрый день! Сергей действительно работает завтра. Проверю, есть ли у него свободное время на стрижку в 15:00. Как вас зовут?

У Сергей свободно завтра:
С утра: 10:00, 10:30, 11:00
Днём: 12:00, 13:00, 14:00
Вечером: 17:00, 18:00, 19:00
```

## Что было сделано

### 1. Добавлена новая команда CHECK_STAFF_SCHEDULE

Создана команда для быстрой проверки расписания мастеров через базу данных `staff_schedules`.

#### Изменения в command-handler.js:

```javascript
// Добавлен новый метод
async checkStaffSchedule(params, context) {
  const { staff_name, date } = params;
  
  // Парсим дату
  const targetDate = await dateParser.parseRelativeDate(date || 'сегодня');
  const dateStr = targetDate.toISOString().split('T')[0];
  
  // Находим мастера по имени
  let staff = null;
  if (staff_name) {
    staff = context.staff.find(s => 
      s.name.toLowerCase().includes(staff_name.toLowerCase()) ||
      staff_name.toLowerCase().includes(s.name.toLowerCase())
    );
  }
  
  // Получаем расписание из базы данных
  const supabase = require('../../../database/supabase');
  
  let query = supabase
    .from('staff_schedules')
    .select('*')
    .eq('date', dateStr);
    
  if (staff) {
    query = query.eq('staff_id', staff.yclients_id);
  }
  
  const { data: schedules, error } = await query;
  
  // Формируем результат с информацией о работающих мастерах
  // ...
}
```

### 2. Усилены правила обработки конкретного времени

#### Обновлен промпт AI (src/services/ai-admin-v2/index.js):

```javascript
// Добавлены более четкие правила
3. КРИТИЧЕСКИ ВАЖНО - АВТОМАТИЧЕСКАЯ ЗАПИСЬ: 
   - ЕСЛИ клиент указал КОНКРЕТНОЕ ВРЕМЯ (например: "в 15:00", "в три часа", "в 16:00") - это КОНКРЕТНОЕ ВРЕМЯ!
   - ЕСЛИ есть КОНКРЕТНОЕ ВРЕМЯ + УСЛУГА + ИМЯ клиента = ИСПОЛЬЗУЙ [CREATE_BOOKING]
   - ЕСЛИ есть КОНКРЕТНОЕ ВРЕМЯ + УСЛУГА, но НЕТ ИМЕНИ = сначала спроси имя, потом [CREATE_BOOKING]
   - НЕ ИСПОЛЬЗУЙ [SEARCH_SLOTS] когда клиент УЖЕ СКАЗАЛ ВРЕМЯ!
   - НЕ СПРАШИВАЙ "на какое время" если клиент УЖЕ СКАЗАЛ ВРЕМЯ!
   - НЕ ПОКАЗЫВАЙ СЛОТЫ если клиент СКАЗАЛ КОНКРЕТНОЕ ВРЕМЯ!
   - Примеры КОНКРЕТНОГО времени: "в 14:00", "в два часа", "в половину третьего", "в 16:00", "на 3 часа дня"
   - Если [CREATE_BOOKING] вернул ошибку - только тогда покажи альтернативные слоты
   - ВАЖНО: Даже если клиент спросил "работает ли мастер?" и указал время - это запрос НА ЗАПИСЬ!
```

### 3. Обновлены правила работы с мастерами

```javascript
ВАЖНО ПО МАСТЕРАМ:
- "МАСТЕРА СЕГОДНЯ" показывает ТОЛЬКО кто работает СЕГОДНЯ
- "РАСПИСАНИЕ МАСТЕРОВ" показывает кто работает в БЛИЖАЙШИЕ ДНИ
- НИКОГДА не говори "у нас нет мастера" если клиент спрашивает про другой день!
- Если клиент спрашивает "работает ли мастер" - СНАЧАЛА используй [CHECK_STAFF_SCHEDULE] для быстрой проверки
- Если мастер работает И клиент указал время - сразу используй [CREATE_BOOKING] (или спроси имя если нет)
- Если мастер работает но время НЕ указано - спроси на какое время записать
- НЕ делай выводы о доступности мастера без проверки
- Используй [SEARCH_SLOTS] только если нужно показать доступные слоты
```

### 4. Добавлены примеры использования

```javascript
Клиент: "Сергей работает завтра?"
Ты: "Проверю расписание Сергея на завтра. [CHECK_STAFF_SCHEDULE staff_name: Сергей, date: завтра]"

Клиент: "работает Сергей? хочу постричься у него на 3 часа дня"
Ты: "Проверю, работает ли Сергей завтра. Как вас зовут? [CHECK_STAFF_SCHEDULE staff_name: Сергей, date: завтра]"
(После подтверждения что работает и получения имени: [CREATE_BOOKING service_name=стрижка, staff_name=Сергей, date=завтра, time=15:00])
```

## Технические детали

### Измененные файлы:
1. **src/services/ai-admin-v2/index.js** - обновлен промпт AI с новыми правилами и командой
2. **src/services/ai-admin-v2/modules/command-handler.js** - добавлена реализация CHECK_STAFF_SCHEDULE
3. **Импорты** - добавлен импорт dateParser для парсинга дат

### Обработка результатов CHECK_STAFF_SCHEDULE:
```javascript
} else if (result.type === 'staff_schedule') {
  // Обработка результата проверки расписания мастеров
  if (result.data && result.data.targetStaff) {
    // Ответ про конкретного мастера
    const staff = result.data.targetStaff;
    if (staff.isWorking) {
      // Мастер работает - не добавляем ничего, AI сам ответит
    } else if (staff.found && !staff.isWorking) {
      finalResponse += `\n\n${staff.name} не работает ${result.data.formattedDate}.`;
    } else {
      finalResponse += `\n\n${staff.name} не найден в расписании на ${result.data.formattedDate}.`;
    }
  } else if (result.data && result.data.working.length > 0) {
    // Общее расписание
    finalResponse += `\n\n${result.data.formattedDate} работают: ${result.data.working.join(', ')}.`;
    if (result.data.notWorking.length > 0) {
      finalResponse += `\nНе работают: ${result.data.notWorking.join(', ')}.`;
    }
  } else if (result.data) {
    finalResponse += `\n\n${result.data.formattedDate} никто не работает.`;
  }
}
```

## Результаты

### Ожидаемое поведение после изменений:

**Сценарий 1: Клиент указал конкретное время**
```
Клиент: "хочу записаться к Сергею завтра на 3 часа дня"
Бот: "Проверю, работает ли Сергей завтра. Как вас зовут? [CHECK_STAFF_SCHEDULE staff_name: Сергей, date: завтра]"
Клиент: "Николай"
Бот: "Спасибо, Николай! Записываю вас к Сергею на стрижку завтра в 15:00. [SAVE_CLIENT_NAME name: Николай] [CREATE_BOOKING service_name=стрижка, staff_name=Сергей, date=завтра, time=15:00]"
✅ Запись создана!
```

**Сценарий 2: Проверка доступности мастера**
```
Клиент: "Сергей работает в пятницу?"
Бот: "Проверю расписание Сергея на пятницу. [CHECK_STAFF_SCHEDULE staff_name: Сергей, date: пятница]"
Сергей работает в пятницу.
```

### Преимущества:
1. **Меньше запросов к YClients API** - проверка через локальную БД
2. **Лучший UX** - клиент не видит лишние слоты когда указал конкретное время
3. **Быстрее ответ** - запрос к БД быстрее чем к внешнему API
4. **Точнее логика** - AI лучше понимает намерения клиента

## Проблемы для мониторинга

1. **Актуальность данных в staff_schedules** - зависит от частоты синхронизации
2. **Обработка случаев когда мастер не найден** - нужно корректное сообщение
3. **Совместимость с существующей логикой** - не должно ломать другие сценарии

## Следующие шаги

1. Протестировать новую команду в production
2. Мониторить использование CHECK_STAFF_SCHEDULE vs SEARCH_SLOTS
3. Собрать фидбек по новому поведению при указании конкретного времени
4. Возможно добавить кеширование результатов CHECK_STAFF_SCHEDULE

## Выводы

Изменения решают две важные проблемы UX:
1. Убирают показ лишних слотов когда клиент уже выбрал время
2. Ускоряют проверку доступности мастеров

Это должно значительно улучшить опыт пользователей, особенно в сценариях когда они уже знают когда хотят записаться.