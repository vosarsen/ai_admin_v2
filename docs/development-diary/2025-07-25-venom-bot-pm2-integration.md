# 2025-07-25: Интеграция Venom Bot в PM2 и исправление критической ошибки

## Контекст

Пользователь обратился с проблемой: бот не работал. При тестировании обнаружилось, что сообщения обрабатываются AI, но не отправляются в WhatsApp из-за ошибки `ECONNREFUSED ::1:3001`.

## Что было сделано

### 1. Диагностика проблемы

Обнаружено, что Venom Bot (WhatsApp сервер) не был запущен:
- Ошибка в логах: `connect ECONNREFUSED ::1:3001`
- Порт 3001 не был занят
- Venom Bot отсутствовал в списке PM2 процессов

### 2. Поиск и запуск Venom Bot

Найден рабочий Venom Bot в `/opt/venom-bot/`:
```bash
# Запуск через PM2
pm2 start /opt/venom-bot/index.js --name venom-bot
```

После запуска бот начал успешно отправлять и получать сообщения.

### 3. Интеграция в PM2 конфигурацию

Добавлен Venom Bot в `ecosystem.config.js`:
```javascript
{
  name: 'venom-bot',
  script: '/opt/venom-bot/index.js',
  instances: 1,
  exec_mode: 'fork',
  cwd: '/opt/venom-bot',
  env: {
    NODE_ENV: 'production',
    PORT: 3001
  },
  error_file: '/opt/venom-bot/logs/error.log',
  out_file: '/opt/venom-bot/logs/out.log',
  log_date_format: 'YYYY-MM-DD HH:mm:ss',
  max_memory_restart: '500M',
  autorestart: true,
  watch: false
}
```

### 4. Создание документации

Создан файл `docs/VENOM_BOT_SETUP.md` с:
- Обзором архитектуры
- PM2 командами управления
- Инструкциями по устранению неполадок
- Описанием взаимодействия с AI Admin

## Технические детали

### Архитектура взаимодействия
```
WhatsApp User → Venom Bot (3001) → Webhook → AI Admin API (3000) → Queue → Worker v2 → AI → Venom Bot → User
```

### Ключевые файлы
- `/opt/venom-bot/index.js` - основной сервер Venom Bot
- `/opt/ai-admin/ecosystem.config.js` - конфигурация PM2
- `/opt/venom-bot/tokens/` - токены сессии WhatsApp

### Безопасность
- Webhook использует HMAC-SHA256 подпись
- Venom Bot слушает только на localhost
- Секретные ключи в переменных окружения

## Проблемы и решения

**Проблема**: Venom Bot не запускался автоматически при перезагрузке сервера.

**Решение**: Добавлен в PM2 конфигурацию с `autorestart: true`.

**Проблема**: Логи Venom Bot смешивались с основными логами.

**Решение**: Настроены отдельные файлы логов в `/opt/venom-bot/logs/`.

## Уроки на будущее

1. **Важность PM2 конфигурации**: Все критичные сервисы должны быть в `ecosystem.config.js` для автоматического управления.

2. **Проверка зависимостей**: При диагностике проблем важно проверять все компоненты цепочки взаимодействия.

3. **Документирование**: Создание документации сразу после внесения изменений помогает избежать подобных проблем в будущем.

## Результат

- ✅ Бот полностью функционирует
- ✅ Venom Bot автоматически запускается при старте сервера
- ✅ Настроено логирование и мониторинг
- ✅ Создана полная документация

## Следующие шаги

1. Настроить мониторинг статуса Venom Bot
2. Добавить алерты при падении сервиса
3. Рассмотреть возможность использования WhatsApp Business API для большей надежности