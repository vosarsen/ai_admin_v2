# Service Matcher Fix - Приоритет точных совпадений

## Дата: 30 июля 2025

## Контекст

Клиент с номером +79686484488 попросил записать его на "воск комплекс", но AI записал его на услугу "воск" вместо "воск комплекс".

## Проблема

При анализе логов выяснилось, что система ServiceMatcher присвоила более высокий балл услуге "ВОСК" (145 баллов) по сравнению с "ВОСК КОМПЛЕКС" (100 баллов), несмотря на точное совпадение запроса с услугой "ВОСК КОМПЛЕКС".

### Детали подсчета баллов:
- **"ВОСК"** получил 145 баллов:
  - query_contains_title: 70 баллов (так как "воск комплекс" содержит "воск")
  - word_matches: 20 баллов (слово "воск" найдено)
  - synonyms: 30 баллов
  - simple_service_bonus: 25 баллов (бонус за простую услугу)

- **"ВОСК КОМПЛЕКС"** получил 100 баллов:
  - exact_match: 100 баллов (точное совпадение)

## Решение

Изменен алгоритм подсчета баллов в `src/services/ai-admin-v2/modules/service-matcher.js`:

1. **Точное совпадение** теперь дает 1000 баллов (было 100) - это гарантирует максимальный приоритет
2. **Добавлено новое правило `all_words_match`** (500 баллов) - срабатывает когда все значимые слова запроса (длиннее 2 символов) присутствуют в названии услуги
3. Сохранена обратная совместимость для других сценариев поиска

### Код изменений:
```javascript
// 1. Точное совпадение = 1000 баллов (максимальный приоритет)
if (serviceTitle === query) {
  scoreDetails.components.push({ rule: 'exact_match', points: 1000 });
  scoreDetails.totalScore = 1000;
  logger.info('Service match details:', scoreDetails);
  return 1000;
}

// 2. Проверка, что все слова запроса есть в названии услуги = 500 баллов
const significantQueryWords = queryWords.filter(w => w.length > 2); // Игнорируем предлоги
const allQueryWordsInService = significantQueryWords.length > 1 && 
  significantQueryWords.every(qWord => 
    serviceWords.some(sWord => sWord.includes(qWord))
  );

if (allQueryWordsInService) {
  score += 500;
  scoreDetails.components.push({ rule: 'all_words_match', points: 500 });
}
```

## Результат

Теперь при запросе "воск комплекс":
- **"ВОСК КОМПЛЕКС"** получит 1000 баллов (exact_match)
- **"ВОСК"** получит максимум 145 баллов

Система будет правильно выбирать услугу "ВОСК КОМПЛЕКС" когда клиент явно указывает полное название услуги.

## Тестирование

После деплоя нужно протестировать:
1. Запрос "воск комплекс" → должен выбрать "ВОСК КОМПЛЕКС"
2. Запрос "воск" → должен выбрать "ВОСК"
3. Запрос "стрижка машинкой" → должен выбрать "СТРИЖКА МАШИНКОЙ | 1 НАСАДКА"
4. Запрос "стрижка" → должен выбрать базовую услугу стрижки

## Уроки

1. При разработке алгоритмов скоринга важно тестировать на реальных данных
2. Точное совпадение должно всегда иметь наивысший приоритет
3. Нужно регулярно проверять логи на предмет неправильного выбора услуг