# Сохранение склонений при синхронизации

**Дата**: 31 августа 2025
**Автор**: AI Admin Team

## Контекст

После успешной реализации системы автоматической генерации склонений (30 августа), обнаружилась критическая проблема: при ежедневной синхронизации данных из YClients склонения удалялись из базы данных, приводя к неправильным падежам в напоминаниях.

## Проблема

### Симптомы:
- Склонения периодически пропадали из БД (поле `declensions` становилось NULL)
- Напоминания отправлялись с неправильными падежами: "на мужская стрижка" вместо "на мужскую стрижку"

### Причина:
Процесс синхронизации (`src/sync/services-sync.js` и `src/sync/staff-sync.js`) при каждом запуске:
1. Загружал данные из YClients (без склонений)
2. Пытался сгенерировать склонения через AI
3. Если AI недоступен или произошла ошибка → склонения = NULL
4. Перезаписывал все данные в БД, включая NULL склонения

### Расписание синхронизации:
```javascript
// src/sync/sync-manager.js
services: '0 1 * * *',     // 01:00 - Услуги (раз в день)
staff: '0 2 * * *',        // 02:00 - Мастера (раз в день)
```

## Решение

### 1. Сохранение существующих склонений

**Модифицирован `src/sync/services-sync.js`:**
```javascript
// Получаем существующие услуги из БД для сохранения склонений
const { data: existingServices } = await supabase
  .from(this.tableName)
  .select('yclients_id, declensions')
  .eq('company_id', this.config.COMPANY_ID);

// Создаем маппинг существующих склонений
const existingDeclensionsMap = new Map();
if (existingServices) {
  existingServices.forEach(service => {
    if (service.declensions) {
      existingDeclensionsMap.set(service.yclients_id, service.declensions);
    }
  });
}

// Определяем новые услуги (для которых нужно генерировать склонения)
const newServices = services.filter(service => 
  !existingDeclensionsMap.has(service.id)
);

// Генерируем склонения ТОЛЬКО для новых услуг
if (newServices.length > 0) {
  const declensionsMap = await serviceDeclension.generateBatchDeclensions(newServices);
  // Добавляем новые склонения к общему маппингу
}

// Применяем склонения ко всем услугам (существующие или новые)
services.forEach(service => {
  if (existingDeclensionsMap.has(service.id)) {
    service.declensions = existingDeclensionsMap.get(service.id);
  }
});
```

### 2. Аналогичные изменения для мастеров

**Модифицирован `src/sync/staff-sync.js`:**
- Та же логика: загружаем существующие склонения
- Генерируем только для новых мастеров
- Сохраняем существующие склонения при обновлении

### 3. Восстановление потерянных склонений

**Создан скрипт `scripts/regenerate-all-declensions.js`:**
- Находит все записи без склонений
- Генерирует склонения через AI
- Обновляет только те записи, где склонений не было

**Быстрое восстановление `scripts/fix-declensions-quick.js`:**
- Предопределенные склонения для основных услуг
- Используется когда AI недоступен
- Моментальное восстановление без внешних зависимостей

## Результаты

1. ✅ Синхронизация больше не удаляет существующие склонения
2. ✅ Новые услуги/мастера автоматически получают склонения
3. ✅ Если AI недоступен, существующие склонения сохраняются
4. ✅ Восстановлены склонения для всех 45 услуг

## Технические детали

### Измененные файлы:
- `src/sync/services-sync.js` - добавлено сохранение существующих склонений
- `src/sync/staff-sync.js` - добавлено сохранение существующих склонений
- `scripts/regenerate-all-declensions.js` - скрипт полной регенерации
- `scripts/fix-declensions-quick.js` - быстрое восстановление

### Важные замечания:
1. **AI доступность**: DeepSeek API иногда обрывает соединение (ECONNRESET), но это не должно влиять на существующие данные
2. **Производительность**: Загрузка существующих склонений добавляет ~200ms к синхронизации, но это приемлемо
3. **Масштабируемость**: Решение работает для любого количества услуг и мастеров

## Уроки на будущее

1. **Никогда не перезаписывать критичные данные**: При синхронизации всегда проверять и сохранять существующие значения
2. **Graceful degradation**: Если внешний сервис недоступен, система должна продолжать работать с существующими данными
3. **Тестирование синхронизации**: Нужны тесты, которые проверяют, что синхронизация не удаляет существующие данные
4. **Мониторинг**: Добавить алерты на случай массового удаления склонений

## Команды для восстановления

```bash
# Полная регенерация через AI (может быть медленно)
node scripts/regenerate-all-declensions.js

# Быстрое восстановление с предопределенными склонениями
node scripts/fix-declensions-quick.js

# Ручная синхронизация с сохранением склонений
node scripts/manual-sync.js services
```

## Статус

✅ Проблема решена, склонения сохраняются при синхронизации и восстановлены для всех услуг.