# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

**–î–∞—Ç–∞**: 26 –∞–≤–≥—É—Å—Ç–∞ 2025
**–ê–≤—Ç–æ—Ä**: –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ—à–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞: AI Admin —Ç–µ—Ä—è–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è –≤ Redis.

### –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: —Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ —á–µ—Ç–≤–µ—Ä–≥
AI: –ù–∞ —á–µ—Ç–≤–µ—Ä–≥ –µ—Å—Ç—å –≤—Ä–µ–º—è... [–Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ]
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –î–∞–≤–∞–π—Ç–µ –Ω–∞ 16:00  
AI: –ù–∞ –∫–∞–∫—É—é —É—Å–ª—É–≥—É —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è? [–∑–∞–±—ã–ª —á—Ç–æ —É–∂–µ –æ–±—Å—É–∂–¥–∞–ª–∏]
```

## –ê–Ω–∞–ª–∏–∑

### –î–≤–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
–í –ø—Ä–æ–µ–∫—Ç–µ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–≤–µ —Å–∏—Å—Ç–µ–º—ã:
1. **–°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞** (`src/services/context/index.js`)
   - –ö–ª—é—á–∏ –≤ Redis: `context:companyId:phone`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ `data` –∫–∞–∫ JSON —Å—Ç—Ä–æ–∫—É
   
2. **–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ context-v2** (`src/services/context/context-service-v2.js`)  
   - –ö–ª—é—á–∏ –≤ Redis: `dialog:companyId:phone`
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å –ø–æ–ª–µ–º `selection`

### –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã
–ü—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ –≤—ã—è—Å–Ω–∏–ª–æ—Å—å:
1. –ö–æ–Ω—Ç–µ–∫—Å—Ç –°–û–•–†–ê–ù–Ø–õ–°–Ø –≤ Redis: `"dataField":"{\"lastDate\":\"—á–µ—Ç–≤–µ—Ä–≥\",\"lastService\":\"–°–¢–†–ò–ñ–ö–ê\"}"`
2. –ù–æ –ù–ï –ü–ï–†–ï–î–ê–í–ê–õ–°–Ø –≤ Stage 1 –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
3. –ú–µ—Ç–æ–¥ `getContext()` —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª –ø–æ–ª–µ `data`
4. two-stage-processor –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª `currentSelection` –∏–∑ context-v2

## –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω contextService (`src/services/context/index.js`)
```javascript
return {
  // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
  // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ data –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ two-stage processor
  data: contextData?.data
};
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω two-stage-processor
```javascript
const commandPromptText = this.commandPrompt.getPrompt({
  // ... –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  currentSelection: context.currentSelection // –ü–µ—Ä–µ–¥–∞–µ–º –∏–∑ context-v2
});
```

### 3. –£–ª—É—á—à–µ–Ω –ø—Ä–æ–º–ø—Ç (`two-stage-command-prompt.js`)
```javascript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¢–†–ò –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
const previousContext = {
  lastService: currentSelection.service || parsedRedisData.lastService || parsedRedisData.selectedService,
  lastDate: currentSelection.date || parsedRedisData.lastDate || parsedRedisData.selectedDate,
  // ...
};
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥:
```
Message 1: "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ —á–µ—Ç–≤–µ—Ä–≥"
–†–µ–∑—É–ª—å—Ç–∞—Ç: AI –Ω–∞—à–µ–ª —Å–ª–æ—Ç—ã –Ω–∞ —á–µ—Ç–≤–µ—Ä–≥, —Å–æ—Ö—Ä–∞–Ω–∏–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç

Message 2: "–î–∞–≤–∞–π—Ç–µ –Ω–∞ 16:00"  
–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ AI –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å–æ–∑–¥–∞–ª –∑–∞–ø–∏—Å—å
```

### –õ–æ–≥–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç:
```
üìù Previous context for Stage 1: {
  lastService: '–°–¢–†–ò–ñ–ö–ê',
  lastStaff: '–ë–∞—Ä–∏',
  lastDate: '—á–µ—Ç–≤–µ—Ä–≥'
}

‚úÖ CREATE_BOOKING —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–ª–∞ –∑–∞–ø–∏—Å—å id: 1241378607
ü§ñ Bot: "–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞–ª –≤–∞—Å –Ω–∞ –º—É–∂—Å–∫—É—é —Å—Ç—Ä–∏–∂–∫—É 28 –∞–≤–≥—É—Å—Ç–∞ –≤ 16:00 –∫ –º–∞—Å—Ç–µ—Ä—É –ë–∞—Ä–∏."
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `/src/services/context/index.js` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `data` –≤ return
2. `/src/services/ai-admin-v2/modules/two-stage-processor.js` - –ø–µ—Ä–µ–¥–∞—á–∞ currentSelection
3. `/src/services/ai-admin-v2/prompts/two-stage-command-prompt.js` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- –û–±–µ—Å–ø–µ—á–µ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –º–µ–∂–¥—É –¥–≤—É–º—è —Å–∏—Å—Ç–µ–º–∞–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –Ω–æ–≤–æ–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ø–æ–ª–µ–π (lastService/selectedService)

## –í—ã–≤–æ–¥—ã

1. **–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é** - –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞—é—Ç –æ–±–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ

1. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É context-v2
2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
3. –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞