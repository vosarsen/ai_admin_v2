# 22 июля 2025 - Исправление ненужного показа слотов

## Проблема

Когда клиент просит записать на конкретное время (например, "запиши меня завтра в 16:00"), бот всегда показывает доступные слоты, даже если клиент их не просил. Это создает плохой UX.

### Пример проблемы:
```
Клиент: Здравствуйте! Хочу записаться на стрижку завтра в 16:00. Меня зовут Василий
Бот: Василий, проверю свободное время на завтра в 16:00 на стрижку.

У Рамзан свободно завтра:
С утра: 11:05, 11:30
Днём: 12:00, 13:00, 14:00
Вечером: 17:00, 18:00, 19:00
```

Клиент не спрашивал "когда можно", он указал конкретное время!

## Анализ

### Причина проблемы:

1. **В промпте** была инструкция всегда использовать `[SEARCH_SLOTS]` для проверки доступности
2. **В коде** `processAIResponse()` всегда добавлял результаты SEARCH_SLOTS к ответу
3. AI выполнял SEARCH_SLOTS даже когда клиент указал конкретное время

### Найденные места в коде:

1. `src/services/ai-admin-v2/index.js:257` - промпт заставлял всегда использовать SEARCH_SLOTS
2. `src/services/ai-admin-v2/index.js:367` - автоматическое добавление слотов к ответу
3. `src/services/ai-admin-v2/modules/formatter.js:293` - форматирование "У X свободно"

## Решение

### 1. Изменен промпт (index.js):
```javascript
// Было:
- Сначала используй [SEARCH_SLOTS] чтобы проверить доступность
- Если время свободно - СРАЗУ используй [CREATE_BOOKING] без подтверждения

// Стало:
- НЕ ИСПОЛЬЗУЙ [SEARCH_SLOTS] - сразу пытайся создать запись через [CREATE_BOOKING]
- Если [CREATE_BOOKING] успешен - запись создана
- Если [CREATE_BOOKING] вернул ошибку "недоступно" - только тогда используй [SEARCH_SLOTS]
```

### 2. Обновлены примеры в промпте:
```javascript
// Было:
Ты: "Проверю доступность на завтра в 15:00. [SEARCH_SLOTS...] [CREATE_BOOKING...]"

// Стало:
Ты: "Записываю вас на стрижку завтра в 15:00. [CREATE_BOOKING service_name=стрижка, date=завтра, time=15:00]"
```

### 3. Улучшен CREATE_BOOKING (command-handler.js):
- Теперь поддерживает параметр `service_name` (не только service_id)
- Автоматически находит подходящего мастера, если staff_id не указан
- Проверяет доступность времени для каждого мастера

## Ожидаемый результат

Теперь бот должен:
1. При запросе на конкретное время - сразу пытаться создать запись
2. Показывать слоты только если:
   - Время занято (ошибка "недоступно")
   - Клиент явно спросил ("когда можно", "покажи время", "есть слоты")

## Статус

- ✅ Код изменен и задеплоен на сервер
- ⏳ **НЕ ПРОТЕСТИРОВАНО** - нужно проверить через реальный WhatsApp
- ⏳ Нужно проверить все сценарии:
  - Запись на свободное время (должна создаваться без показа слотов)
  - Запись на занятое время (должны показаться альтернативы)
  - Явный запрос слотов (должны показаться слоты)

## Важные заметки

1. Изменение может повлиять на другие сценарии - нужно тщательное тестирование
2. Если мастер не указан, система теперь автоматически найдет доступного
3. CREATE_BOOKING может быть медленнее из-за проверки всех мастеров