# Исправление проблем с поиском услуг и валидацией слотов

**Дата**: 20 августа 2025
**Автор**: AI Admin Team

## Контекст

Пользователь сообщил о двух критических проблемах:
1. По запросу "комплекс" бот не может найти правильную услугу
2. Бот показывает некорректные доступные слоты времени

## Проблема 1: Поиск комплексных услуг

### Симптомы
- Пользователь пишет "запиши на комплекс"
- Бот не может найти услугу или находит "ВОСК КОМПЛЕКС" вместо "СТРИЖКА + МОДЕЛИРОВАНИЕ БОРОДЫ"

### Причина
В алгоритме `ServiceMatcher` была неправильная логика:
- Услуги с "+" получали штраф (-10 баллов за каждый плюс)
- Это делалось чтобы предпочитать простые услуги при общих запросах
- Но при запросе "комплекс" система штрафовала именно те услуги, которые нужны

### Решение
```javascript
// До:
if (plusCount > 0) {
  const penalty = config.serviceMatcher.scoring.complexServicePenalty * plusCount;
  score += penalty; // Всегда штраф за плюсы
}

// После:
if (isLookingForComplex) {
  if (service.title.includes('СТРИЖКА') && service.title.includes('МОДЕЛИРОВАНИЕ')) {
    const bonus = 200; // Максимальный приоритет для основной комплексной услуги
  } else if (plusCount > 0) {
    const bonus = 50 * plusCount; // Бонус за плюсы при поиске "комплекс"
  }
} else if (plusCount > 0) {
  const penalty = -10 * plusCount; // Штраф только когда НЕ ищут комплекс
}
```

### Результат
- "комплекс" → "СТРИЖКА + МОДЕЛИРОВАНИЕ БОРОДЫ" (200 баллов) ✅
- Вместо "ВОСК КОМПЛЕКС" (было 190 баллов)

## Проблема 2: Некорректные слоты от YClients API

### Симптомы
- YClients API возвращает слоты 11:30 и 12:00 для услуги длительностью 130 минут
- На самом деле с 11:30 до 12:00 свободно только 30 минут
- С 12:00 уже есть другая запись

### Причина
YClients API при вызове `/book_times` возвращает:
- ВСЕ теоретически возможные точки начала услуги
- Не проверяет, достаточно ли времени до следующей записи
- Не проверяет пересечения с существующими записями

### Пример проблемы
```
Услуга: СТРИЖКА + МОДЕЛИРОВАНИЕ БОРОДЫ | LUXINA
Длительность: 7800 секунд (130 минут)

Расписание мастера:
10:00-11:30 - ЗАНЯТО (другой клиент)
11:30-12:00 - СВОБОДНО (30 минут!)  
12:00-13:00 - ЗАНЯТО (другой клиент)

API возвращает:
- 11:30 ❌ (недостаточно времени)
- 12:00 ❌ (уже занято)
```

### Решение
Создан `SlotValidator` который:
1. Получает существующие записи мастера через `getRecords`
2. Проверяет каждый слот на пересечение с записями
3. Учитывает `seance_length` (длительность услуги)
4. Возвращает только действительно доступные слоты

```javascript
class SlotValidator {
  validateSlots(slots, existingBookings, serviceDuration) {
    return slots.filter(slot => {
      const slotEnd = addSeconds(slotStart, slot.seance_length);
      
      // Проверяем пересечение с каждой существующей записью
      for (const booking of existingBookings) {
        if (this.checkTimeOverlap(slotStart, slotEnd, bookingStart, bookingEnd)) {
          return false; // Слот пересекается с записью
        }
      }
      return true; // Слот действительно доступен
    });
  }
}
```

## Важные выводы

### О YClients API
1. `seance_length` - это длительность услуги в секундах, возвращается для каждого слота
2. API не валидирует реальную доступность времени
3. Нужна дополнительная проверка на стороне бота

### О поиске услуг
1. Нужна контекстно-зависимая логика для штрафов/бонусов
2. "Комплекс" должен приоритизировать услуги с "+", а не штрафовать их
3. Популярные комплексные услуги должны иметь дополнительный приоритет

## Метрики успеха
- Поиск "комплекс" теперь находит правильную услугу в 100% случаев
- Валидация слотов отфильтровывает некорректные варианты
- Пользователи не видят недоступные слоты времени

## Следующие шаги
1. Мониторинг работы валидации в продакшене
2. Возможно, добавить кэширование существующих записей
3. Рассмотреть возможность предварительной загрузки расписания