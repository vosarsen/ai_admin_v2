# Развертывание Redis батчинга и исправление критических ошибок

**Дата**: 23 июля 2025, 15:00-16:00
**Автор**: AI Admin Team
**Статус**: Частично завершено

## Резюме сессии

В этой сессии мы успешно развернули Redis-based батчинг в production и обнаружили несколько критических ошибок в процессе создания записей. Батчинг теперь работает для всех реальных клиентов, но требуются дополнительные исправления для корректной работы записи.

## 1. Развертывание Redis батчинга

### Что было сделано:

#### 1.1 Настройка Venom Bot для использования нового webhook
- **Проблема**: Venom Bot использовал старый webhook `/webhook/whatsapp`
- **Решение**: Изменили URL в `/opt/venom-bot/index.js` на `/webhook/whatsapp/batched`
- **Результат**: Все сообщения от клиентов теперь проходят через батчинг

#### 1.2 Увеличение таймаута батчинга
- **Было**: 5 секунд
- **Стало**: 10 секунд
- **Причина**: Дать пользователям больше времени для отправки сообщений по частям
- **Реализация**: Изменен параметр `batchTimeout` в `RedisBatchService`

#### 1.3 Инициализация batch service в webhook
- **Проблема**: `Cannot read properties of null (reading 'rpush')`
- **Причина**: batchService не был инициализирован в webhook модуле
- **Решение**: Добавлена автоматическая инициализация при загрузке модуля

### Результаты тестирования:

**Тест с реальным клиентом Николаем (+79163779444)**:
```
15:38:14 - "Запишите на стрижку меня"
15:38:17 - "На завтра"
15:38:22 - "В 18:00"
15:38:26 - "К Бари"
→ Объединено в: "Запишите на стрижку меня На завтра В 18:00 К Бари"
```

✅ **Батчинг работает корректно!**

## 2. Обнаруженные и исправленные ошибки

### 2.1 Неправильный порядок параметров в getAvailableSlots

**Симптом**: Ошибка 404 "Филиала с идентификатором 18356010 не найдено"

**Причина**: 
```javascript
// Было (неправильно):
await this.getAvailableSlots(
  staffMember.yclients_id,
  targetDate,
  actualServiceId,  // ❌ serviceId передавался как 3-й параметр
  companyId
);

// Стало (правильно):
await this.getAvailableSlots(
  staffMember.yclients_id,
  targetDate,
  { service_id: actualServiceId },  // ✅ serviceId в объекте params
  companyId
);
```

**Где исправлено**: 
- `src/services/booking/index.js` (строки 166-170 и 241-245)

**Результат**: API теперь корректно проверяет доступность слотов

### 2.2 Отсутствие staff_id при создании записи

**Симптом**: Ошибка валидации данных при создании записи

**Проблема**:
```json
// Отправляется:
{
  "appointments": [{
    "id": 1,
    "services": [18356394],
    "datetime": "2025-07-24 18:30:00"
    // ❌ Отсутствует staff_id
  }]
}

// Должно быть:
{
  "appointments": [{
    "id": 1,
    "services": [18356394],
    "staff_id": 3413963,
    "datetime": "2025-07-24 18:30:00"
  }]
}
```

**Статус**: ❌ Не исправлено (требует дополнительного анализа)

## 3. Анализ работы системы

### 3.1 Успешная обработка батчей

Batch processor корректно обрабатывает сообщения:
- Ждет настроенный таймаут (10 секунд)
- Объединяет сообщения в правильном порядке
- Передает объединенное сообщение в обработку
- AI корректно понимает объединенный контекст

### 3.2 Проблемы с созданием записей

1. **AI корректно извлекает параметры**:
   - Услуга: стрижка → service_id: 18356010
   - Мастер: Бари → staff_id: 3413963
   - Дата: завтра → "2025-07-24"
   - Время: 18:00

2. **Но при создании записи**:
   - AI использует `staff_id: "last"` (из контекста)
   - Код не обрабатывает "last" правильно
   - В итоге staff_id не попадает в запрос

## 4. Технические детали

### 4.1 Конфигурация батчинга
```javascript
class RedisBatchService {
  constructor() {
    this.batchTimeout = 10000;    // 10 секунд
    this.maxBatchSize = 10;       // максимум сообщений
    this.defaultTTL = 10;         // TTL для Redis ключей
  }
}
```

### 4.2 Новые эндпоинты
- `POST /webhook/whatsapp/batched` - основной webhook для батчинга
- `GET /webhook/whatsapp/batched/stats` - статистика батчей
- `DELETE /webhook/whatsapp/batched/:phone` - очистка батча

### 4.3 PM2 конфигурация
```javascript
{
  name: 'ai-admin-batch-processor',
  script: './src/workers/batch-processor.js',
  instances: 1,
  max_memory_restart: '200M'
}
```

## 5. Метрики производительности

- **Время объединения**: 5-10 секунд (настраиваемо)
- **Обработка батча**: <100ms
- **Размер батча**: до 10 сообщений
- **Использование памяти batch processor**: ~60MB

## 6. Оставшиеся задачи

### Критические:
1. ❌ Исправить обработку `staff_id: "last"` в command-handler
2. ❌ Добавить автоматическое предложение альтернативных слотов при ошибке
3. ❌ Улучшить обработку ошибок валидации от YClients API

### Желательные:
1. ⚠️ Добавить метрики батчинга в monitoring dashboard
2. ⚠️ Настроить алерты при накоплении необработанных батчей
3. ⚠️ Добавить возможность настройки таймаута через конфигурацию

## 7. Команды для мониторинга

```bash
# Проверить статус батчей
curl http://46.149.70.219:3000/webhook/whatsapp/batched/stats

# Логи batch processor
ssh root@46.149.70.219 "pm2 logs ai-admin-batch-processor --lines 50"

# Найти объединенные сообщения
ssh root@46.149.70.219 "grep 'Processing batch' ~/.pm2/logs/ai-admin-batch-processor-out.log"

# Проверить использование нового webhook
ssh root@46.149.70.219 "tail -100 /opt/ai-admin/logs/api-out-0.log | grep 'POST /webhook'"
```

## 8. Выводы

1. **Redis батчинг успешно развернут** и работает в production
2. **Все клиенты теперь используют батчинг** через новый webhook
3. **Обнаружены и частично исправлены** критические ошибки в создании записей
4. **Требуется дополнительная работа** над обработкой параметров из AI

Батчинг значительно улучшает пользовательский опыт, позволяя клиентам отправлять сообщения естественным образом, по частям.