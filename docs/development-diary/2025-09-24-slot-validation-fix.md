# Исправление валидации доступности слотов

**Дата**: 24 сентября 2025
**Автор**: Арсен (с помощью Claude)
**Контекст**: Клиент Олег попытался записаться на 19:00, бот сказал что время занято, хотя в YClients оно было свободно

## Проблема

При запросе клиента на запись в 19:00, система неправильно определяла доступность слота:
- YClients API показывал слот 19:00 как свободный
- Система валидации отклоняла его как недоступный
- После того как администратор вручную записал клиента на 19:00, система все равно показывала этот слот как свободный другим клиентам

## Анализ

### Причина 1: Неправильная длительность услуги
YClients API возвращал `seance_length: 7800` секунд (130 минут) для услуги "СТРИЖКА: УТРО", хотя в базе данных правильно указано 3600 секунд (60 минут).

**Влияние**: Система думала, что услуга длится 2 часа 10 минут, поэтому слот в 19:00 "не помещался" до следующей записи в 20:00.

### Причина 2: Неполная проверка пересечений времени
Функция `checkTimeOverlap` использовала `isAfter` и `isBefore` из date-fns, которые не включают равенство:
- `isAfter(19:00, 19:00)` = false
- `isBefore(19:00, 19:00)` = false

**Влияние**: Когда два слота начинались в одно время (оба в 19:00), система не определяла это как конфликт.

## Решение

### Исправление 1: Приоритет длительности из БД
```javascript
// До:
const duration = slot.seance_length || serviceDuration || 3600;

// После:
const duration = serviceDuration || slot.seance_length || 3600;
```
Теперь система приоритизирует длительность из базы данных над значением из YClients API.

### Исправление 2: Улучшенная проверка пересечений
```javascript
// До:
return (
  (isAfter(start1, start2) && isBefore(start1, end2)) ||
  (isAfter(end1, start2) && isBefore(end1, end2)) ||
  (isBefore(start1, start2) && isAfter(end1, end2)) ||
  (isAfter(start1, start2) && isBefore(end1, end2))
);

// После:
const overlap = (
  (isEqual(start1, start2)) ||                          // начинаются одновременно
  (isAfter(start1, start2) && isBefore(start1, end2)) ||
  (isAfter(end1, start2) && isBefore(end1, end2)) ||
  (isEqual(end1, end2)) ||                              // заканчиваются одновременно
  (isBefore(start1, start2) && isAfter(end1, end2))
);
```

Добавлена проверка `isEqual` для случаев, когда слоты начинаются или заканчиваются в одно время.

## Файлы изменены
- `src/services/booking/slot-validator.js` - основная логика валидации слотов

## Результаты тестирования

**До исправления**:
- Слот 19:00 ошибочно блокировался при отсутствии записей
- После записи клиента на 19:00, слот все равно показывался как доступный

**После исправления**:
- Система корректно использует длительность 60 минут
- Занятые слоты правильно исключаются из списка доступных
- При тестировании бот показал только реально свободные слоты: 17:00, 17:30, 18:00, 21:00

## Уроки

1. **Не доверяй внешним API полностью** - YClients может возвращать неточные данные. Важно иметь свой источник правды (БД).

2. **Граничные условия критичны** - функции сравнения дат часто не включают равенство, это нужно учитывать явно.

3. **Логирование помогает** - добавленное отладочное логирование поможет быстрее находить подобные проблемы в будущем.

## Метрики
- Время на анализ: ~20 минут
- Время на исправление: ~10 минут
- Количество измененных строк: 27 (19 добавлено, 8 удалено)
- Влияние: критическое - клиенты не могли записываться на доступное время

## Следующие шаги
- Мониторить логи на предмет сообщений "Time overlap detected"
- Рассмотреть возможность полного отказа от `seance_length` из YClients API в пользу данных из БД
- Добавить unit-тесты для функции `checkTimeOverlap` с граничными случаями