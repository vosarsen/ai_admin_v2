# Реализация системы мониторинга новых записей

**Дата**: 25 июля 2025
**Автор**: AI Assistant с Claude Code

## Контекст

Пользователь запросил функциональность автоматической отправки уведомлений клиентам при создании записи администратором через YClients. Сценарий: клиент звонит в барбершоп, администратор создает запись, клиент автоматически получает WhatsApp уведомление.

## Что было сделано

### 1. Исследование возможностей YClients API

Изначально планировалось использовать webhook от YClients, но выяснилось, что их webhook поддерживает только события:
- `uninstall` - отключение приложения
- `freeze` - заморозка интеграции

События создания/изменения записей не поддерживаются через webhook.

### 2. Реализация polling-based решения

Создан сервис `BookingMonitorService`, который:
- Проверяет новые записи каждую минуту
- Сравнивает с последней проверкой
- Отправляет уведомления через WhatsApp

### 3. Ключевые компоненты

#### BookingMonitorService (`src/services/booking-monitor/index.js`)
- Периодическая проверка новых записей
- Фильтрация записей созданных через бота
- Задержка отправки на 30 секунд
- Форматирование и отправка уведомлений

#### Worker (`src/workers/booking-monitor-worker.js`)
- Запуск и управление сервисом
- Graceful shutdown
- Обработка ошибок

#### База данных
- `booking_monitor_state` - состояние мониторинга
- `booking_notifications` - история уведомлений

### 4. Особенности реализации

1. **Задержка отправки**: 30 секунд после создания записи, чтобы администратор мог внести изменения

2. **Предотвращение дублей**: 
   - Проверка в таблице `booking_notifications`
   - Фильтрация записей созданных через бота

3. **Надежность**:
   - Сохранение состояния между перезапусками
   - Обработка ошибок без остановки сервиса
   - Детальное логирование

## Технические детали

### Алгоритм работы
```
1. Каждую минуту:
   - Получить записи на сегодня и завтра
   - Отфильтровать новые (created > last_checked_at)
   - Для каждой новой записи:
     - Проверить, не наша ли это запись
     - Проверить, прошло ли 30 секунд
     - Отправить уведомление
     - Сохранить в БД
```

### Конфигурация
```bash
BOOKING_MONITOR_ENABLED=true          # Включить/выключить
BOOKING_MONITOR_INTERVAL=60000        # Интервал проверки (мс)
BOOKING_NOTIFICATION_DELAY=30000      # Задержка отправки (мс)
```

## Проблемы и решения

### Проблема 1: YClients API не поддерживает фильтрацию по времени создания
**Решение**: Получаем все записи на сегодня/завтра и фильтруем локально

### Проблема 2: Как отличить записи созданные ботом от записей администратора
**Решение**: Проверяем таблицу `bookings` - если запись там есть, значит создана ботом

### Проблема 3: Администратор может изменить запись после создания
**Решение**: Добавили задержку 30 секунд перед отправкой

## Результат

Реализована полноценная система автоматических уведомлений:
- ✅ Клиенты получают уведомления о записях созданных администратором
- ✅ Нет дублирования с уведомлениями от бота
- ✅ Есть задержка для возможности корректировки
- ✅ Система надежна и восстанавливается после сбоев

## Следующие шаги

1. Развернуть на production сервере
2. Протестировать с реальными записями
3. Настроить мониторинг производительности
4. Возможно, добавить настройку задержки per-company

## Уроки

1. **Всегда проверяйте документацию API** - webhook YClients оказался ограниченным
2. **Polling может быть хорошим решением** - простое, надежное, контролируемое
3. **Задержка важна** - дает время на исправление ошибок
4. **Состояние нужно персистить** - для восстановления после сбоев