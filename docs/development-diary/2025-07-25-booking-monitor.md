# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π

**–î–∞—Ç–∞**: 25 –∏—é–ª—è 2025
**–ê–≤—Ç–æ—Ä**: AI Assistant —Å Claude Code

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —á–µ—Ä–µ–∑ YClients. –°—Ü–µ–Ω–∞—Ä–∏–π: –∫–ª–∏–µ–Ω—Ç –∑–≤–æ–Ω–∏—Ç –≤ –±–∞—Ä–±–µ—Ä—à–æ–ø, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å, –∫–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç WhatsApp —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π YClients API

–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–æ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å webhook –æ—Ç YClients, –Ω–æ –≤—ã—è—Å–Ω–∏–ª–æ—Å—å, —á—Ç–æ –∏—Ö webhook –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è:
- `uninstall` - –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `freeze` - –∑–∞–º–æ—Ä–æ–∑–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

–°–æ–±—ã—Ç–∏—è —Å–æ–∑–¥–∞–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ webhook.

### 2. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è polling-based —Ä–µ—à–µ–Ω–∏—è

–°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å `BookingMonitorService`, –∫–æ—Ç–æ—Ä—ã–π:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WhatsApp

### 3. –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### BookingMonitorService (`src/services/booking-monitor/index.js`)
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–µ–π —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –±–æ—Ç–∞
- –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ 30 —Å–µ–∫—É–Ω–¥
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

#### Worker (`src/workers/booking-monitor-worker.js`)
- –ó–∞–ø—É—Å–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–º
- Graceful shutdown
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

#### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- `booking_monitor_state` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- `booking_notifications` - –∏—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 4. –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏**: 30 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏, —á—Ç–æ–±—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–≥ –≤–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

2. **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–µ–π**: 
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ `booking_notifications`
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–µ–π —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –±–æ—Ç–∞

3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**:
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–∞
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã
```
1. –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É:
   - –ü–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –∑–∞–≤—Ç—Ä–∞
   - –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ (created > last_checked_at)
   - –î–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏:
     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –Ω–∞—à–∞ –ª–∏ —ç—Ç–æ –∑–∞–ø–∏—Å—å
     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–æ—à–ª–æ –ª–∏ 30 —Å–µ–∫—É–Ω–¥
     - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
     - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```bash
BOOKING_MONITOR_ENABLED=true          # –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å
BOOKING_MONITOR_INTERVAL=60000        # –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (–º—Å)
BOOKING_NOTIFICATION_DELAY=30000      # –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–º—Å)
```

## –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: YClients API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ**: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ö–∞–∫ –æ—Ç–ª–∏—á–∏—Ç—å –∑–∞–ø–∏—Å–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –±–æ—Ç–æ–º –æ—Ç –∑–∞–ø–∏—Å–µ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É `bookings` - –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å —Ç–∞–º –µ—Å—Ç—å, –∑–Ω–∞—á–∏—Ç —Å–æ–∑–¥–∞–Ω–∞ –±–æ—Ç–æ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏–ª–∏ –∑–∞–¥–µ—Ä–∂–∫—É 30 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
- ‚úÖ –ö–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–ø–∏—Å—è—Ö —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –æ—Ç –±–æ—Ç–∞
- ‚úÖ –ï—Å—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –Ω–∞–¥–µ–∂–Ω–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–±–æ–µ–≤

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ Production

### –ü—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è (19:48 - 19:55)

1. **–ó–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞** - —Å—Ä–∞–∑—É –≤—ã—è–≤–∏–ª –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–º–ø–æ—Ä—Ç–∞–º–∏
2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–∞**:
   - `date-utils` –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª ‚Üí —Å–æ–∑–¥–∞–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä—è–º–æ –≤ –º–æ–¥—É–ª–µ
   - `YclientsClient` —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª—Å—è –∫–∞–∫ `{ YclientsClient }` ‚Üí –∏—Å–ø—Ä–∞–≤–∏–ª–∏ –∏–º–ø–æ—Ä—Ç
   - `WhatsAppClient` –±—ã–ª singleton ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≥–æ—Ç–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
3. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –≤—ã–∑–æ–≤–∞** - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `getRecords` –±—ã–ª–∏ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
4. **–§–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫** - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ YClients API —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –ø—Ä–∞–≤

### –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
- ‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- ‚ö†Ô∏è YClients API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403 "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤"
- üìä –ò—Å–ø–æ–ª—å–∑—É–µ—Ç ~15-20MB –ø–∞–º—è—Ç–∏

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ ~~–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ production —Å–µ—Ä–≤–µ—Ä–µ~~ (–í—ã–ø–æ–ª–Ω–µ–Ω–æ)
2. –ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞ –æ—Ç YClients API
3. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ Supabase —á–µ—Ä–µ–∑ Dashboard
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤

## –£—Ä–æ–∫–∏

1. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API** - webhook YClients –æ–∫–∞–∑–∞–ª—Å—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º
2. **Polling –º–æ–∂–µ—Ç –±—ã—Ç—å —Ö–æ—Ä–æ—à–∏–º —Ä–µ—à–µ–Ω–∏–µ–º** - –ø—Ä–æ—Å—Ç–æ–µ, –Ω–∞–¥–µ–∂–Ω–æ–µ, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ
3. **–ó–∞–¥–µ—Ä–∂–∫–∞ –≤–∞–∂–Ω–∞** - –¥–∞–µ—Ç –≤—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
4. **–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω—É–∂–Ω–æ –ø–µ—Ä—Å–∏—Å—Ç–∏—Ç—å** - –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ–µ–≤