# Исправление использования контекста диалога при поиске слотов

**Дата**: 27 августа 2025
**Автор**: AI Admin Development Team

## Проблема

При продолжении диалога о записи, когда клиент указывает только изменение даты (например "На завтра"), бот не находил доступные слоты, хотя они были доступны. Система отвечала "К сожалению, на завтра все время занято", даже когда слоты были.

### Сценарий воспроизведения
1. Клиент: "Запишите на стрижку"
2. Бот: "На стрижку есть свободное время сегодня в 20:30 у мастера Бари"
3. Клиент: "На завтра"
4. Бот: "К сожалению, на завтра все время занято" ❌

## Анализ причины

При анализе логов выявлено:
- AI правильно распознал команду SEARCH_SLOTS с параметром date: "завтра"
- НО не передал service_name и staff_name из контекста диалога
- Функция searchSlots проверяла только params, не используя сохранённый контекст
- В результате команда возвращала пустой массив слотов

```
SEARCH_SLOTS called without service specification
```

## Решение

Модифицирована функция `searchSlots` в `src/services/ai-admin-v2/modules/command-handler.js`:

### Ключевые изменения:

1. **Использование контекста диалога для услуги**:
```javascript
// Если услуга не указана в params, используем из контекста диалога
if (!serviceToSearch && !params.service_id && context.redisContext?.selection?.service) {
  serviceToSearch = context.redisContext.selection.service;
  logger.info('Using service from dialog context:', serviceToSearch);
}
```

2. **Использование контекста диалога для мастера**:
```javascript
// Если мастер не указан в params, используем из контекста диалога
if (!staffToSearch && context.redisContext?.selection?.staff) {
  staffToSearch = context.redisContext.selection.staff;
  logger.info('Using staff from dialog context:', staffToSearch);
}
```

3. **Улучшенное логирование**:
- Логируется использование данных из контекста
- Логируется найденный мастер с ID

## Результаты тестирования

После внедрения исправления:
1. Клиент: "На завтра"
2. Система использует сохранённые service: "СТРИЖКА" и staff: "Бари"
3. Успешно находит 11 доступных слотов
4. Бот корректно отвечает со списком времён

## Технические детали

- **Файл**: `src/services/ai-admin-v2/modules/command-handler.js`
- **Метод**: `searchSlots(params, context)`
- **Контекст**: Используется `context.redisContext.selection` для получения сохранённых данных

## Уроки и выводы

1. **Важность контекста**: При продолжении диалога критически важно использовать сохранённый контекст выбора клиента
2. **Валидация параметров**: Нужно проверять не только явные параметры, но и доступный контекст
3. **Логирование**: Детальное логирование помогло быстро найти причину проблемы

## Влияние на пользователей

- ✅ Улучшен пользовательский опыт при изменении даты записи
- ✅ Сокращено количество шагов для записи
- ✅ Бот стал более "умным" и помнит предыдущий выбор клиента