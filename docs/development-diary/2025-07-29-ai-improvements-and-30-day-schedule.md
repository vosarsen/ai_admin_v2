# AI Admin v2 - Улучшения AI и расширение периода расписания до 30 дней

**Дата**: 29 июля 2025  
**Автор**: AI Admin Development Team

## Контекст

Пользователь Арсен пытался записаться к мастеру Бари на 7 августа в 10:00. Возникли две критические проблемы:
1. AI Admin не находил клиента в базе данных, хотя он там был
2. AI Admin говорил, что Бари не работает 7 августа, хотя он работал (и предлагал Сергея и Рамзана, которые НЕ работали)

## Проблемы и решения

### 1. Проблема с поиском клиента в базе данных

**Проблема**: 
- AI Admin получал номер телефона в формате `79686484488@c.us`
- Метод `loadClient` искал по полю `raw_phone`, которое хранит номер с "+" (`+79686484488`)
- После удаления `@c.us` получалось `79686484488` (без "+"), что не совпадало с `+79686484488` в базе

**Решение**:
Изменили поиск на поле `phone`, которое хранит номер без "+" (например: `79686484488`).

```javascript
// Было:
const cleanPhone = phone.replace('@c.us', '');
// Добавляем + если его нет (raw_phone в БД хранится с +)
if (!cleanPhone.startsWith('+')) {
  cleanPhone = '+' + cleanPhone;
}
const { data, error } = await supabase
  .from('clients')
  .select('*')
  .eq('raw_phone', cleanPhone)

// Стало:
const cleanPhone = phone.replace('@c.us', '');
// Ищем по phone (без +)
const { data, error } = await supabase
  .from('clients')
  .select('*')
  .eq('phone', cleanPhone)
```

### 2. Проблема с видимостью расписания

**Проблема**:
- AI Admin загружал расписание только на 7 дней вперед
- В промпте отображались только первые 3 дня расписания
- 7 августа (9-й день от текущей даты) не попадало в видимость AI

**Решение**:
Увеличили период загрузки и отображения расписания до 30 дней.

#### Изменения в `src/services/ai-admin-v2/modules/data-loader.js`:
```javascript
// Было:
// Загружаем расписание на ближайшие 7 дней
weekLater.setDate(today.getDate() + 7);

// Стало:
// Загружаем расписание на ближайшие 30 дней
weekLater.setDate(today.getDate() + 30);
```

#### Изменения в `src/services/ai-admin-v2/modules/formatter.js`:
```javascript
// Было:
const days = Object.keys(scheduleByDate).sort().slice(0, 3);

// Стало:
const days = Object.keys(scheduleByDate).sort().slice(0, 30);
```

#### Изменения в `universal-yclients-sync.js`:
```javascript
// Было:
// Обрабатываем следующие 14 дней
for (let i = 0; i < 14; i++) {

// Стало:
// Обрабатываем следующие 30 дней
for (let i = 0; i < 30; i++) {
```

### 3. Улучшения промптов AI

**Проблема**:
- AI использовал команду CHECK_STAFF_SCHEDULE даже когда расписание было загружено
- AI не распознавал услугу "стрижка" в сообщении клиента

**Решения**:

#### Добавили правило проверки загруженного расписания:
```
КРИТИЧЕСКИ ВАЖНО: СНАЧАЛА ПРОВЕРЬ РАЗДЕЛ "РАСПИСАНИЕ МАСТЕРОВ"!
- Если нужная дата ЕСТЬ в расписании → НЕ ИСПОЛЬЗУЙ эту команду, просто посмотри кто работает
- Если нужной даты НЕТ в расписании → используй команду для проверки
```

#### Добавили правила распознавания услуг:
```
РАСПОЗНАВАНИЕ УСЛУГ В СООБЩЕНИИ:
- "на стрижку" = услуга: стрижка
- "стричься" = услуга: стрижка
- "подстричься" = услуга: стрижка
- "подстричь волосы" = услуга: стрижка
- "на маникюр" = услуга: маникюр
- "ногти сделать" = услуга: маникюр
- "на педикюр" = услуга: педикюр
ВАЖНО: Если клиент упомянул услугу ЛЮБЫМ способом - НЕ СПРАШИВАЙ "какую услугу?"!
```

## Технические детали

### Архитектура синхронизации
- `sync-manager.js` - управляет всей синхронизацией, запускает каждые 30 минут
- `UniversalYclientsSync` - выполняет фактическую синхронизацию с YClients API
- Расписание теперь синхронизируется на 30 дней вперед

### Результаты синхронизации
После запуска синхронизации подтверждено:
- Бари работает 7 августа (✅ Бари 2025-08-07: WORKING)
- Загружены данные на 30 дней для всех мастеров
- Всего обработано 90 дней расписания (30 дней × 3 мастера)

## Итоги

1. **Исправлен поиск клиентов** - теперь AI правильно находит существующих клиентов
2. **Расширен период видимости расписания** - AI видит расписание на месяц вперед
3. **Улучшено распознавание услуг** - AI понимает различные формулировки
4. **Оптимизировано использование команд** - AI не делает лишних проверок

## Рекомендации

1. Мониторить корректность работы после изменений
2. Рассмотреть возможность кеширования расписания для снижения нагрузки
3. Добавить алерты при неудачной синхронизации расписания

## Связанные файлы
- `/src/services/ai-admin-v2/modules/data-loader.js`
- `/src/services/ai-admin-v2/modules/formatter.js`
- `/src/services/ai-admin-v2/index.js`
- `/universal-yclients-sync.js`
- `/src/sync/sync-manager.js`