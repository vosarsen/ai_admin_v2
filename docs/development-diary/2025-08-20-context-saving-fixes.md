# Исправления сохранения контекста между сообщениями

**Дата**: 20 августа 2025  
**Автор**: AI Admin Team  
**Проблема**: Контекст не сохранялся между сообщениями, AI не мог создать запись по фразе "Давай на час"  
**Статус**: ✅ Частично решено

## Описание проблемы

### Исходная ситуация
При диалоге клиента с ботом терялся контекст между сообщениями:
1. Клиент: "Когда можно постричься?"
2. Бот: Показывает слоты
3. Клиент: "Давай на час"
4. ❌ Бот НЕ понимал что нужно создать запись на 13:00

### Выявленные проблемы

1. **commandResults не передавались из Two-Stage процессора**
   - Two-Stage возвращал `commandResults`, но они не сохранялись в переменную
   - Из-за этого контекст после SEARCH_SLOTS не сохранялся

2. **Контекст терялся при повторном вызове setContext**
   - При первом вызове данные приходили в `contextData.data`
   - При втором вызове (от saveContext) поле `data` было пустым
   - Старые данные перезаписывались пустыми

3. **Таблица bookings отсутствовала в Supabase**
   - Вызывало ошибки при попытке загрузить записи клиента

## Технические исправления

### 1. Добавлено сохранение commandResults

**Файл**: `src/services/ai-admin-v2/index.js`

```javascript
// Было:
if (useTwoStage) {
  // ...
  finalResponse = twoStageResult.response;
  executedCommands = twoStageResult.commands;
}

// Стало:
let commandResults = []; // Добавлена переменная

if (useTwoStage) {
  // ...
  finalResponse = twoStageResult.response;
  executedCommands = twoStageResult.commands;
  commandResults = twoStageResult.commandResults || []; // Сохраняем результаты
}

// И в результате:
const result = {
  success: true,
  response: finalResponse,
  executedCommands: executedCommands,
  commandResults: commandResults, // Передаем для сохранения контекста
  results: []
};
```

### 2. Исправлено объединение контекста в Redis

**Файл**: `src/services/context/index.js`

```javascript
// Добавлено объединение старых и новых данных
if (shouldClearOldData) {
  // Очистка старых данных если прошло больше суток
  // ...
} else {
  // Если не прошло суток, объединяем старые данные с новыми
  const oldData = existingContext?.data ? JSON.parse(existingContext.data) : {};
  dataToSave = {
    ...oldData,     // Сохраняем старые данные
    ...dataToSave   // Перезаписываем новыми
  };
}
```

### 3. Создана таблица bookings

**Файл**: `scripts/database/create-bookings-table.sql`

Таблица включает все необходимые поля для хранения записей:
- YClients идентификаторы
- Информация о клиенте и мастере
- Услуги и время
- Статус записи
- Индексы для быстрого поиска

### 4. Добавлено детальное логирование

Для отладки добавлены логи в:
- `setContext` - что приходит и что сохраняется
- `index.js` - какие данные передаются в Redis

## Результаты тестирования

### ✅ Успешно исправлено:

1. **Контекст сохраняется после SEARCH_SLOTS**:
```json
{
  "lastService": "МУЖСКАЯ СТРИЖКА",
  "lastDate": "сегодня",
  "lastCommand": "SEARCH_SLOTS",
  "lastStaff": "Бари"
}
```

2. **Контекст не теряется при повторных вызовах**
   - Старые данные объединяются с новыми
   - Поле `data` больше не становится пустым

3. **Таблица bookings создана и работает**

### ❌ Оставшаяся проблема:

AI (DeepSeek) все еще не извлекает команду CREATE_BOOKING из сообщения "Давай на час", даже когда контекст доступен. При обработке второго сообщения:
- Контекст загружается правильно
- Промпт содержит правила для "на час" = 13:00
- Но AI возвращает 0 команд

## Влияние на продукт

### До исправления:
- ❌ Контекст терялся между сообщениями
- ❌ Бот не мог создать запись по контексту
- ❌ Ошибки при загрузке bookings

### После исправления:
- ✅ Контекст сохраняется и доступен
- ✅ Нет ошибок от отсутствующей таблицы
- ✅ Инфраструктура готова для контекстных записей
- ⚠️ Требуется улучшение промпта/модели AI

## Рекомендации

1. **Улучшить промпт Two-Stage**:
   - Добавить более агрессивные правила использования контекста
   - Усилить примеры с "на час" и контекстом

2. **Протестировать другие AI модели**:
   - Qwen может лучше понимать контекст
   - GPT-4 имеет лучшее понимание диалогов

3. **Добавить fallback логику**:
   - Если есть контекст и время, автоматически предлагать CREATE_BOOKING
   - Не полагаться только на AI для очевидных случаев

## Файлы изменений

- `src/services/ai-admin-v2/index.js` - добавлено сохранение commandResults
- `src/services/context/index.js` - исправлено объединение контекста
- `scripts/database/create-bookings-table.sql` - SQL для создания таблицы
- `docs/development-diary/2025-08-20-context-saving-fixes.md` - эта документация

## Заключение

Инфраструктурные проблемы с сохранением контекста полностью решены. Контекст теперь корректно сохраняется и доступен между сообщениями. Однако, требуется дополнительная работа над промптами или сменой AI модели для полного решения задачи автоматического создания записей по контексту.