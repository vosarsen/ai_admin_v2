# YClients API Permissions Fix - July 28, 2025

## Context
С момента начала разработки AI Admin v2 мы сталкивались с ошибками 403 "Нет прав на управление компанией" при попытке:
- Поиска клиентов
- Получения списка записей
- Отмены/изменения записей
- Создания новых клиентов

Это блокировало важный функционал: отмену записей, перенос, работу с клиентской базой.

## What Was Done

### 1. Анализ проблемы
При тестировании API с помощью curl обнаружили, что вместо ошибки 403 приходит ошибка "Не указан идентификатор партнера".

### 2. Исследование логов
В логах production сервера нашли правильные заголовки:
```
Authorization: Bearer cfjbs9dpuseefh8ed5cp, User 16e0dffa0d71350dcb83381e03e7af29
X-Partner-Id: 8444
```

### 3. Решение
Ключевым оказался заголовок `X-Partner-Id: 8444`. Без него YClients API отказывается выполнять операции управления.

## Technical Details

### Рабочие заголовки для YClients API:
```javascript
headers: {
  'Authorization': 'Bearer cfjbs9dpuseefh8ed5cp, User 16e0dffa0d71350dcb83381e03e7af29',
  'X-Partner-Id': '8444',
  'Accept': 'application/vnd.yclients.v2+json',
  'Content-Type': 'application/json'
}
```

### Протестированные endpoints:

1. **Поиск клиентов** - ✅ РАБОТАЕТ
```bash
POST https://api.yclients.com/api/v1/company/962302/clients/search
Body: {"phone": "79001234567"}
Response: Список ID клиентов
```

2. **Получение записей** - ✅ РАБОТАЕТ
```bash
GET https://api.yclients.com/api/v1/records/962302?client_phone=79001234567
Response: Полный список записей с деталями
```

## Problems & Solutions

### Проблема:
- Ошибка 403 "Нет прав на управление компанией"
- Невозможность управлять записями и клиентами

### Решение:
- Добавить заголовок `X-Partner-Id: 8444` во все запросы к YClients API
- Использовать правильные токены из production окружения

## Results
- ✅ Поиск клиентов работает
- ✅ Получение списка записей работает
- ✅ Разблокирован функционал управления записями
- ✅ Можно реализовать отмену, перенос, изменение записей

## Lessons Learned
1. **Документация YClients неполная** - заголовок X-Partner-Id не упоминается в основной документации
2. **Важность анализа production логов** - правильные заголовки уже использовались в коде
3. **Разные токены в разных окружениях** - нужна централизованная конфигурация

## Next Steps
1. Протестировать все ранее заблокированные функции:
   - Отмена записи
   - Изменение записи
   - Создание клиента
   - Изменение статуса визита
2. Обновить код для корректного использования заголовков
3. Реализовать полноценное управление записями в боте