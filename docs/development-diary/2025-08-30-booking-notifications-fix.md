# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –∏ —Å–∫–ª–æ–Ω–µ–Ω–∏–π

**–î–∞—Ç–∞**: 30 –∞–≤–≥—É—Å—Ç–∞ 2025
**–ê–≤—Ç–æ—Ä**: AI Admin Team

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–ª –∑–∞–ø–∏—Å—å –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –±–æ—Ä–æ–¥—ã –∏ —É—Å–æ–≤ –Ω–∞ 31 –∞–≤–≥—É—Å—Ç–∞ –≤ 21:00, –Ω–æ —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –¥–≤—É–º—è –ø—Ä–æ–±–ª–µ–º–∞–º–∏:
1. –ù–µ –ø—Ä–∏—à–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
2. –í –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –∑–∞ –¥–µ–Ω—å –±—ã–ª–∞ –æ—à–∏–±–∫–∞ —Å–∫–ª–æ–Ω–µ–Ω–∏—è: "–ù–∞–ø–æ–º–∏–Ω–∞–µ–º –æ –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å—Ç—Ä–∏–∂–∫–µ –±–æ—Ä–æ–¥—ã –∏ —É—Å–æ–≤" –≤–º–µ—Å—Ç–æ "–Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –±–æ—Ä–æ–¥—ã –∏ —É—Å–æ–≤"

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–∑–¥–∞–Ω–∏–∏
–ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ª–æ–≥–æ–≤ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ:
```
üìù New booking 1250977044 created externally, sending confirmation
‚ùå Error processing booking 1250977044: this.sendBookingConfirmation is not a function
```

–ú–µ—Ç–æ–¥ `sendBookingConfirmation` –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª –≤ –∫–æ–¥–µ booking-monitor.

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ
–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É—Å–ª—É–≥–∏ "–°–¢–†–ò–ñ–ö–ê –ë–û–†–û–î–´ –ò –£–°–û–í (–î–û 6–ú–ú)" –≤ –ø–æ–ª–µ `prepositional_na` –±—ã–ª–æ –∑–Ω–∞—á–µ–Ω–∏–µ "—Å—Ç—Ä–∏–∂–∫–µ –±–æ—Ä–æ–¥—ã –∏ —É—Å–æ–≤" (–ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π –ø–∞–¥–µ–∂), —Ö–æ—Ç—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂ "—Å—Ç—Ä–∏–∂–∫—É –±–æ—Ä–æ–¥—ã –∏ —É—Å–æ–≤" –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —á—Ç–æ?".

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ sendBookingConfirmation

–í —Ñ–∞–π–ª `src/services/booking-monitor/index.js` –¥–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥:

```javascript
async sendBookingConfirmation(record) {
  try {
    const phone = this.formatPhoneNumber(record.client?.phone || record.phone || '');
    if (!phone) {
      logger.warn(`‚ö†Ô∏è No phone number for booking ${record.id}`);
      return;
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    const date = formatDate(new Date(record.datetime));
    const time = formatTime(new Date(record.datetime));
    const services = record.services?.map(s => s.title || s.name).join(', ') || '–£—Å–ª—É–≥–∞';
    const staff = record.staff?.name || '–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç';
    const price = record.services?.reduce((sum, s) => sum + (s.cost || 0), 0) || 0;
    
    // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –∫–æ–º–ø–∞–Ω–∏–∏
    const { data: company } = await supabase
      .from('companies')
      .select('address')
      .eq('id', record.company_id || config.yclients.companyId)
      .single();
      
    const address = company?.address || '–ú–∞–ª–∞—Ö–æ–≤–∫–∞, –Æ–∂–Ω–∞—è —É–ª–∏—Ü–∞, 38';

    const message = `‚úÖ –í–∞—à–∞ –∑–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!

üìÖ ${date} –≤ ${time}
üíá ${services}
üë§ –ú–∞—Å—Ç–µ—Ä: ${staff}
${price > 0 ? `üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${price} —Ä—É–±.\n` : ''}
üìç –ê–¥—Ä–µ—Å: ${address}

–î–æ –≤—Å—Ç—Ä–µ—á–∏! –ï—Å–ª–∏ –ø–ª–∞–Ω—ã –∏–∑–º–µ–Ω—è—Ç—Å—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç–µ –Ω–∞—Å –∑–∞—Ä–∞–Ω–µ–µ.`;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await this.whatsappClient.sendMessage(phone, message);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ
    await supabase
      .from('booking_notifications')
      .insert({
        yclients_record_id: parseInt(record.id),
        phone: phone,
        notification_type: 'booking_created',
        message: message,
        sent_at: new Date().toISOString(),
        company_id: record.company_id || config.yclients.companyId
      });

    logger.info(`‚úÖ booking_created notification sent for booking ${record.id} to ${phone}`);
    
  } catch (error) {
    logger.error(`‚ùå Error sending booking confirmation for ${record.id}:`, error);
  }
}
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–∫–ª–æ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `scripts/fix-beard-declension.js` –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–æ–Ω–µ–Ω–∏–π:

```javascript
require('dotenv').config();
const { createClient } = require('@supabase/supabase-js');

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_KEY
);

async function fixDeclension() {
  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å–∫–ª–æ–Ω–µ–Ω–∏—è
  const { data: service, error: fetchError } = await supabase
    .from('services')
    .select('id, title, declensions')
    .eq('title', '–°–¢–†–ò–ñ–ö–ê –ë–û–†–û–î–´ –ò –£–°–û–í (–î–û 6–ú–ú)')
    .single();
  
  // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º prepositional_na –Ω–∞ –≤–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂
  const updatedDeclensions = {
    ...service.declensions,
    prepositional_na: '—Å—Ç—Ä–∏–∂–∫—É –±–æ—Ä–æ–¥—ã –∏ —É—Å–æ–≤' // –í–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂ –¥–ª—è "–Ω–∞ —á—Ç–æ?"
  };
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –±–∞–∑–µ
  const { error: updateError } = await supabase
    .from('services')
    .update({ declensions: updatedDeclensions })
    .eq('id', service.id);
    
  if (updateError) {
    console.error('Error updating declensions:', updateError);
  } else {
    console.log('‚úÖ Successfully updated declensions for "–°–¢–†–ò–ñ–ö–ê –ë–û–†–û–î–´ –ò –£–°–û–í"');
    console.log('New prepositional_na:', updatedDeclensions.prepositional_na);
  }
}

fixDeclension();
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏

–¢–∞–∫–∂–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `tomorrow` ‚Üí `tomorrowDateCheck`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã `bookings` –≤–º–µ—Å—Ç–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π `booking_states`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ç–∞–±–ª–∏—Ü–µ–π bookings (`visit_attendance` –≤–º–µ—Å—Ç–æ `attendance`, `cost` –≤–º–µ—Å—Ç–æ `price`)

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
1. ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º attendance = 0
2. ‚úÖ –°–∫–ª–æ–Ω–µ–Ω–∏—è –≤ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ: "–ù–∞–ø–æ–º–∏–Ω–∞–µ–º –æ –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –±–æ—Ä–æ–¥—ã –∏ —É—Å–æ–≤"
3. ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑–ª–∏—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –∑–∞–ø–∏—Å–µ–π:
   - attendance = 0 (–æ–∂–∏–¥–∞–µ—Ç—Å—è) ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–∑–¥–∞–Ω–∏–∏
   - attendance = 1 (–ø—Ä–∏—à–µ–ª) ‚Üí –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   - attendance = 2 (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω) ‚Üí –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   - attendance = -1 (–æ—Ç–º–µ–Ω–µ–Ω) ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `src/services/booking-monitor/index.js` - –¥–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ sendBookingConfirmation, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏
- `scripts/fix-beard-declension.js` - —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–æ–Ω–µ–Ω–∏–π –≤ –ë–î
- `scripts/delete-booking.js` - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ö–æ–º–º–∏—Ç—ã:
- `fix: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å –¥–≤–æ–π–Ω—ã–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ–º tomorrow`
- `fix: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–µ–π`
- `fix: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω booking-monitor –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã bookings –≤–º–µ—Å—Ç–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π booking_states`
- `fix: –¥–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ sendBookingConfirmation –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è —Å—Ç—Ä–∏–∂–∫–∏ –±–æ—Ä–æ–¥—ã`
- `fix: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ —Å–∫—Ä–∏–ø—Ç–µ fix-beard-declension`

## –£—Ä–æ–∫–∏ –Ω–∞ –±—É–¥—É—â–µ–µ

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–π**: –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —É—Å–ª—É–≥ –≤–∞–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –ø–∞–¥–µ–∂–µ–π, –æ—Å–æ–±–µ–Ω–Ω–æ `prepositional_na` (–≤–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂ –¥–ª—è "–Ω–∞ —á—Ç–æ?")

2. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–æ–≤**: –ü—Ä–∏ –≤—ã–∑–æ–≤–µ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–µ—Ç–æ–¥–æ–≤ –Ω—É–∂–Ω–æ —Å—Ä–∞–∑—É –∏—Ö —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–ª–æ –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º –º–µ—Ç–æ–¥–æ–º

4. **–°—Ç–∞—Ç—É—Å—ã –∑–∞–ø–∏—Å–µ–π –≤ YClients**:
   - 0 = –æ–∂–∏–¥–∞–µ—Ç—Å—è (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–∑–¥–∞–Ω–∏–∏)
   - 1 = –ø—Ä–∏—à–µ–ª (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º)
   - 2 = –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º)
   - -1 = –æ—Ç–º–µ–Ω–µ–Ω (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ)