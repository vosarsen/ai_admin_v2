# AI Admin v2 - Полное решение проблемы с Redis батчингом

## Дата: 26 августа 2025
## Автор: AI Assistant

## Контекст проблемы
После миграции на систему Context v2, Redis батчинг перестал работать. Сообщения, отправленные быстро друг за другом, обрабатывались отдельно, что делало бота неестественным и выдавало его искусственную природу.

## Симптомы проблемы

1. **API создавал ключи**, но они мгновенно исчезали:
   ```
   API: Found rapid-fire keys: 1, keys: rapid-fire:+79686484488
   Batch Processor: No pending batches found
   ```

2. **Batch processor не видел ключи** `rapid-fire:*`, хотя видел другие ключи с символом `+`

3. **Сообщения обрабатывались отдельно**, не объединяясь в единое предложение

## Диагностика

### Шаг 1: Проверка конфигурации Redis
- API и Batch Processor используют централизованную конфигурацию через `redis-config.js`
- Оба процесса запущены с `NODE_ENV=production`
- Конфигурация выглядела корректной

### Шаг 2: Тестирование создания и поиска ключей
```javascript
// Тест на сервере показал:
// 1. При NODE_ENV=production клиент подключается к localhost:6379
// 2. Ключи создаются и видны через keys('rapid-fire:*')
// 3. Batch processor видит созданные вручную ключи
```

### Шаг 3: Анализ логов
Обнаружена критическая деталь в логах API:
```
Batch service initialized in webhook {"env":"production","redisUrl":"redis://localhost:6380"}
```

## Корень проблемы

В файле `.env` на сервере была установлена переменная:
```
REDIS_URL=redis://localhost:6380
```

Это заставляло API использовать:
- **Порт 6380** - предназначенный для SSH туннеля при локальной разработке
- Вместо **порта 6379** - где реально работает Redis на сервере

В результате:
1. API создавал ключи в несуществующем Redis (порт 6380)
2. Batch Processor искал ключи в правильном Redis (порт 6379)
3. Ключи никогда не встречались

## Решение

### 1. Исправление переменной окружения
```bash
# Изменили REDIS_URL в .env файле
sed -i 's/REDIS_URL=redis:\/\/localhost:6380/REDIS_URL=redis:\/\/localhost:6379/' .env
```

### 2. Перезапуск с обновлением окружения
```bash
# Важно использовать флаг --update-env
pm2 restart ai-admin-api --update-env
pm2 restart ai-admin-batch-processor
```

## Результаты

### ✅ Полностью рабочий батчинг:

1. **API корректно создает ключи**:
   ```
   RPUSH executed for key: rapid-fire:+79001234567
   SET executed for key: last-msg:+79001234567
   EXPIRE executed - batch: 1, lastMsg: 1, TTL: 600
   ```

2. **Batch Processor видит и обрабатывает батчи**:
   ```
   Found 1 pending batches
   Checking batch for +79001234567: size=3, maxSize=10
   Batch for +79001234567 idle for 9455ms, processing
   ```

3. **Сообщения объединяются**:
   ```
   Processing batch for +79001234567:
   combinedLength: 49
   messagesCount: 3
   preview: "Привет! Хочу записаться на стрижку завтра в 15:00..."
   ```

## Технические детали

### Параметры батчинга:
- **TTL**: 600 секунд (10 минут) - время жизни батча
- **batchTimeout**: 9000 мс (9 секунд) - задержка после последнего сообщения
- **maxBatchSize**: 10 - максимум сообщений в батче

### Архитектура:
```
WhatsApp → API (webhook) → Redis → Batch Processor → Message Queue → Worker v2 → AI
                ↓                           ↑
         rapid-fire:phone ←────────────────┘
         last-msg:phone
```

### Важные файлы:
- `src/services/redis-batch-service.js` - сервис батчинга
- `src/api/webhooks/whatsapp-batched.js` - webhook для приема сообщений
- `src/workers/batch-processor.js` - процессор батчей
- `src/config/redis-config.js` - централизованная конфигурация Redis
- `.env` - переменные окружения (КРИТИЧНО: правильный REDIS_URL)

## Уроки и рекомендации

### 1. Всегда проверяйте переменные окружения
- Используйте `pm2 env <id>` для проверки
- При изменении .env используйте `pm2 restart --update-env`

### 2. Централизованная конфигурация
- Система уже имеет `redis-config.js` для единых настроек
- НО переменные окружения могут переопределить конфигурацию

### 3. Различие портов для разных окружений
- **Production**: Redis на localhost:6379
- **Development**: SSH туннель на localhost:6380
- Это правильная практика, но требует внимания при деплое

### 4. Диагностика Redis
- Всегда проверяйте что сервисы используют один Redis
- Используйте `keys()` для проверки видимости ключей
- Логируйте конфигурацию при инициализации

## Статус системы после исправления

| Компонент | Статус | Описание |
|-----------|--------|----------|
| Redis батчинг | ✅ Работает | Сообщения корректно группируются |
| Context System v2 | ✅ Работает | Контекст сохраняется и используется |
| API → Redis | ✅ Исправлено | Использует правильный порт 6379 |
| Batch Processor | ✅ Работает | Видит и обрабатывает батчи |
| Worker v2 | ✅ Работает | Получает объединенные сообщения |

## Команды для мониторинга

```bash
# Проверка батчей в Redis
redis-cli -a $REDIS_PASSWORD keys 'rapid-fire:*'

# Мониторинг логов батч процессора
pm2 logs ai-admin-batch-processor --lines 50

# Проверка переменных окружения
pm2 env 0 | grep REDIS

# Статус всех процессов
pm2 status
```

## Заключение

Проблема была связана с неправильной конфигурацией REDIS_URL в production окружении. После исправления система батчинга работает корректно, объединяя быстрые сообщения в единое целое, что делает бота более естественным и человечным в общении.