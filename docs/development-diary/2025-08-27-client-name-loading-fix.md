# Исправление загрузки имени клиента из базы данных

**Дата**: 27 августа 2025
**Автор**: AI Admin Team  
**Проблема**: Бот не использовал имя клиента из базы данных при создании записи

## Контекст проблемы

При попытке записи на услугу, бот постоянно просил клиента представиться, даже если информация о клиенте (включая имя) уже была в базе данных.

### Пример проблемы:
```
Клиент: Добрый день, хочу записаться на стрижку
Бот: Добрый день! Сегодня свободное время: 17:00, 18:00...
Клиент: Давай на 17:00
Бот: К сожалению, не удалось создать запись: Пожалуйста, сначала представьтесь. Как вас зовут?
```

При этом в базе данных существовала полная информация о клиенте:
- Имя: Арсен
- Телефон: +79686484488
- История визитов: 5 посещений
- Последние услуги и предпочтения

## Анализ проблемы

### 1. Первопричина - Circuit Breaker
Worker постоянно перезапускался из-за ошибки:
```
TypeError: circuitBreakerFactory.getBreaker is not a function
```

**Решение**: Добавлен метод `getBreaker` как алиас для `get` в `CircuitBreakerFactory`:
```javascript
// src/utils/circuit-breaker.js
factory.getBreaker = factory.get;
```

### 2. Основная проблема - логика загрузки клиента

В файле `src/services/ai-admin-v2/modules/context-manager-v2.js` была неправильная логика проверки наличия данных клиента:

```javascript
// Старый код (неправильный)
if (context.company && context.services && context.staff && context.client) {
  return context; // Не загружаем из БД, даже если client.name === null
}
```

Проблема: Если в Redis был сохранен объект клиента с `name: null`, система считала, что данные уже загружены и не обращалась к базе данных.

## Решение

### Изменения в context-manager-v2.js:

1. **Проверка наличия имени при определении необходимости загрузки**:
```javascript
// Новый код
if (context.company && context.services && context.staff && context.client && context.client.name) {
  return context; // Загружаем из БД только если есть И клиент И его имя
}
```

2. **Условная загрузка клиента из БД**:
```javascript
// Загружаем клиента из БД если его нет в Redis контексте или если нет имени
(context.client && context.client.name) ? context.client : dataLoader.loadClient(phone, companyId)
```

3. **Сохранение в Redis после загрузки**:
```javascript
// Если загрузили клиента из БД - сохраним его в Redis для будущих запросов
if (client && (!context.client || !context.client.name)) {
  logger.info(`Saving client ${client.name} to Redis cache`);
  await contextServiceV2.saveClientCache(phone, companyId, client);
}
```

### Изменения в data-loader.js:

Исправлена валидация `companyId` для поддержки строковых значений:
```javascript
case 'companyId':
  // Преобразуем строку в число для companyId
  const numValue = typeof input === 'string' ? parseInt(input, 10) : input;
  if (isNaN(numValue)) {
    throw new Error(`Invalid ${type}: ${input}`);
  }
  return numValue;
```

## Результат

После внесения изменений бот успешно:
1. Загружает данные клиента из базы данных при первом обращении
2. Использует имя клиента при создании записи
3. Кеширует полные данные клиента в Redis для последующих обращений

### Пример успешной работы:
```
Клиент: Добрый день, хочу записаться на стрижку
Бот: Добрый день, Арсен! Сегодня свободное время: 17:00, 18:00...
Клиент: Давай на 17:00
Бот: Арсен, записал вас на стрижку сегодня в 17:00 к мастеру Бари.
```

## Технические детали

### Файлы изменений:
1. `src/utils/circuit-breaker.js` - добавлен метод getBreaker
2. `src/services/ai-admin-v2/modules/context-manager-v2.js` - исправлена логика загрузки клиента
3. `src/services/ai-admin-v2/modules/data-loader.js` - исправлена валидация companyId

### Коммиты:
- `95d7612` - fix: добавлен метод getBreaker для обратной совместимости
- `6e06bc2` - fix: корректная проверка наличия имени клиента при загрузке из БД

## Уроки на будущее

1. **Всегда проверять полноту данных**, а не только их наличие
2. **Circuit Breaker** должен иметь обратную совместимость при изменении API
3. **Логирование** критически важно для диагностики проблем в production
4. **Redis кеш** должен валидироваться на полноту данных перед использованием

## Метрики

- Время на диагностику: ~2 часа
- Количество попыток: 3 итерации исправлений
- Затронуто файлов: 3
- Результат: 100% успешное использование имен клиентов из БД