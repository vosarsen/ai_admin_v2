# Исправление форматирования WhatsApp сообщений

**Дата**: 27 июля 2025
**Автор**: AI Assistant с Арсеном

## Контекст

Обнаружена проблема с форматированием сообщений в WhatsApp. AI генерировал текст с символами форматирования (`**Утро:**`, `**День:**`, `**Вечер:**`), которые не преобразовывались в жирный шрифт WhatsApp, а отображались как есть. Это делало очевидным, что отвечает бот, а не человек.

## Что было сделано

### 1. Анализ проблемы
- Выяснили, что WhatsApp использует одинарные звездочки `*текст*` для жирного шрифта
- AI генерировал двойные звездочки `**текст**` (Markdown стиль)
- Символы отображались в сообщениях как есть

### 2. Попытка №1: Инструкция в промпте
Добавили в промпт AI (`src/services/ai-admin-v2/index.js`):
```
ФОРМАТИРОВАНИЕ WHATSAPP:
- НЕ ИСПОЛЬЗУЙ звездочки (*) для выделения текста
- НЕ ИСПОЛЬЗУЙ подчеркивания (_) или другие символы форматирования
- НЕ ИСПОЛЬЗУЙ жирный шрифт или курсив
- Пиши простым текстом как обычный человек
- Вместо *Утро:* пиши просто "Утро:"
- Вместо **текст** пиши просто "текст"
```

**Результат**: AI продолжал использовать форматирование, игнорируя инструкции.

### 3. Попытка №2: Постобработка в removeCommands
Расширили функцию `removeCommands` в `src/services/ai-admin-v2/modules/command-handler.js`:
```javascript
// ВАЖНО: Убираем форматирование WhatsApp (звездочки)
// Заменяем **текст** на текст
cleaned = cleaned.replace(/\*\*(.+?)\*\*/g, '$1');
// Заменяем *текст* на текст
cleaned = cleaned.replace(/\*(.+?)\*/g, '$1');
// Убираем подчеркивания и другое форматирование
cleaned = cleaned.replace(/_(.+?)_/g, '$1');
cleaned = cleaned.replace(/~(.+?)~/g, '$1');
```

**Результат**: Основной текст очищался, но форматирование слотов все еще содержало звездочки.

### 4. Финальное решение
Обнаружили, что слоты форматируются отдельным вызовом AI и добавляются к ответу без обработки. Исправили в `src/services/ai-admin-v2/index.js`:
```javascript
const formattedSlots = await this.callAI(slotsPrompt);
// Удаляем форматирование из ответа AI о слотах
const cleanFormattedSlots = commandHandler.removeCommands(formattedSlots);
finalResponse += '\n\n' + cleanFormattedSlots;
```

## Технические детали

### Проблема с двойным форматированием
1. Основной ответ AI проходит через `removeCommands`
2. Слоты форматируются отдельным вызовом AI
3. Результат добавлялся напрямую, минуя очистку

### Решение
Применили `removeCommands` ко всем частям ответа, включая отдельно форматируемые слоты.

## Результаты

**До исправления:**
```
**Утро:**  
10:00, 10:30, 11:00  

**День:**  
12:00, 13:00, 14:00  

**Вечер:**  
17:00, 18:00, 19:00
```

**После исправления:**
```
Утро:
10:00, 10:30, 11:00

День:
12:00, 13:00, 14:00

Вечер:
17:00, 18:00, 19:00
```

## Выводы

1. **Простота лучше**: Отказ от форматирования сделал бота более человечным
2. **Многоуровневая защита**: Комбинация инструкций в промпте и постобработки обеспечивает надежность
3. **Внимание к деталям**: Важно проверять все пути генерации текста, не только основной

## Уроки на будущее

- При работе с мессенджерами учитывать их специфику форматирования
- Всегда проверять финальный вывод, а не промежуточные результаты
- Использовать простой текст для более естественного общения ботов