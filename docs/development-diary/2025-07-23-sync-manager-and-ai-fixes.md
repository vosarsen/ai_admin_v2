# 2025-07-23 - Исправление синхронизации расписаний и путаницы AI с доступностью мастеров

## Контекст
При тестировании бота обнаружились две критические проблемы:
1. AI говорил "у нас нет мастера Сергей", хотя сразу после этого показывал его доступные слоты
2. База данных staff_schedules содержала устаревшие данные (только до 24 июля)

## Что было сделано

### 1. Исправлена путаница AI с доступностью мастеров

**Проблема**: AI делал выводы о доступности мастеров на основе секции "МАСТЕРА СЕГОДНЯ" в промпте, не учитывая что клиент может спрашивать про другие дни.

**Решение**: Обновлены правила в промпте AI (`src/services/ai-admin-v2/index.js`):

```javascript
// Старые правила
ВАЖНО ПО МАСТЕРАМ:
- ВСЕГДА проверяй в РАСПИСАНИИ кто работает сегодня
- НЕ говори что мастер свободен, если его нет в расписании на сегодня

// Новые правила
ВАЖНО ПО МАСТЕРАМ:
- "МАСТЕРА СЕГОДНЯ" показывает ТОЛЬКО кто работает СЕГОДНЯ
- "РАСПИСАНИЕ МАСТЕРОВ" показывает кто работает в БЛИЖАЙШИЕ ДНИ
- НИКОГДА не говори "у нас нет мастера" если клиент спрашивает про другой день!
- Если клиент спрашивает про конкретного мастера - ВСЕГДА используй [SEARCH_SLOTS] чтобы проверить
- НЕ делай выводы о доступности мастера без проверки через [SEARCH_SLOTS]
- Если [SEARCH_SLOTS] нашел слоты для мастера - значит он РАБОТАЕТ в этот день!
```

Также добавлены правила обработки результатов команд:
```javascript
ОБРАБОТКА РЕЗУЛЬТАТОВ [SEARCH_SLOTS]:
- Если команда нашла слоты - НЕ ГОВОРИ что мастера нет!
- Если слоты найдены - покажи их клиенту
- НЕ противоречь результатам команды в своем тексте
```

### 2. Исправлена автоматическая синхронизация расписаний

**Проблема**: SyncManager был создан но никогда не инициализировался, поэтому автоматическая синхронизация не работала.

**Решение**: 
1. Добавлена инициализация syncManager в главный файл запуска API (`src/index.js`):

```javascript
// Добавлен импорт
const { syncManager } = require('./sync/sync-manager');

// Добавлена инициализация после запуска сервера
await syncManager.initialize();

// Добавлен graceful shutdown
await syncManager.shutdown();
```

2. Перемещен файл `UniversalYclientsSync` из `tests/manual/` в корень проекта

3. Теперь синхронизация работает автоматически:
   - Расписание мастеров синхронизируется каждые 30 минут
   - Полная синхронизация всех данных происходит 2 раза в день (в 4:00 и 14:00)

### 3. Исправлена ошибка с сохранением имени клиента

**Проблема**: При попытке сохранить имя клиента возникала ошибка `contextService.setContext is not a function`.

**Решение**: Исправлен вызов метода в `src/services/ai-admin-v2/modules/command-handler.js`:
```javascript
// Было
await contextService.setContext(cleanPhone, redisContext);

// Стало
await contextService.updateContext(cleanPhone, context.company.yclients_id || context.company.company_id, {
  clientInfo: { name: params.name }
});
```

## Результаты

1. **AI больше не путается с доступностью мастеров** - правильно интерпретирует расписание на разные дни
2. **База данных автоматически обновляется** - расписание мастеров теперь актуально
3. **Подтверждено через логи**:
   - Сергей работает 25 июля (пятница)
   - Запись в staff_schedules создана: `is_working: true, has_booking_slots: true`

## Технические детали

### Файлы изменены:
- `src/services/ai-admin-v2/index.js` - обновлен промпт AI
- `src/services/ai-admin-v2/modules/command-handler.js` - исправлен метод сохранения имени
- `src/index.js` - добавлена инициализация syncManager
- `universal-yclients-sync.js` - перемещен в корень проекта

### Синхронизация теперь включает:
- **Каждые 30 минут**: синхронизация расписания мастеров
- **2 раза в день**: полная синхронизация (компания, услуги, мастера, клиенты, записи)
- **При старте**: если данные старше 24 часов - запускается полная синхронизация

## Оставшиеся задачи

1. **Исправить обработку staff_id: "last"** - когда AI использует эту конструкцию при создании записи
2. **Добавить автоматический показ альтернативных слотов** при ошибках бронирования
3. **Протестировать полный флоу создания записи** с реальными сценариями

## Проблемы для мониторинга

1. **Права API** - некоторые методы синхронизации возвращают 403 (нет прав на управление компанией)
2. **Ошибки синхронизации staff** - `null value in column "name"` - нужно исследовать
3. **Производительность** - полная синхронизация занимает около 40 секунд

## Команды для проверки

```bash
# Проверить статус синхронизации
ssh -i ~/.ssh/id_ed25519_ai_admin root@46.149.70.219 "pm2 logs ai-admin-api --lines 100 | grep -i sync"

# Проверить расписание в БД
mcp__supabase__query_table table: staff_schedules, filters: {"date": "2025-07-25"}

# Проверить логи AI обработки
mcp__logs__logs_search service: ai-admin-worker-v2, pattern: "SEARCH_SLOTS|CREATE_BOOKING"
```

## Выводы

Основные проблемы были связаны с:
1. Неправильной интерпретацией данных AI (решено обновлением промпта)
2. Отсутствием автоматической синхронизации (решено инициализацией syncManager)

Теперь система должна корректно обрабатывать запросы о доступности мастеров в любые дни недели.