# CHECK_STAFF_SCHEDULE Fix - Исправление проверки расписания мастеров

## Дата: 30 июля 2025

## Контекст

При тестировании с разными номерами телефонов было обнаружено странное поведение:
- С реальным номером (+79686484488) AI успешно записал на стрижку к Бари на завтра
- С тестовым номером (79001234567) AI сказал, что Бари не работает завтра

При этом в базе данных Бари действительно работает завтра (31.07.2025).

## Проблема

Команда `CHECK_STAFF_SCHEDULE` неправильно определяла работающих мастеров на указанную дату.

### Анализ логов показал:
1. С реальным номером AI сразу выполнил `CREATE_BOOKING` без проверки расписания
2. С тестовым номером AI выполнил `CHECK_STAFF_SCHEDULE`, которая дала неверный результат

### Проверка базы данных:
```javascript
// Расписание на 2025-07-31:
{ id: 2895125, name: 'Сергей', is_working: false, has_slots: false }
{ id: 3820250, name: 'Рамзан', is_working: false, has_slots: false }
{ id: 3413963, name: 'Бари', is_working: true, has_slots: true }  // Бари работает!
```

### Причина проблемы:
Логика определения не работающих мастеров была неверной:
```javascript
// Старый код:
context.staff.forEach(staffMember => {
  if (!workingStaffIds.has(staffMember.yclients_id)) {
    result.notWorking.push(staffMember.name);
  }
});
```

Проблема в том, что `workingStaffIds` содержит только тех, кто работает И имеет слоты. Но код не учитывал, что мастер может вообще отсутствовать в расписании на эту дату.

## Решение

Исправлена логика в `src/services/ai-admin-v2/modules/command-handler.js`:

```javascript
// Новый код:
// Находим всех кто НЕ работает из тех, кто есть в расписании
// Если мастера нет в расписании на эту дату - считаем что он не работает
const scheduledStaffIds = new Set(schedules.map(s => s.staff_id));

context.staff.forEach(staffMember => {
  if (!scheduledStaffIds.has(staffMember.yclients_id) || !workingStaffIds.has(staffMember.yclients_id)) {
    result.notWorking.push(staffMember.name);
  }
});
```

Теперь логика учитывает:
1. Если мастера нет в расписании на дату - он не работает
2. Если мастер есть в расписании, но `is_working = false` или `has_booking_slots = false` - он не работает
3. Только если мастер есть в расписании И работает И имеет слоты - он считается работающим

## Результат

Теперь команда `CHECK_STAFF_SCHEDULE` правильно определяет работающих мастеров на любую дату, а не только на сегодня.

## Уроки

1. Важно тестировать с разными входными данными (разные номера телефонов)
2. AI может выбирать разные команды для одинаковых запросов в зависимости от контекста
3. Логика проверки должна учитывать все возможные состояния данных