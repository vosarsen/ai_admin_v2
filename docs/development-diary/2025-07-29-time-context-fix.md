# Development Diary: Исправление сохранения контекста времени в AI

**Дата**: 29 июля 2025  
**Автор**: AI Admin Team  
**Теги**: #ai #booking #bugfix #context

## Контекст

При анализе диалога клиента с ботом была обнаружена критическая ошибка: AI не сохранял контекст времени из предыдущих сообщений при изменении даты записи.

### Пример проблемного диалога:
```
Клиент: Хочу записаться на моделирование бороды
Клиент: К Бари
Клиент: На завтра
Клиент: В 18:00
Бот: К сожалению, Бари не работает завтра
Клиент: Можно на 7 августа
Бот: Не удалось создать запись (ошибка: datetime: undefined:00)
```

## Что было сделано

### 1. Анализ проблемы

В логах обнаружена ошибка при создании записи:
```
"datetime":"2025-08-07 undefined:00"
```

AI не передал параметр `time` в команду CREATE_BOOKING, хотя клиент указал время (18:00) в предыдущих сообщениях.

### 2. Добавлено правило в промпт AI

В файл `src/services/ai-admin-v2/index.js` добавлено правило о сохранении контекста времени:

```javascript
КРИТИЧЕСКИ ВАЖНО - СОХРАНЕНИЕ КОНТЕКСТА ВРЕМЕНИ:
Если клиент указал время в предыдущих сообщениях, ПОМНИ его для следующих действий!
Пример диалога:
Клиент: "Хочу записаться на стрижку"
Ты: "На какой день?"
Клиент: "На завтра"
Ты: "На какое время?"
Клиент: "В 18:00"
Ты: "К сожалению, время занято. Могу предложить другое время"
Клиент: "Можно на послезавтра"
ВАЖНО: Клиент имеет в виду то же время 18:00! Используй: [CREATE_BOOKING service_name: стрижка, date: послезавтра, time: 18:00]
```

### 3. Добавлена проверка наличия времени

В файл `src/services/ai-admin-v2/modules/command-handler.js` добавлена проверка:

```javascript
// Проверяем, что время указано
if (!params.time) {
  logger.error('Time is not specified in CREATE_BOOKING:', {
    params,
    message: context.message,
    conversation: context.conversation
  });
  throw new Error('Не указано время для записи. Пожалуйста, укажите желаемое время.');
}
```

## Технические детали

### Изменения в AI промпте:
- Добавлены примеры диалогов с сохранением контекста времени
- Усилены инструкции о необходимости помнить время из предыдущих сообщений
- Добавлены конкретные примеры для случая "Можно на 7 августа"

### Изменения в обработчике команд:
- Добавлена валидация параметра `time` перед созданием записи
- Улучшено логирование для отладки подобных проблем

## Результаты тестирования

После внесения изменений протестирован сценарий:
1. Клиент указывает время для одной даты
2. Затем меняет дату, не указывая время повторно
3. AI успешно использует время из контекста

Лог успешного создания записи:
```
"time":"18:00"
"datetime":"2025-08-07 18:00:00"
Booking created successfully, record_id: 1211820807
```

## Проблемы и решения

### Проблема 1: AI "забывал" время из контекста
**Решение**: Добавлены явные инструкции в промпт с примерами

### Проблема 2: Отсутствие валидации времени
**Решение**: Добавлена проверка наличия параметра time перед созданием записи

### Проблема 3: Сложность отладки
**Решение**: Улучшено логирование с выводом полного контекста диалога

## Уроки и выводы

1. **Важность контекста в диалоговых системах**: AI должен учитывать не только текущее сообщение, но и всю историю диалога
2. **Явные инструкции в промптах**: Чем конкретнее примеры в промпте, тем лучше AI понимает требуемое поведение
3. **Валидация на всех уровнях**: Проверка обязательных параметров должна быть как в AI, так и в коде
4. **Логирование для отладки**: Детальные логи критически важны для понимания проблем в production

## Следующие шаги

1. Мониторить логи на предмет подобных ошибок
2. Рассмотреть возможность сохранения контекста записи в Redis для более надежной работы
3. Добавить автоматические тесты для проверки сохранения контекста времени
4. Обучить AI лучше работать с контекстом через fine-tuning на реальных диалогах