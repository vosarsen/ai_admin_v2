# Development Diary: Smart Booking Monitor - –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–î–∞—Ç–∞**: 13 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–ê–≤—Ç–æ—Ä**: AI Admin Team  
**–ó–∞–¥–∞—á–∞**: –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å booking-monitor –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ

## üéØ –¶–µ–ª—å

–ö–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞–ª–∏ –Ω–µ–Ω—É–∂–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è "–í–∞—à–∞ –∑–∞–ø–∏—Å—å –∏–∑–º–µ–Ω–µ–Ω–∞" –ø—Ä–∏ –ø—Ä–æ—Å—Ç–æ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ù—É–∂–Ω–æ –±—ã–ª–æ —Å–¥–µ–ª–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —É–º–Ω–µ–µ - –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–∂–Ω—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
1. –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ (attendance: 0 ‚Üí 2)
2. –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏—à–µ–ª (attendance ‚Üí 1)
3. –î–ª—è –∑–∞–ø–∏—Å–µ–π –≤ –ø—Ä–æ—à–ª–æ–º –≤—Ä–µ–º–µ–Ω–∏
4. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É

### –û–¢–ü–†–ê–í–õ–Ø–¢–¨ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ:
1. –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏ (attendance ‚Üí -1)
2. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∏
3. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥
4. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–∞

## üèóÔ∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `booking_states`

–°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –∑–∞–ø–∏—Å–µ–π:

```sql
CREATE TABLE booking_states (
    id UUID PRIMARY KEY,
    yclients_record_id TEXT UNIQUE,
    company_id INTEGER,
    
    -- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    attendance INTEGER, -- 2=–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞, 1=–ø—Ä–∏—à–µ–ª, 0=–æ–∂–∏–¥–∞–Ω–∏–µ, -1=–Ω–µ –ø—Ä–∏—à–µ–ª
    datetime TIMESTAMP,
    services JSONB,
    staff_id INTEGER,
    staff_name TEXT,
    client_phone TEXT,
    price DECIMAL,
    
    -- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
    last_attendance INTEGER,
    last_datetime TIMESTAMP,
    last_services JSONB,
    last_staff_id INTEGER,
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    last_checked_at TIMESTAMP
);
```

### 2. –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

#### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:

1. **–ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É** –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–∏—Å–∏ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π
2. **–î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏**:
   - –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—à–µ–¥—à–∏–µ
   - –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ø—Ä–∏—à–µ–ª" (attendance = 1)
   - –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ `booking_states`
   
3. **–ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–æ–≤–∞—è**:
   - –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ `booking_states`
   - –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

4. **–ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç**:
   - –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
   - –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–∑–Ω–∞—á–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (0‚Üí2, ‚Üí1)
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ –≤–∞–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

### 3. –ú–µ—Ç–æ–¥ `detectChanges()`

```javascript
detectChanges(previousState, currentState) {
    const changes = [];
    
    // –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏
    if (previousState.attendance !== -1 && currentState.attendance === -1) {
        changes.push({ type: 'booking_cancelled' });
    }
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    if (previousState.datetime !== currentState.datetime) {
        changes.push({ type: 'booking_time_changed' });
    }
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞
    if (previousState.staff_id !== currentState.staff_id) {
        changes.push({ type: 'booking_staff_changed' });
    }
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —É—Å–ª—É–≥
    if (JSON.stringify(previousState.services) !== JSON.stringify(currentState.services)) {
        changes.push({ type: 'booking_service_changed' });
    }
    
    // –§–ò–õ–¨–¢–†–´ - –Ω–µ —Å—á–∏—Ç–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏:
    // - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (0 ‚Üí 2)
    if (previousState.attendance === 0 && currentState.attendance === 2) {
        return [];
    }
    
    // - –ö–ª–∏–µ–Ω—Ç –ø—Ä–∏—à–µ–ª (‚Üí 1)
    if (currentState.attendance === 1) {
        return [];
    }
    
    return changes;
}
```

### 4. –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

#### –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏:
```
‚ùå *–í–∞—à–∞ –∑–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞*

üìÖ 13 –∞–≤–≥—É—Å—Ç–∞ –≤ 15:00
üíá –ú—É–∂—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞

–ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏.
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–ø–∏—Å–∏:
```
üîÑ *–í–∞—à–∞ –∑–∞–ø–∏—Å—å –∏–∑–º–µ–Ω–µ–Ω–∞*

üìÖ –í—Ä–µ–º—è: 13 –∞–≤–≥—É—Å—Ç–∞ 15:00 ‚Üí 14 –∞–≤–≥—É—Å—Ç–∞ 16:00
üë§ –ú–∞—Å—Ç–µ—Ä: –ò–≤–∞–Ω ‚Üí –ü–µ—Ç—Ä

üìã *–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:*
üìÖ 14 –∞–≤–≥—É—Å—Ç–∞ –≤ 16:00
üíá –ú—É–∂—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞
üë§ –ü–µ—Ç—Ä
üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 1500 —Ä—É–±.
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- –ö–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µ–Ω—É–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π –æ–ø—ã—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∞–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- –ß–µ—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–º, —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (30-–º–∏–Ω—É—Ç–Ω–æ–µ –æ–∫–Ω–æ)

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –§–∞–π–ª—ã:
- `src/services/booking-monitor/index.js` - –Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
- `booking_states` —Ç–∞–±–ª–∏—Ü–∞ - —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π
- `booking_notifications` —Ç–∞–±–ª–∏—Ü–∞ - –∏—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–µ–π: –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- –û—Ö–≤–∞—Ç: 7 –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥
- –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö: –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π

### –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 30 –º–∏–Ω—É—Ç
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

## üìù –í—ã–≤–æ–¥—ã

–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ booking-monitor —Å—Ç–∞–ª–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–Ω–µ–µ:
1. **–ü–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç** - —Ä–∞–∑–ª–∏—á–∞–µ—Ç –≤–∞–∂–Ω—ã–µ –∏ –Ω–µ–≤–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
2. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é** - –∑–Ω–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
3. **–§–∏–ª—å—Ç—Ä—É–µ—Ç —à—É–º** - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
4. **–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∞** - —á–µ—Ç–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

–≠—Ç–æ —É–ª—É—á—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç –∏ —Å–Ω–∏–∂–∞–µ—Ç "—É–≤–µ–¥–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —à—É–º", –¥–µ–ª–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é –±–æ–ª–µ–µ —Ü–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –∏ –ø–æ–ª–µ–∑–Ω–æ–π.