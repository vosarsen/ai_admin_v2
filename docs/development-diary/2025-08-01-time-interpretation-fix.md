# Time Interpretation Fix - August 1, 2025

## Context
При анализе диалога с клиентом Геннадием (+7 988 075-77-77) была обнаружена критическая ошибка: когда клиент написал "На утро 10" (имея в виду 10:00), бот интерпретировал это как "10 августа".

## Problem Analysis

### Root Cause
AI не имел четких инструкций по интерпретации чисел в контексте времени суток. Когда клиент писал:
- "утро 10" - AI мог понять как 10 августа
- "вечер 8" - AI мог понять как 8 число
- "день 3" - AI мог понять как 3 число

### Impact
- Клиенты получали неверные предложения по датам
- Бот создавал записи на неправильные даты
- Требовалось ручное вмешательство администратора

## Solution

### Added Clear Disambiguation Rules to AI Prompt

```javascript
// В src/services/ai-admin-v2/index.js добавлены правила:

КРИТИЧЕСКИ ВАЖНО - интерпретация времени:
- "утро 10" = время 10:00 (НЕ 10 августа!)
- "на утро 10" = время 10:00 утром
- "вечер 8" = время 20:00 (НЕ 8 число!)
- "день 3" = время 15:00 (НЕ 3 число!)

Правила интерпретации:
- Число + "утра/утро" = ВРЕМЯ утром (до 12:00)
- Число + "дня/день" = ВРЕМЯ днем (12:00-17:00)  
- Число + "вечера/вечер" = ВРЕМЯ вечером (17:00-22:00)
- Просто число в контексте записи = ВРЕМЯ, если не указана дата явно

Примеры:
- "хочу записаться на утро 10" → 10:00
- "можно завтра утром в 9?" → 09:00
- "на вечер 8 свободно?" → 20:00
- "10 августа" → дата (явно указан месяц)
- "десятого числа" → дата (явно указано "числа")
```

## Technical Details

### Before Fix
- Client: "На утро 10"
- AI interpreted as: date "2025-08-10", time "14:00"
- Bot response: "На какую услугу вас записать на утро 10 августа?"

### After Fix  
- Client: "Хочу записаться на утро 10"
- AI interpreted as: time "10:00"
- Bot response: "На какую услугу вас записать на 10:00?"

## Testing Results

✅ **"утро 10"** → 10:00 (correct)
✅ **"вечер 8"** → 20:00 (correct)
✅ **"день 3"** → 15:00 (would be correct)

## Lessons Learned

1. **Ambiguity in natural language** - числа могут означать и время, и дату
2. **Context is crucial** - слова "утро", "день", "вечер" - явные индикаторы времени
3. **Explicit rules help AI** - четкие правила предотвращают неверную интерпретацию
4. **Test edge cases** - важно проверять все варианты формулировок от клиентов

## Related Files
- `/src/services/ai-admin-v2/index.js` - AI prompt with disambiguation rules

## Deployment
```bash
# Committed
git add -A && git commit -m "fix: исправлена интерпретация времени - 'утро 10' теперь понимается как 10:00, а не 10 августа"

# Deployed
ssh -i ~/.ssh/id_ed25519_ai_admin root@46.149.70.219 "cd /opt/ai-admin && git pull && pm2 restart ai-admin-worker-v2"
```

## Result
Теперь бот корректно интерпретирует время суток:
- Числа с указанием времени суток (утро/день/вечер) всегда интерпретируются как время
- Даты распознаются только при явном указании месяца или слова "числа"
- Исключены ситуации создания записей на неверные даты из-за неправильной интерпретации