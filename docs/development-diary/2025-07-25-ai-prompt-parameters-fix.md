# 2025-07-25: Исправление передачи параметров в командах AI

## Контекст
При тестировании бронирования обнаружилась критическая проблема: AI отправлял команду CREATE_BOOKING без параметров, что приводило к ошибке "Не удалось определить мастера для записи".

## Что было сделано

### 1. Диагностика проблемы
- Обнаружено, что AI использует команду `[CREATE_BOOKING]` без параметров
- В логах видно: `"params":{}`
- Проблема была в неправильном формате примеров в промпте

### 2. Исправление формата команд в промпте
- Заменен формат `key=value` на `key: value` во всех примерах
- Было: `[CREATE_BOOKING service_name=стрижка, date=завтра, time=15:00]`
- Стало: `[CREATE_BOOKING service_name: стрижка, date: завтра, time: 15:00]`

### 3. Усиление инструкций для AI
- Добавлены четкие правила о необходимости ВСЕГДА передавать параметры
- Добавлены примеры правильного и неправильного использования
- Указаны обязательные параметры: service_name, date, time

### 4. Добавлено логирование
- Добавлен вывод ответа AI и извлеченных команд для отладки

## Технические детали

### Проблема парсинга
Регулярное выражение в `parseCommandParams` ожидает формат `key: value` или `key=value`:
```javascript
const paramRegex = /(\w+)[:=]\s*([^,]+)/g;
```

Но в примерах был смешанный формат, что путало AI.

### Результаты тестирования
После исправлений:
1. AI начал передавать параметры корректно
2. Успешно создана запись на стрижку к мастеру Сергею на 20:00
3. Система корректно определила услугу и мастера по названиям

## Проблемы и решения

### Проблема 1: YClients API 403 ошибки
- При попытке найти или создать клиента возникает ошибка 403
- "Нет прав на управление компанией"
- Несмотря на это, запись создается успешно
- **TODO**: Запросить расширенные права API у YClients

### Проблема 2: Автоматический выбор мастера
- Если клиент не указал мастера, система требует уточнения
- Это правильное поведение согласно бизнес-логике

## Уроки и выводы

1. **Важность точности в примерах**: AI точно следует примерам из промпта
2. **Необходимость логирования**: Без логов было бы сложно найти проблему
3. **Постепенное улучшение**: Система работает даже с ограничениями API

## Следующие шаги

1. Запросить расширенные права API у YClients для управления клиентами
2. Рассмотреть возможность автоматического выбора мастера при наличии предпочтений
3. Улучшить обработку ошибок при создании записи