# Проблемы с обработкой батчей Redis - 23 июля 2025

## Проблема
Реализован механизм батчинга для объединения rapid-fire сообщений в WhatsApp, но батчи исчезают после таймаута без обработки.

## Симптомы
1. Сообщения корректно добавляются в батч
2. Время простоя (idle time) корректно отсчитывается
3. При достижении 10 секунд батч исчезает из Redis
4. Метод `processBatch` не вызывается
5. Сообщения теряются, пользователь не получает ответ

## Найденные проблемы

### 1. TTL конфликт (первая попытка исправления)
- **Проблема**: TTL был установлен на 10 секунд, что совпадало с таймаутом обработки
- **Исправление**: Увеличен TTL до 60 секунд
- **Результат**: Проблема не решена

### 2. Исчезновение батча между проверками
- Батч существует при idle = 9267ms
- Батч исчезает к следующей проверке (через 1 секунду)
- Нет логов об обработке между этими моментами

## Текущее состояние отладки

### Добавлено логирование:
1. Проверка TTL батча при каждой проверке
2. Детальное логирование при приближении к таймауту:
   - 9000-9500ms: info лог "approaching timeout"
   - >9500ms: warning "VERY close to timeout" с точной разницей
3. Логирование начала processBatch
4. Проверка существования батча если нет lastMessageTime

### Технические детали:
- `defaultTTL = 60` секунд
- `batchTimeout = 10000` мс (10 секунд)
- Проверка батчей каждую секунду
- TTL обновляется при каждом новом сообщении

## Гипотезы

### 1. Race condition
Возможно, между проверкой shouldProcess и вызовом processBatch батч удаляется

### 2. Неправильный подсчет TTL
TTL может считаться от первого сообщения, а не обновляться

### 3. Проблема с Redis
Возможны проблемы с подключением или командами Redis

## Следующие шаги для отладки

1. Проверить фактический TTL батча перед обработкой
2. Добавить атомарную операцию для проверки и обработки
3. Логировать все операции с Redis
4. Проверить синхронизацию времени между проверками

## Временная статистика
- Батчи обрабатывались корректно при таймауте 5-6 секунд (старые логи)
- При таймауте 10 секунд батчи исчезают без обработки
- Проблема воспроизводится стабильно

## Код для воспроизведения
Отправить 3-5 сообщений частями в WhatsApp с интервалом 1-2 секунды между сообщениями.

## Критичность
ВЫСОКАЯ - потеря пользовательских сообщений в production