# Fix: Ложные уведомления об изменении услуг + Рефакторинг хардкодов

**Дата:** 24 сентября 2025
**Автор:** AI Assistant с Владиславом
**Компонент:** booking-monitor

## Проблема

Клиенты получали уведомления "Ваша запись изменена. Услуги изменены" каждые 30-60 минут, хотя реальных изменений в записи не было.

### Симптомы:
- Клиент Владислав (79166746333) получал уведомления о booking ID 1296135393 каждые 30-60 минут
- В уведомлении указывалось "Услуги изменены"
- Актуальные данные в уведомлении были идентичны предыдущим
- Проблема затрагивала множество клиентов (79999883213, 79880757777, 79166135632 и др.)

## Анализ

### Корневая причина:
YClients API возвращает массив услуг в произвольном порядке при каждом запросе:
- Первый запрос: `["МУЖСКАЯ СТРИЖКА", "VOLCANO"]`
- Следующий запрос: `["VOLCANO", "МУЖСКАЯ СТРИЖКА"]`

При сравнении через `JSON.stringify()` разный порядок элементов воспринимался как изменение услуг.

### Места в коде с проблемой:
1. `src/services/booking-monitor/index.js:299-310` - метод `detectChanges()`
2. `src/services/booking-monitor/index.js:326-329` - метод `hasOtherChanges()`

## Решение

### Изменения в коде:

1. **Сортировка массивов перед сравнением:**
```javascript
// Было:
const prevServices = JSON.stringify(previousState.services || []);
const currServices = JSON.stringify(currentState.services || []);
if (prevServices !== currServices) {
  // Отправляем уведомление об изменении
}

// Стало:
const prevServices = (previousState.services || []).sort();
const currServices = (currentState.services || []).sort();
const prevServicesStr = JSON.stringify(prevServices);
const currServicesStr = JSON.stringify(currServices);
if (prevServicesStr !== currServicesStr) {
  // Отправляем уведомление об изменении
}
```

2. **Увеличение окна проверки дубликатов:**
- Изменено с 30 минут на 60 минут для дополнительной защиты

### Файлы изменены:
- `src/services/booking-monitor/index.js` - исправлена логика сравнения услуг

## Результат

✅ **Проблема решена:**
- Услуги теперь сравниваются корректно независимо от порядка
- Ложные уведомления больше не отправляются
- Клиенты получают уведомления только о реальных изменениях

## Тестирование

1. Развернуто на production сервере
2. Booking monitor перезапущен: `pm2 restart ai-admin-booking-monitor`
3. Мониторинг подтвердил отсутствие ложных уведомлений

## Уроки

1. **Важность нормализации данных:** При сравнении массивов нужно учитывать, что порядок элементов может меняться
2. **API особенности:** YClients API не гарантирует постоянный порядок элементов в массивах
3. **Защита от дубликатов:** Увеличенное окно проверки (60 минут) добавляет дополнительную защиту

## Дополнительный рефакторинг: Удаление хардкодов

После исправления основной проблемы был проведен рефакторинг для соответствия политике "No Hardcoding" проекта.

### Что было захардкожено:
1. Окно проверки дубликатов: `60 * 60 * 1000` (1 час)
2. Русские тексты сообщений прямо в коде
3. Тексты для типов изменений ("Время изменено", "Мастер изменен" и т.д.)
4. Значения по умолчанию ("Услуга", "Специалист", "Не указан")

### Решение рефакторинга:

#### 1. Создан файл конфигурации сообщений `src/config/booking-monitor-messages.js`:
```javascript
const messages = {
  cancellation: {
    template: `Ваша запись отменена...`
  },
  change: {
    template: `Ваша запись изменена...`,
    changes: {
      time: 'Время изменено: {oldDateTime} → {newDateTime}',
      staff: 'Мастер изменен: {oldStaff} → {newStaff}',
      services: 'Услуги изменены',
      notSpecified: 'Не указан'
    }
  },
  defaults: {
    service: 'Услуга',
    staff: 'Специалист'
  }
};
```

#### 2. Добавлен конфигурируемый параметр для окна проверки:
```javascript
this.duplicateCheckWindow = config.bookingMonitor?.duplicateCheckWindow || 60 * 60 * 1000;
```

### Преимущества рефакторинга:
- ✅ Централизованное управление текстами
- ✅ Легкая локализация в будущем
- ✅ Настраиваемые временные окна
- ✅ Соответствие архитектурным принципам проекта
- ✅ Упрощение тестирования

## Метрики

- **Количество затронутых клиентов:** ~10-15 активных записей
- **Частота ложных уведомлений:** каждые 30-60 минут
- **Время на исправление основной проблемы:** 15 минут
- **Время на рефакторинг хардкодов:** 10 минут
- **Downtime:** 0 (hot reload через PM2)

## Итоговые изменения:

### Файлы изменены:
1. `src/services/booking-monitor/index.js` - исправлена логика сравнения + удалены хардкоды
2. `src/config/booking-monitor-messages.js` - новый файл с конфигурацией сообщений

### Коммиты:
1. `fix: false notifications about service changes due to order differences`
2. `refactor: remove hardcoded values from booking monitor`