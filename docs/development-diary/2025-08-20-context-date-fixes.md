# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –¥–∞—Ç—ã –≤ AI Admin v2

**–î–∞—Ç–∞**: 20 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–ê–≤—Ç–æ—Ä**: –ê—Ä—Å–µ–Ω  
**–ó–∞–¥–∞—á–∞**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Ç–µ—Ä—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∞—Ç—ã –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–ª "–ö–æ–≥–¥–∞ –∑–∞–≤—Ç—Ä–∞ —Å–≤–æ–±–æ–¥–Ω–æ?", –ø–æ–ª—É—á–∞–ª —Å–ø–∏—Å–æ–∫ –≤—Ä–µ–º–µ–Ω–∏, –∑–∞—Ç–µ–º –≥–æ–≤–æ—Ä–∏–ª "–ó–∞–ø–∏—à–∏ –Ω–∞ 15:00", –Ω–æ —Å–∏—Å—Ç–µ–º–∞ –∏—Å–∫–∞–ª–∞ –≤—Ä–µ–º—è –Ω–∞ **—Å–µ–≥–æ–¥–Ω—è** –≤–º–µ—Å—Ç–æ **–∑–∞–≤—Ç—Ä–∞**, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–µ "–≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ".

### –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ö–æ–≥–¥–∞ –∑–∞–≤—Ç—Ä–∞ —É –ë–∞—Ä–∏ —Å–≤–æ–±–æ–¥–Ω–æ?
–ë–æ—Ç: –ó–∞–≤—Ç—Ä–∞ —É –ë–∞—Ä–∏ —Å–≤–æ–±–æ–¥–Ω–æ: 15:00, 16:00, 17:00...
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ó–∞–ø–∏—à–∏ –Ω–∞ 15:00
–ë–æ—Ç: –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, 15:00 —É–∂–µ –∑–∞–Ω—è—Ç–æ. [–∏—Å–∫–∞–ª –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, –∞ –Ω–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞]
```

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω

1. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** - –∫–∞–∂–¥—ã–π `updateContext` –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª –ø—Ä–µ–¥—ã–¥—É—â–∏–π
2. **–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞** - —É–¥–∞–ª—è–ª–∏—Å—å –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—É—Å–ª—É–≥–∞, –º–∞—Å—Ç–µ—Ä, –¥–∞—Ç–∞)
3. **AI –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç** - –≤ –ø—Ä–æ–º–ø—Ç–µ –Ω–µ –±—ã–ª–æ —è–≤–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `lastDate`
4. **redisContext –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –≤ Two-Stage –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä** - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ v2

–°–æ–∑–¥–∞–Ω `ContextServiceV2` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö:
- **dialog** (2 —á–∞—Å–∞) - —Ç–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä —É—Å–ª—É–≥–∏, –º–∞—Å—Ç–µ—Ä–∞, –≤—Ä–µ–º–µ–Ω–∏
- **client** (24 —á–∞—Å–∞) - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ –∏–∑ –ë–î
- **preferences** (30 –¥–Ω–µ–π) - –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
- **messages** (24 —á–∞—Å–∞) - –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

### 2. –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–í–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤:
```javascript
// –ë—ã–ª–æ
await contextService.updateContext(...);
await contextService.updateContext(...); // –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–π
await contextService.setContext(...);    // –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ

// –°—Ç–∞–ª–æ
await contextManager.saveContext(phone, companyId, {
  userMessage, botResponse, selection, clientName
}); // –æ–¥–∏–Ω –∞—Ç–æ–º–∞—Ä–Ω—ã–π –≤—ã–∑–æ–≤
```

### 3. –£–º–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ selection

```javascript
selection = {
  ...oldSelection,
  ...newSelection,
  // –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–ª—è –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º null/undefined
  date: newSelection.date !== undefined ? newSelection.date : oldSelection.date
};
```

### 4. –£—Å–∏–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Two-Stage

–î–æ–±–∞–≤–ª–µ–Ω—ã —è–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
```
üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –î–ê–¢–´ –ò–ó –ö–û–ù–¢–ï–ö–°–¢–ê:
- –ï–°–õ–ò –í –ö–û–ù–¢–ï–ö–°–¢–ï –ï–°–¢–¨ lastDate ‚Üí –í–°–ï–ì–î–ê –ò–°–ü–û–õ–¨–ó–£–ô –ï–Å!
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: lastDate="–∑–∞–≤—Ç—Ä–∞", –ö–ª–∏–µ–Ω—Ç: "–Ω–∞ 16:00" ‚Üí date="–∑–∞–≤—Ç—Ä–∞" (–ù–ï "—Å–µ–≥–æ–¥–Ω—è"!)
```

### 5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—á–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ `ai-admin-v2/index.js`:
```javascript
// –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ redisContext –¥–ª—è Two-Stage
context.redisContext = redisContext;
```

### 6. –Ø–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ lastDate

–ü–æ—Å–ª–µ SEARCH_SLOTS —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—É:
```javascript
if (cmd.command === 'SEARCH_SLOTS' && cmd.params?.date) {
  await contextService.setContext(phone, companyId, {
    data: { lastDate: cmd.params.date }
  });
}
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –ë–æ—Ç —Ç–µ—Ä—è–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∞—Ç—ã
- –ò—Å–∫–∞–ª –≤—Ä–µ–º—è –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–µ–Ω—å
- –ì–æ–≤–æ—Ä–∏–ª "–≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ" –∫–æ–≥–¥–∞ –æ–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ

### ‚úÖ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- –î–∞—Ç–∞ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–µ–Ω—å

### –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ö–æ–≥–¥–∞ –∑–∞–≤—Ç—Ä–∞ —Å–≤–æ–±–æ–¥–Ω–æ –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∫ –ë–∞—Ä–∏?
–ë–æ—Ç: –ó–∞–≤—Ç—Ä–∞ —É –ë–∞—Ä–∏ —Å–≤–æ–±–æ–¥–Ω–æ: 15:00, 16:00...
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ó–∞–ø–∏—à–∏ –Ω–∞ 15:00
–ë–æ—Ç: ‚úÖ –ó–∞–ø–∏—Å–∞–ª –≤–∞—Å –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞ –≤ 15:00 –∫ –º–∞—Å—Ç–µ—Ä—É –ë–∞—Ä–∏
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `src/services/context/context-service-v2.js` - –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
2. `src/services/ai-admin-v2/modules/context-manager-v2.js` - –º–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
3. `src/services/ai-admin-v2/index.js` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
4. `src/services/ai-admin-v2/prompts/two-stage-command-prompt.js` - —É—Å–∏–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
5. `src/services/ai-admin-v2/modules/two-stage-processor.js` - —É–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ TTL –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–µ–π
- –£–º–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤

## –í—ã–≤–æ–¥—ã

–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞ —á–µ—Ä–µ–∑ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
2. –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ (—è–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è AI)
3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤ (–ø–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.