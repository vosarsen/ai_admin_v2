# Исправления парсинга времени и контекста диалога

**Дата**: 20 августа 2025  
**Автор**: AI Admin Team  
**Проблема**: Бот не понимал временные выражения и терял контекст между сообщениями  
**Статус**: ✅ Частично решено

## Описание проблемы

### Анализ диалога Арсена (11:52-11:54)

Клиент вел диалог:
1. "Добрый день Когда можно постричься?"
2. Бот показал слоты: 12:00, 13:00, 13:30...
3. "Давай на час" 
4. ❌ Бот НЕ понял что "на час" = 13:00, спросил заново услугу и дату
5. "Сегодня стрижка"
6. ❌ Бот выполнил 0 команд и не создал запись

### Выявленные проблемы

1. **Парсинг времени**: "на час" не интерпретировалось как 13:00
2. **Потеря контекста**: После SEARCH_SLOTS контекст услуги не сохранялся
3. **service_id как объект**: В YClients API передавался `service_id=[object Object]`
4. **Импорт CompanyInfoSync**: Неправильный импорт класса вместо экземпляра
5. **Отсутствующая таблица bookings**: Вызывала ошибки при загрузке данных

## Технические исправления

### 1. Парсинг временных выражений

**Файл**: `src/services/ai-admin-v2/prompts/two-stage-command-prompt.js`

Добавлены правила понимания времени:
```javascript
КРИТИЧЕСКИ ВАЖНО - ПОНИМАНИЕ ВРЕМЕНИ:
- "на час" = 13:00 (на час дня)
- "на час дня" = 13:00
- "в час" = 13:00
- "на два" = 14:00 (на два часа дня)
- "на три" = 15:00
- "на 10 утра" = 10:00
- "на 6 вечера" = 18:00
- Числа от 1 до 12 обычно означают дневное время (13:00-24:00)
```

Добавлен пример в промпт:
```javascript
Пример 7: Время "на час"
Контекст: lastService="стрижка", lastDate="сегодня", lastStaff="Бари"
Сообщение: "Давай на час"
{
  "commands": [
    {
      "name": "CREATE_BOOKING",
      "params": {
        "service_name": "стрижка",
        "date": "сегодня",
        "time": "13:00",
        "staff_name": "Бари"
      }
    }
  ]
}
```

### 2. Исправление передачи service_id

**Файл**: `src/integrations/yclients/client.js`

```javascript
// Исправляем service_id если он передан как вложенный объект
if (queryParams.service_id && typeof queryParams.service_id === 'object') {
  queryParams.service_id = queryParams.service_id.service_id;
}
```

### 3. Исправление импорта CompanyInfoSync

**Файл**: `src/services/ai-admin-v2/modules/data-loader.js`

```javascript
// Было:
const companyInfoSync = require('../../../sync/company-info-sync');

// Стало:
const { CompanyInfoSync } = require('../../../sync/company-info-sync');
const companyInfoSync = new CompanyInfoSync();
```

### 4. Обработка отсутствующей таблицы bookings

**Файл**: `src/services/ai-admin-v2/modules/data-loader.js`

```javascript
if (error) {
  // Если таблица не существует, просто возвращаем пустой массив
  if (error.code === '42P01') {
    logger.debug('Bookings table does not exist yet');
  } else {
    logger.error('Error loading bookings:', error);
  }
  return [];
}
```

### 5. Улучшение сохранения контекста

**Файл**: `src/services/ai-admin-v2/modules/two-stage-processor.js`

```javascript
return {
  response: finalResponse,
  commands: executedCommands,
  executedCommands: executedCommands, // Для совместимости с сохранением контекста
  commandResults: commandResults, // Для сохранения результатов
  // ...
};
```

## Результаты тестирования

### Тест парсинга времени
- ✅ Промпт обновлен с правилами парсинга
- ✅ Добавлены примеры для AI
- ⚠️ Требуется дополнительное тестирование с реальными сообщениями

### Тест контекста
- ✅ Two-Stage теперь возвращает executedCommands и commandResults
- ✅ Контекст сохраняется в Redis после выполнения команд
- ⚠️ Нужно проверить что контекст правильно передается в следующие сообщения

## Оставшиеся проблемы

1. **Бот все еще может не создавать запись** когда есть вся информация
2. **Нужно улучшить логику Two-Stage** чтобы при наличии контекста и времени сразу выполнялся CREATE_BOOKING
3. **Таблица bookings** должна быть создана в Supabase

## Рекомендации

1. **Создать таблицу bookings** в Supabase используя SQL из `scripts/create-bookings-table-simple.js`
2. **Добавить более строгую логику** в Two-Stage промпт для CREATE_BOOKING
3. **Протестировать с реальными диалогами** через WhatsApp
4. **Мониторить логи** на предмет правильного парсинга времени

## Влияние на продукт

### До исправления:
- ❌ "на час" не понималось как время
- ❌ Контекст терялся между сообщениями
- ❌ service_id передавался некорректно в YClients
- ❌ Ошибки при загрузке bookings

### После исправления:
- ✅ Временные выражения должны парситься корректно
- ✅ service_id передается как число
- ✅ Нет ошибок от отсутствующей таблицы
- ✅ Контекст сохраняется между сообщениями
- ⚠️ Требуется дополнительная проверка эффективности

## Заключение

Внесены критические исправления для улучшения понимания временных выражений и сохранения контекста. Однако, требуется дополнительное тестирование и возможно более глубокие изменения в логике Two-Stage процессора для полного решения проблемы.