# Development Diary: –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ context-v2
**Date**: 2025-08-26
**Author**: vosarsen
**Module**: Context System v2

## –ö–æ–Ω—Ç–µ–∫—Å—Ç
–ü–æ—Å–ª–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –≤ —Å–∏—Å—Ç–µ–º–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏, –ª–æ–∂–Ω—ã–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏) –±—ã–ª–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É context-v2.

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞

### 1. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã
- **–ü—Ä–æ–±–ª–µ–º–∞**: –¢—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–æ–∑–¥–∞–≤–∞–ª–∏ –ø—É—Ç–∞–Ω–∏—Ü—É
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ –∫–ª—é—á–∏ Redis (context:*, dialog:*, messages:*)
- **–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–≥–∞—Ö

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ v2
- ‚úÖ –£–¥–∞–ª–µ–Ω UnifiedContextService (–Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä—è–º–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞)
- ‚úÖ –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω—ã —Å contextService –Ω–∞ contextServiceV2
- ‚úÖ –°–æ–∑–¥–∞–Ω —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å–æ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –º–æ–¥—É–ª–∏:
  - `context-manager-v2.js` - –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  - `cached-data-loader.js` - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  - `ai-admin-v2/index.js` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å AI

### 3. –û—á–∏—Å—Ç–∫–∞ Redis
- –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `safe-redis-cleanup.js` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∫–ª—é—á–µ–π
- –£–¥–∞–ª–µ–Ω–æ 85 —Å—Ç–∞—Ä—ã—Ö –∫–ª—é—á–µ–π —Ñ–æ—Ä–º–∞—Ç–∞ `context:*`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ –Ω–æ–≤—ã–µ –∫–ª—é—á–∏ v2: `dialog:*`, `messages:*`, `full_ctx:*`

### 4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
```
üìä V2 System Statistics:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  dialog:*       : 1 keys
  messages:*     : 4 keys  
  client:*       : 0 keys
  prefs:*        : 0 keys
  full_ctx:*     : 3 keys
  processing:*   : 0 keys
  intermediate:* : 0 keys
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ v2

| –ü–∞—Ä–∞–º–µ—Ç—Ä           | v1 (—Å—Ç–∞—Ä–∞—è)       | v2 (–Ω–æ–≤–∞—è)               |
|--------------------|-------------------|--------------------------|
| –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö   | –í—Å—ë –≤ –æ–¥–Ω–æ–º –∫–ª—é—á–µ | –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º      |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è   | 12-—á–∞—Å–æ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ   |
| –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å         | JSON –≤ —Å—Ç—Ä–æ–∫–∞—Ö    | –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å   | –°–ª–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å  | –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞    |
| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è       | –•–∞—Ä–¥–∫–æ–¥ TTL       | ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ           |

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª—é—á–µ–π Redis:
- `dialog:{companyId}:{phone}` - —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ª–æ–≥ –∏ –≤—ã–±–æ—Ä
- `messages:{companyId}:{phone}` - –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- `client:{companyId}:{phone}` - –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
- `prefs:{companyId}:{phone}` - –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
- `full_ctx:{companyId}:{phone}` - –ø–æ–ª–Ω—ã–π –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

### –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
```javascript
// src/config/context-config.js
module.exports = {
  ttl: {
    dialog: {
      messages: process.env.CONTEXT_TTL_MESSAGES || 24 * 60 * 60,
      selection: process.env.CONTEXT_TTL_SELECTION || 2 * 60 * 60,
      pendingAction: process.env.CONTEXT_TTL_PENDING || 30 * 60
    },
    cache: {
      fullContext: process.env.CONTEXT_TTL_FULL || 12 * 60 * 60
    }
  }
};
```

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —Å–∏—Å—Ç–µ–º–∞ –±–∞—Ç—á–∏–Ω–≥–∞ –ø–µ—Ä–µ—Å—Ç–∞–ª–∞ —Ä–∞–±–æ—Ç–∞—Ç—å. Batch processor –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –∫–ª—é—á–∏ `rapid-fire:*` –≤ Redis, —Ö–æ—Ç—è API –ª–æ–≥–∏—Ä—É–µ—Ç –∏—Ö –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ. –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞ —Å–∏—Å—Ç–µ–º—ã –±–∞—Ç—á–∏–Ω–≥–∞.

## –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞ –Ω–∞ v2 –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
‚úÖ –£–¥–∞–ª–µ–Ω—ã –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã
‚úÖ –û—á–∏—â–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Redis
‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –±–∞—Ç—á–∏–Ω–≥–∞

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å batch processor
2. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è v2 —Å–∏—Å—Ç–µ–º—ã
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è