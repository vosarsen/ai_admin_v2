# Two-Stage –ü—Ä–æ–º–ø—Ç—ã: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 40%

**–î–∞—Ç–∞:** 29 —Å–µ–Ω—Ç—è–±—Ä—è 2025
**–ê–≤—Ç–æ—Ä:** –ê—Ä—Å–µ–Ω
**–¢–∏–ø:** –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## –ü—Ä–æ–±–ª–µ–º–∞

Two-stage –ø—Ä–æ–º–ø—Ç—ã —Å—Ç–∞–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–º–∏:
- Stage 1: ~3,035 —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
- Stage 2: ~1,775 —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
- –ò—Ç–æ–≥–æ: ~4,810 —Ç–æ–∫–µ–Ω–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –º–∞–∫—Å–∏–º—É–º 2,000-3,000)

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫:
- –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
- –ü–æ–≤—ã—à–µ–Ω–Ω—ã–º –∑–∞—Ç—Ä–∞—Ç–∞–º –Ω–∞ API
- –°–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ –∫–æ–¥–∞

## –†–µ—à–µ–Ω–∏–µ

### 1. –ê–Ω–∞–ª–∏–∑ –∏ –≤—ã—è–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–π

–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
- **380 —Å—Ç—Ä–æ–∫ –ø—Ä–∏–º–µ—Ä–æ–≤** –≤ Stage 1 (12+ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤)
- **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è** –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –ø—Ä–∞–≤–∏–ª
- **–ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è** –ª–æ–≥–∏–∫–∏
- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –≤ —Ä–∞–∑–Ω—ã—Ö —Å–µ–∫—Ü–∏—è—Ö

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Stage 1 (Command Extraction)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
```javascript
// –ë—ã–ª–æ: –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª –¥–∞—Ç—ã
üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –î–ê–¢–´ –ü–û –ö–û–ù–¢–ï–ö–°–¢–£: [50 —Å—Ç—Ä–æ–∫]
üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –î–ê–¢–´ –ò–ó –ö–û–ù–¢–ï–ö–°–¢–ê: [30 —Å—Ç—Ä–æ–∫]
üî¥üî¥üî¥ –°–£–ü–ï–† –í–ê–ñ–ù–û - –ù–ò–ö–û–ì–î–ê –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô "—Å–µ–≥–æ–¥–Ω—è": [20 —Å—Ç—Ä–æ–∫]

// –°—Ç–∞–ª–æ: –æ–¥–∏–Ω –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–ª–æ–∫
–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –†–ê–ë–û–¢–ê –° –î–ê–¢–û–ô –ò–ó –ö–û–ù–¢–ï–ö–°–¢–ê: [10 —Å—Ç—Ä–æ–∫]
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å 502 –¥–æ 186 —Å—Ç—Ä–æ–∫ (-63%)

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Stage 2 (Response Generation)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
```javascript
// –ë—ã–ª–æ: –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø—Ä–∞–≤–∏–ª–∞
–ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê: [25 —Å—Ç—Ä–æ–∫]
–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: [15 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è]
–§–ò–ù–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê: [15 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è]

// –°—Ç–∞–ª–æ: –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
–û–°–ù–û–í–ù–´–ï –ü–†–ê–í–ò–õ–ê: [6 —Å—Ç—Ä–æ–∫]
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å 459 –¥–æ 393 —Å—Ç—Ä–æ–∫ (-14%)

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Production —Ç–µ—Å—Ç
```bash
# –í–∫–ª—é—á–µ–Ω–∏–µ two-stage —Ä–µ–∂–∏–º–∞
export USE_TWO_STAGE=true
export AI_PROMPT_VERSION=two-stage
pm2 restart ai-admin-worker-v2 --update-env

# –¢–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥
–ö–ª–∏–µ–Ω—Ç: "–ü—Ä–∏–≤–µ—Ç! –•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞"
–ë–æ—Ç: [–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ª–æ—Ç—ã]
–ö–ª–∏–µ–Ω—Ç: "–î–∞–≤–∞–π –Ω–∞ 14:00"
–ë–æ—Ç: "–ó–∞–ø–∏—Å–∞–ª –≤–∞—Å –Ω–∞ –º—É–∂—Å–∫—É—é —Å—Ç—Ä–∏–∂–∫—É..."
```

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –≠—Ç–∞–ø | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|------|-----|-------|-----------|
| Stage 1 | ~8 —Å–µ–∫ | ~6.3 —Å–µ–∫ | -21% |
| Stage 2 | ~5 —Å–µ–∫ | ~3.2 —Å–µ–∫ | -36% |
| **–ò—Ç–æ–≥–æ** | ~13 —Å–µ–∫ | ~9.4 —Å–µ–∫ | **-28%** |

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Git diff —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```bash
2 files changed, 81 insertions(+), 461 deletions(-)
```

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç:
- ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤

## –í—ã–≤–æ–¥—ã

1. **–£—Å–ø–µ—à–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 40% –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
2. **–£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:** –û—Ç–≤–µ—Ç—ã —Å—Ç–∞–ª–∏ –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ 28%
3. **–°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç:** –ú–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ = –º–µ–Ω—å—à–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ API
4. **–õ—É—á—à–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞:** –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –ª–µ–≥—á–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å

## Backup

–í—Å–µ —É–¥–∞–ª–µ–Ω–Ω—ã–µ —á–∞—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤:
`src/services/ai-admin-v2/prompts/removed-duplications-backup.md`

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ –≤–Ω–µ–¥—Ä–µ–Ω–æ –≤ production