# 22 июля 2025 - Автоматический показ альтернативных слотов при ошибке бронирования

## Проблема

При попытке записи на занятое время бот возвращал общую ошибку без предложения альтернативных вариантов:

```
Клиент: Запишите меня на стрижку сегодня в 18:00
Бот: К сожалению, не удалось создать запись. Попробуйте выбрать другое время или позвоните нам.
```

Это создавало плохой UX - клиенту приходилось делать дополнительный запрос для получения доступных слотов.

## Анализ

### Выявленные проблемы:

1. **Ошибка передавалась как объект**
   - В `command-handler.js` при ошибке выбрасывался `Error(result.error)`, где `result.error` был объектом
   - Это приводило к ошибке `[object Object]` вместо текста

2. **Детальные ошибки YClients не извлекались**
   - YClients возвращает ошибки в `meta.errors` массиве
   - Эта информация терялась при обработке

3. **Не срабатывала проверка на ошибки доступности**
   - Проверка `error.includes('недоступн')` не работала с объектом
   - Автоматический поиск альтернатив не запускался

## Решение

### 1. Извлечение детальных ошибок YClients

В `client.js` добавлено извлечение `yclientsErrors`:
```javascript
if (data?.meta?.errors && Array.isArray(data.meta.errors)) {
  yclientsErrors = data.meta.errors;
}
```

### 2. Правильная обработка ошибок в command-handler

```javascript
if (result.error && result.error.yclientsErrors && Array.isArray(result.error.yclientsErrors)) {
  errorMessage = result.error.yclientsErrors.map(err => err.message).join('. ');
}
```

### 3. Автоматический поиск альтернативных слотов

В `index.js` добавлена логика автоматического поиска:
```javascript
if (isAvailabilityError) {
  // Извлекаем параметры из неудачной попытки
  const searchResult = await commandHandler.searchSlots(searchParams, context);
  
  if (searchResult && searchResult.slots && searchResult.slots.length > 0) {
    finalResponse += '\n\nВот доступное время:';
    finalResponse += '\n' + formatter.formatSlots(searchResult.slots, context.company.type);
  }
}
```

### 4. Добавлено логирование для отладки

```javascript
logger.info('Processing error result:', {
  command: result.command,
  error: result.error,
  errorType: typeof result.error,
  params: result.params
});
```

## Результаты

Теперь при записи на занятое время:

```
Клиент: Запишите меня на стрижку сегодня в 18:00. Меня зовут Павел
Бот: К сожалению, выбранное время недоступно.

Вот доступное время:
У Рамзан свободно сегодня:
Днём: 16:15, 16:30
Вечером: 17:00, 19:00
```

## Технические детали

### Измененные файлы:
1. `src/integrations/yclients/client.js` - извлечение yclientsErrors
2. `src/services/ai-admin-v2/modules/command-handler.js` - правильная обработка ошибок
3. `src/services/ai-admin-v2/index.js` - автоматический поиск альтернатив и логирование

### Проверки ошибок доступности:
- `недоступн` (недоступно, недоступна, недоступны)
- `Услуга недоступна`
- `Нет доступных`
- `выбранное время`
- `занято`

## Влияние на производительность

- Дополнительный запрос к YClients API только при ошибке бронирования
- Использование существующего кэша для поиска слотов
- Минимальное влияние на общую производительность

## Будущие улучшения

1. Можно добавить предиктивную проверку доступности перед попыткой бронирования
2. Кэширование информации о занятых слотах
3. Более умный выбор альтернативных времен на основе предпочтений клиента