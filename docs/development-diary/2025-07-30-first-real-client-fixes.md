# Development Diary: Критические исправления после первого реального клиента

**Дата**: 30 июля 2025  
**Автор**: AI Admin Development Team  
**Контекст**: Анализ диалога с первым реальным клиентом барбершопа - Наталия (+7 999 968-54-52)

## Что произошло

Сегодня в 12:32 состоялся первый диалог с реальным клиентом в production. Клиент Наталия успешно записалась на стрижку сына, но в процессе были выявлены критические проблемы.

### Хронология диалога

1. **12:32** - Клиент: "Здравствуйте"
2. **12:32** - Бот: "Здравствуйте, Наталия! Чем могу помочь?" ✅
3. **12:32** - Клиент: "Рамзан работает сегодня?"
4. **12:32** - Бот: "Наталия, да, Рамзан работает сегодня. На какую услугу вас записать?" ✅
5. **12:33** - Клиент: "Хочу подстричь сына 14 лет"
6. **12:33** - Бот предложил доступное время ✅
7. **12:34** - Клиент: "Сейчас согласую"
8. **12:41** - Клиент: "15 часов, пожалуйста Запишите нас" (через 7 минут)
9. **12:41** - Бот: "Наталия, здравствуйте! На какую услугу вас записать?" ❌
10. **12:42** - Клиент: "Стрижка"
11. **12:42** - Бот успешно создал запись, но обращается "Стрижка, здравствуйте!" ❌

## Выявленные проблемы

### 1. Потеря контекста диалога (КРИТИЧНО)
**Проблема**: После 7-минутной паузы AI забыл контекст разговора и заново спросил об услуге.

**Причина**: Контекст сохранялся только в Supabase, но не в Redis. При загрузке нового контекста Redis был пустой.

**Решение**: В `data-loader.js` добавлено сохранение контекста в Redis после каждого сообщения с информацией о последней команде, услуге, мастере и последних сообщениях.

### 2. Сохранение названия услуги как имени клиента (КРИТИЧНО)
**Проблема**: AI сохранил слово "Стрижка" как имя клиента вместо "Наталия".

**Причина**: В методе `extractNameFromMessage` был паттерн `/^([А-ЯЁ][а-яё]+)$/m`, который срабатывал на любое слово с заглавной буквы в отдельной строке.

**Решение**: 
- Убран проблемный паттерн
- Добавлен черный список слов (услуги, дни недели и т.д.)
- Улучшена проверка потенциальных имен

### 3. Напоминания для близких записей
**Проблема**: Клиент записался в 12:42 на 15:00 того же дня, но получил напоминание в 13:00.

**Решение**: Добавлена проверка - не создавать напоминания, если до записи менее 4 часов.

### 4. Ошибка сохранения в БД
**Проблема**: В логах "Failed to save booking to database", хотя запись в YClients создана успешно.

**Статус**: Требует дополнительного исследования структуры таблицы bookings.

## Технические детали

### Файлы изменены:
1. `src/services/ai-admin-v2/modules/data-loader.js` - добавлено сохранение в Redis
2. `src/services/ai-admin-v2/modules/command-handler.js` - исправлен extractNameFromMessage
3. `src/workers/message-worker-v2.js` - добавлена проверка времени для напоминаний
4. `src/services/ai-admin-v2/fixes/natalia-dialog-fixes.js` - документация исправлений

### Код изменений:

#### 1. Сохранение контекста в Redis
```javascript
// В data-loader.js добавлено:
const contextData = {
  lastCommand: result.executedCommands?.[0]?.command || null,
  lastService: result.executedCommands?.[0]?.params?.service_name || null,
  lastStaff: result.executedCommands?.[0]?.params?.staff_name || null,
  lastMessageTime: new Date().toISOString(),
  recentMessages: recentMessages.slice(-5),
  clientName: context.client?.name || null
};

await contextService.setContext(cleanPhone, companyId, {
  data: contextData
});
```

#### 2. Исправление извлечения имени
```javascript
// Добавлен черный список
const notNames = [
  'стрижка', 'маникюр', 'педикюр', 'окрашивание', 'укладка', 
  'макияж', 'массаж', 'эпиляция', 'брови', 'ресницы', 'стричься',
  // ... и другие
];

// Убран проблемный паттерн
// БЫЛО: /^([А-ЯЁ][а-яё]+)$/m
// СТАЛО: проверка через черный список
```

#### 3. Проверка времени для напоминаний
```javascript
const hoursUntilBooking = (bookingTime - now) / (1000 * 60 * 60);

if (hoursUntilBooking < 4) {
  logger.info(`⏭️ Skipping reminders - booking in ${hoursUntilBooking.toFixed(1)} hours`);
  return;
}
```

## Результаты

- ✅ Контекст теперь сохраняется в Redis для быстрого доступа
- ✅ Имена клиентов больше не перезаписываются названиями услуг
- ✅ Напоминания не создаются для близких записей
- ⏳ Требуется исправить сохранение в БД

## Уроки и выводы

1. **Важность реального тестирования** - проблемы выявились только при работе с реальным клиентом
2. **Контекст критичен** - потеря контекста создает плохой UX
3. **Регулярные выражения опасны** - слишком общие паттерны могут давать неожиданные результаты
4. **Напоминания должны быть умными** - не нужно напоминать о записи через час

## Следующие шаги

1. Исправить проблему с сохранением в БД
2. Провести полное тестирование всех исправлений
3. Мониторить логи на предмет новых проблем
4. Улучшить обработку длинных пауз в диалоге

## Метрики

- Время выявления проблем: 30 минут
- Время исправления: 1 час
- Количество затронутых файлов: 4
- Критичность: ВЫСОКАЯ (влияет на UX первого клиента)