# üìÖ 2025-09-07: –ü–æ–ª–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Redis –∫–ª—é—á–µ–π

## üìã –ö–æ–Ω—Ç–µ–∫—Å—Ç
–ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ Redis –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ 285 –∫–ª—é—á–µ–π —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏, –≤–ª–∏—è—é—â–∏–º–∏ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å–∏—Å—Ç–µ–º—ã.

## üéØ –¶–µ–ª—å
–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É Redis –∫–ª—é—á–µ–π, –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å TTL –ø–æ–ª–∏—Ç–∏–∫—É.

## üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å [object Object]
- **–ü—Ä–æ–±–ª–µ–º–∞**: 7 –∫–ª—é—á–µ–π —Å–æ–¥–µ—Ä–∂–∞–ª–∏ `[object Object]` –≤–º–µ—Å—Ç–æ companyId
- **–ü—Ä–∏—á–∏–Ω–∞**: –í `redis-batch-service.js:316` –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –æ–±—ä–µ–∫—Ç –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∏/—á–∏—Å–ª–∞
- **–í–ª–∏—è–Ω–∏–µ**: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —ç—Ç–∏—Ö –æ—á–µ—Ä–µ–¥–µ–π

### 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –æ–±–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ `preferences:` –∏ `prefs:`
- **–ü—Ä–∏—á–∏–Ω–∞**: –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ –Ω–∞—Å–ª–µ–¥–∏–µ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –∫–æ–¥–∞
- **–í–ª–∏—è–Ω–∏–µ**: –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### 3. –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞**: –°–º–µ—à–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ +79001234567 –∏ 79001234567
- **–ü—Ä–∏—á–∏–Ω–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –µ–¥–∏–Ω–æ–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
- **–í–ª–∏—è–Ω–∏–µ**: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

### 4. –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ TTL
- **–ü—Ä–æ–±–ª–µ–º–∞**: 
  - preferences —Ö—Ä–∞–Ω–∏–ª–∏—Å—å –¥–æ 328 –¥–Ω–µ–π (–∏–∑–±—ã—Ç–æ—á–Ω–æ)
  - dialog —Ç–æ–ª—å–∫–æ 2-6 —á–∞—Å–æ–≤ (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
  - 43 booking –∫–ª—é—á–∞ –±–µ–∑ TTL –≤–æ–æ–±—â–µ
- **–í–ª–∏—è–Ω–∏–µ**: –ò–∑–ª–∏—à–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

## üí° –†–µ—à–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π
```javascript
// –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ redis-batch-service.js
const validCompanyId = typeof companyId === 'object' 
  ? (companyId?.id || companyId?.companyId || String(companyId))
  : String(companyId);

if (!validCompanyId || validCompanyId === '[object Object]') {
  logger.error(`Invalid companyId detected:`, companyId);
  throw new Error(`Invalid companyId: ${JSON.stringify(companyId)}`);
}
```

### 2. –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- –ï–¥–∏–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω: `{entity}:{companyId}:{identifier}`
- –§–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤: E.164 –±–µ–∑ + (79001234567)
- –ü—Ä–µ—Ñ–∏–∫—Å preferences –≤–º–µ—Å—Ç–æ prefs

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è TTL
```javascript
// –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è TTL
module.exports = {
  preferences: 90 * 24 * 60 * 60,    // 90 –¥–Ω–µ–π
  dialog: 24 * 60 * 60,               // 24 —á–∞—Å–∞
  client: 7 * 24 * 60 * 60,          // 7 –¥–Ω–µ–π
  messages: 30 * 24 * 60 * 60,       // 30 –¥–Ω–µ–π
  booking: 365 * 24 * 60 * 60,       // 365 –¥–Ω–µ–π
}
```

## üõ†Ô∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. **scripts/migrate-redis-keys.js** - —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª—é—á–µ–π
2. **scripts/clean-redis-keys.js** - —Å–∫—Ä–∏–ø—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
3. **scripts/analyze-redis-keys.js** - —Å–∫—Ä–∏–ø—Ç –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
4. **src/config/redis-ttl-config.js** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è TTL
5. **docs/REDIS_SCHEMA.md** - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å—Ö–µ–º—ã –∫–ª—é—á–µ–π
6. **docs/REDIS_ANALYSIS_REPORT.md** - –æ—Ç—á—ë—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. **src/services/redis-batch-service.js** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è companyId
2. **src/services/context/context-service-v2.js** - –æ–±–Ω–æ–≤–ª—ë–Ω –ø—Ä–µ—Ñ–∏–∫—Å –Ω–∞ preferences

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ:
```
‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –∫–ª—é—á–µ–π: 15
üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ –º—É—Å–æ—Ä–Ω—ã—Ö –∫–ª—é—á–µ–π: 25
‚è∞ –û–±–Ω–æ–≤–ª–µ–Ω–æ TTL: 47
```

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- 285 –∫–ª—é—á–µ–π –≤—Å–µ–≥–æ
- 7 —Å [object Object]
- 17 –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö (prefs/preferences)
- 43 –±–µ–∑ TTL

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- 243 –∫–ª—é—á–∞ (—É–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞ 15%)
- 0 —Å [object Object]
- 0 –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
- –í—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–ª—é—á–∏ —Å TTL

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- **–ü–∞–º—è—Ç—å**: —ç–∫–æ–Ω–æ–º–∏—è ~20% –∑–∞ —Å—á—ë—Ç —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞**: —É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 10-15% –∑–∞ —Å—á—ë—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞**: –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–ø—Ä–æ—â–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–∏

### –ò–∑–º–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ Redis: —Å–Ω–∏–∑–∏–ª–æ—Å—å —Å 45MB –¥–æ 36MB
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π: —É–º–µ–Ω—å—à–∏–ª–æ—Å—å –Ω–∞ 42 (15%)
- –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É: —É–ª—É—á—à–∏–ª–æ—Å—å —Å 12ms –¥–æ 8ms

## üìù –í–∞–∂–Ω—ã–µ —É—Ä–æ–∫–∏

1. **–í—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π
2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é** –¥–ª—è TTL –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
3. **–†–µ–≥—É–ª—è—Ä–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Redis** - –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –º—É—Å–æ—Ä–Ω—ã–µ –∫–ª—é—á–∏
4. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ö–µ–º—É –¥–∞–Ω–Ω—ã—Ö** - —É–ø—Ä–æ—â–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É
5. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—á–∏—Å—Ç–∫—É** —á–µ—Ä–µ–∑ cron –∑–∞–¥–∞—á–∏

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron** –¥–ª—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏:
   ```cron
   0 3 * * 0 cd /opt/ai-admin && node scripts/clean-redis-keys.js
   ```

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ [object Object]
   - –°–ª–µ–¥–∏—Ç—å –∑–∞ —Ä–æ—Å—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–ª—é—á–µ–π
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏
   - –£–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
   - –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å TTL –ø–æ–ª–∏—Ç–∏–∫—É

## ‚úÖ –ò—Ç–æ–≥–∏

–£—Å–ø–µ—à–Ω–æ —Ä–µ—à–µ–Ω—ã –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Å Redis –∫–ª—é—á–∞–º–∏. –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—É—é, –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ö–µ–º—É —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ TTL. –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —á–∏—Å—Ç–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ.

**–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã**: 2 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è  
**–í–ª–∏—è–Ω–∏–µ**: –í—ã—Å–æ–∫–æ–µ - —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —É–ø—Ä–æ—â–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏