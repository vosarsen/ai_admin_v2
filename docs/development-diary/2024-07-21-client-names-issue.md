# 21 июля 2025 - Исследование проблемы с именами клиентов в YClients

## Проблема

Клиент сообщил, что при создании записи через WhatsApp бота в интерфейсе YClients отображается "Клиент" вместо реального имени, хотя он представился.

### Пример:
```
Клиент: запиши меня к сергею сегодня на 8 вечера
Клиент: меня зовут Андрей
Бот: ✅ Запись создана! Номер записи: 1196999691

В YClients отображается: "Клиент" вместо "Андрей"
```

## Исследование

### 1. Анализ кода

Проверили логику извлечения имени в `command-handler.js`:
- Метод `extractNameFromMessage` корректно извлекает имя из сообщения
- Поддерживает паттерны: "меня зовут X", "я - X", "это X"
- Имя сохраняется в Redis для будущего использования

### 2. Анализ логов

Из логов видно, что система работает правильно:
```
Using name from current message: {"name":"Андрей","phone":"79936363848"}
fullBookingData: {"phone":"79936363848","fullname":"Андрей","email":"","comment":"Запись через AI администратора WhatsApp",...}
```

### 3. Проблема с правами доступа

Обнаружены ошибки 403 при работе с YClients API:
- `POST company/962302/clients/search` - "Нет прав на управление компанией"
- `POST clients/962302` - "Нет прав на управление филиалом с идентификатором 962302"

При этом создание записи работает успешно:
- `POST book_record/962302` - 201 Created

## Выводы

1. **Код AI Admin v2 работает корректно** - имя извлекается и передается в API
2. **Проблема в правах доступа YClients API** - нет прав на управление клиентами
3. **YClients создает запись, но не может связать её с клиентом** из-за отсутствия прав

## Решение

Необходимо обратиться к администратору YClients для добавления прав на:
- Просмотр клиентов компании
- Создание новых клиентов

## Тестирование

Создан тестовый скрипт `test-random-booking.js` для проверки с рандомными номерами:
```javascript
// Генерирует случайный номер и имя
const randomPhone = '7900' + Math.floor(Math.random() * 9000000 + 1000000);
const randomName = ['Василий', 'Петр', 'Николай', 'Александр', 'Дмитрий'][Math.floor(Math.random() * 5)];
```

Тест подтвердил, что имя правильно передается в API.

## Документация

Добавлена информация в `TASK.md` как Known Issue #5 с описанием проблемы и указанием, что код работает корректно.