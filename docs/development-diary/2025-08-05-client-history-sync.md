# Development Diary: Синхронизация истории клиентов из YClients

**Дата**: 5 августа 2025
**Автор**: AI Assistant
**Задача**: Создать систему синхронизации полной истории визитов клиентов из YClients в Supabase

## Контекст

Пользователь обратил внимание, что база данных содержит много полезной информации о клиентах, которая не используется. Особенно важна история визитов для персонализации обслуживания. Нужно было создать систему для выгрузки всей истории из YClients.

## Что было сделано

### 1. Анализ структуры БД
- Изучена полная структура таблиц в Supabase
- Выявлены неиспользуемые поля: `visit_history`, `last_services`, `preferences`, `loyalty_level`
- Определен потенциал для персонализации

### 2. Исследование YClients API
- Протестирован endpoint `/clients/visits/search` - не вернул данные
- Успешно использован `/records/{company_id}` с фильтрацией по client_id
- Требуется заголовок `Accept: application/vnd.api.v2+json`

### 3. Создание модулей синхронизации
- `ClientVisitsSync` - первая попытка через `/clients/visits/search` (не работает)
- `ClientRecordsSync` - рабочий вариант через `/records` endpoint
- Интеграция в `UniversalYclientsSync`

### 4. Конфигурация и лимиты
- Создан `sync-config.js` для централизованных настроек
- Добавлены лимиты для предотвращения превышения API квот
- Поддержка фильтрации по дате и количеству визитов

### 5. Инструменты и скрипты
- `test-client-records-sync.js` - для тестирования одного клиента
- `sync-all-visits.js` - для массовой синхронизации с dry-run режимом

## Технические детали

### Успешный API запрос
```javascript
const response = await axios.get(
  `https://api.yclients.com/api/v1/records/962302?start_date=2023-08-05&end_date=2025-08-05&client_id=207712323`,
  {
    headers: {
      'Authorization': `Bearer ${TOKEN}, User ${USER_TOKEN}`,
      'Accept': 'application/vnd.api.v2+json'
    }
  }
);
```

### Структура сохраняемых данных
```javascript
{
  visit_count: 5,
  visit_history: [
    {
      date: "2024-05-10",
      services: ["СТРИЖКА + МОДЕЛИРОВАНИЕ БОРОДЫ"],
      staff: "Али",
      cost: 2500,
      status: "attended"
    }
  ],
  last_services: ["СТРИЖКА + МОДЕЛИРОВАНИЕ БОРОДЫ", "МУЖСКАЯ СТРИЖКА"],
  total_spent: 9501,
  average_bill: 1900,
  loyalty_level: "Silver"
}
```

## Проблемы и решения

### Проблема 1: API endpoint не возвращал данные
- **Причина**: `/clients/visits/search` требует специальные права или другой формат
- **Решение**: Использовать `/records` с фильтрацией

### Проблема 2: Ошибка "укажите заголовок Accept"
- **Причина**: YClients API v2 требует специальный Accept header
- **Решение**: Добавлен `Accept: application/vnd.api.v2+json`

### Проблема 3: Превышение API лимитов
- **Причина**: 1000+ клиентов могут превысить квоты
- **Решение**: Добавлены настройки MAX_VISITS_SYNC_PER_RUN и задержки

## Результаты

1. **Успешная синхронизация** истории для клиента Арсен (5 визитов)
2. **Статистика БД**: 1000 клиентов с визитами, ~2863 визита всего
3. **Время синхронизации**: ~0.5 сек на клиента
4. **API нагрузка**: 1 запрос на клиента + задержка 300мс

## Уроки и выводы

1. **YClients API документация** не всегда точная - нужно тестировать разные endpoints
2. **Accept header критичен** для v2 API endpoints
3. **Rate limiting важен** - без задержек можно получить бан
4. **Инкрементальная синхронизация** лучше полной - меньше нагрузка
5. **Dry-run режим** обязателен для массовых операций

## Следующие шаги

1. Запустить полную синхронизацию для всех 1000 клиентов
2. Настроить автоматическую синхронизацию в SyncManager
3. Использовать данные истории для персонализации в AI
4. Добавить метрики синхронизации в Prometheus

## Код для воспроизведения

```bash
# Синхронизация одного клиента
node scripts/test-client-records-sync.js +79686484488

# Проверка статистики
node scripts/sync-all-visits.js --dry-run

# Синхронизация первых 100 клиентов
SYNC_CLIENT_VISITS=true MAX_VISITS_SYNC_PER_RUN=100 node scripts/universal-yclients-sync.js clients
```