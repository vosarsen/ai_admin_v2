# –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –º–∞—Å—Ç–µ—Ä–æ–≤

**–î–∞—Ç–∞:** 2025-10-23
**–ê–≤—Ç–æ—Ä:** Claude Code
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –∑–∞–¥–µ–ø–ª–æ–µ–Ω–æ

## –ü—Ä–æ–±–ª–µ–º–∞

### –ò—Å—Ö–æ–¥–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –º–∞—Å—Ç–µ—Ä–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ —Ç–æ–ª—å–∫–æ **1 —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏** (–≤ 05:00).

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–µ–π—Å (—Å–∞–ª–æ–Ω Kultura)
–°–µ–≥–æ–¥–Ω—è –≤ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω–æ–º —Å–∞–ª–æ–Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Å–∏—Ç—É–∞—Ü–∏—è:
- –û–¥–∏–Ω –º–∞—Å—Ç–µ—Ä –∑–∞–±–æ–ª–µ–ª –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è
- –ï–≥–æ —Å–º–µ–Ω—É –∑–∞–∫—Ä—ã–ª–∏
- –î—Ä—É–≥–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ –≤—ã–∑–≤–∞–ª–∏ –Ω–∞ –∑–∞–º–µ–Ω—É
- –°–º–µ–Ω—É –º–∞—Å—Ç–µ—Ä–∞-–∑–∞–º–µ–Ω—ã –æ—Ç–∫—Ä—ã–ª–∏ —Å –º–æ–º–µ–Ω—Ç–∞, –∫–æ–≥–¥–∞ –ø–µ—Ä–≤—ã–π —É—à—ë–ª –¥–æ–º–æ–π

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ë–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–ª –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Å–ª–æ—Ç—ã –∑–∞–±–æ–ª–µ–≤—à–µ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ ‚ùå
- –ë–æ—Ç –Ω–µ –≤–∏–¥–µ–ª –Ω–æ–≤—ã–µ —Å–ª–æ—Ç—ã –º–∞—Å—Ç–µ—Ä–∞-–∑–∞–º–µ–Ω—ã ‚ùå
- –ö–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞–ª–∏ –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–æ 05:00 —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è ‚ùå

### –ê–Ω–∞–ª–∏–∑ –∑–∞—Ç—Ä–∞—Ç

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–∞—Å—Ç–∞—è –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–∫–∞–∂–¥—ã–µ 15 –º–∏–Ω)
```
API –∑–∞–ø—Ä–æ—Å—ã: 11 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 96 —Ä–∞–∑/—Å—É—Ç–∫–∏ = 1056 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å—É—Ç–∫–∏
–ü—Ä–æ–±–ª–µ–º—ã:
- 95x –±–æ–ª—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ YClients API (—Ä–∏—Å–∫ ban)
- 95% –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–ø—É—Å—Ç—É—é (—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–¥–∫–æ –º–µ–Ω—è–µ—Ç—Å—è)
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–≤—ã–±—Ä–∞–Ω)
```
FULL (–Ω–æ—á—å—é): 11 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 1 —Ä–∞–∑ = 11 –∑–∞–ø—Ä–æ—Å–æ–≤
TODAY-ONLY (–¥–Ω—ë–º): 11 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 16 —Ä–∞–∑ = 176 –∑–∞–ø—Ä–æ—Å–æ–≤
–ò–¢–û–ì–û: 187 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å—É—Ç–∫–∏ (vs 1056 –ø—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç–µ 1)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ API-—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: **15x —ç–∫–æ–Ω–æ–º–∏—è** vs —á–∞—Å—Ç–æ–π –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å: max **1 —á–∞—Å –∑–∞–¥–µ—Ä–∂–∫–∞** (vs 24 —á–∞—Å–∞)
- ‚úÖ –í –ø—Ä–µ–¥–µ–ª–∞—Ö API –ª–∏–º–∏—Ç–æ–≤ YClients (160 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É)

## –†–µ—à–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ **–≥–∏–±—Ä–∏–¥–Ω–∞—è –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**:

### 1. FULL (–ü–æ–ª–Ω–∞—è) - –Ω–æ—á—å—é –≤ 05:00
```javascript
Cron: '0 5 * * *'
–ü–µ—Ä–∏–æ–¥: 30 –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥
API –∑–∞–ø—Ä–æ—Å–æ–≤: ~11 (1 staff list + 10 –º–∞—Å—Ç–µ—Ä–æ–≤)
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
```

### 2. TODAY-ONLY (–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è) - –∫–∞–∂–¥—ã–π —á–∞—Å —Å 8:00 –¥–æ 23:00
```javascript
Cron: '0 8-23 * * *'
–ü–µ—Ä–∏–æ–¥: 2 –¥–Ω—è (—Å–µ–≥–æ–¥–Ω—è + –∑–∞–≤—Ç—Ä–∞)
API –∑–∞–ø—Ä–æ—Å–æ–≤: ~11 (1 staff list + 10 –º–∞—Å—Ç–µ—Ä–æ–≤)
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è
```

### 3. Manual API (–≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è)
```bash
# –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (30 –¥–Ω–µ–π)
POST /api/sync/schedules

# –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è (—Å–µ–≥–æ–¥–Ω—è+–∑–∞–≤—Ç—Ä–∞)
POST /api/sync/schedules/today
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

#### 1. `src/sync/schedules-sync.js`
```javascript
// –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä daysAhead –≤ fetchStaffSchedule()
async fetchStaffSchedule(staffId, daysAhead = 30) {
  // ...
  endDate.setDate(endDate.getDate() + daysAhead);
}

// –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
async syncTodayOnly() {
  logger.info('üîÑ Starting TODAY-ONLY schedules synchronization...');
  const result = await this.syncAllSchedulesToday(staff);
  return { success: true, ...result, mode: 'today-only' };
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è+–∑–∞–≤—Ç—Ä–∞
async syncAllSchedulesToday(staff) {
  const schedules = await this.fetchStaffSchedule(staffMember.id, 2); // 2 –¥–Ω—è
  // ...
}
```

#### 2. `src/sync/sync-manager.js`
```javascript
// –û–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
this.schedule = {
  schedules: '0 5 * * *',         // FULL: 05:00 –Ω–æ—á—å—é
  schedulesToday: '0 8-23 * * *', // TODAY-ONLY: –∫–∞–∂–¥—ã–π —á–∞—Å 8-23
  // ...
}

// –ù–æ–≤—ã–π –º–µ—Ç–æ–¥
async syncSchedulesToday() {
  logger.info('üîÑ Syncing schedules (TODAY-ONLY - today+tomorrow)...');
  return await this.modules.schedules.syncTodayOnly();
}

// –î–≤–∞ cron job
cron.schedule(this.schedule.schedules, async () => {
  logger.info('‚è∞ Running scheduled FULL schedules sync (30 days)...');
  await this.syncSchedules();
});

cron.schedule(this.schedule.schedulesToday, async () => {
  logger.info('üîÑ Running scheduled TODAY-ONLY schedules sync (today+tomorrow)...');
  await this.syncSchedulesToday();
});
```

#### 3. `src/config/sync-config.js`
```javascript
SCHEDULE: {
  'SCHEDULES': '0 5 * * *',              // –ü–æ–ª–Ω–∞—è (30 –¥–Ω–µ–π)
  'SCHEDULES_TODAY': '0 8-23 * * *',     // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è (—Å–µ–≥–æ–¥–Ω—è+–∑–∞–≤—Ç—Ä–∞)
  // ...
}
```

#### 4. `src/api/index.js`
```javascript
// FULL sync endpoint
app.post('/api/sync/schedules', rateLimiter, validateApiKey, async (req, res) => {
  const result = await syncManager.syncSchedules();
  res.json({
    success: true,
    message: 'Full schedule sync initiated (30 days)'
  });
});

// TODAY-ONLY sync endpoint
app.post('/api/sync/schedules/today', rateLimiter, validateApiKey, async (req, res) => {
  const result = await syncManager.syncSchedulesToday();
  res.json({
    success: true,
    message: 'Today-only schedule sync initiated (today+tomorrow)'
  });
});
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: TODAY-ONLY sync
```bash
ssh root@46.149.70.219 "curl -X POST http://localhost:3000/api/sync/schedules/today"

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "success": true,
  "message": "Today-only schedule sync initiated (today+tomorrow)",
  "result": {
    "success": true,
    "processed": 13,
    "errors": 0,
    "total": 13,
    "duration": 3007,  # 3 —Å–µ–∫—É–Ω–¥—ã
    "mode": "today-only"
  }
}
```

### –¢–µ—Å—Ç 2: FULL sync
```bash
ssh root@46.149.70.219 "curl -X POST http://localhost:3000/api/sync/schedules"

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "success": true,
  "message": "Full schedule sync initiated (30 days)",
  "result": {
    "success": true,
    "processed": 13,
    "errors": 0,
    "total": 13,
    "duration": 2108  # 2.1 —Å–µ–∫—É–Ω–¥—ã
  }
}
```

## –ú–µ—Ç—Ä–∏–∫–∏

### API –Ω–∞–≥—Ä—É–∑–∫–∞
| –¢–∏–ø | –ß–∞—Å—Ç–æ—Ç–∞ | –ó–∞–ø—Ä–æ—Å–æ–≤ | –ò—Ç–æ–≥–æ/—Å—É—Ç–∫–∏ |
|-----|---------|----------|-------------|
| **–ë—ã–ª–æ** | 1 —Ä–∞–∑/—Å—É—Ç–∫–∏ | 11 | 11 |
| **FULL** | 1 —Ä–∞–∑/—Å—É—Ç–∫–∏ (05:00) | 11 | 11 |
| **TODAY-ONLY** | –ö–∞–∂–¥—ã–π —á–∞—Å (8-23) | 11 | 176 |
| **–ò–¢–û–ì–û** | - | - | **187** |

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **TODAY-ONLY**: 13 –∑–∞–ø–∏—Å–µ–π –∑–∞ 3 —Å–µ–∫—É–Ω–¥—ã
- **FULL**: 13 –∑–∞–ø–∏—Å–µ–π –∑–∞ 2.1 —Å–µ–∫—É–Ω–¥—ã
- **–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å**: max 1 —á–∞—Å –∑–∞–¥–µ—Ä–∂–∫–∞ (vs 24 —á–∞—Å–∞ —Ä–∞–Ω–µ–µ)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- YClients API –ª–∏–º–∏—Ç: 160 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- –ù–∞—à–∞ –Ω–∞–≥—Ä—É–∑–∫–∞: max ~11 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å = 0.003 –∑–∞–ø—Ä–æ—Å–∞/—Å–µ–∫
- **–ó–∞–ø–∞—Å:** 53,000x –æ—Ç –ª–∏–º–∏—Ç–∞ üéØ

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ
‚úÖ **–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:** max 1 —á–∞—Å –∑–∞–¥–µ—Ä–∂–∫–∞ –≤–º–µ—Å—Ç–æ 24 —á–∞—Å–æ–≤
‚úÖ **API-—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** 15x —ç–∫–æ–Ω–æ–º–∏—è vs —á–∞—Å—Ç–æ–π –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å:** —Ä—É—á–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
‚úÖ **Production-ready:** –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç API –ª–∏–º–∏—Ç—ã
‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:** –æ–±–∞ —Ç–∏–ø–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –ö–µ–π—Å Kultura - —Ä–µ—à—ë–Ω
–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è:
1. –°–∞–ª–æ–Ω –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Ä—É—á–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é: `POST /api/sync/schedules/today`
2. –ò–ª–∏ –ø–æ–¥–æ–∂–¥–∞—Ç—å max 1 —á–∞—Å –¥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
3. –ë–æ—Ç –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–æ–≤

## –ö–æ–º–º–∏—Ç
```
feat: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≥–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –º–∞—Å—Ç–µ—Ä–æ–≤

Commit: 36121be
Branch: feature/redis-context-cache
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)
1. **Webhook –æ—Ç YClients** (–µ—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è API)
   - Event-driven —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞
   - –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

2. **Smart-–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis**
   - –ö–µ—à —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π —Å TTL 1 —á–∞—Å
   - –£–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Supabase

3. **Telegram-–∫–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä—É—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**
   ```
   /sync_schedules_today - —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ —Å–∞–ª–æ–Ω–∞
   ```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–¥–µ–ø–ª–æ–µ–Ω–æ –≤ production
**–î–∞—Ç–∞ –¥–µ–ø–ª–æ—è:** 2025-10-23 12:52 MSK
