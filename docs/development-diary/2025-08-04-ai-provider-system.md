# Development Diary: AI Provider System
**Date**: August 4, 2025  
**Feature**: Унифицированная система AI провайдеров и промптов

## Контекст
Пользователь столкнулся с проблемами интеграции Qwen:
1. Сложная система обёрток через `index-qwen-simple.js`
2. Qwen не выполнял команды SEARCH_SLOTS для составных запросов
3. В ответах появлялся символ "|"
4. Не было возможности удобно тестировать разные промпты

## Что было сделано

### 1. Создана фабрика AI провайдеров
**Файл**: `src/services/ai/provider-factory.js`

Единая точка управления AI провайдерами:
- Поддержка DeepSeek, Qwen Plus, Qwen 72B
- Кэширование провайдеров
- Унифицированный интерфейс `call(prompt, options)`

### 2. Система управления промптами
**Файл**: `src/services/ai-admin-v2/prompt-manager.js`

Функциональность:
- Загрузка промптов из директории `prompts/`
- A/B тестирование
- Сбор статистики (успешность, время ответа, количество команд)
- API для переключения промптов

### 3. Три версии промптов

1. **base-prompt.js** - минималистичный базовый промпт
2. **enhanced-prompt.js** - с примерами диалогов (рекомендуется для DeepSeek)
3. **strict-prompt.js** - строгий формат для Qwen с чёткими шаблонами

### 4. API для управления
**Файл**: `src/api/routes/ai-management.js`

Endpoints:
- `/api/ai/providers` - управление провайдерами
- `/api/ai/prompts` - управление промптами
- `/api/ai/prompts/stats` - статистика использования
- `/api/ai/prompts/test` - тестирование промптов

### 5. Удобные скрипты

- `scripts/switch-ai-provider.js` - переключение между провайдерами
- `scripts/manage-prompts.js` - управление промптами и A/B тестами

## Технические детали

### Интеграция в AI Admin v2
```javascript
// Старый подход
if (USE_QWEN) {
  require('./index-qwen-simple.js'); // обёртка
}

// Новый подход
const provider = await providerFactory.getProvider();
const result = await provider.call(prompt, options);
```

### Формат промпта
```javascript
module.exports = {
  version: '1.0',
  name: 'prompt-name',
  getPrompt: (context) => {
    // context содержит businessInfo, services, staff, userInfo
    return `Промпт с плейсхолдером {message}`;
  }
};
```

## Проблемы и решения

### Проблема 1: Qwen не выполнял команды
**Причина**: Qwen плохо понимал сложный формат команд в длинном промпте  
**Решение**: Создан `strict-prompt` с минималистичным форматом и чёткими примерами

### Проблема 2: Символ "|" в ответах
**Причина**: Qwen добавлял этот символ как разделитель  
**Решение**: Глобальная замена "|" на ". " в методе processAIResponse

### Проблема 3: Сложность переключения между моделями
**Причина**: Жёстко зашитая логика через USE_QWEN  
**Решение**: Provider Factory с динамическим выбором через AI_PROVIDER

## Результаты

1. **Упрощение кода**: Убраны сложные обёртки, единый интерфейс для всех провайдеров
2. **Гибкость**: Можно добавлять новые AI модели без изменения основного кода
3. **Мониторинг**: Автоматический сбор статистики по каждому промпту
4. **A/B тестирование**: Возможность сравнивать эффективность разных промптов

## Дальнейшие улучшения

1. **Автоматический fallback**: Если Qwen не справляется, автоматически переключаться на DeepSeek
2. **Динамический выбор модели**: Использовать Qwen Plus для простых запросов, 72B для сложных
3. **Персонализация промптов**: Разные промпты для разных типов бизнеса
4. **ML-оптимизация**: Использовать собранную статистику для автоматического выбора лучшего промпта

## Команды для тестирования

```bash
# Переключиться на Qwen со строгим промптом
AI_PROVIDER=qwen AI_PROMPT_VERSION=strict-prompt node src/workers/index-v2.js

# Включить A/B тестирование
AI_PROMPT_AB_TEST=true node src/workers/index-v2.js

# Посмотреть статистику
node scripts/manage-prompts.js list
```

## Важные файлы

- `src/services/ai/provider-factory.js` - фабрика провайдеров
- `src/services/ai-admin-v2/prompt-manager.js` - менеджер промптов
- `src/services/ai-admin-v2/prompts/` - директория с промптами
- `docs/ai-provider-system.md` - документация системы