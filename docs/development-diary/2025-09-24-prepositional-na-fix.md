# Исправление системы склонений: prepositional_na

**Дата**: 24 сентября 2025
**Автор**: AI Admin Development Team
**Проблема**: Неправильные падежи в напоминаниях WhatsApp

## Описание проблемы

Пользователь получил напоминание с грамматической ошибкой:
```
"Здравствуйте, Никита! Напоминаем, что ожидаем Вас на мужской стрижке в 20:00"
```

Правильно должно быть:
```
"Здравствуйте, Никита! Напоминаем, что ожидаем Вас на мужскую стрижку в 20:00"
```

## Анализ причины

### 1. Неправильные данные в базе

Проверка показала, что в таблице `services` поле `declensions->>'prepositional_na'` содержало предложный падеж вместо винительного:

```json
{
  "prepositional": "мужской стрижке",    // Предложный (о чём?)
  "prepositional_na": "мужской стрижке"  // ❌ Должен быть винительный!
}
```

### 2. Неправильные инструкции для AI

В файлах генерации склонений (`service-declension.js`) промпт для AI содержал неверное описание:

```javascript
// БЫЛО:
"prepositional_na": "предложный падеж с предлогом НА (на ком? на чём?)"

// СТАЛО:
"prepositional_na": "винительный падеж для предлога НА (на что? на кого?)"
```

## Логика системы склонений

### Зачем нужно поле prepositional_na?

В русском языке предлог "на" может требовать разные падежи в зависимости от контекста:

1. **Винительный падеж** (направление действия):
   - "Записаться НА стрижку"
   - "Ожидаем вас НА стрижку"
   - "Приглашаем НА процедуру"

2. **Предложный падеж** (местонахождение):
   - "Находиться НА стрижке"
   - "Быть НА процедуре"

В контексте напоминаний о записи всегда используется **винительный падеж**, поэтому:
- `prepositional_na` = копия поля `accusative`
- Это специальное поле для удобства шаблонизатора

## Решение

### 1. Скрипт исправления данных

Создан `scripts/fix-prepositional-na.js`:

```javascript
// Проверяем все услуги
if (service.declensions.prepositional_na === service.declensions.prepositional) {
    // Заменяем на винительный падеж
    service.declensions.prepositional_na = service.declensions.accusative;
}
```

**Результат**: Исправлено 52 услуги локально и 27 на сервере.

### 2. Исправление генерации для новых услуг

Обновлены файлы:
- `src/services/declension/service-declension.js`
- `scripts/generate-declensions-for-existing.js`

**Изменения в промптах**:
```javascript
// Правильные примеры для AI:
"Мужская стрижка" ->
  accusative: "мужскую стрижку",
  prepositional_na: "мужскую стрижку"  // Оба винительный падеж!
```

### 3. Обновление шаблонов

Файл `src/services/reminder/templates.js` уже корректно использует склонения:

```javascript
// "на {service}" - заменяется на prepositional_na
result.replace(/на {service}/g,
  `на ${data.serviceDeclensions.prepositional_na}`);
```

## Тестирование

### До исправления
```
SELECT title, declensions->>'prepositional_na'
FROM services
WHERE title = 'МУЖСКАЯ СТРИЖКА';

-- Результат: "мужской стрижке"
```

### После исправления
```
-- Результат: "мужскую стрижку"
```

### Проверка сообщения
```
Здравствуйте, Никита! Напоминаем, что ожидаем Вас на мужскую стрижку в 20:00 ✅
```

## Файлы изменены

1. `/scripts/fix-prepositional-na.js` - новый скрипт исправления
2. `/src/services/declension/service-declension.js` - исправлен промпт
3. `/scripts/generate-declensions-for-existing.js` - исправлен промпт
4. `/docs/DECLENSION_SYSTEM.md` - новая документация
5. `/docs/development-diary/2025-09-24-prepositional-na-fix.md` - эта запись

## Команды деплоя

```bash
# Локально
node scripts/fix-prepositional-na.js

# На сервере
ssh root@46.149.70.219 "cd /opt/ai-admin && git pull"
ssh root@46.149.70.219 "cd /opt/ai-admin && node scripts/fix-prepositional-na.js"
ssh root@46.149.70.219 "pm2 restart ai-admin-booking-monitor"
```

## Уроки и выводы

1. **Важность примеров в промптах**: AI генерирует на основе примеров, поэтому они должны быть правильными
2. **Специализированные поля**: `prepositional_na` - не избыточность, а необходимость для правильной грамматики
3. **Тестирование на реальных данных**: Ошибка обнаружена благодаря скриншоту от пользователя
4. **Документирование особенностей**: Теперь есть четкое объяснение, почему `prepositional_na` != `prepositional`

## Влияние на систему

- ✅ Исправлены все существующие услуги
- ✅ Новые услуги будут генерироваться правильно
- ✅ Сообщения грамматически корректны
- ✅ Система готова к масштабированию на новые компании

## Статус

**ЗАВЕРШЕНО** - Система склонений работает корректно, все услуги исправлены, документация обновлена.