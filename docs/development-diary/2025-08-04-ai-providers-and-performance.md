# Development Diary: AI Providers and Performance Improvements

**Date**: August 4, 2025  
**Developer**: Claude AI Assistant with Arsen

## Context

Пользователь пожаловался, что бот неправильно отвечает на вопросы о свободном времени. Вместо использования команд для проверки реального расписания, AI просто выдумывал время "с 10:00 до 22:00".

## What Was Done

### 1. Исследование проблемы
- Проверили логи через @logs MCP server
- Обнаружили, что AI (Qwen Plus) не генерирует команды
- Массив "Extracted commands" был пустой

### 2. Попытка перехода на Qwen
- Добавили поддержку моделей Qwen (Plus, Max, Turbo)
- Настроили DASHSCOPE_API_KEY
- Попытались использовать несуществующую модель qwen3-30b-a3b-instruct-2507
- Получили ошибку 401 (неверный API ключ)

### 3. Решение остаться на DeepSeek
- После сравнения провайдеров решили остаться на DeepSeek
- DeepSeek дешевле и уже проверен в production
- Правильно генерирует команды

### 4. Улучшения кода
- Добавлен метод `applyBusinessTypeFormatting` в formatter.js
- Создан модуль `performance-metrics.js` для мониторинга
- LRU кэш вынесен в отдельный модуль с unit тестами
- Документирован API команд в COMMANDS_API.md
- Создана документация AI провайдеров

## Technical Details

### Поддерживаемые AI провайдеры:
1. **DeepSeek** (основной)
   - Модель: deepseek-chat
   - Цена: $0.14/1M input, $0.28/1M output
   - Время ответа: 5-9 секунд

2. **Qwen Plus**
   - Модель: qwen-plus
   - Сбалансированная производительность
   - Время ответа: 2-5 секунд

3. **Qwen Max**
   - Модель: qwen-max
   - Самая мощная для сложных задач
   - Время ответа: 3-6 секунд

4. **Qwen Turbo**
   - Модель: qwen-turbo
   - Самая быстрая
   - Время ответа: 1-3 секунды

### Система промптов:
- `base-prompt` - минимальный
- `enhanced-prompt` - с примерами
- `strict-prompt` - строгий формат
- `detailed-prompt` - полный (используется по умолчанию)

### Метрики производительности:
- Время ответа с процентилями (p95, p99)
- Статистика по командам
- Hit rate кэша
- Ошибки по провайдерам

## Problems & Solutions

**Проблема**: AI не генерирует команды  
**Решение**: Использовать detailed-prompt с DeepSeek

**Проблема**: Qwen требует другой API ключ  
**Решение**: Документировали процесс настройки, но остались на DeepSeek

**Проблема**: Несуществующие модели Qwen  
**Решение**: Удалили несуществующие модели, оставили только официальные

## Lessons Learned

1. **Не всегда нужно переключаться на новое** - DeepSeek работает хорошо и дешевле
2. **Важно проверять документацию API** - мы пытались использовать несуществующую модель
3. **Модульная архитектура окупается** - легко добавили поддержку новых провайдеров
4. **Метрики важны** - помогают понять реальную производительность

## Future Improvements

1. A/B тестирование промптов в production
2. Автоматический fallback при ошибках провайдера
3. Дашборд для мониторинга метрик
4. Оптимизация промптов для уменьшения токенов

## Code Quality

После всех изменений:
- ✅ Все критические ошибки исправлены
- ✅ Добавлена защита от DoS атак
- ✅ Оптимизирована производительность (LRU кэш, алгоритмы O(n log n))
- ✅ Полная документация
- ✅ Unit тесты для критических компонентов