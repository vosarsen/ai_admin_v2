# Redis Batching Fix - 23 июля 2025

## Контекст
После реализации Redis-based батчинга для решения проблемы rapid-fire protection, обнаружилась критическая проблема: батчи исчезали через 0.5-11 секунд вместо запланированных 60 секунд.

## Что было сделано

### 1. Исследование проблемы
- Создал серию тестов для отслеживания жизненного цикла Redis ключей
- Обнаружил, что ключи с префиксом `rapid-fire:` удаляются преждевременно
- Выяснил, что batch processor работает каждую секунду

### 2. Найдена коренная причина
В методе `shouldProcessBatch` была логика, которая обрабатывала батчи немедленно, если отсутствовал ключ `lastMessageTime`:
```javascript
if (!lastMessageTime) {
  const exists = await this.redis.exists(batchKey);
  return exists > 0; // Обрабатываем только если батч существует
}
```

Это приводило к race condition: между проверками ключ `lastMessageTime` мог истечь или не быть создан.

### 3. Решение
- Изменил логику: батчи без `lastMessageTime` теперь НЕ обрабатываются
- Убрал автоматическое удаление пустых батчей (предотвращение race conditions)

## Технические детали

### Тесты
1. `test-redis-mystery.js` - мониторинг удаления ключей в реальном времени
2. `test-redis-fix.js` - проверка исправленной логики

### Изменения в коде
```javascript
// До
if (!lastMessageTime) {
  return exists > 0; // Обрабатываем если батч существует
}

// После  
if (!lastMessageTime) {
  return false; // НЕ обрабатываем без времени
}
```

## Проблемы и решения

### Проблема 1: Ключи удаляются слишком быстро
**Решение**: Не обрабатывать батчи без метки времени последнего сообщения

### Проблема 2: Race condition между добавлением и обработкой
**Решение**: Не удалять пустые батчи автоматически, позволить им истечь по TTL

## Результаты
- Батчи теперь корректно ждут 10 секунд таймаута
- Сообщения успешно объединяются
- Нет преждевременного удаления ключей

## Извлеченные уроки
1. **Важность детального логирования**: Добавление логов TTL помогло найти проблему
2. **Race conditions в распределенных системах**: Нужно быть осторожным с проверками существования ключей
3. **Тестирование в реальных условиях**: Проблема проявлялась только при работающем batch processor

## Что еще нужно сделать
- Мониторить работу в production
- Возможно, увеличить TTL до 120 секунд для большего запаса
- Добавить метрики для отслеживания эффективности батчинга