# Development Diary: AI Prompt Improvements (July 23, 2025)

## Context
Клиент Николай (+79163779444) написал: "хочу записаться на завтра на моделирование бороды"

AI ответил: "Николай, на завтра доступен мастер Бари. Проверю свободные слоты на моделирование бороды." и показал все слоты.

## Problem
1. AI говорит про доступность Бари, хотя клиент не спрашивал про конкретного мастера
2. AI показывает слоты, хотя клиент не спрашивал "когда можно" - он просто хочет записаться
3. Правильный ответ должен быть: "На какое время вас записать завтра?"

## Root Cause
AI выполняет команду `[SEARCH_SLOTS]` несмотря на явные инструкции в промпте не делать этого. DeepSeek AI видимо не полностью следует сложным условным правилам.

## Solution Attempts

### Attempt 1: Улучшение правил (PARTIAL SUCCESS)
- Изменено правило 5 в промпте - более явное указание когда НЕ показывать слоты
- Добавлены примеры с пометкой "БЕЗ КОМАНДЫ"
- AI теперь спрашивает "На какое время вас записать?" но все равно выполняет SEARCH_SLOTS

### Attempt 2: Усиление промпта (IN PROGRESS)
- Добавлено критически важное правило
- Явно указано что "хочу записаться на завтра" - это НЕ вопрос о времени
- Добавлены пошаговые примеры диалога без команд

### Attempt 3: Изменение формата ответа
- Добавлено правило "НЕ ДОБАВЛЯЙ КОМАНДУ если просто спрашиваешь время"
- Указано что команды добавляются ТОЛЬКО если это нужно

## Technical Details
AI всегда выполняет в логах:
```
Executing command: SEARCH_SLOTS {"date":"завтра","service_name":"моделирование бороды"}
```

Несмотря на промпт с правилами:
- "НЕ ИСПОЛЬЗУЙ [SEARCH_SLOTS] если клиент не спрашивал о времени"
- "хочу записаться на завтра" - это НЕ вопрос о времени
- Примеры показывают ответ БЕЗ КОМАНДЫ

## Lessons Learned
1. DeepSeek AI может игнорировать сложные условные правила
2. Нужны очень явные и повторяющиеся инструкции
3. Примеры должны быть максимально похожи на реальные случаи
4. Возможно стоит рассмотреть post-processing ответа AI

## Next Steps
1. Если текущие изменения не помогут - рассмотреть фильтрацию команд в processAIResponse
2. Добавить логику: если в ответе есть вопрос "На какое время" - удалить SEARCH_SLOTS
3. Возможно переключиться на другую AI модель с лучшим следованием инструкциям