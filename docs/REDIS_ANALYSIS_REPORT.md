# üìä –û—Ç—á—ë—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É Redis –∫–ª—é—á–µ–π

## –°–≤–æ–¥–∫–∞
- **–í—Å–µ–≥–æ –∫–ª—é—á–µ–π**: 285
- **–û—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤**: 16
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º**: 2
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π**: 8

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ö–ª—é—á–∏ —Å [object Object] (7 —à—Ç—É–∫)
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –æ–±—ä–µ–∫—Ç –≤–º–µ—Å—Ç–æ companyId
```
bull:company-[object Object]-messages:marker
bull:company-[object Object]-messages:1
bull:company-[object Object]-messages:events
...
```

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `src/services/redis-batch-service.js:316`
```javascript
const { companyId, metadata } = messages[0];
// companyId –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º, –µ—Å–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω
```

**–†–µ—à–µ–Ω–∏–µ**: 
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ messages[0].companyId
2. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é: `const companyId = messages[0].companyId?.toString() || messages[0].companyId`
3. –ù–∞–π—Ç–∏ –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ–±—ä–µ–∫—Ç –≤–º–µ—Å—Ç–æ ID

### 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ preferences/prefs
**–ü—Ä–æ–±–ª–µ–º–∞**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–µ—Ñ–∏–∫—Å–∞ –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- `preferences:962302:+79001234567` (10 –∫–ª—é—á–µ–π)
- `prefs:962302:79001234567` (7 –∫–ª—é—á–µ–π)

**–†–∞–∑–ª–∏—á–∏–µ**: 
- preferences –∏—Å–ø–æ–ª—å–∑—É–µ—Ç "+7" –≤ –Ω–æ–º–µ—Ä–µ
- prefs –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã

**–†–µ—à–µ–Ω–∏–µ**: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ–¥–∏–Ω –ø–∞—Ç—Ç–µ—Ä–Ω `preferences:{companyId}:{phone}`

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å—Ä–µ–¥–Ω–µ–π –≤–∞–∂–Ω–æ—Å—Ç–∏

### 3. TTL –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
| –¢–∏–ø –∫–ª—é—á–∞ | –¢–µ–∫—É—â–∏–π TTL | –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π TTL |
|-----------|-------------|-------------------|
| preferences | 20-328 –¥–Ω–µ–π | 30-90 –¥–Ω–µ–π |
| dialog | 2-6 —á–∞—Å–æ–≤ | 24 —á–∞—Å–∞ |
| client | 24 —á–∞—Å–∞ | 7 –¥–Ω–µ–π (–∫—ç—à) |
| messages | 24 —á–∞—Å–∞ | 7-30 –¥–Ω–µ–π |
| booking:owner | –ù–µ—Ç | 365 –¥–Ω–µ–π |

### 4. –ó–∞–±—ã—Ç—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏
- `test:api` - –±–µ–∑ TTL, –∑–∞–±—ã—Ç –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º

### BullMQ –æ—á–µ—Ä–µ–¥–∏ (213 –∫–ª—é—á–µ–π)
```
company-962302-messages: 156 –∫–ª—é—á–µ–π
reminders: 43 –∫–ª—é—á–µ–π  
company-[object Object]-messages: 7 –∫–ª—é—á–µ–π (–û–®–ò–ë–ö–ê!)
test-queue: 6 –∫–ª—é—á–µ–π
messages: 1 –∫–ª—é—á
```

### –ë–∏–∑–Ω–µ—Å-–¥–∞–Ω–Ω—ã–µ (72 –∫–ª—é—á–∞)
```
booking:owner: 43 –∫–ª—é—á–µ–π (–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ)
preferences/prefs: 17 –∫–ª—é—á–µ–π (–¥—É–±–ª–∏–∫–∞—Ç—ã!)
client: 2 –∫–ª—é—á–∞ (–∫—ç—à)
messages: 2 –∫–ª—é—á–∞ (–∏—Å—Ç–æ—Ä–∏—è)
dialog: 1 –∫–ª—é—á (–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥)
rate limiting: 4 –∫–ª—é—á–∞ (—Å TTL)
reminder_context: 2 –∫–ª—é—á–∞
test:api: 1 –∫–ª—é—á (–∑–∞–±—ã—Ç)
```

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–ª—é—á–µ–π —Å [object Object]**
   - –§–∞–π–ª: `src/services/redis-batch-service.js:316`
   - –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é companyId

2. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã preferences/prefs**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω: `preferences:{companyId}:{phone}`
   - –ù–∞–ø–∏—Å–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª—é—á–µ–π

3. **–£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏**
   ```bash
   redis-cli DEL test:api
   redis-cli --scan --pattern "bull:test-queue:*" | xargs redis-cli DEL
   ```

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
4. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å TTL**
   - preferences: —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Å 328 –¥–æ 90 –¥–Ω–µ–π
   - dialog: —É–≤–µ–ª–∏—á–∏—Ç—å —Å 2-6 —á–∞—Å–æ–≤ –¥–æ 24 —á–∞—Å–æ–≤
   - client: —É–≤–µ–ª–∏—á–∏—Ç—å –∫—ç—à —Å 24 —á–∞—Å–æ–≤ –¥–æ 7 –¥–Ω–µ–π
   - booking:owner: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å TTL 365 –¥–Ω–µ–π

5. **–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–ª—é—á–µ–π BullMQ**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫—É completed –∑–∞–¥–∞—á —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
   - –£–¥–∞–ª–∏—Ç—å failed –∑–∞–¥–∞—á–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
6. **–ï–¥–∏–Ω–∞—è —Å—Ö–µ–º–∞ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è**
   ```
   {entity}:{companyId}:{identifier}
   –ù–∞–ø—Ä–∏–º–µ—Ä:
   - client:962302:79001234567
   - dialog:962302:79001234567
   - preferences:962302:79001234567
   ```

7. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Redis**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ –∫–ª—é—á–∏ –±–µ–∑ TTL
   - –°–ª–µ–¥–∏—Ç—å –∑–∞ —Ä–æ—Å—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–ª—é—á–µ–π
   - –†–µ–≥—É–ª—è—Ä–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (—Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é)

8. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
   - –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É –≤—Å–µ—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∫–ª—é—á–µ–π
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å TTL –ø–æ–ª–∏—Ç–∏–∫—É
   - –î–æ–±–∞–≤–∏—Ç—å –≤ README.md —Ä–∞–∑–¥–µ–ª –ø—Ä–æ Redis

## üìù –°—Ö–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Redis

```javascript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
const key = `preferences:${companyId}:${phone}`;
await redis.setex(key, 90 * 24 * 3600, JSON.stringify(data)); // 90 –¥–Ω–µ–π

// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ  
const key = `prefs:${company}:${phoneNumber}`; // —Ä–∞–∑–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
await redis.set(key, data); // –±–µ–∑ TTL
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–ª—é—á–µ–π –Ω–∞ ~20%
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª—é—á–µ–π
- –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ "–º—É—Å–æ—Ä–Ω—ã—Ö" –∫–ª—é—á–µ–π
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞

## üìÖ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

1. **–°–µ–≥–æ–¥–Ω—è**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å [object Object] –∏ —É–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏
2. **–≠—Ç–∞ –Ω–µ–¥–µ–ª—è**: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å preferences/prefs
3. **–≠—Ç–æ—Ç –º–µ—Å—è—Ü**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å TTL –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
4. **–ü–æ—Å—Ç–æ—è–Ω–Ω–æ**: –°–ª–µ–¥–æ–≤–∞—Ç—å —Å—Ö–µ–º–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è