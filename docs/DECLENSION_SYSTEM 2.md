# Система склонений (Declension System)

## Обзор

Система автоматической генерации склонений для русского языка в AI Admin v2. Обеспечивает грамматически корректные сообщения в напоминаниях и уведомлениях.

## Архитектура

### Компоненты системы

1. **service-declension.js** - генерация склонений для услуг
2. **staff-declension.js** - генерация склонений для имен сотрудников
3. **templates.js** - использование склонений в шаблонах сообщений
4. **База данных** - хранение склонений в JSONB полях

### Структура склонений

```json
{
  "original": "Мужская стрижка",      // Оригинальное название
  "nominative": "мужская стрижка",    // Именительный (кто? что?)
  "genitive": "мужской стрижки",      // Родительный (кого? чего?)
  "dative": "мужской стрижке",        // Дательный (кому? чему?)
  "accusative": "мужскую стрижку",    // Винительный (кого? что?)
  "instrumental": "мужской стрижкой", // Творительный (кем? чем?)
  "prepositional": "мужской стрижке", // Предложный (о ком? о чем?)
  "prepositional_na": "мужскую стрижку" // Винительный для предлога НА
}
```

## Важно: поле prepositional_na

⚠️ **prepositional_na** - это **ВИНИТЕЛЬНЫЙ падеж** для конструкций с предлогом "на", а НЕ предложный падеж.

### Почему это важно?

В русском языке предлог "на" в контексте направления действия требует **винительный падеж**:
- ✅ "Записаться НА мужскую стрижку" (винительный)
- ✅ "Ожидаем вас НА мужскую стрижку" (винительный)
- ❌ "Записаться НА мужской стрижке" (предложный - неправильно!)

### Примеры правильного использования

| Услуга | accusative | prepositional | prepositional_na |
|--------|-----------|---------------|------------------|
| Мужская стрижка | мужскую стрижку | мужской стрижке | мужскую стрижку |
| Моделирование бороды | моделирование бороды | моделировании бороды | моделирование бороды |
| Укладка | укладку | укладке | укладку |

## Использование в шаблонах

### Примеры замен в templates.js

```javascript
// "на {service}" - используется prepositional_na (винительный)
"Ждём вас на {service}" → "Ждём вас на мужскую стрижку"

// "о {service}" - используется prepositional (предложный)
"Напоминаем о {service}" → "Напоминаем о мужской стрижке"

// "до {service}" - используется genitive (родительный)
"Осталось 2 часа до {service}" → "Осталось 2 часа до мужской стрижки"

// "{service} запланирована" - используется nominative (именительный)
"У вас {service}" → "У вас мужская стрижка"
```

## Генерация склонений

### При синхронизации услуг

1. Новые услуги получают склонения автоматически через AI
2. AI использует промпт с правильными примерами
3. Склонения сохраняются в поле `declensions` таблицы `services`

### Промпт для AI

```javascript
{
  "nominative": "именительный",
  "genitive": "родительный",
  "dative": "дательный",
  "accusative": "винительный",
  "instrumental": "творительный",
  "prepositional": "предложный",
  "prepositional_na": "винительный для предлога НА (на что?)"
}
```

## Исправление существующих данных

### Скрипт fix-prepositional-na.js

Исправляет неправильные значения `prepositional_na` в базе данных:

```bash
node scripts/fix-prepositional-na.js
```

Скрипт:
1. Загружает все услуги с склонениями
2. Проверяет, если `prepositional_na` == `prepositional`
3. Заменяет на значение из `accusative`
4. Сохраняет обратно в базу

## Таблицы базы данных

### services.declensions (JSONB)

```sql
-- Пример данных
{
  "original": "МУЖСКАЯ СТРИЖКА",
  "nominative": "мужская стрижка",
  "genitive": "мужской стрижки",
  "dative": "мужской стрижке",
  "accusative": "мужскую стрижку",
  "instrumental": "мужской стрижкой",
  "prepositional": "мужской стрижке",
  "prepositional_na": "мужскую стрижку"  -- Винительный падеж!
}
```

### staff.declensions (JSONB)

```sql
-- Пример данных
{
  "nominative": "Сергей",
  "genitive": "Сергея",
  "dative": "Сергею",
  "accusative": "Сергея",
  "instrumental": "Сергеем",
  "prepositional": "Сергее",
  "prepositional_u": "у Сергея"  -- Специальная форма с предлогом "у"
}
```

## Отладка и тестирование

### Проверка склонений в базе

```sql
-- Проверить склонения для конкретной услуги
SELECT title, declensions
FROM services
WHERE title LIKE '%стрижка%';

-- Найти услуги с неправильными склонениями
SELECT title,
       declensions->>'prepositional' as prep,
       declensions->>'prepositional_na' as prep_na
FROM services
WHERE declensions->>'prepositional' = declensions->>'prepositional_na';
```

### Тестирование через MCP

```bash
# Отправить тестовое сообщение
@whatsapp send_message phone:79001234567 message:"Тест склонений"

# Проверить логи
@logs logs_tail service:ai-admin-worker-v2 lines:50
```

## Решение проблем

### Проблема: "на мужской стрижке" вместо "на мужскую стрижку"

**Причина**: В базе данных `prepositional_na` содержит предложный падеж вместо винительного

**Решение**:
1. Запустить `node scripts/fix-prepositional-na.js`
2. Перезапустить сервис напоминаний: `pm2 restart ai-admin-booking-monitor`

### Проблема: Новые услуги генерируются с неправильными склонениями

**Причина**: Неправильный промпт для AI в service-declension.js

**Решение**: Убедиться, что в промпте указано:
- `prepositional_na: "винительный для предлога НА"`
- Правильные примеры с винительным падежом

## Файлы системы

- `/src/services/declension/service-declension.js` - генерация склонений услуг
- `/src/services/declension/staff-declension.js` - генерация склонений имен
- `/src/services/reminder/templates.js` - использование склонений
- `/scripts/fix-prepositional-na.js` - исправление данных в БД
- `/scripts/generate-declensions-for-existing.js` - генерация для существующих

## См. также

- [docs/development-diary/2025-08-30-declension-system.md](development-diary/2025-08-30-declension-system.md) - история создания системы
- [docs/features/reminder-examples-with-declensions.md](features/reminder-examples-with-declensions.md) - примеры использования