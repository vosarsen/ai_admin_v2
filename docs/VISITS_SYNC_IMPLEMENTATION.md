# üìä –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –≤–∏–∑–∏—Ç–æ–≤ - –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

## üéØ –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∏—Å—Ç–æ—Ä–∏–∏ –≤–∏–∑–∏—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ YClients –≤ Supabase –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—â–µ–Ω–∏—è –∏ —É–º–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.

## üîç –ü—Ä–æ–±–ª–µ–º–∞ –∫–æ—Ç–æ—Ä—É—é –º—ã —Ä–µ—à–∏–ª–∏

### –î–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
- –í —Ç–∞–±–ª–∏—Ü–µ `clients` –±—ã–ª–∏ —Ç–æ–ª—å–∫–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (visit_count, total_spent)
- –ü–æ–ª—è `visit_history`, `last_services`, `favorite_staff_ids` –≤—Å–µ–≥–¥–∞ –ø—É—Å—Ç—ã–µ
- –ù–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–∂–¥–æ–º –≤–∏–∑–∏—Ç–µ
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—â–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏

### –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
- –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `visits` –¥–ª—è –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –≤–∏–∑–∏—Ç–æ–≤ —Å –¥–µ—Ç–∞–ª—è–º–∏ —É—Å–ª—É–≥, –º–∞—Å—Ç–µ—Ä–æ–≤, –æ–ø–ª–∞—Ç
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `scripts/database/create-visits-table.sql` - –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏
- `scripts/database/create-visits-table-simple.sql` - –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è Supabase

### 2. –ú–æ–¥—É–ª—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `src/sync/visits-sync.js` - –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–∏–∑–∏—Ç–æ–≤
  - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ YClients API endpoint `/company/{id}/clients/visits/search`
  - –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (50 –≤–∏–∑–∏—Ç–æ–≤ –∑–∞ —Ä–∞–∑)
  - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Supabase
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ª—É–≥, –ø—Ä–æ–¥–∞–∂ —Ç–æ–≤–∞—Ä–æ–≤, –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤

### 3. –°–∫—Ä–∏–ø—Ç—ã –∑–∞–ø—É—Å–∫–∞
- `scripts/sync-visits.js` - –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–ø—Ü–∏—è–º–∏
- `test-visits-sync.js` - –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
- `scripts/create-visits-table.js` - –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
- `scripts/execute-visits-table.sh` - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `CREATE_VISITS_TABLE_INSTRUCTIONS.md` - –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- `docs/VISITS_SYNC_IMPLEMENTATION.md` - –≠—Ç–æ—Ç —Ñ–∞–π–ª

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã visits

```sql
visits
‚îú‚îÄ‚îÄ id (UUID) - Primary Key
‚îú‚îÄ‚îÄ YClients –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ yclients_visit_id
‚îÇ   ‚îú‚îÄ‚îÄ yclients_record_id (UNIQUE with company_id)
‚îÇ   ‚îî‚îÄ‚îÄ company_id
‚îú‚îÄ‚îÄ –ö–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ client_id (FK ‚Üí clients.id)
‚îÇ   ‚îú‚îÄ‚îÄ client_phone
‚îÇ   ‚îú‚îÄ‚îÄ client_name
‚îÇ   ‚îî‚îÄ‚îÄ client_yclients_id
‚îú‚îÄ‚îÄ –ú–∞—Å—Ç–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ staff_id
‚îÇ   ‚îú‚îÄ‚îÄ staff_name
‚îÇ   ‚îî‚îÄ‚îÄ staff_yclients_id
‚îú‚îÄ‚îÄ –£—Å–ª—É–≥–∏
‚îÇ   ‚îú‚îÄ‚îÄ services (JSONB) - [{id, name, cost, duration}]
‚îÇ   ‚îú‚îÄ‚îÄ service_names (TEXT[])
‚îÇ   ‚îú‚îÄ‚îÄ service_ids (INTEGER[])
‚îÇ   ‚îî‚îÄ‚îÄ services_cost
‚îú‚îÄ‚îÄ –í—Ä–µ–º—è
‚îÇ   ‚îú‚îÄ‚îÄ visit_date
‚îÇ   ‚îú‚îÄ‚îÄ visit_time
‚îÇ   ‚îú‚îÄ‚îÄ datetime
‚îÇ   ‚îî‚îÄ‚îÄ duration
‚îú‚îÄ‚îÄ –§–∏–Ω–∞–Ω—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ total_cost
‚îÇ   ‚îú‚îÄ‚îÄ paid_amount
‚îÇ   ‚îú‚îÄ‚îÄ discount_amount
‚îÇ   ‚îú‚îÄ‚îÄ tips_amount
‚îÇ   ‚îú‚îÄ‚îÄ payment_status
‚îÇ   ‚îî‚îÄ‚îÄ payment_method
‚îú‚îÄ‚îÄ –°—Ç–∞—Ç—É—Å
‚îÇ   ‚îú‚îÄ‚îÄ attendance (-1/0/1/2)
‚îÇ   ‚îú‚îÄ‚îÄ status (completed/cancelled/no_show)
‚îÇ   ‚îî‚îÄ‚îÄ is_online
‚îî‚îÄ‚îÄ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    ‚îú‚îÄ‚îÄ created_at
    ‚îú‚îÄ‚îÄ updated_at
    ‚îî‚îÄ‚îÄ synced_at
```

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ YClients
```javascript
POST /company/{company_id}/clients/visits/search
{
  client_id: 123,
  payment_statuses: [],
  attendance: 1 // –¢–æ–ª—å–∫–æ –≥–¥–µ –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏—à–µ–ª
}
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –ü–∞—Ä—Å–∏–Ω–≥ –≤–∏–∑–∏—Ç–æ–≤ –∏ –∑–∞–ø–∏—Å–µ–π
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å–ª—É–≥–∞—Ö
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–∞–∂ —Ç–æ–≤–∞—Ä–æ–≤
- –†–∞—Å—á–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Supabase
- –ü–∞–∫–µ—Ç–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ (upsert) –ø–æ 50 –∑–∞–ø–∏—Å–µ–π
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–µ–π —á–µ—Ä–µ–∑ UNIQUE constraint
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)
1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://supabase.com/dashboard/project/wyfbwjqnkkjeldhnmnpb/sql/new
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ SQL –∏–∑: `scripts/database/create-visits-table-simple.sql`
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
node test-visits-sync.js

# –¢–µ—Å—Ç–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (3 –∫–ª–∏–µ–Ω—Ç–∞)
node scripts/sync-visits.js --limit 3

# VIP –∫–ª–∏–µ–Ω—Ç—ã
node scripts/sync-visits.js --vip

# –ö–ª–∏–µ–Ω—Ç—ã —Å 10+ –≤–∏–∑–∏—Ç–∞–º–∏
node scripts/sync-visits.js --min-visits 10 --limit 20
```

### –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
```bash
# –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã
node scripts/sync-visits.js

# –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è: 1-2 –º–∏–Ω—É—Ç—ã –Ω–∞ 100 –∫–ª–∏–µ–Ω—Ç–æ–≤
```

## üìä –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º—É

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
–í `sync-manager.js` –¥–æ–±–∞–≤–ª–µ–Ω–æ:
- –ú–æ–¥—É–ª—å `VisitsSync`
- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 04:00 –ú–°–ö
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ (03:00)

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
–ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ:
1. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤–∏–∑–∏—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞
2. –û–ø—Ä–µ–¥–µ–ª—è—Ç—å –ª—é–±–∏–º—ã–µ —É—Å–ª—É–≥–∏
3. –ù–∞—Ö–æ–¥–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤
4. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
5. –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–¢–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞ –≤—Ä—É—á–Ω—É—é** —á–µ—Ä–µ–∑ Supabase Dashboard
2. **–ü–µ—Ä–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–π–º–µ—Ç –≤—Ä–µ–º—è** (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤)
3. **Rate limits YClients API** - 500ms –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–∞–º–∏
4. **–ú–∞–∫—Å–∏–º—É–º 100 –≤–∏–∑–∏—Ç–æ–≤ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üìà –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

–ü–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `visits` —Å–æ–¥–µ—Ä–∂–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –≤–∏–∑–∏—Ç–æ–≤
- ‚úÖ –ü–æ–ª—è `last_service_ids`, `favorite_staff_ids` –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏

## üîú –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É visits** –≤ Supabase
2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é**
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ**
4. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é**
5. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ AI –ø—Ä–æ–º–ø—Ç—ã**