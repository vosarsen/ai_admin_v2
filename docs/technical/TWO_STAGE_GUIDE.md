# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ Two-Stage –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—É

## –û–±–∑–æ—Ä

Two-Stage –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä - —ç—Ç–æ —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –∏ –±—ã—Å—Ç—Ä–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ReAct –ø–∞—Ç—Ç–µ—Ä–Ω—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ AI Admin v2. –û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **2.5x —É—Å–∫–æ—Ä–µ–Ω–∏–µ** –æ—Ç–≤–µ—Ç–æ–≤ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
graph LR
    A[–°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞] --> B[Stage 1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥]
    B --> C[JSON —Å –∫–æ–º–∞–Ω–¥–∞–º–∏]
    C --> D[–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ]
    D --> E[–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–º–∞–Ω–¥]
    E --> F[Stage 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞]
    F --> G[–û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É]
```

### –≠—Ç–∞–ø 1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
- **–í—Ö–æ–¥**: –°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ + –∫–æ–Ω—Ç–µ–∫—Å—Ç
- **AI –∑–∞–¥–∞—á–∞**: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å
- **–í—ã—Ö–æ–¥**: JSON –º–∞—Å—Å–∏–≤ –∫–æ–º–∞–Ω–¥
- **–í—Ä–µ–º—è**: ~8 —Å–µ–∫—É–Ω–¥

### –≠—Ç–∞–ø 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
- **–í—Ö–æ–¥**: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
- **AI –∑–∞–¥–∞—á–∞**: –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —á–µ–ª–æ–≤–µ—á–Ω—ã–π –æ—Ç–≤–µ—Ç
- **–í—ã—Ö–æ–¥**: –¢–µ–∫—Å—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
- **–í—Ä–µ–º—è**: ~5 —Å–µ–∫—É–Ω–¥

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å ReAct

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | Two-Stage | ReAct |
|----------------|-----------|--------|
| **–°–∫–æ—Ä–æ—Å—Ç—å** | 13 —Å–µ–∫ | 33 —Å–µ–∫ |
| **–ò—Ç–µ—Ä–∞—Ü–∏–∏** | –í—Å–µ–≥–¥–∞ 2 | 2-4 |
| **–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å** | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏** | –ü—Ä–æ—Å—Ç–∞—è | –°–ª–æ–∂–Ω–∞—è |
| **–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö** | JSON | –¢–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ |

## –ê–∫—Ç–∏–≤–∞—Ü–∏—è

### –ß–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –í —Ñ–∞–π–ª–µ .env
AI_PROMPT_VERSION=two-stage
USE_TWO_STAGE=true
```

### –ß–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É

```bash
# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å Two-Stage
export USE_TWO_STAGE=true
export AI_PROMPT_VERSION=two-stage

# –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ ReAct
export USE_TWO_STAGE=false
export AI_PROMPT_VERSION=react-prompt
```

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
# –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ Two-Stage
ssh ai-admin-server "cd /opt/ai-admin && \
  sed -i 's/AI_PROMPT_VERSION=.*/AI_PROMPT_VERSION=two-stage/' .env && \
  sed -i 's/USE_TWO_STAGE=.*/USE_TWO_STAGE=true/' .env && \
  pm2 restart ai-admin-worker-v2"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
ssh ai-admin-server "grep -E 'TWO_STAGE|AI_PROMPT' /opt/ai-admin/.env"
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
src/services/ai-admin-v2/
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îî‚îÄ‚îÄ two-stage-processor.js    # –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
‚îú‚îÄ‚îÄ prompts/
‚îÇ   ‚îú‚îÄ‚îÄ two-stage-command-prompt.js   # –ü—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–∞–ø–∞ 1
‚îÇ   ‚îî‚îÄ‚îÄ two-stage-response-prompt.js  # –ü—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–∞–ø–∞ 2
‚îî‚îÄ‚îÄ index.js                      # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
```

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–æ–º–∞–Ω–¥—ã

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã |
|---------|----------|-----------|
| `SEARCH_SLOTS` | –ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ | service_name, date, staff_name |
| `CREATE_BOOKING` | –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ | service_name, date, time, staff_name |
| `CANCEL_BOOKING` | –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ | - |
| `SHOW_PRICES` | –ü–æ–∫–∞–∑–∞—Ç—å —Ü–µ–Ω—ã | - |
| `CHECK_STAFF_SCHEDULE` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ | staff_name, date |

## –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### –ü—Ä–∏–º–µ—Ä 1: –ó–∞–ø—Ä–æ—Å —Å–ª–æ—Ç–æ–≤

**–ö–ª–∏–µ–Ω—Ç**: "–ö–∞–∫–æ–µ –≤—Ä–µ–º—è —Å–≤–æ–±–æ–¥–Ω–æ –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞?"

**Stage 1 –≤—ã—Ö–æ–¥ (JSON)**:
```json
{
  "commands": [
    {
      "name": "SEARCH_SLOTS",
      "params": {
        "service_name": "—Å—Ç—Ä–∏–∂–∫–∞",
        "date": "–∑–∞–≤—Ç—Ä–∞"
      }
    }
  ]
}
```

**Stage 2 –æ—Ç–≤–µ—Ç**: "–ó–∞–≤—Ç—Ä–∞ –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É —Å–≤–æ–±–æ–¥–Ω–æ: 10:00, 14:00, 17:00. –ù–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –≤–∞—Å –∑–∞–ø–∏—Å–∞—Ç—å?"

### –ü—Ä–∏–º–µ—Ä 2: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏

**–ö–ª–∏–µ–Ω—Ç**: "–ó–∞–ø–∏—à–∏—Ç–µ –º–µ–Ω—è –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞ –≤ 15:00"

**Stage 1 –≤—ã—Ö–æ–¥ (JSON)**:
```json
{
  "commands": [
    {
      "name": "CREATE_BOOKING",
      "params": {
        "service_name": "—Å—Ç—Ä–∏–∂–∫–∞",
        "date": "–∑–∞–≤—Ç—Ä–∞",
        "time": "15:00",
        "staff_name": "–ë–∞—Ä–∏"
      }
    }
  ]
}
```

**Stage 2 –æ—Ç–≤–µ—Ç**: "–ê—Ä—Å–µ–Ω, –∑–∞–ø–∏—Å–∞–ª –≤–∞—Å –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞ –≤ 15:00 –∫ –º–∞—Å—Ç–µ—Ä—É –ë–∞—Ä–∏. –ñ–¥—ë–º –≤–∞—Å –ø–æ –∞–¥—Ä–µ—Å—É: –ú–∞–ª–∞—Ö–æ–≤–∫–∞, –Æ–∂–Ω–∞—è —É–ª–∏—Ü–∞, 38."

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
node test-two-stage.js

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
USE_TWO_STAGE=true node test-direct-webhook.js "–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Two-Stage
ssh ai-admin-server "pm2 logs ai-admin-worker-v2 | grep -E 'Two-Stage|Stage [12]'"

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
ssh ai-admin-server "pm2 logs ai-admin-worker-v2 | grep 'completed in.*ms'"
```

## –û—Ç–ª–∞–¥–∫–∞

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–ü—Ä–æ–º–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ñ–∞–π–ª—ã –ø—Ä–æ–º–ø—Ç–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `AI_PROMPT_VERSION=two-stage`

2. **AI –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π JSON**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–º–ø—Ç –¥–ª—è Stage 1
   - –ï—Å—Ç—å fallback –Ω–∞ regex –ø–∞—Ä—Å–∏–Ω–≥

3. **–ö–æ–º–∞–Ω–¥—ã –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ command-handler
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ API YClients –¥–æ—Å—Ç—É–ø–µ–Ω

### –ü–æ–ª–µ–∑–Ω—ã–µ –ª–æ–≥–∏

```bash
# –û–±—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å
"üéØ Using Two-Stage processor"
"üöÄ Starting Two-Stage processing"

# Stage 1
"üìã Stage 1: Command extraction"
"‚úÖ Stage 1 completed in Xms, found Y commands"

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
"‚öôÔ∏è Executing N commands"
"‚úÖ Commands executed in Xms"

# Stage 2
"üí¨ Stage 2: Response generation"
"‚úÖ Stage 2 completed in Xms"

# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
"üéâ Two-Stage processing completed in Xms"
```

## –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–ø—Ä–æ–¥–∞–∫—à–µ–Ω)

- **Stage 1**: 7-9 —Å–µ–∫—É–Ω–¥
- **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥**: 10-500 –º—Å (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç API)
- **Stage 2**: 4-6 —Å–µ–∫—É–Ω–¥
- **–û–±—â–µ–µ –≤—Ä–µ–º—è**: 12-15 —Å–µ–∫—É–Ω–¥

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å ReAct

- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ**: 2.5x
- **–°–Ω–∏–∂–µ–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ AI**: 40%
- **–£–º–µ–Ω—å—à–µ–Ω–∏–µ –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏**: 60%

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã

1. –û–±–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ–º–ø—Ç –≤ `two-stage-command-prompt.js`:
```javascript
// –î–æ–±–∞–≤—å—Ç–µ –≤ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
"5. NEW_COMMAND - –æ–ø–∏—Å–∞–Ω–∏–µ
   –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: param1, param2"
```

2. –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ `command-handler.js`:
```javascript
case 'NEW_COMMAND':
  const result = await this.executeNewCommand(cmd.params, context);
  results.push({ type: 'new_command', data: result });
  break;
```

3. –û–±–Ω–æ–≤–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `two-stage-response-prompt.js`:
```javascript
case 'NEW_COMMAND':
  return `‚úÖ NEW_COMMAND: ${data.description}`;
```

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Two-Stage –¥–ª—è**:
   - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∑–∞–ø–∏—Å—å
   - –ó–∞–ø—Ä–æ—Å–æ–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Ü–µ–Ω—ã, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ)
   - –ü—Ä–æ—Å—Ç—ã—Ö –∫–æ–º–∞–Ω–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

2. **–ü–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ—Å—å –Ω–∞ ReAct –¥–ª—è**:
   - –°–ª–æ–∂–Ω—ã—Ö –º–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
   - –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - –û—Ç–ª–∞–¥–∫–∏ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
   - –õ–æ–≥–∏—Ä—É–π—Ç–µ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
   - –°–ª–µ–¥–∏—Ç–µ –∑–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç—å—é –∫–æ–º–∞–Ω–¥

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Two-Stage –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ –∫–∞—á–µ—Å—Ç–≤–æ–º –æ—Ç–≤–µ—Ç–æ–≤. –ü—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –æ–Ω —Å–ø–æ—Å–æ–±–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å 95% –∑–∞–ø—Ä–æ—Å–æ–≤ –±—ã—Å—Ç—Ä–µ–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ, —á–µ–º ReAct, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏ —ç—Ç–æ–º –≥–∏–±–∫–æ—Å—Ç—å –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.