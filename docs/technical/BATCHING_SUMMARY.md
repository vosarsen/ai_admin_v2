# Redis Батчинг - Итоговая документация

## 📋 Краткое описание

Redis-based батчинг решает проблему обработки сообщений, отправленных по частям. Теперь, когда клиент отправляет несколько сообщений подряд (например, "Привет" → "запишите меня" → "на стрижку"), они автоматически объединяются в одно осмысленное сообщение.

## 🚀 Текущий статус

**✅ Развернуто в production и работает!**

- Все клиенты используют новый батчинговый webhook
- Сообщения объединяются с таймаутом 10 секунд
- Протестировано с реальными клиентами

## 🏗️ Архитектура

```
┌─────────────┐     ┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│  WhatsApp   │────▶│   Webhook   │────▶│ Redis Lists  │────▶│   Batch     │
│   Client    │     │  /batched   │     │ rapid-fire:* │     │ Processor   │
└─────────────┘     └─────────────┘     └──────────────┘     └─────────────┘
                                                                      │
                                                                      ▼
                                                              ┌─────────────┐
                                                              │   Message   │
                                                              │    Queue    │
                                                              └─────────────┘
```

## 📝 Ключевые компоненты

### 1. RedisBatchService (`src/services/redis-batch-service.js`)
- Управляет батчами сообщений в Redis
- Параметры: таймаут 10 сек, макс размер 10 сообщений
- Методы: `addMessage()`, `processPendingBatches()`, `getStats()`

### 2. Batch Processor (`src/workers/batch-processor.js`)
- Отдельный PM2 процесс
- Проверяет батчи каждую секунду
- Обрабатывает готовые батчи автоматически

### 3. Batched Webhook (`src/api/webhooks/whatsapp-batched.js`)
- Endpoint: `/webhook/whatsapp/batched`
- Просто добавляет сообщения в Redis
- Быстрый ответ клиенту

## 🔧 Конфигурация

### PM2
```bash
pm2 status
# Должны видеть:
# - ai-admin-api
# - ai-admin-worker-v2
# - ai-admin-batch-processor ← новый процесс
# - venom-bot
```

### Venom Bot
Настроен на использование нового webhook:
- Файл: `/opt/venom-bot/index.js`
- URL: `http://localhost:3000/webhook/whatsapp/batched`

## 📊 Мониторинг

### Проверка статистики батчей
```bash
curl http://46.149.70.219:3000/webhook/whatsapp/batched/stats
```

### Логи batch processor
```bash
ssh root@46.149.70.219 "pm2 logs ai-admin-batch-processor --lines 50"
```

### Поиск объединенных сообщений
```bash
ssh root@46.149.70.219 "grep 'Processing batch' /opt/ai-admin/logs/batch-processor-out-3.log"
```

## 🐛 Известные проблемы

### 1. ❌ Отсутствует staff_id при создании записи
- AI использует `staff_id: "last"`, но код не обрабатывает это
- Приводит к ошибке валидации при создании записи
- **Статус**: Требует исправления

### 2. ❌ Нет автоматических альтернатив при ошибках
- При ошибке создания записи не показываются альтернативные слоты
- **Статус**: Требует реализации

## 📈 Метрики

- **Время батчинга**: 10 секунд (настраиваемо)
- **Максимальный размер батча**: 10 сообщений
- **Использование памяти**: ~60MB (batch processor)
- **Производительность**: <100ms на обработку батча

## 🔍 Пример работы

**До батчинга:**
```
15:38:14 → "Запишите на стрижку меня" → ❌ Непонятно
15:38:17 → "На завтра" → ❌ Без контекста
15:38:22 → "В 18:00" → ❌ Что в 18:00?
15:38:26 → "К Бари" → ❌ К Бари на что?
```

**После батчинга:**
```
15:38:14-26 → "Запишите на стрижку меня На завтра В 18:00 К Бари"
→ ✅ AI понимает полный контекст и может создать запись
```

## 🚨 Важные замечания

1. **Порт Redis**: На сервере используется 6379, локально через туннель 6380
2. **Инициализация**: Batch service должен быть инициализирован во всех модулях
3. **Rate limiting**: Webhook имеет ограничение 5 запросов в burst mode

## 📚 Дополнительная документация

- План реализации: `docs/development-diary/2025-07-23-rapid-fire-redis-solution.md`
- Детали реализации: `docs/development-diary/2025-07-23-redis-batching-implementation.md`
- Деплой и исправления: `docs/development-diary/2025-07-23-batching-deployment-fixes.md`