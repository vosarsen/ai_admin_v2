# üìö Redis Schema Documentation

## –û–±–∑–æ—Ä
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∫–ª—é—á–µ–π Redis –≤ –ø—Ä–æ–µ–∫—Ç–µ AI Admin v2.

## üîë –°—Ö–µ–º–∞ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∫–ª—é—á–µ–π

### –û–±—â–∏–π —Ñ–æ—Ä–º–∞—Ç
```
{entity}:{companyId}:{identifier}
```

- **entity** - —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö (preferences, dialog, client, etc.)
- **companyId** - ID –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏
- **identifier** - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–æ–±—ã—á–Ω–æ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ E.164)

### –§–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç **E.164 –±–µ–∑ –∑–Ω–∞–∫–∞ +**: `79001234567`

## üì¶ –¢–∏–ø—ã –∫–ª—é—á–µ–π

### 1. preferences (–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤)
**–ü–∞—Ç—Ç–µ—Ä–Ω**: `preferences:{companyId}:{phone}`  
**–¢–∏–ø**: String (JSON)  
**TTL**: 90 –¥–Ω–µ–π  
**–ü—Ä–∏–º–µ—Ä**: `preferences:962302:79001234567`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö**:
```json
{
  "favoriteService": "–ú–£–ñ–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê",
  "favoriteStaff": "–°–µ—Ä–≥–µ–π",
  "preferredTime": "evening",
  "lastBookingDate": "2025-08-30",
  "visitCount": 5
}
```

### 2. dialog (–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞)
**–ü–∞—Ç—Ç–µ—Ä–Ω**: `dialog:{companyId}:{phone}`  
**–¢–∏–ø**: Hash  
**TTL**: 24 —á–∞—Å–∞  
**–ü—Ä–∏–º–µ—Ä**: `dialog:962302:79001234567`

**–ü–æ–ª—è**:
- `companyId` - ID –∫–æ–º–ø–∞–Ω–∏–∏
- `state` - —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
- `phone` - —Ç–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞
- `selection` - —Ç–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä
- `clientName` - –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
- `lastUpdated` - timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### 3. client (–ö—ç—à –∫–ª–∏–µ–Ω—Ç–∞)
**–ü–∞—Ç—Ç–µ—Ä–Ω**: `client:{companyId}:{phone}`  
**–¢–∏–ø**: String (JSON)  
**TTL**: 7 –¥–Ω–µ–π  
**–ü—Ä–∏–º–µ—Ä**: `client:962302:79001234567`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö**:
```json
{
  "id": 95406,
  "name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  "phone": "79001234567",
  "email": "ivan@example.com",
  "visitCount": 10,
  "totalSpent": 15000
}
```

### 4. messages (–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π)
**–ü–∞—Ç—Ç–µ—Ä–Ω**: `messages:{companyId}:{phone}`  
**–¢–∏–ø**: List  
**TTL**: 30 –¥–Ω–µ–π  
**–ü—Ä–∏–º–µ—Ä**: `messages:962302:79001234567`

–•—Ä–∞–Ω–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

### 5. booking:owner (–í–ª–∞–¥–µ–ª—å—Ü—ã –±—É–∫–∏–Ω–≥–æ–≤)
**–ü–∞—Ç—Ç–µ—Ä–Ω**: `booking:owner:{bookingId}`  
**–¢–∏–ø**: String  
**TTL**: 365 –¥–Ω–µ–π  
**–ü—Ä–∏–º–µ—Ä**: `booking:owner:1224758990`

–•—Ä–∞–Ω–∏—Ç phone –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±—É–∫–∏–Ω–≥–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞.

### 6. reminder_context (–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π)
**–ü–∞—Ç—Ç–µ—Ä–Ω**: `reminder_context:{phone}`  
**–¢–∏–ø**: String (JSON)  
**TTL**: 24 —á–∞—Å–∞  
**–ü—Ä–∏–º–µ—Ä**: `reminder_context:79001234567`

### 7. rate (Rate Limiting)
**–ü–∞—Ç—Ç–µ—Ä–Ω—ã**:
- `rate:day:{phone}` - –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç (TTL: 24 —á–∞—Å–∞)
- `rate:hour:{phone}` - —á–∞—Å–æ–≤–æ–π –ª–∏–º–∏—Ç (TTL: 1 —á–∞—Å)
- `rate:minute:{phone}` - –º–∏–Ω—É—Ç–Ω—ã–π –ª–∏–º–∏—Ç (TTL: 1 –º–∏–Ω—É—Ç–∞)

**–¢–∏–ø**: ZSet (sorted set)

### 8. bull (BullMQ –æ—á–µ—Ä–µ–¥–∏)
**–ü–∞—Ç—Ç–µ—Ä–Ω—ã**:
- `bull:company-{companyId}-messages:*` - –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- `bull:reminders:*` - –æ—á–µ—Ä–µ–¥–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

–°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–ª—é—á–∏ BullMQ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥—è–º–∏.

## ‚è∞ TTL –ü–æ–ª–∏—Ç–∏–∫–∞

| –¢–∏–ø –∫–ª—é—á–∞ | TTL | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|-----------|-----|-------------|
| preferences | 90 –¥–Ω–µ–π | –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ |
| dialog | 24 —á–∞—Å–∞ | –ê–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ |
| client | 7 –¥–Ω–µ–π | –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î |
| messages | 30 –¥–Ω–µ–π | –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ |
| booking | 365 –¥–Ω–µ–π | –ê—Ä—Ö–∏–≤ –±—É–∫–∏–Ω–≥–æ–≤ |
| reminder_context | 24 —á–∞—Å–∞ | –í—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç |
| rate:day | 24 —á–∞—Å–∞ | –î–Ω–µ–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã |
| rate:hour | 1 —á–∞—Å | –ß–∞—Å–æ–≤—ã–µ –ª–∏–º–∏—Ç—ã |

## üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏

### –°–∫—Ä–∏–ø—Ç—ã
- `scripts/migrate-redis-keys.js` - –º–∏–≥—Ä–∞—Ü–∏—è –∏ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–ª—é—á–µ–π
- `scripts/clean-redis-keys.js` - —Ä–µ–≥—É–ª—è—Ä–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
- `scripts/analyze-redis-keys.js` - –∞–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### –ö–æ–º–∞–Ω–¥—ã
```bash
# –ú–∏–≥—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π
node scripts/migrate-redis-keys.js

# –û—á–∏—Å—Ç–∫–∞ (–∑–∞–ø—É—Å–∫–∞—Ç—å –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ)
node scripts/clean-redis-keys.js

# –ê–Ω–∞–ª–∏–∑
node scripts/analyze-redis-keys.js
```

### Cron –∑–∞–¥–∞—á–∞ –¥–ª—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏
```cron
# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Redis (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 3:00)
0 3 * * 0 cd /opt/ai-admin && node scripts/clean-redis-keys.js >> logs/redis-clean.log 2>&1
```

## ‚úÖ Best Practices

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ E.164 —Ñ–æ—Ä–º–∞—Ç** –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (–±–µ–∑ +)
2. **–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ TTL** –¥–ª—è –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–¥–∏–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω** –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
4. **–í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ companyId** –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∫–ª—é—á–∞
5. **–†–µ–≥—É–ª—è—Ä–Ω–æ –æ—á–∏—â–∞–π—Ç–µ** —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
6. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

## üö´ –ß–µ–≥–æ –∏–∑–±–µ–≥–∞—Ç—å

1. ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ä–µ–∫—Ç—ã –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –∫–ª—é—á–µ–π (`[object Object]`)
2. ‚ùå –ù–µ –¥—É–±–ª–∏—Ä—É–π—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (`prefs` vs `preferences`)
3. ‚ùå –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫–ª—é—á–∏ –±–µ–∑ TTL –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
4. ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ + –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–∞—Ö
5. ‚ùå –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ –±–æ–ª—å—à–∏–µ –æ–±—ä–µ–∫—Ç—ã –≤ Redis (>1MB)

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
```bash
redis-cli -p 6380 info memory
redis-cli -p 6380 dbsize
```

### –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∫–ª—é—á–µ–π
```bash
redis-cli -p 6380 --scan --pattern "*\[object Object\]*"
redis-cli -p 6380 --scan --pattern "*+7*"
```

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã:
1. –û–±–Ω–æ–≤–∏—Ç–µ `scripts/migrate-redis-keys.js`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
3. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–π —Å—Ö–µ–º—ã
4. –û–±–Ω–æ–≤–∏—Ç–µ —ç—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é