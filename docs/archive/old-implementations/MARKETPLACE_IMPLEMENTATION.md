# üöÄ YClients Marketplace Integration - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞-–∏-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
4. [API Reference](#api-reference)
5. [WebSocket –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è](#websocket-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)
6. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
7. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
8. [–ü—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è](#–ø—Ä–æ—Ü–µ—Å—Å-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
9. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∏-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
10. [Troubleshooting](#troubleshooting)

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

AI Admin Marketplace Integration - —ç—Ç–æ –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–º YClients, –ø–æ–∑–≤–æ–ª—è—é—â–∞—è —Å–∞–ª–æ–Ω–∞–º –∫—Ä–∞—Å–æ—Ç—ã –ø–æ–¥–∫–ª—é—á–∞—Ç—å WhatsApp –±–æ—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤.

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–∞–ª–æ–Ω–æ–≤ –∏–∑ YClients
- ‚úÖ QR-–∫–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WhatsApp —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- ‚úÖ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ Rate limiting –∏ –∑–∞—â–∏—Ç–∞ –æ—Ç DDoS
- ‚úÖ Multi-tenant –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

**–í–µ—Ä—Å–∏—è:** 1.0.0
**–°—Ç–∞—Ç—É—Å:** Production Ready
**–û—Ü–µ–Ω–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** 9/10
**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 16 —è–Ω–≤–∞—Ä—è 2025

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   YClients      ‚îÇ
‚îÇ  Marketplace    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    [OAuth/API]
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   AI Admin      ‚îÇ
‚îÇ   API Server    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ Express.js    ‚îÇ
‚îÇ ‚Ä¢ Socket.io     ‚îÇ
‚îÇ ‚Ä¢ JWT Auth      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    [WebSocket]
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  WhatsApp Bot   ‚îÇ
‚îÇ   (Baileys)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    [Messages]
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Clients      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Backend:** Node.js, Express.js
- **WebSocket:** Socket.io
- **WhatsApp:** Baileys/WhiskeySockets
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** PostgreSQL (Supabase)
- **–ö—ç—à:** Redis
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** JWT
- **–í–∞–ª–∏–¥–∞—Ü–∏—è:** Custom validators

## üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js >= 16.x
- PostgreSQL >= 13
- Redis >= 6.x
- PM2 (–¥–ª—è production)

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
YCLIENTS_API_KEY=your_yclients_api_key
JWT_SECRET=your_secret_key_min_32_chars
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your_supabase_service_key
REDIS_URL=redis://localhost:6379

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
NODE_ENV=production
PORT=3000
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git clone https://github.com/vosarsen/ai_admin_v2.git
cd ai_admin_v2

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª

# –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
npm run migrate

# –ó–∞–ø—É—Å–∫ –≤ development
npm run dev

# –ó–∞–ø—É—Å–∫ –≤ production
npm run build
pm2 start ecosystem.config.js
```

## üìö API Reference

### –ë–∞–∑–æ–≤—ã–π URL

```
Production: https://ai-admin.app
Development: http://localhost:3000
```

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

–í—Å–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ endpoints —Ç—Ä–µ–±—É—é—Ç API –∫–ª—é—á –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ:

```http
X-API-Key: your_api_key_here
```

### Endpoints

#### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–ø–∞–Ω–∏–∏

```http
POST /marketplace/register
Content-Type: application/json

{
  "salon_id": 962302,
  "phone": "79001234567",
  "email": "salon@example.com"
}
```

**Response:**
```json
{
  "success": true,
  "company_id": 1,
  "salon_id": 962302,
  "api_key": "sk_...",
  "connect_url": "/marketplace/connect?token=...&company=1&salon=962302"
}
```

**–ö–æ–¥—ã –æ—à–∏–±–æ–∫:**
- `400` - –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- `409` - –ö–æ–º–ø–∞–Ω–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- `500` - –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞

#### 2. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WhatsApp

```http
GET /marketplace/connect?token={token}&company={id}&salon={salon_id}
```

–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å QR-–∫–æ–¥–æ–º –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WhatsApp.

#### 3. –ü–æ–ª—É—á–µ–Ω–∏–µ QR-–∫–æ–¥–∞

```http
GET /marketplace/qr/{token}
```

**Response:**
```json
{
  "success": true,
  "qr": "2@ABCdef123...",
  "expires_in": 20
}
```

#### 4. –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```http
GET /marketplace/status/{companyId}
```

**Response:**
```json
{
  "success": true,
  "company_id": 1,
  "whatsapp_connected": true,
  "whatsapp_phone": "79001234567",
  "integration_status": "active",
  "connected_at": "2025-01-16T10:00:00Z"
}
```

#### 5. Callback –¥–ª—è YClients

```http
POST /marketplace/callback
Content-Type: application/json

{
  "salon_id": 962302,
  "company_id": 1,
  "status": "connected",
  "whatsapp_phone": "79001234567",
  "api_key": "sk_..."
}
```

#### 6. Webhook –æ—Ç YClients

```http
POST /marketplace/webhook/{companyId}
Content-Type: application/json

{
  "type": "booking_created",
  "data": {
    "id": 123,
    "client_id": 456,
    "service_id": 789,
    "datetime": "2025-01-20T15:00:00Z"
  }
}
```

#### 7. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

```http
GET /marketplace/companies
X-API-Key: admin_key
```

**Response:**
```json
{
  "success": true,
  "stats": {
    "total": 100,
    "connected": 85
  }
}
```

## üîå WebSocket –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```javascript
const socket = io('/marketplace', {
  auth: {
    token: 'your_token_here'
  },
  transportOptions: {
    polling: {
      extraHeaders: {
        'Authorization': 'Bearer your_token_here'
      }
    }
  },
  query: {
    companyId: '1'
  }
});
```

### –°–æ–±—ã—Ç–∏—è

#### Client ‚Üí Server

- `request-qr` - –ó–∞–ø—Ä–æ—Å –Ω–æ–≤–æ–≥–æ QR-–∫–æ–¥–∞
- `disconnect` - –û—Ç–∫–ª—é—á–µ–Ω–∏–µ

#### Server ‚Üí Client

- `qr-update` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ QR-–∫–æ–¥–∞
  ```json
  {
    "qr": "2@ABCdef...",
    "expiresIn": 20
  }
  ```

- `whatsapp-connected` - –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  ```json
  {
    "success": true,
    "phone": "79001234567",
    "companyId": 1,
    "message": "WhatsApp —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!"
  }
  ```

- `error` - –û—à–∏–±–∫–∞
  ```json
  {
    "message": "–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏"
  }
  ```

### Rate Limiting

- **–õ–∏–º–∏—Ç:** 5 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∑–∞ 60 —Å–µ–∫—É–Ω–¥ —Å –æ–¥–Ω–æ–≥–æ IP
- **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞:** –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- **–û—Ç–≤–µ—Ç –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏:** Instant disconnect —Å –æ—à–∏–±–∫–æ–π

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ä—ã –∑–∞—â–∏—Ç—ã

1. **JWT Authentication**
   - –¢–æ–∫–µ–Ω—ã —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è (24 —á–∞—Å–∞)
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ JWT_SECRET –∏–∑ env
   - –¢–æ–∫–µ–Ω—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ headers, –Ω–µ –≤ URL

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**
   - –í—Å–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è
   - –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ (max 255 —Å–∏–º–≤–æ–ª–æ–≤)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ email –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
   - –ó–∞—â–∏—Ç–∞ –æ—Ç SQL injection —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

3. **Rate Limiting**
   - WebSocket: 5 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π/60 —Å–µ–∫ –Ω–∞ IP
   - API: 30 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É –Ω–∞ endpoint
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏

4. **CORS & Origin –ø—Ä–æ–≤–µ—Ä–∫–∞**
   - –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ origin –¥–ª—è WebSocket –≤ production

5. **–ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–µ—Å—Å–∏–π
   - –£–¥–∞–ª–µ–Ω–∏–µ event listeners
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ rate limiter

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ JWT_SECRET
openssl rand -base64 32

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTPS (Nginx)
server {
    listen 443 ssl http2;
    server_name ai-admin.app;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã companies

```sql
CREATE TABLE companies (
  id SERIAL PRIMARY KEY,
  yclients_id INTEGER UNIQUE NOT NULL,
  company_id INTEGER,
  title VARCHAR(255),
  phone VARCHAR(20),
  email VARCHAR(255),
  address TEXT,
  timezone VARCHAR(50) DEFAULT 'Europe/Moscow',
  whatsapp_enabled BOOLEAN DEFAULT false,
  whatsapp_connected BOOLEAN DEFAULT false,
  whatsapp_phone VARCHAR(20),
  whatsapp_connected_at TIMESTAMPTZ,
  ai_enabled BOOLEAN DEFAULT true,
  sync_enabled BOOLEAN DEFAULT true,
  integration_status VARCHAR(50) DEFAULT 'pending',
  api_key VARCHAR(255),
  raw_data JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_companies_yclients_id ON companies(yclients_id);
CREATE INDEX idx_companies_whatsapp_connected ON companies(whatsapp_connected);
```

### Redis —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
marketplace:token:{token} ‚Üí companyId (TTL: 24h)
marketplace:company:{companyId}:token ‚Üí token (TTL: 24h)
marketplace:qr:{companyId} ‚Üí {qr, generated_at} (TTL: 20s)
```

## üì± –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ**
   - –°–∞–ª–æ–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ YClients
   - YClients –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ `/marketplace/register`
   - –°–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–º–ø–∞–Ω–∏—è –≤ –ë–î, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è API –∫–ª—é—á

2. **–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ connect_url
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

3. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞**
   - Baileys —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é WhatsApp
   - QR-–∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket
   - –¢–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥

4. **–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WhatsApp –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
   - –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR —á–µ—Ä–µ–∑ "–°–≤—è–∑–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
   - WhatsApp –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

5. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**
   - Baileys –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –≤ –ë–î
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è callback –≤ YClients
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –î–∏–∞–≥—Ä–∞–º–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

```mermaid
sequenceDiagram
    participant YC as YClients
    participant API as AI Admin API
    participant WS as WebSocket
    participant QR as QR Generator
    participant WA as WhatsApp
    participant DB as Database

    YC->>API: POST /marketplace/register
    API->>DB: Create company
    API-->>YC: Return connect_url

    Note over YC,API: User clicks connect_url

    YC->>API: GET /marketplace/connect
    API-->>YC: HTML page
    YC->>WS: Connect WebSocket

    WS->>QR: Generate QR
    QR-->>WS: QR code
    WS-->>YC: Display QR

    Note over YC,WA: User scans QR

    WA->>QR: Authenticate
    QR->>DB: Update status
    QR->>WS: Send success
    WS-->>YC: Show success

    API->>YC: POST callback
    YC-->>API: 200 OK
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ —É—Ä–æ–≤–Ω—è–º–∏:

```javascript
logger.info('‚úÖ –ö–æ–º–ø–∞–Ω–∏—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞', { companyId, salonId });
logger.warn('Rate limit –ø—Ä–µ–≤—ã—à–µ–Ω –¥–ª—è IP:', clientIp);
logger.error('–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞:', error);
```

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

- **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket:** –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **Rate limit hits:** –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–π –ª–∏–º–∏—Ç–∞
- **QR –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:** –£—Å–ø–µ—à–Ω—ã–µ/–Ω–µ—É—Å–ø–µ—à–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- **WhatsApp –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:** –£—Å–ø–µ—à–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ —á–∞—Å
- **API –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ endpoints

### PM2 –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
pm2 status

# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
pm2 logs ai-admin-api

# –ú–µ—Ç—Ä–∏–∫–∏
pm2 monit

# Web dashboard
pm2 web
```

## üîß Troubleshooting

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

#### 1. QR-–∫–æ–¥ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º–∞ —Å Baileys —Å–µ—Å—Å–∏–µ–π

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –û—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏–∏
rm -rf sessions/company_*

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
pm2 restart ai-admin-api
```

#### 2. WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx

**–†–µ—à–µ–Ω–∏–µ:**
```nginx
# –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection 'upgrade';
```

#### 3. Rate limit —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–∏–∑–∫–∏–π –ª–∏–º–∏—Ç –¥–ª—è production

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
// –í marketplace-socket.js
this.RATE_LIMIT_MAX = 10; // –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 10
this.RATE_LIMIT_WINDOW = 60000; // –ó–∞ –º–∏–Ω—É—Ç—É
```

#### 4. JWT_SECRET –æ—à–∏–±–∫–∞

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –í .env —Ñ–∞–π–ª–µ
JWT_SECRET=your_very_long_secret_key_at_least_32_chars

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
echo $JWT_SECRET
```

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
redis-cli ping

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î
psql $DATABASE_URL -c "SELECT COUNT(*) FROM companies;"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -f ~/.pm2/logs/ai-admin-api-out.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç—ã
netstat -tlnp | grep 3000

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã
ps aux | grep node
```

## üìù –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ frontend

```javascript
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
async function connectWhatsApp(token, companyId) {
  const socket = io('/marketplace', {
    auth: { token },
    transportOptions: {
      polling: {
        extraHeaders: {
          'Authorization': `Bearer ${token}`
        }
      }
    },
    query: { companyId }
  });

  socket.on('connect', () => {
    console.log('Connected to server');
  });

  socket.on('qr-update', (data) => {
    // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å QR-–∫–æ–¥
    displayQR(data.qr);
  });

  socket.on('whatsapp-connected', (data) => {
    // –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—Ö
    showSuccess(data);
  });

  socket.on('error', (error) => {
    // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫—É
    handleError(error);
  });
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ backend

```javascript
const MarketplaceService = require('./services/marketplace/marketplace-service');

async function checkCompanyStatus(companyId) {
  const service = new MarketplaceService();
  await service.init();

  const company = await service.getCompany(companyId);

  if (company.whatsapp_connected) {
    console.log(`‚úÖ WhatsApp –ø–æ–¥–∫–ª—é—á–µ–Ω: ${company.whatsapp_phone}`);
  } else {
    console.log('‚ùå WhatsApp –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
  }

  return company;
}
```

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Production —á–µ–∫–ª–∏—Å—Ç

- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å HTTPS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Nginx reverse proxy
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å PM2 ecosystem
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±—ç–∫–∞–ø—ã –ë–î
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å rate limits
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ö–æ–º–∞–Ω–¥—ã –¥–µ–ø–ª–æ—è

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
git add .
git commit -m "Deploy: –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
git push origin main

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /opt/ai-admin
git pull
npm install --production
npm run migrate
pm2 restart ecosystem.config.js
pm2 save

# –ü—Ä–æ–≤–µ—Ä–∫–∞
curl https://ai-admin.app/health
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**Email:** support@ai-admin.app
**Telegram:** @ai_admin_support
**GitHub Issues:** https://github.com/vosarsen/ai_admin_v2/issues

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License - —Å–º. —Ñ–∞–π–ª LICENSE

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 16 —è–Ω–≤–∞—Ä—è 2025*
*–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: 1.0.0*