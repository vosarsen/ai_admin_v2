# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Two-Stage –ø—Ä–æ–º–ø—Ç–æ–≤

**–î–∞—Ç–∞:** 29 —Å–µ–Ω—Ç—è–±—Ä—è 2025
**–ê–≤—Ç–æ—Ä:** –ê—Ä—Å–µ–Ω
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤:** 1.0 ‚Üí 1.1

## ‚ö†Ô∏è –í–ê–ñ–ù–û–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–ï

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –î–í–ê —ç—Ç–∞–ø–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

1. **‚úÖ –í–´–ü–û–õ–ù–ï–ù–û:** –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–π (—Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 40%)
2. **üöß –†–ê–ó–†–ê–ë–û–¢–ê–ù–û, –ù–û –ù–ï –í–ù–ï–î–†–ï–ù–û:** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 50%)

–§–∞–π–ª—ã `context-optimizer.js` –∏ `response-templates.js` —Å–æ–∑–¥–∞–Ω—ã, –Ω–æ –µ—â–µ **–ù–ï –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã** –≤ production.

## üìä –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
| –ü—Ä–æ–º–ø—Ç | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ |
|--------|---------------|-------------------|------------|
| Stage 1 (Command) | 502 —Å—Ç—Ä–æ–∫ (~3,780 —Ç–æ–∫–µ–Ω–æ–≤) | 186 —Å—Ç—Ä–æ–∫ (~1,400 —Ç–æ–∫–µ–Ω–æ–≤) | **-63%** |
| Stage 2 (Response) | 459 —Å—Ç—Ä–æ–∫ (~4,080 —Ç–æ–∫–µ–Ω–æ–≤) | 393 —Å—Ç—Ä–æ–∫ (~3,500 —Ç–æ–∫–µ–Ω–æ–≤) | **-14%** |
| **–ò—Ç–æ–≥–æ** | 961 —Å—Ç—Ä–æ–∫ (~7,860 —Ç–æ–∫–µ–Ω–æ–≤) | 579 —Å—Ç—Ä–æ–∫ (~4,900 —Ç–æ–∫–µ–Ω–æ–≤) | **-40%** |

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|---------------|-------------------|-----------|
| Stage 1 | ~8 —Å–µ–∫—É–Ω–¥ | ~6.3 —Å–µ–∫—É–Ω–¥—ã | **-21%** |
| Stage 2 | ~5 —Å–µ–∫—É–Ω–¥ | ~3.2 —Å–µ–∫—É–Ω–¥—ã | **-36%** |
| **–û–±—â–µ–µ –≤—Ä–µ–º—è** | ~13 —Å–µ–∫—É–Ω–¥ | ~9.4 —Å–µ–∫—É–Ω–¥—ã | **-28%** |

## üéØ –ß—Ç–æ –±—ã–ª–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ

### Stage 1 - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥

1. **–£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**
   - –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏ (–±—ã–ª–æ 5 –±–ª–æ–∫–æ–≤, —Å—Ç–∞–ª 1)
   - –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥
   - –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

2. **–°–æ–∫—Ä–∞—â–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã:**
   - –° 12+ –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–æ 7 –∫–ª—é—á–µ–≤—ã—Ö
   - –£–¥–∞–ª–µ–Ω—ã –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è
   - –û—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –∫–µ–π—Å—ã

3. **–£–ø—Ä–æ—â–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:**
   - –£–±—Ä–∞–Ω—ã –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è "–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û"
   - –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã –ø–æ—Ö–æ–∂–∏–µ –ø—Ä–∞–≤–∏–ª–∞
   - –°–æ–∫—Ä–∞—â–µ–Ω—ã verbose –æ–ø–∏—Å–∞–Ω–∏—è

### Stage 2 - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤

1. **–ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã —à–∞–±–ª–æ–Ω—ã:**
   - –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —à–∞–±–ª–æ–Ω—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π
   - –£–ø—Ä–æ—â–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –°–æ–∫—Ä–∞—â–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤

2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª–∞:**
   - –£–¥–∞–ª–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø—Ä–æ SHOW_PRICES
   - –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
   - –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è

## ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:

- ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–æ–º–∞–Ω–¥ (SEARCH_SLOTS, CREATE_BOOKING, etc.)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É—Å–ª—É–≥–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–∞–º–∏ –∏ –≤—Ä–µ–º–µ–Ω–µ–º
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–µ–Ω –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

## üìÅ –§–∞–π–ª—ã

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `src/services/ai-admin-v2/prompts/two-stage-command-prompt.js`
- `src/services/ai-admin-v2/prompts/two-stage-response-prompt.js`

### –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:
- `src/services/ai-admin-v2/prompts/removed-duplications-backup.md`

## üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
```
–ö–ª–∏–µ–Ω—Ç: –ü—Ä–∏–≤–µ—Ç! –•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞
–ë–æ—Ç: –ê—Ä—Å–µ–Ω, –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –µ—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è...
–ö–ª–∏–µ–Ω—Ç: –î–∞–≤–∞–π –Ω–∞ 14:00
–ë–æ—Ç: –ó–∞–ø–∏—Å–∞–ª –≤–∞—Å –Ω–∞ –º—É–∂—Å–∫—É—é —Å—Ç—Ä–∏–∂–∫—É 30 —Å–µ–Ω—Ç—è–±—Ä—è –≤ 14:00 –∫ –°–µ—Ä–≥–µ—é
```

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- **Stage 1 (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥):** 6.274 —Å–µ–∫—É–Ω–¥—ã
- **Stage 2 (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞):** 3.167 —Å–µ–∫—É–Ω–¥—ã
- **–û–±—â–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:** 9.442 —Å–µ–∫—É–Ω–¥—ã
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ

## üí° –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

1. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–æ–≤:** –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 40% —Å–Ω–∏–∂–∞–µ—Ç –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ API –∏ —É—Å–∫–æ—Ä—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É
2. **–°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞:** –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 28% –¥–µ–ª–∞–µ—Ç –±–æ—Ç–∞ –±–æ–ª–µ–µ –æ—Ç–∑—ã–≤—á–∏–≤—ã–º
3. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞:** –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –ª–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å
4. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–π —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ –ª–æ–≥–∏–∫–µ

## üìà –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ –≤ production
2. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –°—Ä–∞–≤–Ω–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
3. **–î–∞–ª—å–Ω–µ–π—à–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –í–æ–∑–º–æ–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å Stage 1 –¥–æ 1,000-1,200 —Ç–æ–∫–µ–Ω–æ–≤
4. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## üîß –ö–∞–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å

### –í–∫–ª—é—á–∏—Ç—å two-stage —Ä–µ–∂–∏–º:
```bash
export USE_TWO_STAGE=true
export AI_PROMPT_VERSION=two-stage
pm2 restart ai-admin-worker-v2 --update-env
```

### –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Ä–µ–∂–∏–º—É:
```bash
unset USE_TWO_STAGE
export AI_PROMPT_VERSION=react-prompt
pm2 restart ai-admin-worker-v2 --update-env
```

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –í—Å–µ —É–¥–∞–ª–µ–Ω–Ω—ã–µ —á–∞—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ backup-—Ñ–∞–π–ª–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–≤—ã–µ 24-48 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ production