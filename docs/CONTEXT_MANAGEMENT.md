# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –¥–∏–∞–ª–æ–≥–∞ –≤ AI Admin v2

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –≤ AI Admin v2 –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- **30-–¥–Ω–µ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤
- **–ó–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π** –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ 1 –≥–æ–¥
- **–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤** –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É** —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –î–≤–æ–π–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
1. **Redis** - –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å TTL
   - –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞: 30 –¥–Ω–µ–π
   - –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: 365 –¥–Ω–µ–π
   - –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: 24 —á–∞—Å–∞
   
2. **Supabase** - –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
   - –¢–∞–±–ª–∏—Ü–∞ `dialog_contexts`
   - –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤
   - –ë–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

#### –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
```javascript
{
  phone: "79001234567",
  companyId: 962302,
  client: { /* –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ */ },
  lastMessages: [ /* –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π */ ],
  services: [ /* –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏ */ ],
  staff: [ /* —Å–ø–∏—Å–æ–∫ –º–∞—Å—Ç–µ—Ä–æ–≤ */ ],
  lastBooking: { /* –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å */ },
  preferences: { /* –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ */ },
  conversationSummary: { /* —Å–∞–º–º–∞—Ä–∏ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è */ }
}
```

#### –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
```javascript
{
  favoriteService: "–ú—É–∂—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞",
  favoriteStaff: "–°–µ—Ä–≥–µ–π",
  preferredTime: "evening", // morning/afternoon/evening/any
  lastBookingDate: "2025-07-25",
  notes: "–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç —Ç–∏—Ö—É—é –º—É–∑—ã–∫—É"
}
```

## üîß API ContextService

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

#### getContext(phone, companyId)
–ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞.

#### setContext(phone, companyId, contextData)
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç (—Ä–∞–Ω–µ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥).

#### updateContext(phone, companyId, update)
–û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.

#### savePreferences(phone, companyId, preferences)
–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ (—Ö—Ä–∞–Ω—è—Ç—Å—è 1 –≥–æ–¥).

#### getPreferences(phone, companyId)
–ü–æ–ª—É—á–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è.

#### canContinueConversation(phone, companyId)
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥ (–ø–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å < 24 —á–∞—Å–æ–≤).

#### getConversationSummary(phone, companyId)
–ü–æ–ª—É—á–∞–µ—Ç —Å–∞–º–º–∞—Ä–∏ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞.

#### clearOldContexts(daysToKeep = 30)
–û—á–∏—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã —Å—Ç–∞—Ä—à–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π.

#### markForFollowUp(phone, companyId, reason, followUpDate)
–ü–æ–º–µ—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞.

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:
- –õ—é–±–∏–º–∞—è —É—Å–ª—É–≥–∞
- –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π –º–∞—Å—Ç–µ—Ä
- –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–æ–µ –≤—Ä–µ–º—è –¥–Ω—è
- –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏

```javascript
// –í command-handler.js –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
if (context.phone && serviceName && staffName) {
  const preferences = {
    favoriteService: serviceName,
    favoriteStaff: staffName,
    preferredTime: determineTimePreference(params.time),
    lastBookingDate: parsedDate
  };
  
  await contextService.savePreferences(phone, companyId, preferences);
}
```

### –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤–µ—Ä–Ω—É–≤—à–∏—Ö—Å—è –∫–ª–∏–µ–Ω—Ç–æ–≤

AI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –û–±—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ –∏–º–µ–Ω–∏
- –ù–µ –∑–¥–æ—Ä–æ–≤–∞–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è
- –ú–æ–∂–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ª—é–±–∏–º—ã–µ —É—Å–ª—É–≥–∏/–º–∞—Å—Ç–µ—Ä–æ–≤
- –£—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞

### –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤:
- AI –≤–∏–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
- –ú–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å
- –ù–µ —Ç–µ—Ä—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏/–≤—Ä–µ–º–µ–Ω–∏

## üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ TTL

–í `src/services/context/index.js`:
```javascript
this.contextTTL = 30 * 24 * 60 * 60; // 30 –¥–Ω–µ–π
this.preferenceTTL = 365 * 24 * 60 * 60; // 1 –≥–æ–¥
this.shortTTL = 24 * 60 * 60; // 24 —á–∞—Å–∞
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞

1. **–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫**:
```bash
node scripts/cleanup-old-contexts.js --days=30
```

2. **–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫** (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è):
```bash
node scripts/cleanup-old-contexts.js --days=30 --dry-run
```

3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron** –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
ssh root@46.149.70.219
cd /opt/ai-admin
./scripts/setup-context-cleanup-cron.sh
```

–û—á–∏—Å—Ç–∫–∞ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 –Ω–æ—á–∏.

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
```javascript
const metrics = await contextService.getMetrics();
// {
//   memoryUsage: "125.5MB",
//   keys: 15234,
//   connected: true
// }
```

### –õ–æ–≥–∏ –æ—á–∏—Å—Ç–∫–∏
```bash
tail -f /opt/ai-admin/logs/context-cleanup.log
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:
```bash
node test-context-features.js
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç:
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∞–º–º–∞—Ä–∏
- –£—Å—Ç–∞–Ω–æ–≤–∫—É –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ü–æ–º–µ—Ç–∫—É –¥–ª—è follow-up
- –ú–µ—Ç—Ä–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–∞

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Redis –∏ Supabase**
   - Redis - –æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
   - Supabase - —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
   - –ü—Ä–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É Redis

2. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**
   - –ú–∞–∫—Å–∏–º—É–º 50 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏
   - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è 30 –¥–Ω–µ–π
   - –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è 1 –≥–æ–¥

3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∞ 5 –º–∏–Ω—É—Ç
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ò–Ω–¥–µ–∫—Å—ã –≤ Redis –ø–æ –∫–ª—é—á–∞–º

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ companyId
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π