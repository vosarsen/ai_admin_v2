# Задачи по онбордингу

## Выполнено (2025-12-04)

### Тестирование
- [x] Подключить салон 962302 через YClients маркетплейс
- [x] Пройти онбординг с QR-кодом
- [x] Подключить WhatsApp через Pairing Code
- [x] Отправить тестовое сообщение
- [x] Проверить AI обработку
- [x] Задокументировать результаты

### Исправленные баги
- [x] UTF-8 кодировка на странице онбординга (commit c5e70ba)
- [x] Отображение личных данных пользователя (commit 705c605)
- [x] JWT URL-safe base64 декодирование (commit 3ec9f33)
- [x] company_title не передавался в токен (commit 57cb7fa)
- [x] LID формат номеров (commit 5331a59) - частично

---

## В работе

### КРИТИЧЕСКИЙ: Отправка сообщений с LID
- [ ] Диагностировать почему фикс LID не работает
- [ ] Проверить что код обновился на сервере
- [ ] Добавить debug логи в `_formatPhone()`
- [ ] Проверить `_extractPhoneNumber()` - возможно удаляет нужный суффикс
- [ ] Тест: отправить напрямую через baileys-service

---

## Бэклог

### Улучшения онбординга
- [ ] Унифицировать формат company_id (`962302` vs `company_962302`)
- [ ] Исправить WebSocket уведомления (страница не обновляется после подключения)
- [ ] Автоматический редирект после успешного подключения
- [ ] Показывать название компании на странице (сейчас только ID)
- [ ] Добавить обработку ошибок на странице

### Архитектурные улучшения
- [ ] Рефакторинг: единый формат company_id во всех компонентах
- [ ] Добавить миграцию для унификации credentials в БД
- [ ] Документация: описать флоу онбординга полностью

### Тестирование
- [ ] Тест: подключение нового салона с нуля
- [ ] Тест: переподключение после отключения
- [ ] Тест: несколько салонов одновременно
- [ ] Тест: отправка сообщений на обычные номера (не LID)

---

## Технические детали

### Проблема LID

**Симптомы:**
- Входящие сообщения приходят с LID: `152926689472618`
- При отправке ответа - 400 ошибка
- Baileys требует формат `152926689472618@lid`

**Текущий фикс в `client.js`:**
```javascript
if (cleanPhone.length >= 15) {
  return `${cleanPhone}@lid`;
}
```

**Почему не работает (гипотезы):**
1. Код не обновился на сервере
2. `_extractPhoneNumber()` удаляет суффикс после форматирования
3. Где-то в цепочке происходит повторное форматирование

**Диагностика:**
```bash
# Проверить версию на сервере
ssh root@46.149.70.219 "cd /opt/ai-admin && git log -1 --oneline"

# Логи с форматированием
ssh root@46.149.70.219 "pm2 logs ai-admin-worker-v2 --lines 100 | grep -E 'formatPhone|@lid|cleanPhone'"

# Тест напрямую
curl -X POST http://localhost:3003/send \
  -d '{"phone":"152926689472618@lid","message":"Direct test"}'
```

### Формат company_id

**Где используется `962302`:**
- `.env` (`YCLIENTS_COMPANY_ID`)
- `baileys-service`
- `companies.company_id` в БД

**Где используется `company_962302`:**
- `whatsapp_auth.company_id`
- `whatsapp_keys.company_id`
- Сессии в `ai-admin-api`

**Рекомендация:**
Использовать `962302` везде. Убрать префикс `company_`.
