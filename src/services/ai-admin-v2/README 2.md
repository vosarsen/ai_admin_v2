# AI Admin v2 - Чистая архитектура

## Обзор

AI Admin v2 - это переработанная версия AI-ассистента для салонов красоты с чистой модульной архитектурой.

## Архитектура

### Основные модули

1. **index.js** - Главный класс AIAdminV2
   - Координирует работу всех модулей
   - Обрабатывает входящие сообщения
   - Управляет контекстом

2. **modules/error-handler.js** - Унифицированная обработка ошибок
   - Классификация ошибок
   - Retry логика с exponential backoff
   - User-friendly сообщения об ошибках
   - Поддержка разных типов ошибок (API, Booking, Validation, etc.)

3. **modules/response-processor.js** - Обработка ответов AI
   - Извлечение команд из текста
   - Очистка и форматирование ответов
   - Делегирование выполнения команд
   - Обработка ошибок команд

4. **modules/command-executor.js** - Выполнение команд
   - Централизованное выполнение всех команд
   - Интеграция с внешними сервисами
   - Форматирование результатов
   - Обработка специфичных команд

5. **modules/message-processor.js** - Вспомогательная обработка сообщений
   - Обработка pending состояний
   - Загрузка и сохранение контекста
   - Проверка предыдущих обработок
   - Форматирование ошибок

## Поток обработки

```
Входящее сообщение
    ↓
AIAdminV2.processMessage()
    ↓
MessageProcessor (проверки и загрузка контекста)
    ↓
AI Provider (через ProviderFactory)
    ↓
ResponseProcessor.processAIResponse()
    ↓
CommandExecutor.executeCommands()
    ↓
Форматирование и отправка ответа
```

## Команды

Система поддерживает следующие команды:

- `SEARCH_SLOTS` - Поиск доступных слотов
- `CREATE_BOOKING` - Создание записи
- `SHOW_PRICES` - Показ цен на услуги
- `SHOW_PORTFOLIO` - Показ портфолио
- `SAVE_CLIENT_NAME` - Сохранение имени клиента
- `CANCEL_BOOKING` - Отмена записи
- `RESCHEDULE_BOOKING` - Перенос записи
- `SHOW_BOOKINGS` - Показ записей клиента

## Обработка ошибок

### Типы ошибок

1. **ValidationError** - Ошибки валидации данных
2. **APIError** - Ошибки внешних API
3. **BookingError** - Ошибки при работе с записями
4. **ContextError** - Ошибки работы с контекстом
5. **NetworkError** - Сетевые ошибки (retry-able)

### Retry механизм

Для сетевых и временных ошибок применяется retry с exponential backoff:

```javascript
// Конфигурация по умолчанию
{
  maxAttempts: 3,
  initialDelay: 1000,  // 1 секунда
  maxDelay: 10000,     // 10 секунд  
  backoffFactor: 2
}
```

## Тестирование

### Запуск тестов

```bash
# Все тесты
npm test

# Только модули
npm test -- modules/

# С покрытием
npm test -- --coverage
```

### Структура тестов

- `modules/__tests__/error-handler.test.js` - Тесты обработки ошибок
- `modules/__tests__/response-processor.test.js` - Тесты обработки ответов
- `modules/__tests__/command-executor.test.js` - Тесты выполнения команд

## Конфигурация

### Переменные окружения

- `AI_PROVIDER` - Провайдер AI (deepseek/qwen)
- `AI_PROMPT_VERSION` - Версия промпта
- `AI_PROMPT_AB_TEST` - A/B тестирование промптов

### AI Провайдеры

Система поддерживает несколько AI провайдеров:

1. **DeepSeek** (по умолчанию)
2. **Qwen** - Быстрая модель
3. **Qwen-72B** - Умная модель для сложных задач

Переключение:
```bash
AI_PROVIDER=qwen npm start
```

## Метрики и мониторинг

Система собирает следующие метрики:

- Время ответа AI
- Успешность выполнения команд
- Статистика использования промптов
- Частота ошибок по типам

## Лучшие практики

1. **Модульность** - Каждый модуль отвечает за одну задачу
2. **Обработка ошибок** - Используйте ErrorHandler для всех ошибок
3. **Логирование** - Логируйте важные события с контекстом
4. **Тестирование** - Пишите тесты для новых функций
5. **Документация** - Обновляйте README при изменениях

## Развертывание

```bash
# Локально
npm run dev

# Production
pm2 start ecosystem.config.js
```

## Дальнейшие улучшения

1. Добавить метрики производительности
2. Реализовать кэширование команд
3. Добавить webhook для мониторинга
4. Улучшить обработку контекста
5. Добавить поддержку голосовых сообщений