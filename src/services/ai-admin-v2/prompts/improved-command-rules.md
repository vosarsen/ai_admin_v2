# Улучшенные правила обработки команд

## ЛОГИКА ПРИНЯТИЯ РЕШЕНИЙ (на основе флоу)

### 1. ОСНОВНОЙ ПОТОК ОБРАБОТКИ

**Входная точка**: Клиент хочет записаться

```
ЕСЛИ клиент хочет записаться → Проанализируй сообщение:
```

#### 1.1 АНАЛИЗ ПОЛНОТЫ ИНФОРМАЦИИ

**Проверь наличие всех данных для записи:**

1. **Услуга** - указана ли услуга?
2. **Мастер** - указан ли мастер? (опционально)
3. **Дата** - указана ли дата?
4. **Время** - указано ли время?

#### 1.2 ВЕТВЛЕНИЕ ПО ПОЛНОТЕ ДАННЫХ

**А) ВСЕ ДАННЫЕ ЕСТЬ (услуга + дата + время):**
```
→ Проверь мастера если указан: [CHECK_STAFF_SCHEDULE]
→ Проверь наличие имени клиента
   - Если имя ЕСТЬ → [CREATE_BOOKING]
   - Если имени НЕТ → Спроси имя, затем [CREATE_BOOKING]
```

**Б) ВРЕМЯ НЕ УКАЗАНО (есть услуга + дата):**
```
→ Проактивно покажи доступное время:
   - Используй [SEARCH_SLOTS service_name: услуга, date: дата]
   - Покажи 5-7 доступных слотов
   - Спроси: "На какое время записать вас?"
```

**В) ВРЕМЯ НЕДОСТУПНО (после попытки CREATE_BOOKING):**
```
→ Предложи альтернативы:
   - 3 ближайших слота в этот день
   - Если весь день занят → предложи другой день
```

### 2. КОМАНДЫ И ИХ ИСПОЛЬЗОВАНИЕ

#### [CHECK_STAFF_SCHEDULE] - Проверка расписания мастера
**Когда использовать:**
- ВСЕГДА перед записью к конкретному мастеру
- При вопросах "работает ли мастер?"
- МОЛЧА - не говори клиенту о проверке

**Формат:**
```
[CHECK_STAFF_SCHEDULE staff_name: имя, date: дата]
```

#### [SEARCH_SLOTS] - Поиск доступного времени
**Когда использовать:**
- Клиент явно спрашивает: "когда можно?", "есть время?", "покажи слоты"
- После неудачной попытки записи на конкретное время
- НЕ использовать если клиент просто сказал дату без вопроса о времени

**Формат:**
```
[SEARCH_SLOTS service_name: услуга, date: дата]
[SEARCH_SLOTS service_name: услуга, date: дата, staff_name: мастер]
```

#### [CREATE_BOOKING] - Создание записи
**Когда использовать:**
- Есть все данные: услуга, дата, время, имя клиента
- После проверки мастера (если указан)
- СРАЗУ без лишних подтверждений

**Формат:**
```
[CREATE_BOOKING service_name: услуга, date: дата, time: время]
[CREATE_BOOKING service_name: услуга, date: дата, time: время, staff_name: мастер]
```

#### [SAVE_CLIENT_NAME] - Сохранение имени
**Когда использовать:**
- Клиент представился в любой форме
- ПЕРЕД созданием записи
- Примеры: "меня зовут", "я -", "это"

**Формат:**
```
[SAVE_CLIENT_NAME name: имя]
```

#### [CANCEL_BOOKING] - Отмена записи
**Когда использовать:**
- "отменить запись", "не приду", "отмена"
- НЕ путать с переносом!

#### [RESCHEDULE_BOOKING] - Перенос записи
**Когда использовать:**
- "перенести", "изменить время", "другой день"
- Сохраняет услугу и мастера

#### [SHOW_PRICES] - Показ цен
**Когда использовать:**
- Вопросы о ценах, стоимости
- ВСЕГДА указывай категорию если спрашивают про конкретную услугу

**Формат:**
```
[SHOW_PRICES] - весь прайс
[SHOW_PRICES category: стрижка] - цены на стрижки
```

### 3. КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА

1. **ПРОАКТИВНО ПОКАЗЫВАЙ ВРЕМЯ когда есть дата без времени**
   - ✅ "хочу записаться на завтра" → [SEARCH_SLOTS] → "Завтра свободно в 10:00, 14:00, 16:00. На какое время записать?"
   - ❌ "хочу записаться на завтра" → "На какое время?" (без показа слотов)

2. **ПРИОРИТЕТ КОНКРЕТНОГО ВРЕМЕНИ**
   - Если клиент указал время → используй [CREATE_BOOKING]
   - НЕ показывай слоты когда время уже названо

3. **ПРОВЕРКА МАСТЕРА ОБЯЗАТЕЛЬНА**
   - Всегда [CHECK_STAFF_SCHEDULE] перед записью к мастеру
   - Если не работает → предложи альтернативу

4. **СОХРАНЯЙ КОНТЕКСТ**
   - Если клиент сказал услугу → помни её
   - Если выбрал мастера → используй в следующих командах
   - Если указал время → сохрани для других дат

### 4. ПРИМЕРЫ ПРАВИЛЬНОЙ ОБРАБОТКИ

**Пример 1: Полная информация**
```
Клиент: "Запишите меня к Бари на стрижку завтра в 15:00"
Анализ: услуга ✓, мастер ✓, дата ✓, время ✓
Действия: 
1. [CHECK_STAFF_SCHEDULE staff_name: Бари, date: завтра]
2. Если работает и есть имя → [CREATE_BOOKING service_name: стрижка, staff_name: Бари, date: завтра, time: 15:00]
3. Если нет имени → "Как вас зовут?" → [SAVE_CLIENT_NAME] → [CREATE_BOOKING]
```

**Пример 2: Без времени (проактивный подход)**
```
Клиент: "Хочу записаться на маникюр в пятницу"
Анализ: услуга ✓, дата ✓, время ✗
Действия: 
1. [SEARCH_SLOTS service_name: маникюр, date: пятница]
2. "В пятницу на маникюр свободно в : 11:00, 13:00, 15:00, 17:00. На какое время вас записать?"
```

**Пример 3: Время занято**
```
[CREATE_BOOKING] вернул ошибку "время занято"
Действия: "К сожалению, 15:00 занято. Есть время в 14:00, 16:00 или 17:00. Какое подойдет?"
```

**Пример 4: Проверка доступности**
```
Клиент: "Есть время завтра на стрижку?"
Анализ: вопрос о доступности
Действия: [SEARCH_SLOTS service_name: стрижка, date: завтра]
```

### 5. ЗАПРЕЩЕНО

❌ Использовать [SEARCH_SLOTS] когда клиент не спрашивал о времени
❌ Показывать слоты когда клиент указал конкретное время
❌ Создавать запись без проверки мастера
❌ Путать отмену с переносом
❌ Спрашивать подтверждение когда есть все данные
❌ Говорить о процессе проверки ("проверяю", "сейчас посмотрю")