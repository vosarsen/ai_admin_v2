const config = require('../../config');
const logger = require('../../utils/logger').child({ module: 'ai-admin-v2' });

// Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¼Ð¾Ð´ÑƒÐ»Ð¸
const dataLoader = require('./modules/data-loader');
const formatter = require('./modules/formatter');
const businessLogic = require('./modules/business-logic');
const commandHandler = require('./modules/command-handler');
const contextService = require('../context');

/**
 * AI Admin v2 - ÐµÐ´Ð¸Ð½Ñ‹Ð¹ ÑÐµÑ€Ð²Ð¸Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ AI Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼
 * Ð—Ð°Ð¼ÐµÐ½ÑÐµÑ‚ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñƒ Ñ 5-6 ÑÑ‚Ð°Ð¿Ð°Ð¼Ð¸ Ð½Ð° Ð¾Ð´Ð¸Ð½ AI Ð²Ñ‹Ð·Ð¾Ð²
 */
class AIAdminV2 {
  constructor() {
    this.contextCache = new Map();
    this.cacheTimeout = 5 * 60 * 1000; // 5 Ð¼Ð¸Ð½ÑƒÑ‚
    
    // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÑƒ ÐºÐµÑˆÐ°
    setInterval(() => this.cleanupCache(), 60 * 1000); // ÐºÐ°Ð¶Ð´ÑƒÑŽ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
  }

  /**
   * ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
   */
  async processMessage(message, phone, companyId) {
    try {
      logger.info(`ðŸ¤– AI Admin v2 processing: "${message}" from ${phone}`);
      
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‰Ð°Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ð°
      const contextService = require('../context');
      const redisContext = await contextService.getContext(phone.replace('@c.us', ''));
      
      if (redisContext?.pendingCancellation) {
        // ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¸Ð½Ñ‚ÐµÑ€Ð¿Ñ€ÐµÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ°Ðº Ð½Ð¾Ð¼ÐµÑ€ Ð·Ð°Ð¿Ð¸ÑÐ¸
        const selectedNumber = parseInt(message.trim());
        
        if (!isNaN(selectedNumber) && selectedNumber > 0 && selectedNumber <= redisContext.pendingCancellation.length) {
          // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ
          const selectedBooking = redisContext.pendingCancellation[selectedNumber - 1];
          
          // ÐžÑ‚Ð¼ÐµÐ½ÑÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ
          const cancelResult = await bookingService.cancelBooking(selectedBooking.id, companyId);
          
          // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ
          delete redisContext.pendingCancellation;
          await contextService.setContext(phone.replace('@c.us', ''), redisContext);
          
          if (cancelResult.success) {
            return `âœ… Ð—Ð°Ð¿Ð¸ÑÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°!\n\n${selectedBooking.date} Ð² ${selectedBooking.time}\n${selectedBooking.services}\nÐœÐ°ÑÑ‚ÐµÑ€: ${selectedBooking.staff}\n\nÐ•ÑÐ»Ð¸ Ð·Ð°Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ ÑÐ½Ð¾Ð²Ð° - Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ð¹Ñ‚ÐµÑÑŒ! ðŸ˜Š`;
          } else {
            return `âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ: ${cancelResult.error}\n\nÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ Ð¸Ð»Ð¸ ÑÐ²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼.`;
          }
        }
        
        // Ð•ÑÐ»Ð¸ Ð²Ð²ÐµÐ»Ð¸ Ð½Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð¸Ð»Ð¸ Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ - Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ Ð¾Ð±Ñ‹Ñ‡Ð½ÑƒÑŽ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ
        // Ð½Ð¾ Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ
        delete redisContext.pendingCancellation;
        await contextService.setContext(phone.replace('@c.us', ''), redisContext);
      }
      
      // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚
      const context = await this.loadFullContext(phone, companyId);
      
      // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚
      context.currentMessage = message;
      
      // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ Ð±Ð¸Ð·Ð½ÐµÑÐ° Ð´Ð»Ñ Ð°Ð´Ð°Ð¿Ñ‚Ð°Ñ†Ð¸Ð¸ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
      const businessType = businessLogic.detectBusinessType(context.company);
      context.company.type = businessType;
      logger.info(`Business type detected: ${businessType}`);
      
      // Ð¡Ñ‚Ñ€Ð¾Ð¸Ð¼ ÑƒÐ¼Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ñ Ð¿Ð¾Ð»Ð½Ñ‹Ð¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼
      const prompt = this.buildSmartPrompt(message, context, phone);
      
      // ÐžÐ´Ð¸Ð½ Ð²Ñ‹Ð·Ð¾Ð² AI ÑÐ¾ Ð²ÑÐµÐ¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹
      const aiResponse = await this.callAI(prompt);
      
      // ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
      const result = await this.processAIResponse(aiResponse, context);
      
      // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°
      await dataLoader.saveContext(phone, companyId, context, result);
      
      logger.info(`âœ… AI Admin v2 completed in ${Date.now() - context.startTime}ms`);
      
      return {
        success: true,
        response: result.response,
        commands: result.executedCommands
      };
      
    } catch (error) {
      logger.error('Error in AI Admin v2:', error);
      return {
        success: false,
        response: 'Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.',
        error: error.message
      };
    }
  }

  /**
   * Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° (Ñ ÐºÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼)
   */
  async loadFullContext(phone, companyId) {
    const cacheKey = `${phone}_${companyId}`;
    const cached = this.contextCache.get(cacheKey);
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐµÑˆ
    if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
      logger.info('Using cached context');
      return { ...cached.data, startTime: Date.now() };
    }
    
    logger.info('Loading full context from database...');
    const startTime = Date.now();
    
    // ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð²ÑÐµÑ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
    const [company, client, services, staff, conversation, businessStats, staffSchedules, redisContext] = await Promise.all([
      dataLoader.loadCompany(companyId),
      dataLoader.loadClient(phone, companyId),
      dataLoader.loadServices(companyId),
      dataLoader.loadStaff(companyId),
      dataLoader.loadConversation(phone, companyId),
      dataLoader.loadBusinessStats(companyId),
      dataLoader.loadStaffSchedules(companyId),
      contextService.getContext(phone.replace('@c.us', ''))
    ]);
    
    // Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð½ÐµÑ‚ Ð² Ð±Ð°Ð·Ðµ, Ð½Ð¾ ÐµÑÑ‚ÑŒ Ð¸Ð¼Ñ Ð² Redis - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÐµÐ³Ð¾
    if (!client && redisContext?.clientName) {
      client = {
        phone: phone.replace('@c.us', ''),
        name: redisContext.clientName,
        company_id: companyId
      };
    } else if (client && !client.name && redisContext?.clientName) {
      // Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÐµÑÑ‚ÑŒ, Ð½Ð¾ Ð¸Ð¼Ñ Ð½Ðµ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾ - Ð±ÐµÑ€ÐµÐ¼ Ð¸Ð· Redis
      client.name = redisContext.clientName;
    }
    
    // Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑƒÑÐ»ÑƒÐ³Ð¸ Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ñ‡Ñ‚ÐµÐ½Ð¸Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
    const sortedServices = businessLogic.sortServicesForClient(services, client);
    
    const context = {
      company,
      client,
      services: sortedServices,
      staff,
      conversation,
      businessStats,
      staffSchedules,
      currentTime: new Date().toLocaleString('ru-RU', { timeZone: config.app.timezone }),
      timezone: config.app.timezone,
      phone,
      startTime,
      currentMessage: null  // Ð±ÑƒÐ´ÐµÑ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð² processMessage
    };
    
    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² ÐºÐµÑˆ
    this.contextCache.set(cacheKey, {
      data: context,
      timestamp: Date.now()
    });
    
    logger.info(`Context loaded in ${Date.now() - startTime}ms`);
    return context;
  }

  /**
   * ÐŸÐ¾ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ðµ ÑƒÐ¼Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚Ð° Ñ Ð¿Ð¾Ð»Ð½Ñ‹Ð¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼
   */
  buildSmartPrompt(message, context, phone) {
    const terminology = businessLogic.getBusinessTerminology(context.company.type);
    
    return `Ð¢Ñ‹ - ${terminology.role} "${context.company.title}".

Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð¯ Ðž Ð¡ÐÐ›ÐžÐÐ•:
ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ: ${context.company.title}
ÐÐ´Ñ€ÐµÑ: ${context.company.address || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}
Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: ${context.company.phone || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}
Ð§Ð°ÑÑ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹: ${formatter.formatWorkingHours(context.company.working_hours || {})}
Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ ÑÐµÐ³Ð¾Ð´Ð½Ñ: ${context.businessStats.todayLoad}% (${context.businessStats.bookedSlots}/${context.businessStats.totalSlots} ÑÐ»Ð¾Ñ‚Ð¾Ð²)

ÐšÐ›Ð˜Ð•ÐÐ¢:
${context.client ? 
  `Ð˜Ð¼Ñ: ${context.client.name || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾'}
Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: ${phone}
Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ: ${formatter.formatVisitHistory(context.client.visit_history)}
Ð›ÑŽÐ±Ð¸Ð¼Ñ‹Ðµ ÑƒÑÐ»ÑƒÐ³Ð¸: ${context.client.last_service_ids?.join(', ') || 'Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…'}
Ð›ÑŽÐ±Ð¸Ð¼Ñ‹Ðµ Ð¼Ð°ÑÑ‚ÐµÑ€Ð°: ${context.client.favorite_staff_ids?.join(', ') || 'Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…'}` :
  `ÐÐ¾Ð²Ñ‹Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚, Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½: ${phone}
Ð’ÐÐ–ÐÐž: Ð£ Ð½Ð°Ñ Ð½ÐµÑ‚ Ð¸Ð¼ÐµÐ½Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð² Ð±Ð°Ð·Ðµ!`}

Ð”ÐžÐ¡Ð¢Ð£ÐŸÐÐ«Ð• Ð£Ð¡Ð›Ð£Ð“Ð˜ (Ñ‚Ð¾Ð¿-10):
${formatter.formatServices(context.services.slice(0, 10), context.company.type)}

ÐœÐÐ¡Ð¢Ð•Ð Ð Ð¡Ð•Ð“ÐžÐ”ÐÐ¯:
${formatter.formatTodayStaff(context.staffSchedules, context.staff)}

Ð ÐÐ¡ÐŸÐ˜Ð¡ÐÐÐ˜Ð• ÐœÐÐ¡Ð¢Ð•Ð ÐžÐ’ (Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐ¸Ðµ Ð´Ð½Ð¸):
${formatter.formatStaffSchedules(context.staffSchedules, context.staff)}

Ð˜Ð¡Ð¢ÐžÐ Ð˜Ð¯ Ð”Ð˜ÐÐ›ÐžÐ“Ð:
${formatter.formatConversation(context.conversation)}

Ð¢Ð•ÐšÐ£Ð©Ð•Ð• Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð•: "${message}"

ÐÐÐÐ›Ð˜Ð— ÐÐÐœÐ•Ð Ð•ÐÐ˜Ð¯ ÐšÐ›Ð˜Ð•ÐÐ¢Ð:
ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‡ÐµÑ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚, Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ.

Ð’ÐÐ–ÐÐž: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ, Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð¸Ð»ÑÑ Ð»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð² ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸:
- "ÐœÐµÐ½Ñ Ð·Ð¾Ð²ÑƒÑ‚ [Ð¸Ð¼Ñ]" â†’ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸ Ð¸Ð¼Ñ Ñ‡ÐµÑ€ÐµÐ· [SAVE_CLIENT_NAME]
- "Ð¯ - [Ð¸Ð¼Ñ]" â†’ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸ Ð¸Ð¼Ñ Ñ‡ÐµÑ€ÐµÐ· [SAVE_CLIENT_NAME]
- "Ð­Ñ‚Ð¾ [Ð¸Ð¼Ñ]" â†’ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸ Ð¸Ð¼Ñ Ñ‡ÐµÑ€ÐµÐ· [SAVE_CLIENT_NAME]
- "[Ð¸Ð¼Ñ]" (Ð² Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾Ñ "ÐºÐ°Ðº Ð²Ð°Ñ Ð·Ð¾Ð²ÑƒÑ‚?") â†’ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸ Ð¸Ð¼Ñ Ñ‡ÐµÑ€ÐµÐ· [SAVE_CLIENT_NAME]

1. Ð—ÐÐŸÐ˜Ð¡Ð¬ ÐÐ Ð£Ð¡Ð›Ð£Ð“Ð£ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [SEARCH_SLOTS] ÐºÐ¾Ð³Ð´Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚:
   - "Ñ…Ð¾Ñ‡Ñƒ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ", "Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ", "Ð·Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð¼ÐµÐ½Ñ"
   - "Ð½ÑƒÐ¶Ð½Ð° Ð·Ð°Ð¿Ð¸ÑÑŒ", "Ñ…Ð¾Ñ‡Ñƒ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸", "Ð¼Ð¾Ð¶Ð½Ð¾ Ðº Ð²Ð°Ð¼"
   - "Ñ…Ð°Ñ‡Ñƒ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ", "Ð·Ð°Ð¿Ð¸ÑˆÐ¸ Ð¿Ð»Ð·", "Ð¼Ð¾Ð¶Ð½Ð° Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ" (Ñ Ð¾Ð¿ÐµÑ‡Ð°Ñ‚ÐºÐ°Ð¼Ð¸)
   - ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ð¿Ñ€Ð¾ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ ÑƒÑÐ»ÑƒÐ³Ñƒ Ñ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸ÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÐ¸
   
2. ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð’Ð Ð•ÐœÐ•ÐÐ˜ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [SEARCH_SLOTS] ÐºÐ¾Ð³Ð´Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚:
   - "ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾ Ð·Ð°Ð²Ñ‚Ñ€Ð°?", "ÐµÑÑ‚ÑŒ Ð²Ñ€ÐµÐ¼Ñ?", "ÐºÐ¾Ð³Ð´Ð° Ð¼Ð¾Ð¶Ð½Ð¾?"
   - "Ñ‡Ñ‚Ð¾ ÐµÑÑ‚ÑŒ Ð½Ð° Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ñ…?", "Ð¼Ð¾Ð¶Ð½Ð¾ Ð²ÐµÑ‡ÐµÑ€Ð¾Ð¼?"
   - "ÐºÐ°Ð´Ð° Ð¼Ð¾Ð¶Ð½Ð°", "ÐµÑÑ‚ÑŒ Ñ‡Ðµ Ð½Ð° Ð·Ð°Ð²Ñ‚Ñ€Ð°" (Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ)
   - "Ð¼Ð¾Ð¶Ð½Ð¾ Ð² Ð¿ÑÑ‚Ð½Ð¸Ñ†Ñƒ ÑƒÑ‚Ñ€Ð¾Ð¼?", "Ð²ÐµÑ‡ÐµÑ€Ð¾Ð¼ ÑÐµÐ³Ð¾Ð´Ð½Ñ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾?"
   - Ð»ÑŽÐ±Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸/ÑÐ»Ð¾Ñ‚Ð¾Ð²
   
3. Ð¦Ð•ÐÐ« - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [SHOW_PRICES] ÐºÐ¾Ð³Ð´Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚:
   - "ÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ð¾Ð¸Ñ‚", "ÐºÐ°ÐºÐ¸Ðµ Ñ†ÐµÐ½Ñ‹", "Ð¿Ñ€Ð°Ð¹Ñ"
   - "ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ", "Ñ†ÐµÐ½Ð° Ð½Ð°", "Ð¿Ð¾Ñ‡ÐµÐ¼"
   - "ÑÐºÐ¾Ðº ÑÑ‚Ð¾Ð¸Ñ‚", "Ñ‡Ðµ Ð¿Ð¾ Ñ†ÐµÐ½Ð°Ð¼", "ÑÐºÐ¾Ðº Ñ‰Ð°Ñ ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°" (Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ)
   
4. ÐŸÐžÐ”Ð¢Ð’Ð•Ð Ð–Ð”Ð•ÐÐ˜Ð• Ð—ÐÐŸÐ˜Ð¡Ð˜ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [CREATE_BOOKING] ÐºÐ¾Ð³Ð´Ð°:
   - ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð²Ñ‹Ð±Ñ€Ð°Ð» ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð° ÑÐ»Ð¾Ñ‚Ð¾Ð²
   - ÐµÑÑ‚ÑŒ Ð²ÑÑ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ: ÑƒÑÐ»ÑƒÐ³Ð°, Ð¼Ð°ÑÑ‚ÐµÑ€, Ð´Ð°Ñ‚Ð° Ð¸ Ð²Ñ€ÐµÐ¼Ñ
   
5. Ð ÐÐ‘ÐžÐ¢Ð« ÐœÐÐ¡Ð¢Ð•Ð Ð - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [SHOW_PORTFOLIO] ÐºÐ¾Ð³Ð´Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚:
   - "Ð¿Ð¾ÐºÐ°Ð¶Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹", "ÐµÑÑ‚ÑŒ Ñ„Ð¾Ñ‚Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚", "Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñ‹"
   - "Ñ‡Ñ‚Ð¾ ÑƒÐ¼ÐµÐµÑ‚ Ð¼Ð°ÑÑ‚ÐµÑ€", "Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾"
   
6. ÐœÐžÐ˜ Ð—ÐÐŸÐ˜Ð¡Ð˜ - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°:
   - "Ð¼Ð¾Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸", "ÐºÐ¾Ð³Ð´Ð° Ñ Ð·Ð°Ð¿Ð¸ÑÐ°Ð½", "Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ"
   - "Ð²Ð¾ ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ñ Ð·Ð°Ð¿Ð¸ÑÐ°Ð½?", "Ð¿Ð¾ÐºÐ°Ð¶Ð¸ Ð¼Ð¾Ð¸ Ð²Ð¸Ð·Ð¸Ñ‚Ñ‹"
   
7. ÐžÐ¢ÐœÐ•ÐÐ Ð—ÐÐŸÐ˜Ð¡Ð˜ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [CANCEL_BOOKING] ÐºÐ¾Ð³Ð´Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚:
   - "Ð¾Ñ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ", "Ð¾Ñ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð²Ð¸Ð·Ð¸Ñ‚"
   - "ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ", "ÑÐ½ÑÑ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ"
   - "Ð¾Ñ‚Ð¼ÐµÐ½Ð°", "Ð¾Ñ‚Ð¼ÐµÐ½ÑÑŽ" (Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸)
   
8. ÐŸÐžÐ”Ð¢Ð’Ð•Ð Ð–Ð”Ð•ÐÐ˜Ð• Ð—ÐÐŸÐ˜Ð¡Ð˜ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [CONFIRM_BOOKING] ÐºÐ¾Ð³Ð´Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚:
   - "Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ", "Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÑŽ", "Ð´Ð°, Ð¿Ñ€Ð¸Ð´Ñƒ"
   - "Ð±ÑƒÐ´Ñƒ", "Ð¶Ð´Ñƒ", "Ð´Ð¾ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð¸" (Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸)
   - "Ð²ÑÐµ Ð²ÐµÑ€Ð½Ð¾", "Ð´Ð°" (Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð·Ð°Ð¿Ð¸ÑÐ¸)
   
9. ÐÐ•Ð¯Ð’ÐšÐ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [MARK_NO_SHOW] ÐºÐ¾Ð³Ð´Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚:
   - "Ð½Ðµ ÑÐ¼Ð¾Ð³Ñƒ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸", "Ð½Ðµ Ð¿Ñ€Ð¸Ð´Ñƒ", "Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑÑ"
   - "Ð·Ð°Ð±Ð¾Ð»ÐµÐ»", "Ð¾Ð¿Ð¾Ð·Ð´Ð°ÑŽ Ð±Ð¾Ð»ÑŒÑˆÐµ 15 Ð¼Ð¸Ð½ÑƒÑ‚"
   - "Ð¿ÐµÑ€ÐµÐ½ÐµÑÑ‚Ð¸ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ð´ÐµÐ½ÑŒ" (ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ñ‚Ð¼ÐµÑ‚ÑŒ Ð½ÐµÑÐ²ÐºÑƒ, Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð½Ð¾Ð²Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ)

Ð¢Ð’ÐžÐ˜ ÐšÐžÐœÐÐÐ”Ð« (Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—Ð£Ð™ Ð¢ÐžÐ§ÐÐž Ð¢ÐÐšÐžÐ™ Ð¤ÐžÐ ÐœÐÐ¢):
1. [SEARCH_SLOTS service_name: Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ_ÑƒÑÐ»ÑƒÐ³Ð¸, date: Ð´Ð°Ñ‚Ð°, time_preference: Ð²Ñ€ÐµÐ¼Ñ] - Ð¿Ð¾Ð¸ÑÐº ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
   Ð’ÐÐ–ÐÐž: Ð’ service_name Ð¿Ð¸ÑˆÐ¸ Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ ÑÐºÐ°Ð·Ð°Ð» ÐºÐ»Ð¸ÐµÐ½Ñ‚, Ð° ÐÐ• Ñ‚Ð¾Ñ‡Ð½Ð¾Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÐ»ÑƒÐ³Ð¸ Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ°!
   ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
   - ÐšÐ»Ð¸ÐµÐ½Ñ‚: "Ñ…Ð¾Ñ‡Ñƒ Ð¿Ð¾ÑÑ‚Ñ€Ð¸Ñ‡ÑŒÑÑ" â†’ [SEARCH_SLOTS service_name: ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°, date: ÑÐµÐ³Ð¾Ð´Ð½Ñ]  
   - ÐšÐ»Ð¸ÐµÐ½Ñ‚: "Ð½ÑƒÐ¶ÐµÐ½ Ð¼Ð°Ð½Ð¸ÐºÑŽÑ€" â†’ [SEARCH_SLOTS service_name: Ð¼Ð°Ð½Ð¸ÐºÑŽÑ€, date: ÑÐµÐ³Ð¾Ð´Ð½Ñ]
   - ÐšÐ»Ð¸ÐµÐ½Ñ‚: "Ð¿Ð¾ÐºÑ€Ð°ÑÐ¸Ñ‚ÑŒ Ð²Ð¾Ð»Ð¾ÑÑ‹" â†’ [SEARCH_SLOTS service_name: Ð¾ÐºÑ€Ð°ÑˆÐ¸Ð²Ð°Ð½Ð¸Ðµ, date: ÑÐµÐ³Ð¾Ð´Ð½Ñ]
   - ÐÐ• ÐŸÐ˜Ð¨Ð˜: [SEARCH_SLOTS service_name: ÐœÐ£Ð–Ð¡ÐšÐÐ¯ Ð¡Ð¢Ð Ð˜Ð–ÐšÐ] - ÑÐ¸ÑÑ‚ÐµÐ¼Ð° ÑÐ°Ð¼Ð° Ð½Ð°Ð¹Ð´ÐµÑ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½ÑƒÑŽ ÑƒÑÐ»ÑƒÐ³Ñƒ
   
2. [CREATE_BOOKING service_id: id_ÑƒÑÐ»ÑƒÐ³Ð¸, staff_id: id_Ð¼Ð°ÑÑ‚ÐµÑ€Ð°, date: Ð´Ð°Ñ‚Ð°, time: Ð²Ñ€ÐµÐ¼Ñ] - ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸
   Ð’ÐÐ–ÐÐž: Ð•ÑÐ»Ð¸ Ñ‚Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ð°Ð» ÑÐ»Ð¾Ñ‚Ñ‹ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ Ð¸ Ð¾Ð½ Ð²Ñ‹Ð±Ñ€Ð°Ð» Ð²Ñ€ÐµÐ¼Ñ, Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½ÑƒÑŽ Ñ„Ð¾Ñ€Ð¼Ñƒ:
   [CREATE_BOOKING service_id: last, staff_id: last, date: ÑÐµÐ³Ð¾Ð´Ð½Ñ, time: 17:00]
   Ð³Ð´Ðµ "last" Ð¾Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ° ÑÐ»Ð¾Ñ‚Ð¾Ð²
   ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ð¼ÐµÑ€: [CREATE_BOOKING service_id: 18356344, staff_id: 2895125, date: 2024-07-20, time: 14:00]
   
3. [SHOW_PRICES] Ð¸Ð»Ð¸ [SHOW_PRICES category: ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ] - Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ñ€Ð°Ð¹Ñ-Ð»Ð¸ÑÑ‚
   Ð’ÐÐ–ÐÐž: Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ð¿Ñ€Ð¾ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ ÑƒÑÐ»ÑƒÐ³Ñƒ (ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°, Ð¼Ð°Ð½Ð¸ÐºÑŽÑ€, Ð¸ Ñ‚.Ð´.), 
   ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ category Ñ ÑÑ‚Ð¸Ð¼ ÑÐ»Ð¾Ð²Ð¾Ð¼!
   ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
   - "ÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ð¾Ð¸Ñ‚ ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°?" â†’ [SHOW_PRICES category: ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°]
   - "Ñ†ÐµÐ½Ð° Ð½Ð° Ð¼Ð°Ð½Ð¸ÐºÑŽÑ€?" â†’ [SHOW_PRICES category: Ð¼Ð°Ð½Ð¸ÐºÑŽÑ€]
   - "Ð¿Ñ€Ð°Ð¹Ñ Ð½Ð° Ð¾ÐºÑ€Ð°ÑˆÐ¸Ð²Ð°Ð½Ð¸Ðµ" â†’ [SHOW_PRICES category: Ð¾ÐºÑ€Ð°ÑˆÐ¸Ð²Ð°Ð½Ð¸Ðµ]
   - "ÐºÐ°ÐºÐ¸Ðµ Ñ†ÐµÐ½Ñ‹?" â†’ [SHOW_PRICES] (Ð±ÐµÐ· category, Ð¿Ð¾ÐºÐ°Ð¶ÐµÑ‚ Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ ÑƒÑÐ»ÑƒÐ³Ð¸)
   
4. [SHOW_PORTFOLIO] - Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¼Ð°ÑÑ‚ÐµÑ€Ð°
   ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹: staff_id

5. [SAVE_CLIENT_NAME name: Ð¸Ð¼Ñ_ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°] - ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¸Ð¼Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
   Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÑ‚Ñƒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ ÐºÐ¾Ð³Ð´Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð¸Ð»ÑÑ
   ÐŸÑ€Ð¸Ð¼ÐµÑ€: [SAVE_CLIENT_NAME name: ÐÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€]

6. [CANCEL_BOOKING] Ð¸Ð»Ð¸ [CANCEL_BOOKING booking_id: Ð½Ð¾Ð¼ÐµÑ€_Ð·Ð°Ð¿Ð¸ÑÐ¸] - Ð¾Ñ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ
   ÐœÐ¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ ID Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ Ð¿Ñ€ÑÐ¼Ð¾Ð¹ Ð¾Ñ‚Ð¼ÐµÐ½Ñ‹ Ð¸Ð»Ð¸ Ð±ÐµÐ· ID Ð´Ð»Ñ Ð¿Ð¾ÐºÐ°Ð·Ð° ÑÐ¿Ð¸ÑÐºÐ°
   ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
   - [CANCEL_BOOKING] - Ð¿Ð¾ÐºÐ°Ð¶ÐµÑ‚ ÑÐ¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð¿Ð¸ÑÐµÐ¹
   - [CANCEL_BOOKING booking_id: 1199065365] - Ð¾Ñ‚Ð¼ÐµÐ½Ð¸Ñ‚ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ

7. [CONFIRM_BOOKING booking_id: Ð½Ð¾Ð¼ÐµÑ€_Ð·Ð°Ð¿Ð¸ÑÐ¸, visit_id: Ð½Ð¾Ð¼ÐµÑ€_Ð²Ð¸Ð·Ð¸Ñ‚Ð°] - Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ
   Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ¾Ð³Ð´Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÐµÑ‚ Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¸Ð´ÐµÑ‚
   ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹: "Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ", "Ð´Ð°, Ð¿Ñ€Ð¸Ð´Ñƒ", "Ð±ÑƒÐ´Ñƒ"
   
8. [MARK_NO_SHOW booking_id: Ð½Ð¾Ð¼ÐµÑ€_Ð·Ð°Ð¿Ð¸ÑÐ¸, visit_id: Ð½Ð¾Ð¼ÐµÑ€_Ð²Ð¸Ð·Ð¸Ñ‚Ð°, reason: Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð°] - Ð¾Ñ‚Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒ Ð½ÐµÑÐ²ÐºÑƒ
   Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ¾Ð³Ð´Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑÐ¾Ð¾Ð±Ñ‰Ð°ÐµÑ‚ Ñ‡Ñ‚Ð¾ ÐÐ• Ð¿Ñ€Ð¸Ð´ÐµÑ‚ (Ð½Ð¾ Ð½Ðµ Ñ…Ð¾Ñ‡ÐµÑ‚ Ð¾Ñ‚Ð¼ÐµÐ½ÑÑ‚ÑŒ)
   ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹: "Ð½Ðµ ÑÐ¼Ð¾Ð³Ñƒ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸", "Ð¾Ð¿Ð¾Ð·Ð´Ð°ÑŽ Ð±Ð¾Ð»ÑŒÑˆÐµ Ñ‡ÐµÐ¼ Ð½Ð° 15 Ð¼Ð¸Ð½ÑƒÑ‚", "Ð·Ð°Ð±Ð¾Ð»ÐµÐ»"

ÐŸÐ ÐÐ’Ð˜Ð›Ð Ð ÐÐ‘ÐžÐ¢Ð«:
1. Ð’Ð¡Ð•Ð“Ð”Ð Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð¿Ð¾ ÑÐµÐºÑ†Ð¸Ð¸ "ÐÐÐÐ›Ð˜Ð— ÐÐÐœÐ•Ð Ð•ÐÐ˜Ð¯ ÐšÐ›Ð˜Ð•ÐÐ¢Ð"
2. ÐŸÐ•Ð Ð•Ð” Ð—ÐÐŸÐ˜Ð¡Ð¬Ð® ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž ÐŸÐ ÐžÐ’Ð•Ð Ð¬ ÐÐÐ›Ð˜Ð§Ð˜Ð• Ð˜ÐœÐ•ÐÐ˜:
   - Ð•ÑÐ»Ð¸ Ñƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð½ÐµÑ‚ Ð¸Ð¼ÐµÐ½Ð¸ Ð² Ð±Ð°Ð·Ðµ (ÑÐ¼. ÑÐµÐºÑ†Ð¸ÑŽ ÐšÐ›Ð˜Ð•ÐÐ¢) - Ð¡ÐÐÐ§ÐÐ›Ð ÑÐ¿Ñ€Ð¾ÑÐ¸ ÐºÐ°Ðº ÐµÐ³Ð¾ Ð·Ð¾Ð²ÑƒÑ‚
   - ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [CREATE_BOOKING] Ð¿Ð¾ÐºÐ° Ð½Ðµ ÑƒÐ·Ð½Ð°ÐµÑˆÑŒ Ð¸Ð¼Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
   - ÐŸÐ¾ÑÐ»Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð¼ÐµÐ½Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸ ÐµÐ³Ð¾ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ðµ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð° Ð´Ð»Ñ Ð±ÑƒÐ´ÑƒÑ‰ÐµÐ³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
   - Ð’ÐÐ–ÐÐž: Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð¸Ð»ÑÑ Ð² ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ (Ñ„Ñ€Ð°Ð·Ñ‹ Ñ‚Ð¸Ð¿Ð° "Ð¼ÐµÐ½Ñ Ð·Ð¾Ð²ÑƒÑ‚", "Ñ - ", "ÑÑ‚Ð¾"), Ð¡Ð ÐÐ—Ð£ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [SAVE_CLIENT_NAME name: Ð¸Ð¼Ñ] Ð¿ÐµÑ€ÐµÐ´ Ð´Ñ€ÑƒÐ³Ð¸Ð¼Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°Ð¼Ð¸
3. ÐÐ’Ð¢ÐžÐœÐÐ¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ Ð—ÐÐŸÐ˜Ð¡Ð¬: Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑƒÐºÐ°Ð·Ð°Ð» ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð˜ ÑƒÑÐ»ÑƒÐ³Ñƒ Ð˜ Ñƒ Ð½Ð°Ñ ÐµÑÑ‚ÑŒ ÐµÐ³Ð¾ Ð¸Ð¼Ñ:
   - ÐÐ• Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—Ð£Ð™ [SEARCH_SLOTS] - ÑÑ€Ð°Ð·Ñƒ Ð¿Ñ‹Ñ‚Ð°Ð¹ÑÑ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ Ñ‡ÐµÑ€ÐµÐ· [CREATE_BOOKING]
   - Ð•ÑÐ»Ð¸ [CREATE_BOOKING] ÑƒÑÐ¿ÐµÑˆÐµÐ½ - Ð·Ð°Ð¿Ð¸ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ð½Ð°
   - Ð•ÑÐ»Ð¸ [CREATE_BOOKING] Ð²ÐµÑ€Ð½ÑƒÐ» Ð¾ÑˆÐ¸Ð±ÐºÑƒ "Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾" - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚Ð¾Ð³Ð´Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [SEARCH_SLOTS] Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ñ‹
4. Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑƒÐºÐ°Ð·Ð°Ð» Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ñ€ÐµÐ¼Ñ Ð‘Ð•Ð— ÑƒÑÐ»ÑƒÐ³Ð¸ - ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸ ÑƒÑÐ»ÑƒÐ³Ñƒ
5. Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑƒÐºÐ°Ð·Ð°Ð» Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑƒÑÐ»ÑƒÐ³Ñƒ Ð‘Ð•Ð— Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ - Ð¿Ð¾ÐºÐ°Ð¶Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÑÐ»Ð¾Ñ‚Ñ‹
6. ÐÐ• Ð¡ÐŸÐ ÐÐ¨Ð˜Ð’ÐÐ™ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ ÐµÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ñ‡ÐµÑ‚ÐºÐ¾ ÑƒÐºÐ°Ð·Ð°Ð» ÑƒÑÐ»ÑƒÐ³Ñƒ Ð¸ Ð²Ñ€ÐµÐ¼Ñ (Ð¸ Ñƒ Ð½Ð°Ñ ÐµÑÑ‚ÑŒ Ð¸Ð¼Ñ)
7. Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ñ†ÐµÐ½Ñ‹ - ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [SHOW_PRICES]
8. ÐÐ• Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹ "Ñƒ Ð½Ð°Ñ Ð½ÐµÑ‚ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸" - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…

ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐžÐ‘Ð©Ð•ÐÐ˜Ð¯:
1. Ð‘ÑƒÐ´ÑŒ ${terminology.communicationStyle}
2. ÐšÐžÐ ÐžÐ¢ÐšÐ˜Ð• ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ - Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 2-3 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð½Ð° Ð¿ÐµÑ€Ð²Ð¾Ðµ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ
3. ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ: Ð½Ð¸ÐºÐ°ÐºÐ¸Ñ… *, _, ~, [], # Ð¸Ð»Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²
4. ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ¼Ð¾Ð´Ð·Ð¸ ÐµÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑÐ°Ð¼ Ð¸Ñ… Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚
5. ÐŸÐ¸ÑˆÐ¸ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾, ÐºÐ°Ðº Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð² Ð¼ÐµÑÑÐµÐ½Ð´Ð¶ÐµÑ€Ðµ
6. Ð—Ð°Ð´Ð°Ð²Ð°Ð¹ ÐžÐ”Ð˜Ð Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð·Ð° Ñ€Ð°Ð·, Ð½Ðµ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ¶Ð°Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹
7. ÐÐ˜ÐšÐžÐ“Ð”Ð Ð½Ðµ Ð¿Ð¸ÑˆÐ¸ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ Ð² ÑÐºÐ¾Ð±ÐºÐ°Ñ… - Ð¾Ð½Ð¸ Ð²Ð¸Ð´Ð½Ñ‹ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ!
8. ÐÐ• Ð¾Ð±ÑŠÑÑÐ½ÑÐ¹ ÑÐ²Ð¾ÑŽ Ð»Ð¾Ð³Ð¸ÐºÑƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ - Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾Ñ

ÐŸÐ ÐžÐÐšÐ¢Ð˜Ð’ÐÐ«Ð• ÐŸÐ Ð•Ð”Ð›ÐžÐ–Ð•ÐÐ˜Ð¯ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ€Ð°Ð·ÑƒÐ¼Ð½Ð¾):
- Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ñ‹Ð¹ - Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ ÐµÐ³Ð¾ Ð»ÑŽÐ±Ð¸Ð¼ÑƒÑŽ ÑƒÑÐ»ÑƒÐ³Ñƒ
- Ð•ÑÐ»Ð¸ Ð±Ð¾Ð»ÑŒÑˆÐ°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ - Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¼ÐµÐ½ÐµÐµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ
- Ð•ÑÐ»Ð¸ Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ðµ - Ð½Ð°Ð¿Ð¾Ð¼Ð½Ð¸ Ð¾ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð·Ð°Ñ€Ð°Ð½ÐµÐµ Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°Ñ‚ÑŒÑÑ
- ÐŸÑ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ ${terminology.suggestions} ÐºÐ¾Ð³Ð´Ð° ÑƒÐ¼ÐµÑÑ‚Ð½Ð¾
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ðµ ÐµÑÐ»Ð¸ Ð¾Ð½ Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ñ‹Ð¹

Ð’ÐÐ–ÐÐž ÐŸÐž ÐœÐÐ¡Ð¢Ð•Ð ÐÐœ:
- Ð’Ð¡Ð•Ð“Ð”Ð Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐ¹ Ð² Ð ÐÐ¡ÐŸÐ˜Ð¡ÐÐÐ˜Ð˜ ÐºÑ‚Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÑÐµÐ³Ð¾Ð´Ð½Ñ
- ÐÐ• Ð³Ð¾Ð²Ð¾Ñ€Ð¸ Ñ‡Ñ‚Ð¾ Ð¼Ð°ÑÑ‚ÐµÑ€ ÑÐ²Ð¾Ð±Ð¾Ð´ÐµÐ½, ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚ Ð² Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ð¸ Ð½Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ
- Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ñ‹ ÑÐ»Ð¾Ñ‚Ñ‹ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ [SEARCH_SLOTS] Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸

Ð’ÐÐ–ÐÐž:
- Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ: ${context.currentTime}
- Ð§Ð°ÑÐ¾Ð²Ð¾Ð¹ Ð¿Ð¾ÑÑ: ${context.timezone}
- ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸: ${config.business.minBookingMinutesAhead} Ð¼Ð¸Ð½ÑƒÑ‚

ÐŸÐžÐÐ˜ÐœÐÐÐ˜Ð• Ð”ÐÐ•Ð™:
- "ÑÐµÐ³Ð¾Ð´Ð½Ñ" = ${new Date().toISOString().split('T')[0]}
- "Ð·Ð°Ð²Ñ‚Ñ€Ð°" = ${new Date(Date.now() + 86400000).toISOString().split('T')[0]}
- "Ð¿Ð¾ÑÐ»ÐµÐ·Ð°Ð²Ñ‚Ñ€Ð°" = ${new Date(Date.now() + 172800000).toISOString().split('T')[0]}

ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž:
- Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—Ð£Ð™ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ [SEARCH_SLOTS], [SHOW_PRICES] Ð¸ Ñ‚.Ð´. Ð² ÑÐ²Ð¾ÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚Ðµ Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹
- ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¿Ð¸ÑˆÐ¸ Ð’ ÐšÐžÐÐ¦Ð• Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¿Ð¾ÑÐ»Ðµ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÐºÑÑ‚Ð°
- ÐÐ• Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÐ¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÑÐ»Ð¾Ñ‚Ð°Ñ… - ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° ÑÐ°Ð¼Ð° Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
- ÐÐ• Ð·Ð´Ð¾Ñ€Ð¾Ð²Ð°Ð¹ÑÑ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾ ÐµÑÐ»Ð¸ Ð´Ð¸Ð°Ð»Ð¾Ð³ ÑƒÐ¶Ðµ Ð½Ð°Ñ‡Ð°Ñ‚
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ð˜Ð¡Ð¢ÐžÐ Ð˜Ð® Ð”Ð˜ÐÐ›ÐžÐ“Ð Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð½ÑÑ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚

Ð¤ÐžÐ ÐœÐÐ¢ ÐžÐ¢Ð’Ð•Ð¢Ð:
1. Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð½Ð°Ð¿Ð¸ÑˆÐ¸ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ (1-2 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ)
2. Ð—Ð°Ñ‚ÐµÐ¼ Ð´Ð¾Ð±Ð°Ð²ÑŒ Ð½ÑƒÐ¶Ð½ÑƒÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ: [ÐšÐžÐœÐÐÐ”Ð Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹]

ÐŸÐ Ð˜ÐœÐ•Ð Ð« ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐ«Ð¥ ÐžÐ¢Ð’Ð•Ð¢ÐžÐ’:
ÐšÐ»Ð¸ÐµÐ½Ñ‚: "Ñ…Ð¾Ñ‡Ñƒ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ" (Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð±ÐµÐ· Ð¸Ð¼ÐµÐ½Ð¸)
Ð¢Ñ‹: "ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾! ÐšÐ°Ðº Ð²Ð°Ñ Ð·Ð¾Ð²ÑƒÑ‚?"

ÐšÐ»Ð¸ÐµÐ½Ñ‚: "ÐÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€"
Ð¢Ñ‹: "ÐŸÑ€Ð¸ÑÑ‚Ð½Ð¾ Ð¿Ð¾Ð·Ð½Ð°ÐºÐ¾Ð¼Ð¸Ñ‚ÑŒÑÑ, ÐÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€! ÐÐ° ÐºÐ°ÐºÑƒÑŽ ÑƒÑÐ»ÑƒÐ³Ñƒ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ? [SAVE_CLIENT_NAME name: ÐÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€]"

ÐšÐ»Ð¸ÐµÐ½Ñ‚: "Ñ…Ð¾Ñ‡Ñƒ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ" (ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ñ Ð¸Ð¼ÐµÐ½ÐµÐ¼)
Ð¢Ñ‹: "ÐšÐ¾Ð½ÐµÑ‡Ð½Ð¾! ÐÐ° ÐºÐ°ÐºÑƒÑŽ ÑƒÑÐ»ÑƒÐ³Ñƒ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ? [SEARCH_SLOTS]"

ÐšÐ»Ð¸ÐµÐ½Ñ‚: "ÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ð¾Ð¸Ñ‚ ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°?"
Ð¢Ñ‹: "Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ð¿Ð¾ÐºÐ°Ð¶Ñƒ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹. [SHOW_PRICES category: ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°]"

ÐšÐ»Ð¸ÐµÐ½Ñ‚: "ÐµÑÑ‚ÑŒ Ð²Ñ€ÐµÐ¼Ñ Ð·Ð°Ð²Ñ‚Ñ€Ð°?"
Ð¢Ñ‹: "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŽ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° Ð·Ð°Ð²Ñ‚Ñ€Ð°. [SEARCH_SLOTS date=Ð·Ð°Ð²Ñ‚Ñ€Ð°]"

ÐÐ’Ð¢ÐžÐœÐÐ¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ Ð—ÐÐŸÐ˜Ð¡Ð¬ (Ð‘Ð•Ð— ÐŸÐžÐ”Ð¢Ð’Ð•Ð Ð–Ð”Ð•ÐÐ˜Ð¯) - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¸Ð¼Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°:
ÐšÐ»Ð¸ÐµÐ½Ñ‚: "Ñ…Ð¾Ñ‡Ñƒ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° ÑÑ‚Ñ€Ð¸Ð¶ÐºÑƒ Ð·Ð°Ð²Ñ‚Ñ€Ð° Ð² 15:00" (ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ñ Ð¸Ð¼ÐµÐ½ÐµÐ¼)
Ð¢Ñ‹: "Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽ Ð²Ð°Ñ Ð½Ð° ÑÑ‚Ñ€Ð¸Ð¶ÐºÑƒ Ð·Ð°Ð²Ñ‚Ñ€Ð° Ð² 15:00. [CREATE_BOOKING service_name=ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°, date=Ð·Ð°Ð²Ñ‚Ñ€Ð°, time=15:00]"

ÐšÐ»Ð¸ÐµÐ½Ñ‚: "Ð·Ð°Ð¿Ð¸ÑˆÐ¸ Ð¼ÐµÐ½Ñ Ð½Ð° Ð¼Ð°Ð½Ð¸ÐºÑŽÑ€ Ð² Ð¿ÑÑ‚Ð½Ð¸Ñ†Ñƒ Ð² 17:00" (Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚)
Ð¢Ñ‹: "Ð¡ ÑƒÐ´Ð¾Ð²Ð¾Ð»ÑŒÑÑ‚Ð²Ð¸ÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑˆÑƒ Ð²Ð°Ñ! ÐšÐ°Ðº Ð²Ð°Ñ Ð·Ð¾Ð²ÑƒÑ‚?"

ÐšÐ»Ð¸ÐµÐ½Ñ‚: "ÐœÐ°Ñ€Ð¸Ñ"
Ð¢Ñ‹: "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾, ÐœÐ°Ñ€Ð¸Ñ! Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽ Ð²Ð°Ñ Ð½Ð° Ð¼Ð°Ð½Ð¸ÐºÑŽÑ€ Ð² Ð¿ÑÑ‚Ð½Ð¸Ñ†Ñƒ Ð² 17:00. [SAVE_CLIENT_NAME name: ÐœÐ°Ñ€Ð¸Ñ] [CREATE_BOOKING service_name=Ð¼Ð°Ð½Ð¸ÐºÑŽÑ€, date=Ð¿ÑÑ‚Ð½Ð¸Ñ†Ð°, time=17:00]"

Ð’ÐÐ–ÐÐ«Ð™ Ð¡Ð›Ð£Ð§ÐÐ™ - ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ÑÑ Ð² Ñ‚Ð¾Ð¼ Ð¶Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸:
ÐšÐ»Ð¸ÐµÐ½Ñ‚: "Ð´Ð°Ð²Ð°Ð¹ ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð² Ð¿Ð¾Ð» Ð¿ÑÑ‚Ð¾Ð³Ð¾. ÐœÐµÐ½Ñ Ð·Ð¾Ð²ÑƒÑ‚ ÐÑ€ÑÐµÐ½Ð¸Ð¹"
Ð¢Ñ‹: "ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾, ÐÑ€ÑÐµÐ½Ð¸Ð¹! Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽ Ð²Ð°Ñ ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð½Ð° 16:30. [SAVE_CLIENT_NAME name: ÐÑ€ÑÐµÐ½Ð¸Ð¹] [CREATE_BOOKING service_name=ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°, date=ÑÐµÐ³Ð¾Ð´Ð½Ñ, time=16:30]"

Ð’ÐÐ–ÐÐž: ÐÐ• Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ ÑÐ»Ð¾Ñ‚Ñ‹ ÐµÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð½Ðµ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°Ð» "ÐºÐ¾Ð³Ð´Ð° Ð¼Ð¾Ð¶Ð½Ð¾", "ÐµÑÑ‚ÑŒ Ð²Ñ€ÐµÐ¼Ñ", "Ð¿Ð¾ÐºÐ°Ð¶Ð¸ ÑÐ»Ð¾Ñ‚Ñ‹"!

ÐžÑ‚Ð²ÐµÑ‚ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸ Ð½ÑƒÐ¶Ð½Ð¾Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:`
  }

  /**
   * ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚Ð²ÐµÑ‚Ð° AI Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´
   */
  async processAIResponse(aiResponse, context) {
    logger.info('Processing AI response...');
    
    // Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¸Ð· Ð¾Ñ‚Ð²ÐµÑ‚Ð°
    const commands = commandHandler.extractCommands(aiResponse);
    const cleanResponse = commandHandler.removeCommands(aiResponse);
    
    // Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
    const results = await commandHandler.executeCommands(commands, context);
    
    // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚
    let finalResponse = cleanResponse;
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´
    // Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÐ»Ð¾Ñ‚Ñ‹ ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾
    const slotResults = results.filter(r => r.type === 'slots');
    if (slotResults.length > 0) {
      const allSlots = slotResults.reduce((acc, result) => {
        return acc.concat(result.data || []);
      }, []);
      
      if (allSlots.length > 0) {
        finalResponse += '\n\n' + formatter.formatSlots(allSlots, context.company.type);
      }
    }
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
    for (const result of results) {
      if (result.type === 'booking_created') {
        logger.info('Formatting booking confirmation:', {
          resultData: result.data,
          resultDataType: typeof result.data,
          hasRecordId: !!result.data?.record_id,
          hasId: !!result.data?.id
        });
        finalResponse += '\n\nâœ… ' + formatter.formatBookingConfirmation(result.data, context.company.type);
      } else if (result.type === 'prices' && !slotResults.length) {
        finalResponse += '\n\n' + formatter.formatPrices(result.data, context.company.type);
      } else if (result.type === 'booking_list') {
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð±Ñ‹Ð»Ð° Ð»Ð¸ ÑÑ‚Ð¾ Ð¿Ñ€ÑÐ¼Ð°Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ð°
        if (result.data && result.data.directCancellation) {
          if (result.data.success) {
            finalResponse += '\n\nâœ… ' + result.data.message;
          } else {
            finalResponse += '\n\nâŒ ' + result.data.message;
          }
        } else if (result.data && result.data.bookings && result.data.bookings.length > 0) {
          // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð´Ð»Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ñ‹
          finalResponse += '\n\nðŸ“… Ð’Ð°ÑˆÐ¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸:\n';
          result.data.bookings.forEach(booking => {
            finalResponse += `\n${booking.index}. ${booking.date} Ð² ${booking.time}`;
            finalResponse += `\n   Ð£ÑÐ»ÑƒÐ³Ð°: ${booking.services}`;
            finalResponse += `\n   ÐœÐ°ÑÑ‚ÐµÑ€: ${booking.staff}`;
            if (booking.price > 0) {
              finalResponse += `\n   Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: ${booking.price} Ñ€ÑƒÐ±.`;
            }
          });
          finalResponse += '\n\nÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð·Ð°Ð¿Ð¸ÑÐ¸, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¾Ñ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ.';
          
          // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
          const contextService = require('../../context');
          const redisContext = await contextService.getContext(context.phone.replace('@c.us', ''));
          redisContext.pendingCancellation = result.data.bookings;
          await contextService.setContext(context.phone.replace('@c.us', ''), redisContext);
        } else if (result.data && result.data.message) {
          finalResponse += '\n\n' + result.data.message;
        } else {
          finalResponse += '\n\nÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð¿Ð¸ÑÐµÐ¹. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.';
        }
      } else if (result.type === 'error') {
        // ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÐºÐ¾Ð¼Ð°Ð½Ð´
        logger.info('Processing error result:', {
          command: result.command,
          error: result.error,
          errorType: typeof result.error,
          params: result.params
        });
        
        if (result.command === 'CREATE_BOOKING') {
          // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑ‚Ð¾ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¸Ð»Ð¸ Ð´Ñ€ÑƒÐ³Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°
          const isAvailabilityError = result.error && (
            result.error.includes('Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½') || // Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾, Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹
            result.error.includes('Ð£ÑÐ»ÑƒÐ³Ð° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°') ||
            result.error.includes('ÐÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ…') ||
            result.error.includes('Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ') ||
            result.error.includes('Ð·Ð°Ð½ÑÑ‚Ð¾')
          );
          
          logger.info('Availability error check:', {
            isAvailabilityError,
            error: result.error
          });
          
          if (isAvailabilityError) {
            // Ð’Ñ€ÐµÐ¼Ñ/Ð¼Ð°ÑÑ‚ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ - Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ñ‹
            finalResponse = 'Ðš ÑÐ¾Ð¶Ð°Ð»ÐµÐ½Ð¸ÑŽ, Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾.';
            
            // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð½Ð°Ð¹Ñ‚Ð¸ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ ÑÐ»Ð¾Ñ‚Ñ‹
            if (result.params) {
              try {
                // Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¸Ð· Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ð¾Ð¹ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
                const { service_name, service_id, date, time } = result.params;
                
                // Ð˜Ñ‰ÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÑÐ»Ð¾Ñ‚Ñ‹ Ð´Ð»Ñ ÑÑ‚Ð¾Ð¹ ÑƒÑÐ»ÑƒÐ³Ð¸ Ð¸ Ð´Ð°Ñ‚Ñ‹
                const searchParams = {
                  service_name: service_name || (service_id ? null : 'ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°'),
                  service_id: service_id,
                  date: date || 'ÑÐµÐ³Ð¾Ð´Ð½Ñ'
                };
                
                logger.info('Searching for alternative slots after booking error:', searchParams);
                const searchResult = await commandHandler.searchSlots(searchParams, context);
                
                if (searchResult && searchResult.slots && searchResult.slots.length > 0) {
                  finalResponse += '\n\nÐ’Ð¾Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ:';
                  finalResponse += '\n' + formatter.formatSlots(searchResult.slots, context.company.type);
                  
                  // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¿Ð¾Ð¸ÑÐºÐ° Ð´Ð»Ñ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
                  context.lastSearch = searchResult;
                } else {
                  finalResponse += ' Ðš ÑÐ¾Ð¶Ð°Ð»ÐµÐ½Ð¸ÑŽ, Ð½Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð²ÑÐµ Ð·Ð°Ð½ÑÑ‚Ð¾. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ð´ÐµÐ½ÑŒ.';
                }
              } catch (searchError) {
                logger.error('Error searching for alternative slots:', searchError);
                finalResponse += ' Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¿Ð¾Ð´Ð±ÐµÑ€ÐµÐ¼ Ð´Ñ€ÑƒÐ³Ð¾Ðµ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ðµ Ð´Ð»Ñ Ð²Ð°Ñ Ð²Ñ€ÐµÐ¼Ñ.';
              }
            } else if (context.lastSearch?.slots && context.lastSearch.slots.length > 0) {
              // Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð², Ð½Ð¾ ÐµÑÑ‚ÑŒ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð¿Ð¾Ð¸ÑÐº
              finalResponse += '\n\nÐ’Ð¾Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ:';
              finalResponse += '\n' + formatter.formatSlots(context.lastSearch.slots, context.company.type);
            } else {
              finalResponse += ' Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¿Ð¾Ð´Ð±ÐµÑ€ÐµÐ¼ Ð´Ñ€ÑƒÐ³Ð¾Ðµ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ðµ Ð´Ð»Ñ Ð²Ð°Ñ Ð²Ñ€ÐµÐ¼Ñ.';
            }
          } else {
            // Ð”Ñ€ÑƒÐ³Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° (Ð½Ðµ ÑÐ²ÑÐ·Ð°Ð½Ð½Ð°Ñ Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒÑŽ)
            finalResponse = finalResponse.replace(
              /Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽ Ð²Ð°Ñ|Ð·Ð°Ð¿Ð¸ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ð½Ð°|Ð²Ñ‹ Ð·Ð°Ð¿Ð¸ÑÐ°Ð½Ñ‹/gi, 
              'Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ'
            );
            finalResponse += '\n\nÐš ÑÐ¾Ð¶Ð°Ð»ÐµÐ½Ð¸ÑŽ, Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð¸Ð»Ð¸ Ð¿Ð¾Ð·Ð²Ð¾Ð½Ð¸Ñ‚Ðµ Ð½Ð°Ð¼.';
          }
        }
      }
    }
    
    return {
      success: true,
      response: finalResponse,
      executedCommands: commands,
      results
    };
  }

  /**
   * Ð’Ñ‹Ð·Ð¾Ð² AI Ñ‡ÐµÑ€ÐµÐ· AIService
   */
  async callAI(prompt) {
    if (!this.aiProvider) {
      this.aiProvider = require('../ai');
    }
    
    return await this.aiProvider._callAI(prompt);
  }

  /**
   * ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð² ÐºÐµÑˆÐµ
   */
  cleanupCache() {
    const now = Date.now();
    for (const [key, value] of this.contextCache.entries()) {
      if (now - value.timestamp > this.cacheTimeout) {
        this.contextCache.delete(key);
      }
    }
  }
}

module.exports = new AIAdminV2();