const config = require('../../config');
const logger = require('../../utils/logger').child({ module: 'ai-admin-v2' });

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª–∏
const dataLoader = require('./modules/data-loader');
const formatter = require('./modules/formatter');
const businessLogic = require('./modules/business-logic');
const commandHandler = require('./modules/command-handler');
const contextService = require('../context');

/**
 * AI Admin v2 - –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è AI –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
 * –ó–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å 5-6 —ç—Ç–∞–ø–∞–º–∏ –Ω–∞ –æ–¥–∏–Ω AI –≤—ã–∑–æ–≤
 */
class AIAdminV2 {
  constructor() {
    this.contextCache = new Map();
    this.cacheTimeout = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É –∫–µ—à–∞
    setInterval(() => this.cleanupCache(), 60 * 1000); // –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
  }

  /**
   * –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
   */
  async processMessage(message, phone, companyId) {
    try {
      logger.info(`ü§ñ AI Admin v2 processing: "${message}" from ${phone}`);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ–∂–∏–¥–∞—é—â–∞—è –æ—Ç–º–µ–Ω–∞
      const contextService = require('../context');
      const redisContext = await contextService.getContext(phone.replace('@c.us', ''));
      
      if (redisContext?.pendingCancellation) {
        // –ü—Ä–æ–±—É–µ–º –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –Ω–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏
        const selectedNumber = parseInt(message.trim());
        
        if (!isNaN(selectedNumber) && selectedNumber > 0 && selectedNumber <= redisContext.pendingCancellation.length) {
          // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–ø–∏—Å—å
          const selectedBooking = redisContext.pendingCancellation[selectedNumber - 1];
          
          // –û—Ç–º–µ–Ω—è–µ–º –∑–∞–ø–∏—Å—å
          const cancelResult = await bookingService.cancelBooking(selectedBooking.id, companyId);
          
          // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è
          delete redisContext.pendingCancellation;
          await contextService.setContext(phone.replace('@c.us', ''), redisContext);
          
          if (cancelResult.success) {
            return `‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞!\n\n${selectedBooking.date} –≤ ${selectedBooking.time}\n${selectedBooking.services}\n–ú–∞—Å—Ç–µ—Ä: ${selectedBooking.staff}\n\n–ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞ - –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å! üòä`;
          } else {
            return `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å: ${cancelResult.error}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.`;
          }
        }
        
        // –ï—Å–ª–∏ –≤–≤–µ–ª–∏ –Ω–µ –Ω–æ–º–µ—Ä –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—ã—á–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
        // –Ω–æ –æ—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è
        delete redisContext.pendingCancellation;
        await contextService.setContext(phone.replace('@c.us', ''), redisContext);
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
      const context = await this.loadFullContext(phone, companyId);
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
      context.currentMessage = message;
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞ –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –æ–±—â–µ–Ω–∏—è
      const businessType = businessLogic.detectBusinessType(context.company);
      context.company.type = businessType;
      logger.info(`Business type detected: ${businessType}`);
      
      // –°—Ç—Ä–æ–∏–º —É–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
      const prompt = this.buildSmartPrompt(message, context, phone);
      
      // –û–¥–∏–Ω –≤—ã–∑–æ–≤ AI —Å–æ –≤—Å–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
      const aiResponse = await this.callAI(prompt);
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã
      const result = await this.processAIResponse(aiResponse, context);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
      await dataLoader.saveContext(phone, companyId, context, result);
      
      logger.info(`‚úÖ AI Admin v2 completed in ${Date.now() - context.startTime}ms`);
      
      return {
        success: true,
        response: result.response,
        commands: result.executedCommands,
        executedCommands: result.executedCommands,
        results: result.results
      };
      
    } catch (error) {
      logger.error('Error in AI Admin v2:', error);
      return {
        success: false,
        response: '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.',
        error: error.message
      };
    }
  }

  /**
   * –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
   */
  async loadFullContext(phone, companyId) {
    const cacheKey = `${phone}_${companyId}`;
    const cached = this.contextCache.get(cacheKey);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
    if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
      logger.info('Using cached context');
      return { ...cached.data, startTime: Date.now() };
    }
    
    logger.info('Loading full context from database...');
    const startTime = Date.now();
    
    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
    const [
      company, 
      client, 
      services, 
      staff, 
      conversation, 
      businessStats, 
      staffSchedules, 
      redisContext,
      preferences,
      conversationSummary
    ] = await Promise.all([
      dataLoader.loadCompany(companyId),
      dataLoader.loadClient(phone, companyId),
      dataLoader.loadServices(companyId),
      dataLoader.loadStaff(companyId),
      dataLoader.loadConversation(phone, companyId),
      dataLoader.loadBusinessStats(companyId),
      dataLoader.loadStaffSchedules(companyId),
      contextService.getContext(phone.replace('@c.us', '')),
      contextService.getPreferences(phone.replace('@c.us', ''), companyId),
      contextService.getConversationSummary(phone.replace('@c.us', ''), companyId)
    ]);
    
    // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç –≤ –±–∞–∑–µ, –Ω–æ –µ—Å—Ç—å –∏–º—è –≤ Redis - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    if (!client && redisContext?.clientName) {
      client = {
        phone: phone.replace('@c.us', ''),
        name: redisContext.clientName,
        company_id: companyId
      };
    } else if (client && !client.name && redisContext?.clientName) {
      // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –µ—Å—Ç—å, –Ω–æ –∏–º—è –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ - –±–µ—Ä–µ–º –∏–∑ Redis
      client.name = redisContext.clientName;
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —É—Å–ª—É–≥–∏ —Å —É—á–µ—Ç–æ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞
    const sortedServices = businessLogic.sortServicesForClient(services, client);
    
    const context = {
      company,
      client,
      services: sortedServices,
      staff,
      conversation,
      businessStats,
      staffSchedules,
      currentTime: new Date().toLocaleString('ru-RU', { timeZone: config.app.timezone }),
      timezone: config.app.timezone,
      phone,
      startTime,
      currentMessage: null,  // –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ processMessage
      preferences: preferences || {},
      conversationSummary: conversationSummary || {},
      canContinueConversation: conversationSummary?.canContinue || false,
      isReturningClient: conversationSummary?.hasHistory || false
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
    this.contextCache.set(cacheKey, {
      data: context,
      timestamp: Date.now()
    });
    
    logger.info(`Context loaded in ${Date.now() - startTime}ms`);
    return context;
  }

  /**
   * –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —É–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
   */
  buildSmartPrompt(message, context, phone) {
    const terminology = businessLogic.getBusinessTerminology(context.company.type);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –¥–∏–∞–ª–æ–≥–∞
    let continuationInfo = '';
    if (context.canContinueConversation && context.conversationSummary?.recentMessages?.length > 0) {
      continuationInfo = `
–í–ê–ñ–ù–û: –≠—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞. –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
${context.conversationSummary.recentMessages.map(m => `${m.role}: ${m.content}`).join('\n')}

–£—á—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ.
`;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö
    let preferencesInfo = '';
    if (context.preferences && Object.keys(context.preferences).length > 0) {
      preferencesInfo = `
–ü–†–ï–î–ü–û–ß–¢–ï–ù–ò–Ø –ö–õ–ò–ï–ù–¢–ê:
${context.preferences.favoriteService ? `- –õ—é–±–∏–º–∞—è —É—Å–ª—É–≥–∞: ${context.preferences.favoriteService}` : ''}
${context.preferences.favoriteStaff ? `- –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π –º–∞—Å—Ç–µ—Ä: ${context.preferences.favoriteStaff}` : ''}
${context.preferences.preferredTime ? `- –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–æ–µ –≤—Ä–µ–º—è: ${context.preferences.preferredTime}` : ''}
${context.preferences.notes ? `- –ó–∞–º–µ—Ç–∫–∏: ${context.preferences.notes}` : ''}
`;
    }
    
    return `–¢—ã - ${terminology.role} "${context.company.title}".
${continuationInfo}
–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ê–õ–û–ù–ï:
–ù–∞–∑–≤–∞–Ω–∏–µ: ${context.company.title}
–ê–¥—Ä–µ—Å: ${context.company.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}
–¢–µ–ª–µ—Ñ–æ–Ω: ${context.company.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}
–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: ${formatter.formatWorkingHours(context.company.working_hours || {})}
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è: ${context.businessStats.todayLoad}% (${context.businessStats.bookedSlots}/${context.businessStats.totalSlots} —Å–ª–æ—Ç–æ–≤)

–ö–õ–ò–ï–ù–¢:
${context.client ? 
  `–ò–º—è: ${context.client.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}
–ò—Å—Ç–æ—Ä–∏—è: ${formatter.formatVisitHistory(context.client.visit_history)}
–õ—é–±–∏–º—ã–µ —É—Å–ª—É–≥–∏: ${context.client.last_service_ids?.join(', ') || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
–õ—é–±–∏–º—ã–µ –º–∞—Å—Ç–µ—Ä–∞: ${context.client.favorite_staff_ids?.join(', ') || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}` :
  `–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω: ${phone}
–í–ê–ñ–ù–û: –£ –Ω–∞—Å –Ω–µ—Ç –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –±–∞–∑–µ!`}
${preferencesInfo}

–î–û–°–¢–£–ü–ù–´–ï –£–°–õ–£–ì–ò (—Ç–æ–ø-10):
${formatter.formatServices(context.services.slice(0, 10), context.company.type)}

–ú–ê–°–¢–ï–†–ê –°–ï–ì–û–î–ù–Ø:
${formatter.formatTodayStaff(context.staffSchedules, context.staff)}

–†–ê–°–ü–ò–°–ê–ù–ò–ï –ú–ê–°–¢–ï–†–û–í (–±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏):
${formatter.formatStaffSchedules(context.staffSchedules, context.staff)}

–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê:
${formatter.formatConversation(context.conversation)}

–¢–ï–ö–£–©–ï–ï –°–û–û–ë–©–ï–ù–ò–ï: "${message}"

–ê–ù–ê–õ–ò–ó –ù–ê–ú–ï–†–ï–ù–ò–Ø –ö–õ–ò–ï–ù–¢–ê:
–û–ø—Ä–µ–¥–µ–ª–∏, —á—Ç–æ —Ö–æ—á–µ—Ç –∫–ª–∏–µ–Ω—Ç, –∏ –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É.

‚ö†Ô∏è –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï - –ü–ï–†–í–´–ú –î–ï–õ–û–ú –ü–†–û–í–ï–†–¨:
- –£–∫–∞–∑–∞–ª –ª–∏ –∫–ª–∏–µ–Ω—Ç –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø? 
- –ü—Ä–∏–º–µ—Ä—ã: "–≤ 15:00", "–≤ 16:00", "–≤ —Ç—Ä–∏ —á–∞—Å–∞", "–¥–∞–≤–∞–π—Ç–µ –≤ 4", "–Ω–∞ 3 —á–∞—Å–∞ –¥–Ω—è"
- –ï—Å–ª–∏ –î–ê ‚Üí —ç—Ç–æ –ó–ê–ü–ò–°–¨ –ù–ê –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø!
- –ï—Å–ª–∏ –î–ê –∏ –µ—Å—Ç—å –£–°–õ–£–ì–ê –∏ –ò–ú–Ø ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π [CREATE_BOOKING], –ù–ï [SEARCH_SLOTS]!
- –ï—Å–ª–∏ –î–ê –∏ –µ—Å—Ç—å –£–°–õ–£–ì–ê, –Ω–æ –Ω–µ—Ç –ò–ú–ï–ù–ò ‚Üí —Å–ø—Ä–æ—Å–∏ –∏–º—è, –∑–∞—Ç–µ–º [CREATE_BOOKING]!
- –ù–ò–ö–û–ì–î–ê –ù–ï –ü–û–ö–ê–ó–´–í–ê–ô –°–õ–û–¢–´ –ï–°–õ–ò –í–†–ï–ú–Ø –£–ñ–ï –£–ö–ê–ó–ê–ù–û!

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û –û –í–†–ï–ú–ï–ù–ò:
- "–¥–∞–≤–∞–π—Ç–µ –≤ 4" = –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø (16:00)
- "–≤ 3 —á–∞—Å–∞" = –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø (15:00)
- "–Ω–∞ 10 —É—Ç—Ä–∞" = –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø (10:00)
- –ï–°–õ–ò –ï–°–¢–¨ –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø ‚Üí –ù–ï –ü–û–ö–ê–ó–´–í–ê–ô –°–õ–û–¢–´!
- –ï–°–õ–ò –ï–°–¢–¨ –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø ‚Üí –ò–°–ü–û–õ–¨–ó–£–ô [CREATE_BOOKING]!

–í–ê–ñ–ù–û: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∏ —É–∫–∞–∑–∞–ª:
- –ò–º—è –º–∞—Å—Ç–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "–∫ –°–µ—Ä–≥–µ—é")
- –í—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä "–≤ 16:30", "–¥–∞–≤–∞–π—Ç–µ –≤ 4", "–Ω–∞ 10 —É—Ç—Ä–∞")
- –° –¥–∞—Ç–æ–π –∏–ª–∏ –±–µ–∑ –¥–∞—Ç—ã

–¢–æ–≥–¥–∞:
1. –°–æ—Ö—Ä–∞–Ω–∏ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å–ª–∏ –æ–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è
2. –ï—Å–ª–∏ –¥–∞—Ç–∞ –ù–ï —É–∫–∞–∑–∞–Ω–∞ - —Å–ø—Ä–æ—Å–∏ –Ω–∞ –∫–∞–∫–æ–π –¥–µ–Ω—å –∑–∞–ø–∏—Å–∞—Ç—å
3. –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–∫–∞–∑–∞–Ω–∞ –ò –≤—Ä–µ–º—è –ù–ï —É–∫–∞–∑–∞–Ω–æ - –≤—ã–ø–æ–ª–Ω–∏ [SEARCH_SLOTS] –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–ª–æ—Ç–æ–≤
4. –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–∫–∞–∑–∞–Ω–∞ –ò –≤—Ä–µ–º—è –£–ö–ê–ó–ê–ù–û - –∏—Å–ø–æ–ª—å–∑—É–π [CREATE_BOOKING] (–ù–ï [SEARCH_SLOTS]!)
5. –ù–ò–ö–û–ì–î–ê –ù–ï –ì–û–í–û–†–ò "—É –Ω–∞—Å –Ω–µ—Ç –º–∞—Å—Ç–µ—Ä–∞" –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
6. –ù–ï –ü–û–ö–ê–ó–´–í–ê–ô –°–õ–û–¢–´ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –£–ñ–ï –°–ö–ê–ó–ê–õ –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø!
–ù–µ —Å–ø—Ä–∞—à–∏–≤–∞–π –∫–∞–∫—É—é –∏–º–µ–Ω–Ω–æ —É—Å–ª—É–≥—É, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ —É—Ç–æ—á–Ω–∏–ª!

–í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—å, –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è –ª–∏ –∫–ª–∏–µ–Ω—Ç –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏:
- "–ú–µ–Ω—è –∑–æ–≤—É—Ç [–∏–º—è]" ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏ –∏–º—è —á–µ—Ä–µ–∑ [SAVE_CLIENT_NAME]
- "–Ø [–∏–º—è]" (–Ω–∞–ø—Ä–∏–º–µ—Ä: "—è –ê—Ä—Å–µ–Ω", "—è –ú–∞—Ä–∏—è") ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏ –∏–º—è —á–µ—Ä–µ–∑ [SAVE_CLIENT_NAME]
- "–Ø - [–∏–º—è]" ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏ –∏–º—è —á–µ—Ä–µ–∑ [SAVE_CLIENT_NAME]
- "–≠—Ç–æ [–∏–º—è]" ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏ –∏–º—è —á–µ—Ä–µ–∑ [SAVE_CLIENT_NAME]
- "[–∏–º—è]" (–≤ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å "–∫–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?") ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏ –∏–º—è —á–µ—Ä–µ–∑ [SAVE_CLIENT_NAME]

–í–°–ï–ì–î–ê —Å–æ—Ö—Ä–∞–Ω—è–π –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è –≤ –ª—é–±–æ–π —Ñ–æ—Ä–º–µ!

1. –ó–ê–ü–ò–°–¨ –ù–ê –£–°–õ–£–ì–£ - –∏—Å–ø–æ–ª—å–∑—É–π [SEARCH_SLOTS] –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç:
   - "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—à–∏—Ç–µ –º–µ–Ω—è"
   - "–Ω—É–∂–Ω–∞ –∑–∞–ø–∏—Å—å", "—Ö–æ—á—É –ø—Ä–∏–π—Ç–∏", "–º–æ–∂–Ω–æ –∫ –≤–∞–º"
   - "—Ö–∞—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∑–∞–ø–∏—à–∏ –ø–ª–∑", "–º–æ–∂–Ω–∞ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è" (—Å –æ–ø–µ—á–∞—Ç–∫–∞–º–∏)
   - —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —É—Å–ª—É–≥—É —Å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏
   
2. –ü–†–û–í–ï–†–ö–ê –í–†–ï–ú–ï–ù–ò - –∏—Å–ø–æ–ª—å–∑—É–π [SEARCH_SLOTS] –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç:
   - "—Å–≤–æ–±–æ–¥–Ω–æ –∑–∞–≤—Ç—Ä–∞?", "–µ—Å—Ç—å –≤—Ä–µ–º—è?", "–∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ?"
   - "—á—Ç–æ –µ—Å—Ç—å –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö?", "–º–æ–∂–Ω–æ –≤–µ—á–µ—Ä–æ–º?"
   - "–∫–∞–¥–∞ –º–æ–∂–Ω–∞", "–µ—Å—Ç—å —á–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞" (—Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å)
   - "–º–æ–∂–Ω–æ –≤ –ø—è—Ç–Ω–∏—Ü—É —É—Ç—Ä–æ–º?", "–≤–µ—á–µ—Ä–æ–º —Å–µ–≥–æ–¥–Ω—è —Å–≤–æ–±–æ–¥–Ω–æ?"
   - –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏/—Å–ª–æ—Ç–æ–≤
   
3. –¶–ï–ù–´ - –∏—Å–ø–æ–ª—å–∑—É–π [SHOW_PRICES] –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç:
   - "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", "–∫–∞–∫–∏–µ —Ü–µ–Ω—ã", "–ø—Ä–∞–π—Å"
   - "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "—Ü–µ–Ω–∞ –Ω–∞", "–ø–æ—á–µ–º"
   - "—Å–∫–æ–∫ —Å—Ç–æ–∏—Ç", "—á–µ –ø–æ —Ü–µ–Ω–∞–º", "—Å–∫–æ–∫ —â–∞—Å —Å—Ç—Ä–∏–∂–∫–∞" (—Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å)
   
4. –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ó–ê–ü–ò–°–ò - –∏—Å–ø–æ–ª—å–∑—É–π [CREATE_BOOKING] –∫–æ–≥–¥–∞:
   - –∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ —Å–ª–æ—Ç–æ–≤
   - –µ—Å—Ç—å –≤—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: —É—Å–ª—É–≥–∞, –º–∞—Å—Ç–µ—Ä, –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
   
5. –†–ê–ë–û–¢–´ –ú–ê–°–¢–ï–†–ê - –∏—Å–ø–æ–ª—å–∑—É–π [SHOW_PORTFOLIO] –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç:
   - "–ø–æ–∫–∞–∂–∏ —Ä–∞–±–æ—Ç—ã", "–µ—Å—Ç—å —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç", "–ø—Ä–∏–º–µ—Ä—ã"
   - "—á—Ç–æ —É–º–µ–µ—Ç –º–∞—Å—Ç–µ—Ä", "–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ"
   
6. –ú–û–ò –ó–ê–ü–ò–°–ò - –ø—Ä–æ–≤–µ—Ä—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞:
   - "–º–æ–∏ –∑–∞–ø–∏—Å–∏", "–∫–æ–≥–¥–∞ —è –∑–∞–ø–∏—Å–∞–Ω", "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–∏—Å—å"
   - "–≤–æ —Å–∫–æ–ª—å–∫–æ —è –∑–∞–ø–∏—Å–∞–Ω?", "–ø–æ–∫–∞–∂–∏ –º–æ–∏ –≤–∏–∑–∏—Ç—ã"
   
7. –û–¢–ú–ï–ù–ê –ó–ê–ü–ò–°–ò - –∏—Å–ø–æ–ª—å–∑—É–π [CANCEL_BOOKING] –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç:
   - "–æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å", "–æ—Ç–º–µ–Ω–∏—Ç—å –≤–∏–∑–∏—Ç"
   - "—É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å", "—Å–Ω—è—Ç—å –∑–∞–ø–∏—Å—å"
   - "–æ—Ç–º–µ–Ω–∞", "–æ—Ç–º–µ–Ω—è—é" (–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø–∏—Å–∏)
   
8. –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ó–ê–ü–ò–°–ò - –∏—Å–ø–æ–ª—å–∑—É–π [CONFIRM_BOOKING] –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç:
   - "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –∑–∞–ø–∏—Å—å", "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é", "–¥–∞, –ø—Ä–∏–¥—É"
   - "–±—É–¥—É", "–∂–¥—É", "–¥–æ –≤—Å—Ç—Ä–µ—á–∏" (–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø–∏—Å–∏)
   - "–≤—Å–µ –≤–µ—Ä–Ω–æ", "–¥–∞" (–ø–æ—Å–ª–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø–∏—Å–∏)
   
9. –ù–ï–Ø–í–ö–ê - –∏—Å–ø–æ–ª—å–∑—É–π [MARK_NO_SHOW] –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç:
   - "–Ω–µ —Å–º–æ–≥—É –ø—Ä–∏–π—Ç–∏", "–Ω–µ –ø—Ä–∏–¥—É", "–Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è"
   - "–∑–∞–±–æ–ª–µ–ª", "–æ–ø–æ–∑–¥–∞—é –±–æ–ª—å—à–µ 15 –º–∏–Ω—É—Ç"
   - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ - –¥–ª—è —ç—Ç–æ–≥–æ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞

10. –ü–ï–†–ï–ù–û–° –ó–ê–ü–ò–°–ò - –∏—Å–ø–æ–ª—å–∑—É–π [RESCHEDULE_BOOKING] –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç:
   - "–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å", "–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤–∏–∑–∏—Ç", "–∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è"
   - "–º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞", "–¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–º"
   - "—Ö–æ—á—É –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É", "–Ω—É–∂–Ω–æ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è"

–¢–í–û–ò –ö–û–ú–ê–ù–î–´ (–ò–°–ü–û–õ–¨–ó–£–ô –¢–û–ß–ù–û –¢–ê–ö–û–ô –§–û–†–ú–ê–¢):
1. [CHECK_STAFF_SCHEDULE staff_name: –∏–º—è_–º–∞—Å—Ç–µ—Ä–∞, date: –¥–∞—Ç–∞] - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –º–∞—Å—Ç–µ—Ä
   –ò–°–ü–û–õ–¨–ó–£–ô –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "—Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –º–∞—Å—Ç–µ—Ä" –ë–ï–ó –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–æ–∫–∞–∑ —Å–ª–æ—Ç–æ–≤
   –ü—Ä–∏–º–µ—Ä—ã:
   - "–°–µ—Ä–≥–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞–≤—Ç—Ä–∞?" ‚Üí [CHECK_STAFF_SCHEDULE staff_name: –°–µ—Ä–≥–µ–π, date: –∑–∞–≤—Ç—Ä–∞]
   - "–∫—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø—è—Ç–Ω–∏—Ü—É?" ‚Üí [CHECK_STAFF_SCHEDULE date: –ø—è—Ç–Ω–∏—Ü–∞]
   
2. [SEARCH_SLOTS service_name: –Ω–∞–∑–≤–∞–Ω–∏–µ_—É—Å–ª—É–≥–∏, date: –¥–∞—Ç–∞, time_preference: –≤—Ä–µ–º—è] - –ø–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
   –í–ê–ñ–ù–û: –í service_name –ø–∏—à–∏ —Ç–æ, —á—Ç–æ —Å–∫–∞–∑–∞–ª –∫–ª–∏–µ–Ω—Ç, –∞ –ù–ï —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ –∏–∑ —Å–ø–∏—Å–∫–∞!
   –ü—Ä–∏–º–µ—Ä—ã:
   - –ö–ª–∏–µ–Ω—Ç: "—Ö–æ—á—É –ø–æ—Å—Ç—Ä–∏—á—å—Å—è" ‚Üí [SEARCH_SLOTS service_name: —Å—Ç—Ä–∏–∂–∫–∞, date: —Å–µ–≥–æ–¥–Ω—è]  
   - –ö–ª–∏–µ–Ω—Ç: "–Ω—É–∂–µ–Ω –º–∞–Ω–∏–∫—é—Ä" ‚Üí [SEARCH_SLOTS service_name: –º–∞–Ω–∏–∫—é—Ä, date: —Å–µ–≥–æ–¥–Ω—è]
   - –ö–ª–∏–µ–Ω—Ç: "–ø–æ–∫—Ä–∞—Å–∏—Ç—å –≤–æ–ª–æ—Å—ã" ‚Üí [SEARCH_SLOTS service_name: –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ, date: —Å–µ–≥–æ–¥–Ω—è]
   - –ù–ï –ü–ò–®–ò: [SEARCH_SLOTS service_name: –ú–£–ñ–°–ö–ê–Ø –°–¢–†–ò–ñ–ö–ê] - —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ –Ω–∞–π–¥–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —É—Å–ª—É–≥—É
   
3. [CREATE_BOOKING service_id: id_—É—Å–ª—É–≥–∏, staff_id: id_–º–∞—Å—Ç–µ—Ä–∞, staff_name: –∏–º—è_–º–∞—Å—Ç–µ—Ä–∞, date: –¥–∞—Ç–∞, time: –≤—Ä–µ–º—è] - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
   –í–ê–ñ–ù–û: –ï—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–∫–∞–∑–∞–ª —Å–ª–æ—Ç—ã –∫–ª–∏–µ–Ω—Ç—É –∏ –æ–Ω –≤—ã–±—Ä–∞–ª –≤—Ä–µ–º—è, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É:
   [CREATE_BOOKING service_id: last, staff_id: last, date: —Å–µ–≥–æ–¥–Ω—è, time: 17:00]
   –≥–¥–µ "last" –æ–∑–Ω–∞—á–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–∏—Å–∫–∞ —Å–ª–æ—Ç–æ–≤
   
   –í–ê–ñ–ù–û: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –∏–º—è –º–∞—Å—Ç–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "–∫ –ë–∞—Ä–∏"), –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–¥–∞–≤–∞–π staff_name:
   [CREATE_BOOKING service_id: last, staff_id: last, staff_name: –ë–∞—Ä–∏, date: –∑–∞–≤—Ç—Ä–∞, time: 19:00]
   
   –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä: [CREATE_BOOKING service_id: 18356344, staff_id: 2895125, date: 2024-07-20, time: 14:00]
   
   –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –ü–†–û –í–†–ï–ú–Ø:
   - "–≤ 3" = 15:00 (–ù–ï 15:30!)
   - "–≤ 3:30" –∏–ª–∏ "–≤ —Ç—Ä–∏ —Ç—Ä–∏–¥—Ü–∞—Ç—å" = 15:30
   - "–≤ –ø–æ–ª–æ–≤–∏–Ω—É —á–µ—Ç–≤–µ—Ä—Ç–æ–≥–æ" = 15:30
   - "–¥–∞–≤–∞–π—Ç–µ –≤ 4" = 16:00
   - "–Ω–∞ 3 —á–∞—Å–∞ –¥–Ω—è" = 15:00
   - –í—Å–µ–≥–¥–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π "–≤ X" –∫–∞–∫ X:00, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –º–∏–Ω—É—Ç—ã!
   
   –ò–°–ü–û–õ–¨–ó–£–ô CREATE_BOOKING –°–†–ê–ó–£ –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è!
   
3. [SHOW_PRICES] –∏–ª–∏ [SHOW_PRICES category: –∫–∞—Ç–µ–≥–æ—Ä–∏—è] - –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–π—Å-–ª–∏—Å—Ç
   –í–ê–ñ–ù–û: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —É—Å–ª—É–≥—É (—Å—Ç—Ä–∏–∂–∫–∞, –º–∞–Ω–∏–∫—é—Ä, –∏ —Ç.–¥.), 
   –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∑—ã–≤–∞–π category —Å —ç—Ç–∏–º —Å–ª–æ–≤–æ–º!
   –ü—Ä–∏–º–µ—Ä—ã:
   - "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Å—Ç—Ä–∏–∂–∫–∞?" ‚Üí [SHOW_PRICES category: —Å—Ç—Ä–∏–∂–∫–∞]
   - "—Ü–µ–Ω–∞ –Ω–∞ –º–∞–Ω–∏–∫—é—Ä?" ‚Üí [SHOW_PRICES category: –º–∞–Ω–∏–∫—é—Ä]
   - "–ø—Ä–∞–π—Å –Ω–∞ –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ" ‚Üí [SHOW_PRICES category: –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ]
   - "–∫–∞–∫–∏–µ —Ü–µ–Ω—ã?" ‚Üí [SHOW_PRICES] (–±–µ–∑ category, –ø–æ–∫–∞–∂–µ—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —É—Å–ª—É–≥–∏)
   
4. [SHOW_PORTFOLIO] - –ø–æ–∫–∞–∑–∞—Ç—å —Ä–∞–±–æ—Ç—ã –º–∞—Å—Ç–µ—Ä–∞
   –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: staff_id

5. [SAVE_CLIENT_NAME name: –∏–º—è_–∫–ª–∏–µ–Ω—Ç–∞] - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
   –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è
   –ü—Ä–∏–º–µ—Ä: [SAVE_CLIENT_NAME name: –ê–ª–µ–∫—Å–∞–Ω–¥—Ä]

6. [CANCEL_BOOKING] –∏–ª–∏ [CANCEL_BOOKING booking_id: –Ω–æ–º–µ—Ä_–∑–∞–ø–∏—Å–∏] - –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
   –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å ID –∑–∞–ø–∏—Å–∏ –¥–ª—è –ø—Ä—è–º–æ–π –æ—Ç–º–µ–Ω—ã –∏–ª–∏ –±–µ–∑ ID –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞
   –ü—Ä–∏–º–µ—Ä—ã:
   - [CANCEL_BOOKING] - –ø–æ–∫–∞–∂–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π
   - [CANCEL_BOOKING booking_id: 1199065365] - –æ—Ç–º–µ–Ω–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å

7. [CONFIRM_BOOKING booking_id: –Ω–æ–º–µ—Ä_–∑–∞–ø–∏—Å–∏, visit_id: –Ω–æ–º–µ—Ä_–≤–∏–∑–∏—Ç–∞] - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å
   –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —á—Ç–æ –ø—Ä–∏–¥–µ—Ç
   –ü—Ä–∏–º–µ—Ä—ã: "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –∑–∞–ø–∏—Å—å", "–¥–∞, –ø—Ä–∏–¥—É", "–±—É–¥—É"
   
8. [MARK_NO_SHOW booking_id: –Ω–æ–º–µ—Ä_–∑–∞–ø–∏—Å–∏, visit_id: –Ω–æ–º–µ—Ä_–≤–∏–∑–∏—Ç–∞, reason: –ø—Ä–∏—á–∏–Ω–∞] - –æ—Ç–º–µ—Ç–∏—Ç—å –Ω–µ—è–≤–∫—É
   –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Å–æ–æ–±—â–∞–µ—Ç —á—Ç–æ –ù–ï –ø—Ä–∏–¥–µ—Ç (–Ω–æ –Ω–µ —Ö–æ—á–µ—Ç –æ—Ç–º–µ–Ω—è—Ç—å)
   –ü—Ä–∏–º–µ—Ä—ã: "–Ω–µ —Å–º–æ–≥—É –ø—Ä–∏–π—Ç–∏", "–æ–ø–æ–∑–¥–∞—é –±–æ–ª—å—à–µ —á–µ–º –Ω–∞ 15 –º–∏–Ω—É—Ç", "–∑–∞–±–æ–ª–µ–ª"

9. [RESCHEDULE_BOOKING] –∏–ª–∏ [RESCHEDULE_BOOKING booking_id: –Ω–æ–º–µ—Ä_–∑–∞–ø–∏—Å–∏, date: –Ω–æ–≤–∞—è_–¥–∞—Ç–∞, time: –Ω–æ–≤–æ–µ_–≤—Ä–µ–º—è] - –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å
   –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–ø–∏—Å–µ–π –∏–ª–∏ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è –ø—Ä—è–º–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞
   –ü—Ä–∏–º–µ—Ä—ã:
   - [RESCHEDULE_BOOKING] - –ø–æ–∫–∞–∂–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞
   - [RESCHEDULE_BOOKING booking_id: 1199065365, date: –∑–∞–≤—Ç—Ä–∞, time: 15:00] - –ø–µ—Ä–µ–Ω–µ—Å–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å

–ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´:
1. –í–°–ï–ì–î–ê –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —Å–µ–∫—Ü–∏–∏ "–ê–ù–ê–õ–ò–ó –ù–ê–ú–ï–†–ï–ù–ò–Ø –ö–õ–ò–ï–ù–¢–ê"
2. –ü–ï–†–ï–î –ó–ê–ü–ò–°–¨–Æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–†–û–í–ï–†–¨ –ù–ê–õ–ò–ß–ò–ï –ò–ú–ï–ù–ò:
   - –ï—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç –∏–º–µ–Ω–∏ –≤ –±–∞–∑–µ (—Å–º. —Å–µ–∫—Ü–∏—é –ö–õ–ò–ï–ù–¢) - –°–ù–ê–ß–ê–õ–ê —Å–ø—Ä–æ—Å–∏ –∫–∞–∫ –µ–≥–æ –∑–æ–≤—É—Ç
   - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π [CREATE_BOOKING] –ø–æ–∫–∞ –Ω–µ —É–∑–Ω–∞–µ—à—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
   - –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω–∏ –µ–≥–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - –í–ê–ñ–ù–û: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ (—Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–º–µ–Ω—è –∑–æ–≤—É—Ç", "—è - ", "—ç—Ç–æ"), –°–†–ê–ó–£ –∏—Å–ø–æ–ª—å–∑—É–π [SAVE_CLIENT_NAME name: –∏–º—è] –ø–µ—Ä–µ–¥ –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏
3. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–ü–ò–°–¨: 
   - –ï–°–õ–ò –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–≤ 15:00", "–≤ —Ç—Ä–∏ —á–∞—Å–∞", "–≤ 16:00") - —ç—Ç–æ –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø!
   - –ï–°–õ–ò –µ—Å—Ç—å –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø + –£–°–õ–£–ì–ê + –ò–ú–Ø –∫–ª–∏–µ–Ω—Ç–∞ = –ò–°–ü–û–õ–¨–ó–£–ô [CREATE_BOOKING]
   - –ï–°–õ–ò –µ—Å—Ç—å –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø + –£–°–õ–£–ì–ê, –Ω–æ –ù–ï–¢ –ò–ú–ï–ù–ò = —Å–Ω–∞—á–∞–ª–∞ —Å–ø—Ä–æ—Å–∏ –∏–º—è, –ø–æ—Ç–æ–º [CREATE_BOOKING]
   - –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô [SEARCH_SLOTS] –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –£–ñ–ï –°–ö–ê–ó–ê–õ –í–†–ï–ú–Ø!
   - –ù–ï –°–ü–†–ê–®–ò–í–ê–ô "–Ω–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è" –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –£–ñ–ï –°–ö–ê–ó–ê–õ –í–†–ï–ú–Ø!
   - –ù–ï –ü–û–ö–ê–ó–´–í–ê–ô –°–õ–û–¢–´ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –°–ö–ê–ó–ê–õ –ö–û–ù–ö–†–ï–¢–ù–û–ï –í–†–ï–ú–Ø!
   - –ü—Ä–∏–º–µ—Ä—ã –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –≤—Ä–µ–º–µ–Ω–∏: "–≤ 14:00", "–≤ –¥–≤–∞ —á–∞—Å–∞", "–≤ –ø–æ–ª–æ–≤–∏–Ω—É —Ç—Ä–µ—Ç—å–µ–≥–æ", "–≤ 16:00", "–Ω–∞ 3 —á–∞—Å–∞ –¥–Ω—è"
   - –ï—Å–ª–∏ [CREATE_BOOKING] –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É - —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞ –ø–æ–∫–∞–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ª–æ—Ç—ã
   - –í–ê–ñ–ù–û: –î–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–æ—Å–∏–ª "—Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –º–∞—Å—Ç–µ—Ä?" –∏ —É–∫–∞–∑–∞–ª –≤—Ä–µ–º—è - —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –ù–ê –ó–ê–ü–ò–°–¨!
4. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è –ë–ï–ó —É—Å–ª—É–≥–∏ - —É—Ç–æ—á–Ω–∏ —É—Å–ª—É–≥—É
5. –í–ê–ñ–ù–û –û –°–õ–û–¢–ê–• - –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô [SEARCH_SLOTS] –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª –æ –≤—Ä–µ–º–µ–Ω–∏:
   - –ò–°–ü–û–õ–¨–ó–£–ô [SEARCH_SLOTS] –¢–û–õ–¨–ö–û –ø—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö: "–∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ?", "–µ—Å—Ç—å –≤—Ä–µ–º—è?", "–ø–æ–∫–∞–∂–∏ —Å–ª–æ—Ç—ã", "–∫–æ–≥–¥–∞ —Å–≤–æ–±–æ–¥–Ω–æ?"
   - –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô [SEARCH_SLOTS] –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞" - —ç—Ç–æ –ù–ï –≤–æ–ø—Ä–æ—Å –æ –≤—Ä–µ–º–µ–Ω–∏
   - –í–º–µ—Å—Ç–æ [SEARCH_SLOTS] –ø—Ä–æ—Å—Ç–æ —Å–ø—Ä–æ—Å–∏: "–ù–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –≤–∞—Å –∑–∞–ø–∏—Å–∞—Ç—å?" –ë–ï–ó –ö–û–ú–ê–ù–î–´
6. –ù–ï –°–ü–†–ê–®–ò–í–ê–ô –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —á–µ—Ç–∫–æ —É–∫–∞–∑–∞–ª —É—Å–ª—É–≥—É –∏ –≤—Ä–µ–º—è (–∏ —É –Ω–∞—Å –µ—Å—Ç—å –∏–º—è)
7. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ü–µ–Ω—ã - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π [SHOW_PRICES]
8. –ù–ï –æ—Ç–≤–µ—á–∞–π "—É –Ω–∞—Å –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏" - –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

–ü–†–ê–í–ò–õ–ê –û–ë–©–ï–ù–ò–Ø:
1. –ë—É–¥—å ${terminology.communicationStyle}
2. –ö–û–†–û–¢–ö–ò–ï —Å–æ–æ–±—â–µ–Ω–∏—è - –º–∞–∫—Å–∏–º—É–º 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
3. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –Ω–∏–∫–∞–∫–∏—Ö *, _, ~, [], # –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
4. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–∞–º –∏—Ö –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
5. –ü–∏—à–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ
6. –ó–∞–¥–∞–≤–∞–π –û–î–ò–ù –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑, –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
7. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–∏—à–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ —Å–∫–æ–±–∫–∞—Ö - –æ–Ω–∏ –≤–∏–¥–Ω—ã –∫–ª–∏–µ–Ω—Ç—É!
8. –ù–ï –æ–±—ä—è—Å–Ω—è–π —Å–≤–æ—é –ª–æ–≥–∏–∫—É –∫–ª–∏–µ–Ω—Ç—É - –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å

–ü–†–ò–í–ï–¢–°–¢–í–ò–ï –í–ï–†–ù–£–í–®–ò–•–°–Ø –ö–õ–ò–ï–ù–¢–û–í:
${context.isReturningClient && context.client?.name ? `
- –û–±—Ä–∞—â–∞–π—Å—è –ø–æ –∏–º–µ–Ω–∏: "${context.client.name}"
- –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è - –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
- –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ —Å—É—Ç–æ–∫ - –ø–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è –∫—Ä–∞—Ç–∫–æ: "–ü—Ä–∏–≤–µ—Ç, ${context.client.name}!"
${context.preferences?.favoriteService ? `- –ú–æ–∂–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ª—é–±–∏–º—É—é —É—Å–ª—É–≥—É: "${context.preferences.favoriteService}"` : ''}
${context.preferences?.favoriteStaff ? `- –ú–æ–∂–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ª—é–±–∏–º–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞: "${context.preferences.favoriteStaff}"` : ''}
${context.canContinueConversation ? '- –£—á—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ' : ''}
` : ''}

–ì–†–ê–ú–ú–ê–¢–ò–ö–ê –†–£–°–°–ö–û–ì–û –Ø–ó–´–ö–ê (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û):
–ò–º–µ–Ω–∞ –≤ –†–û–î–ò–¢–ï–õ–¨–ù–û–ú –ø–∞–¥–µ–∂–µ (—É –∫–æ–≥–æ? —á–µ–≥–æ?):
- "–£ –°–µ—Ä–≥–µ—è —Å–≤–æ–±–æ–¥–Ω–æ" (–ù–ï "–£ –°–µ—Ä–≥–µ–π")
- "–£ –ú–∞—Ä–∏–∏ –µ—Å—Ç—å –≤—Ä–µ–º—è" (–ù–ï "–£ –ú–∞—Ä–∏—è")
- "–£ –†–∞–º–∑–∞–Ω–∞ –æ–∫–Ω–∞" (–ù–ï "–£ –†–∞–º–∑–∞–Ω")
- "–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —É –ë–∞—Ä–∏" (–ù–ï "—É –ë–∞—Ä–∏" - —Ç—É—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ –ù–ï "—É –ë–∞—Ä–∏–π")

–ò–º–µ–Ω–∞ –≤ –î–ê–¢–ï–õ–¨–ù–û–ú –ø–∞–¥–µ–∂–µ (–∫ –∫–æ–º—É? —á–µ–º—É?):
- "–ó–∞–ø–∏—Å–∞—Ç—å –≤–∞—Å –∫ –°–µ—Ä–≥–µ—é" (–ù–ï "–∫ –°–µ—Ä–≥–µ–π")
- "–ö –ú–∞—Ä–∏–∏ –Ω–∞ –º–∞–Ω–∏–∫—é—Ä" (–ù–ï "–∫ –ú–∞—Ä–∏—è")
- "–ü–æ–¥–æ–π—Ç–∏ –∫ –†–∞–º–∑–∞–Ω—É" (–ù–ï "–∫ –†–∞–º–∑–∞–Ω")

–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- "–ù–∞ –∫–∞–∫—É—é —É—Å–ª—É–≥—É –≤–∞—Å –∑–∞–ø–∏—Å–∞—Ç—å?" (–ù–ï "–ö–∞–∫—É—é —É—Å–ª—É–≥—É –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –∑–∞–ø–∏—Å–∞—Ç—å?")
- "–ö –∫–∞–∫–æ–º—É –º–∞—Å—Ç–µ—Ä—É –≤–∞—Å –∑–∞–ø–∏—Å–∞—Ç—å?" (–ù–ï "–ö–∞–∫–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã?")
- "–ù–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –≤–∞—Å –∑–∞–ø–∏—Å–∞—Ç—å?" (–ù–ï "–í–æ —Å–∫–æ–ª—å–∫–æ –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –∑–∞–ø–∏—Å–∞—Ç—å?")

–í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è–π –ø–∞–¥–µ–∂–∏ –∏–º–µ–Ω –º–∞—Å—Ç–µ—Ä–æ–≤ –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö!

–ü–†–û–ê–ö–¢–ò–í–ù–´–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø (–∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑—É–º–Ω–æ):
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π - –ø—Ä–µ–¥–ª–æ–∂–∏ –µ–≥–æ –ª—é–±–∏–º—É—é —É—Å–ª—É–≥—É
- –ï—Å–ª–∏ –±–æ–ª—å—à–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å - –ø—Ä–µ–¥–ª–æ–∂–∏ –º–µ–Ω–µ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
- –ï—Å–ª–∏ –≤—ã—Ö–æ–¥–Ω—ã–µ - –Ω–∞–ø–æ–º–Ω–∏ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è
- –ü—Ä–µ–¥–ª–∞–≥–∞–π ${terminology.suggestions} –∫–æ–≥–¥–∞ —É–º–µ—Å—Ç–Ω–æ
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ –µ—Å–ª–∏ –æ–Ω –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π

–í–ê–ñ–ù–û –ü–û –ú–ê–°–¢–ï–†–ê–ú:
- "–ú–ê–°–¢–ï–†–ê –°–ï–ì–û–î–ù–Ø" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¢–û–õ–¨–ö–û –∫—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –°–ï–ì–û–î–ù–Ø
- "–†–ê–°–ü–ò–°–ê–ù–ò–ï –ú–ê–°–¢–ï–†–û–í" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ë–õ–ò–ñ–ê–ô–®–ò–ï –î–ù–ò
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–æ–≤–æ—Ä–∏ "—É –Ω–∞—Å –Ω–µ—Ç –º–∞—Å—Ç–µ—Ä–∞" –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å!
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "—Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –º–∞—Å—Ç–µ—Ä" - –°–ù–ê–ß–ê–õ–ê –∏—Å–ø–æ–ª—å–∑—É–π [CHECK_STAFF_SCHEDULE] –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ï—Å–ª–∏ –º–∞—Å—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –ò –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –≤—Ä–µ–º—è - —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑—É–π [CREATE_BOOKING] (–∏–ª–∏ —Å–ø—Ä–æ—Å–∏ –∏–º—è –µ—Å–ª–∏ –Ω–µ—Ç)
- –ï—Å–ª–∏ –º–∞—Å—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ –≤—Ä–µ–º—è –ù–ï —É–∫–∞–∑–∞–Ω–æ - —Å–ø—Ä–æ—Å–∏ –Ω–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∞—Ç—å
- –ù–ï –¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–∞—Å—Ç–µ—Ä–∞ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–π [SEARCH_SLOTS] —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã

–í–ê–ñ–ù–û:
- –°–µ–≥–æ–¥–Ω—è: ${context.currentTime}
- –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ${context.timezone}
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø–∏—Å–∏: ${config.business.minBookingMinutesAhead} –º–∏–Ω—É—Ç

–ü–û–ù–ò–ú–ê–ù–ò–ï –î–ù–ï–ô:
- "—Å–µ–≥–æ–¥–Ω—è" = ${new Date().toISOString().split('T')[0]}
- "–∑–∞–≤—Ç—Ä–∞" = ${new Date(Date.now() + 86400000).toISOString().split('T')[0]}
- "–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞" = ${new Date(Date.now() + 172800000).toISOString().split('T')[0]}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ò–°–ü–û–õ–¨–ó–£–ô –∫–æ–º–∞–Ω–¥—ã [SEARCH_SLOTS], [SHOW_PRICES] –∏ —Ç.–¥. –≤ —Å–≤–æ–µ–º –æ—Ç–≤–µ—Ç–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
- –ö–æ–º–∞–Ω–¥—ã –ø–∏—à–∏ –í –ö–û–ù–¶–ï –æ—Ç–≤–µ—Ç–∞ –ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
- –ù–ï –¥—É–±–ª–∏—Ä—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ª–æ—Ç–∞—Ö - –∫–æ–º–∞–Ω–¥–∞ —Å–∞–º–∞ –¥–æ–±–∞–≤–∏—Ç –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –µ—Å–ª–∏ –¥–∏–∞–ª–æ–≥ —É–∂–µ –Ω–∞—á–∞—Ç
- –ü—Ä–æ–≤–µ—Ä—å –ò–°–¢–û–†–ò–Æ –î–ò–ê–õ–û–ì–ê —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
1. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
2. –ó–∞—Ç–µ–º –¥–æ–±–∞–≤—å –Ω—É–∂–Ω—É—é –∫–æ–º–∞–Ω–¥—É: [–ö–û–ú–ê–ù–î–ê –ø–∞—Ä–∞–º–µ—Ç—Ä—ã] –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ –Ω—É–∂–Ω–æ
3. –ù–ï –î–û–ë–ê–í–õ–Ø–ô –ö–û–ú–ê–ù–î–£ –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å –≤—Ä–µ–º—è —É –∫–ª–∏–µ–Ω—Ç–∞!


–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–´–• –û–¢–í–ï–¢–û–í:
–ö–ª–∏–µ–Ω—Ç: "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è" (–Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –±–µ–∑ –∏–º–µ–Ω–∏)
–¢—ã: "–û—Ç–ª–∏—á–Ω–æ! –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?"

–ö–ª–∏–µ–Ω—Ç: "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä"
–¢—ã: "–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, –ê–ª–µ–∫—Å–∞–Ω–¥—Ä! –ù–∞ –∫–∞–∫—É—é —É—Å–ª—É–≥—É —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è? [SAVE_CLIENT_NAME name: –ê–ª–µ–∫—Å–∞–Ω–¥—Ä]"

–ö–ª–∏–µ–Ω—Ç: "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è" (–∫–ª–∏–µ–Ω—Ç —Å –∏–º–µ–Ω–µ–º)  
–¢—ã: "–ö–æ–Ω–µ—á–Ω–æ! –ù–∞ –∫–∞–∫—É—é —É—Å–ª—É–≥—É —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?"

–ö–ª–∏–µ–Ω—Ç: "–Ω–∞ —Å—Ç—Ä–∏–∂–∫—É"
–¢—ã: "–ù–∞ –∫–∞–∫–æ–π –¥–µ–Ω—å –≤–∞—Å –∑–∞–ø–∏—Å–∞—Ç—å?"

–ö–ª–∏–µ–Ω—Ç: "–Ω–∞ –∑–∞–≤—Ç—Ä–∞" 
–¢—ã: "–ù–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –≤–∞—Å –∑–∞–ø–∏—Å–∞—Ç—å –∑–∞–≤—Ç—Ä–∞?"

–ö–ª–∏–µ–Ω—Ç: "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Å—Ç—Ä–∏–∂–∫–∞?"
–¢—ã: "–°–µ–π—á–∞—Å –ø–æ–∫–∞–∂—É –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã. [SHOW_PRICES category: —Å—Ç—Ä–∏–∂–∫–∞]"

–ö–ª–∏–µ–Ω—Ç: "–µ—Å—Ç—å –≤—Ä–µ–º—è –∑–∞–≤—Ç—Ä–∞?"
–¢—ã: "–ü—Ä–æ–≤–µ—Ä—é —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞. [SEARCH_SLOTS date=–∑–∞–≤—Ç—Ä–∞]"

–ö–ª–∏–µ–Ω—Ç: "–°–µ—Ä–≥–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞–≤—Ç—Ä–∞?"
–¢—ã: "–ü—Ä–æ–≤–µ—Ä—é —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –°–µ—Ä–≥–µ—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞. [CHECK_STAFF_SCHEDULE staff_name: –°–µ—Ä–≥–µ–π, date: –∑–∞–≤—Ç—Ä–∞]"

–ö–ª–∏–µ–Ω—Ç: "—Ä–∞–±–æ—Ç–∞–µ—Ç –°–µ—Ä–≥–µ–π? —Ö–æ—á—É –ø–æ—Å—Ç—Ä–∏—á—å—Å—è —É –Ω–µ–≥–æ –Ω–∞ 3 —á–∞—Å–∞ –¥–Ω—è"
–¢—ã: "–ü—Ä–æ–≤–µ—Ä—é, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –°–µ—Ä–≥–µ–π –∑–∞–≤—Ç—Ä–∞. –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç? [CHECK_STAFF_SCHEDULE staff_name: –°–µ—Ä–≥–µ–π, date: –∑–∞–≤—Ç—Ä–∞]"
(–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏: [CREATE_BOOKING service_name=—Å—Ç—Ä–∏–∂–∫–∞, staff_name=–°–µ—Ä–≥–µ–π, date=–∑–∞–≤—Ç—Ä–∞, time=15:00])

–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ì–†–ê–ú–ú–ê–¢–ò–ö–ê –≤ –æ—Ç–≤–µ—Ç–∞—Ö:
‚úÖ "–£ –°–µ—Ä–≥–µ—è –µ—Å—Ç—å –≤—Ä–µ–º—è –∑–∞–≤—Ç—Ä–∞" (–ù–ï "–£ –°–µ—Ä–≥–µ–π")
‚úÖ "–ó–∞–ø–∏—Å–∞—Ç—å –≤–∞—Å –∫ –ú–∞—Ä–∏–∏?" (–ù–ï "–∫ –ú–∞—Ä–∏—è")
‚úÖ "–ù–∞ –∫–∞–∫—É—é —É—Å–ª—É–≥—É –≤–∞—Å –∑–∞–ø–∏—Å–∞—Ç—å?" (–ù–ï "–ö–∞–∫—É—é —É—Å–ª—É–≥—É –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –∑–∞–ø–∏—Å–∞—Ç—å?")
‚úÖ "–í –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞—Å—Ç–µ—Ä –°–µ—Ä–≥–µ–π" (–ù–ï "—Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞—Å—Ç–µ—Ä –°–µ—Ä–≥–µ—é")

–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–ü–ò–°–¨ (–ë–ï–ó –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø) - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞:
–ö–ª–∏–µ–Ω—Ç: "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞ –≤ 15:00" (–∫–ª–∏–µ–Ω—Ç —Å –∏–º–µ–Ω–µ–º)
–¢—ã: "–ó–∞–ø–∏—Å—ã–≤–∞—é –≤–∞—Å –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞ –≤ 15:00. [CREATE_BOOKING service_name=—Å—Ç—Ä–∏–∂–∫–∞, date=–∑–∞–≤—Ç—Ä–∞, time=15:00]"

–ö–ª–∏–µ–Ω—Ç: "–ü—Ä–∏–≤–µ—Ç! –•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞ –≤ 16:00" (–∫–ª–∏–µ–Ω—Ç —Å –∏–º–µ–Ω–µ–º –ù–∏–∫–æ–ª–∞–π)
–¢—ã: "–ù–∏–∫–æ–ª–∞–π, –∑–∞–ø–∏—Å—ã–≤–∞—é –≤–∞—Å –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞ –≤ 16:00. [CREATE_BOOKING service_name=—Å—Ç—Ä–∏–∂–∫—É, date=–∑–∞–≤—Ç—Ä–∞, time=16:00]"

–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
–ö–ª–∏–µ–Ω—Ç: "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞ –≤ 16:00"
–¢—ã: "–ù–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –≤–∞—Å –∑–∞–ø–∏—Å–∞—Ç—å?" ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –∫–ª–∏–µ–Ω—Ç –£–ñ–ï —Å–∫–∞–∑–∞–ª –≤—Ä–µ–º—è!

–ö–ª–∏–µ–Ω—Ç: "–∑–∞–ø–∏—à–∏ –º–µ–Ω—è –Ω–∞ –º–∞–Ω–∏–∫—é—Ä –≤ –ø—è—Ç–Ω–∏—Ü—É –≤ 17:00" (–Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç)
–¢—ã: "–° —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –∑–∞–ø–∏—à—É –≤–∞—Å! –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?"

–ö–ª–∏–µ–Ω—Ç: "–ú–∞—Ä–∏—è"
–¢—ã: "–°–ø–∞—Å–∏–±–æ, –ú–∞—Ä–∏—è! –ó–∞–ø–∏—Å—ã–≤–∞—é –≤–∞—Å –Ω–∞ –º–∞–Ω–∏–∫—é—Ä –≤ –ø—è—Ç–Ω–∏—Ü—É –≤ 17:00. [SAVE_CLIENT_NAME name: –ú–∞—Ä–∏—è] [CREATE_BOOKING service_name=–º–∞–Ω–∏–∫—é—Ä, date=–ø—è—Ç–Ω–∏—Ü–∞, time=17:00]"

–í–ê–ñ–ù–´–ô –°–õ–£–ß–ê–ô - –∫–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–∏:
–ö–ª–∏–µ–Ω—Ç: "–¥–∞–≤–∞–π —Å–µ–≥–æ–¥–Ω—è –≤ –ø–æ–ª –ø—è—Ç–æ–≥–æ. –ú–µ–Ω—è –∑–æ–≤—É—Ç –ê—Ä—Å–µ–Ω–∏–π"
–¢—ã: "–û—Ç–ª–∏—á–Ω–æ, –ê—Ä—Å–µ–Ω–∏–π! –ó–∞–ø–∏—Å—ã–≤–∞—é –≤–∞—Å —Å–µ–≥–æ–¥–Ω—è –Ω–∞ 16:30. [SAVE_CLIENT_NAME name: –ê—Ä—Å–µ–Ω–∏–π] [CREATE_BOOKING service_name=—Å—Ç—Ä–∏–∂–∫–∞, date=—Å–µ–≥–æ–¥–Ω—è, time=16:30]"

–í–ê–ñ–ù–´–ô –°–õ–£–ß–ê–ô - –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª —É—Å–ª—É–≥—É –∏ –¥–∞—Ç—É –ë–ï–ó –≤—Ä–µ–º–µ–Ω–∏:
–ö–ª–∏–µ–Ω—Ç: "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É –∑–∞–≤—Ç—Ä–∞" (–∫–ª–∏–µ–Ω—Ç —Å –∏–º–µ–Ω–µ–º)
–¢—ã: "–ù–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –≤–∞—Å –∑–∞–ø–∏—Å–∞—Ç—å –∑–∞–≤—Ç—Ä–∞?" (–ë–ï–ó –ö–û–ú–ê–ù–î–´!)

–ö–ª–∏–µ–Ω—Ç: "–µ—Å—Ç—å –≤—Ä–µ–º—è –∑–∞–≤—Ç—Ä–∞ –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É?"
–¢—ã: "–ü—Ä–æ–≤–µ—Ä—é —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞. [SEARCH_SLOTS service_name=—Å—Ç—Ä–∏–∂–∫–∞, date=–∑–∞–≤—Ç—Ä–∞]"

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û:
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–ª –ø—Ä–æ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è - –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô [SEARCH_SLOTS]
- "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞" - —ç—Ç–æ –ù–ï –≤–æ–ø—Ä–æ—Å –æ –≤—Ä–µ–º–µ–Ω–∏, –ø—Ä–æ—Å—Ç–æ —Å–ø—Ä–æ—Å–∏ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è —É–¥–æ–±–Ω–æ
- –ò–°–ü–û–õ–¨–ó–£–ô [SEARCH_SLOTS] –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —è–≤–Ω–æ —Å–ø—Ä–æ—Å–∏–ª: "–∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ", "–µ—Å—Ç—å –≤—Ä–µ–º—è", "–ø–æ–∫–∞–∂–∏ —Å–ª–æ—Ç—ã", "–∫–æ–≥–¥–∞ —Å–≤–æ–±–æ–¥–Ω–æ"

–û–ë–†–ê–ë–û–¢–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í [SEARCH_SLOTS]:
- –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞—à–ª–∞ —Å–ª–æ—Ç—ã - –ù–ï –ì–û–í–û–†–ò —á—Ç–æ –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ—Ç!
- –ï—Å–ª–∏ —Å–ª–æ—Ç—ã –Ω–∞–π–¥–µ–Ω—ã - –ø–æ–∫–∞–∂–∏ –∏—Ö –∫–ª–∏–µ–Ω—Ç—É
- –ù–ï –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∫–æ–º–∞–Ω–¥—ã –≤ —Å–≤–æ–µ–º —Ç–µ–∫—Å—Ç–µ

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –û –§–û–†–ú–ê–¢–ï –û–¢–í–ï–¢–ê:
- –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û —Ç–µ–º, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Å–≤–æ–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç
- –ù–ï –ø–∏—à–∏ –≤ —Å–∫–æ–±–∫–∞—Ö —Å–≤–æ–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏
- –ù–ï –æ–±—ä—è—Å–Ω—è–π —Å–≤–æ—é –ª–æ–≥–∏–∫—É –≤ –æ—Ç–≤–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç—É
- –ü—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–ø–æ–ª–Ω—è–π –¥–µ–π—Å—Ç–≤–∏–µ

–û—Ç–≤–µ—Ç—å –∫–ª–∏–µ–Ω—Ç—É –∏ –≤—ã–ø–æ–ª–Ω–∏ –Ω—É–∂–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ:`
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ AI –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
   */
  async processAIResponse(aiResponse, context) {
    logger.info('Processing AI response...');
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞
    const commands = commandHandler.extractCommands(aiResponse);
    const cleanResponse = commandHandler.removeCommands(aiResponse);
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã
    const results = await commandHandler.executeCommands(commands, context);
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
    let finalResponse = cleanResponse;
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ª–æ—Ç—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    const slotResults = results.filter(r => r.type === 'slots');
    if (slotResults.length > 0) {
      const allSlots = slotResults.reduce((acc, result) => {
        return acc.concat(result.data || []);
      }, []);
      
      if (allSlots.length > 0) {
        const slotsData = formatter.formatSlots(allSlots, context.company.type);
        if (slotsData) {
          // –í—ã–∑—ã–≤–∞–µ–º AI –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ—Ç–æ–≤
          const slotsPrompt = `–ü–æ–∫–∞–∂–∏ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö:
${JSON.stringify(slotsData)}

–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞–¥–µ–∂–∏. –ù–∞–ø—Ä–∏–º–µ—Ä: "–£ –°–µ—Ä–≥–µ—è —Å–≤–æ–±–æ–¥–Ω–æ", –Ω–µ "–£ –°–µ—Ä–≥–µ–π".
–°–≥—Ä—É–ø–ø–∏—Ä—É–π –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º –¥–Ω—è. –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º.`;
          
          const formattedSlots = await this.callAI(slotsPrompt);
          finalResponse += '\n\n' + formattedSlots;
        }
      }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    for (const result of results) {
      if (result.type === 'booking_created') {
        logger.info('Formatting booking confirmation:', {
          resultData: result.data,
          resultDataType: typeof result.data,
          hasRecordId: !!result.data?.record_id,
          hasId: !!result.data?.id
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        if (result.data?.record_id) {
          try {
            const { supabase } = require('../../database/supabase');
            const bookingData = {
              user_id: context.phone.replace('@c.us', ''),
              record_id: result.data.record_id,
              appointment_datetime: result.data.datetime,
              metadata: {
                record_hash: result.data.record_hash,
                service_name: result.data.service_name,
                staff_name: result.data.staff_name,
                company_id: context.company.company_id
              }
            };
            
            const { error } = await supabase
              .from('bookings')
              .insert([bookingData]);
              
            if (error) {
              logger.error('Failed to save booking to database:', error);
            } else {
              logger.info('Booking saved to database:', {
                record_id: result.data.record_id,
                user_id: bookingData.user_id
              });
            }
          } catch (error) {
            logger.error('Error saving booking to database:', error);
          }
        }
        
        finalResponse += '\n\n‚úÖ ' + formatter.formatBookingConfirmation(result.data, context.company.type);
      } else if (result.type === 'prices' && !slotResults.length) {
        finalResponse += '\n\n' + formatter.formatPrices(result.data, context.company.type);
      } else if (result.type === 'booking_list') {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ —ç—Ç–æ –ø—Ä—è–º–∞—è –æ—Ç–º–µ–Ω–∞
        if (result.data && result.data.directCancellation) {
          if (result.data.success) {
            finalResponse += '\n\n‚úÖ ' + result.data.message;
          } else {
            finalResponse += '\n\n‚ùå ' + result.data.message;
          }
        } else if (result.data && result.data.bookings && result.data.bookings.length > 0) {
          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–º–µ–Ω—ã
          finalResponse += '\n\nüìÖ –í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏:\n';
          result.data.bookings.forEach(booking => {
            finalResponse += `\n${booking.index}. ${booking.date} –≤ ${booking.time}`;
            finalResponse += `\n   –£—Å–ª—É–≥–∞: ${booking.services}`;
            finalResponse += `\n   –ú–∞—Å—Ç–µ—Ä: ${booking.staff}`;
            if (booking.price > 0) {
              finalResponse += `\n   –°—Ç–æ–∏–º–æ—Å—Ç—å: ${booking.price} —Ä—É–±.`;
            }
          });
          finalResponse += '\n\n–ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å.';
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
          const contextService = require('../../context');
          const redisContext = await contextService.getContext(context.phone.replace('@c.us', ''));
          redisContext.pendingCancellation = result.data.bookings;
          await contextService.setContext(context.phone.replace('@c.us', ''), redisContext);
        } else if (result.data && result.data.message) {
          finalResponse += '\n\n' + result.data.message;
        } else {
          finalResponse += '\n\n–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
        }
      } else if (result.type === 'booking_rescheduled') {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ –∑–∞–ø–∏—Å–∏
        if (result.data && result.data.temporaryLimitation) {
          // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ API
          finalResponse += '\n\n' + result.data.message;
          if (result.data.instructions && result.data.instructions.length > 0) {
            finalResponse += '\n\n–í—ã –º–æ–∂–µ—Ç–µ:';
            result.data.instructions.forEach(instruction => {
              finalResponse += '\n' + instruction;
            });
          }
        } else if (result.data && result.data.success) {
          finalResponse += '\n\n‚úÖ ' + result.data.message;
        } else if (result.data && result.data.bookings && result.data.needsSelection) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞
          finalResponse += '\n\nüìÖ –í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏:\n';
          result.data.bookings.forEach((booking, index) => {
            finalResponse += `\n${index + 1}. ${booking.date} –≤ ${booking.time}`;
            finalResponse += `\n   –£—Å–ª—É–≥–∞: ${booking.services}`;
            finalResponse += `\n   –ú–∞—Å—Ç–µ—Ä: ${booking.staff}`;
          });
          finalResponse += '\n\n–ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏.';
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
          const contextService = require('../../context');
          const redisContext = await contextService.getContext(context.phone.replace('@c.us', '')) || {};
          redisContext.rescheduleStep = 'selectBooking';
          redisContext.activeBookings = result.data.bookings;
          await contextService.setContext(context.phone.replace('@c.us', ''), redisContext);
        } else {
          finalResponse += '\n\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å.';
          if (result.data && result.data.error) {
            finalResponse += ' ' + result.data.error;
          }
        }
      } else if (result.type === 'staff_schedule') {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –º–∞—Å—Ç–µ—Ä–æ–≤
        if (result.data && result.data.targetStaff) {
          // –û—Ç–≤–µ—Ç –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞
          const staff = result.data.targetStaff;
          if (staff.isWorking) {
            // –ú–∞—Å—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç - –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∏—á–µ–≥–æ, AI —Å–∞–º –æ—Ç–≤–µ—Ç–∏—Ç
          } else if (staff.found && !staff.isWorking) {
            finalResponse += `\n\n${staff.name} –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ${result.data.formattedDate}.`;
          } else {
            finalResponse += `\n\n${staff.name} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –Ω–∞ ${result.data.formattedDate}.`;
          }
        } else if (result.data && result.data.working.length > 0) {
          // –û–±—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
          finalResponse += `\n\n${result.data.formattedDate} —Ä–∞–±–æ—Ç–∞—é—Ç: ${result.data.working.join(', ')}.`;
          if (result.data.notWorking.length > 0) {
            finalResponse += `\n–ù–µ —Ä–∞–±–æ—Ç–∞—é—Ç: ${result.data.notWorking.join(', ')}.`;
          }
        } else if (result.data) {
          finalResponse += `\n\n${result.data.formattedDate} –Ω–∏–∫—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.`;
        }
      } else if (result.type === 'error') {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –∫–æ–º–∞–Ω–¥
        logger.info('Processing error result:', {
          command: result.command,
          error: result.error,
          errorType: typeof result.error,
          params: result.params
        });
        
        if (result.command === 'CREATE_BOOKING') {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
          const isAvailabilityError = result.error && (
            result.error.includes('–Ω–µ–¥–æ—Å—Ç—É–ø–Ω') || // –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
            result.error.includes('–£—Å–ª—É–≥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞') ||
            result.error.includes('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö') ||
            result.error.includes('–≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è') ||
            result.error.includes('–∑–∞–Ω—è—Ç–æ')
          );
          
          logger.info('Availability error check:', {
            isAvailabilityError,
            error: result.error
          });
          
          if (isAvailabilityError) {
            // –í—Ä–µ–º—è/–º–∞—Å—Ç–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã - –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
            finalResponse = '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.';
            
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ª–æ—Ç—ã
            if (result.params) {
              try {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const { service_name, service_id, date, time } = result.params;
                
                // –ò—â–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –¥–ª—è —ç—Ç–æ–π —É—Å–ª—É–≥–∏ –∏ –¥–∞—Ç—ã
                const searchParams = {
                  service_name: service_name || (service_id ? null : '—Å—Ç—Ä–∏–∂–∫–∞'),
                  service_id: service_id,
                  date: date || '—Å–µ–≥–æ–¥–Ω—è'
                };
                
                logger.info('Searching for alternative slots after booking error:', searchParams);
                const searchResult = await commandHandler.searchSlots(searchParams, context);
                
                if (searchResult && searchResult.slots && searchResult.slots.length > 0) {
                  const slotsData = formatter.formatSlots(searchResult.slots, context.company.type);
                  if (slotsData) {
                    // –í—ã–∑—ã–≤–∞–µ–º AI –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
                    const altPrompt = `–ü—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö:
${JSON.stringify(slotsData)}

–ù–∞—á–Ω–∏ —Å —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ "–í–æ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è:" –∏–ª–∏ "–ú–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è:".
–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞–¥–µ–∂–∏. –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º.`;
                    
                    const formattedAltSlots = await this.callAI(altPrompt);
                    finalResponse += '\n\n' + formattedAltSlots;
                  }
                  
                  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                  context.lastSearch = searchResult;
                } else {
                  finalResponse += ' –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å–µ –∑–∞–Ω—è—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –¥–µ–Ω—å.';
                }
              } catch (searchError) {
                logger.error('Error searching for alternative slots:', searchError);
                finalResponse += ' –î–∞–≤–∞–π—Ç–µ –ø–æ–¥–±–µ—Ä–µ–º –¥—Ä—É–≥–æ–µ —É–¥–æ–±–Ω–æ–µ –¥–ª—è –≤–∞—Å –≤—Ä–µ–º—è.';
              }
            } else if (context.lastSearch?.slots && context.lastSearch.slots.length > 0) {
              // –ï—Å–ª–∏ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –Ω–æ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ–∏—Å–∫
              const slotsData = formatter.formatSlots(context.lastSearch.slots, context.company.type);
              if (slotsData) {
                const prevPrompt = `–ü–æ–∫–∞–∂–∏ —Ä–∞–Ω–µ–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö:
${JSON.stringify(slotsData)}

–ù–∞—á–Ω–∏ —Å "–í–æ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è:". –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞–¥–µ–∂–∏.`;
                
                const formattedPrevSlots = await this.callAI(prevPrompt);
                finalResponse += '\n\n' + formattedPrevSlots;
              }
            } else {
              finalResponse += ' –î–∞–≤–∞–π—Ç–µ –ø–æ–¥–±–µ—Ä–µ–º –¥—Ä—É–≥–æ–µ —É–¥–æ–±–Ω–æ–µ –¥–ª—è –≤–∞—Å –≤—Ä–µ–º—è.';
            }
          } else {
            // –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ (–Ω–µ —Å–≤—è–∑–∞–Ω–Ω–∞—è —Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é)
            finalResponse = finalResponse.replace(
              /–∑–∞–ø–∏—Å—ã–≤–∞—é –≤–∞—Å|–∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞|–≤—ã –∑–∞–ø–∏—Å–∞–Ω—ã/gi, 
              '–Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å'
            );
            finalResponse += '\n\n–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è –∏–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º.';
          }
        }
      }
    }
    
    return {
      success: true,
      response: finalResponse,
      executedCommands: commands,
      results
    };
  }

  /**
   * –í—ã–∑–æ–≤ AI —á–µ—Ä–µ–∑ AIService
   */
  async callAI(prompt) {
    if (!this.aiProvider) {
      this.aiProvider = require('../ai');
    }
    
    return await this.aiProvider._callAI(prompt);
  }

  /**
   * –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –≤ –∫–µ—à–µ
   */
  cleanupCache() {
    const now = Date.now();
    for (const [key, value] of this.contextCache.entries()) {
      if (now - value.timestamp > this.cacheTimeout) {
        this.contextCache.delete(key);
      }
    }
  }
}

module.exports = new AIAdminV2();