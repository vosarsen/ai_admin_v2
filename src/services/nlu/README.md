# NLU Service Documentation

## Overview

The NLU (Natural Language Understanding) Service provides AI-powered entity extraction with fallback pattern matching for beauty salon booking conversations. It processes user messages in Russian and extracts booking-related entities like service names, staff preferences, dates, and times.

## Architecture

The service follows a modular architecture with single responsibility principle:

```
NLUService (Main Coordinator)
├── InputValidator - Validates and sanitizes input
├── PromptBuilder - Builds optimized AI prompts
├── EntityExtractor - Pattern-based entity extraction (fallback)
├── ActionResolver - Maps intents to actions
├── ResponseGenerator - Generates user responses
├── DataNormalizer - Normalizes extracted entities
├── NLUCache - LRU cache with TTL support
└── Error Classes - Structured error handling
```

## Key Features

- **AI-Powered Extraction**: Uses AI for accurate entity extraction
- **Fallback Pattern Matching**: Falls back to regex patterns when AI fails
- **Hybrid Approach**: Combines AI and pattern results for best accuracy
- **Smart Caching**: LRU cache with different TTLs based on confidence
- **Input Validation**: Protects against malformed or malicious input
- **Entity Normalization**: Converts various formats to standard representations
- **Error Handling**: Comprehensive error types with detailed context

## Usage Example

```javascript
const AIService = require('../ai');
const NLUService = require('../nlu');

// Initialize with optional cache configuration
const nluService = new NLUService(aiService, {
  maxSize: 2000,    // Max cached entries
  ttl: 7200000      // 2 hours TTL
});

// Process a message
const result = await nluService.processMessage(
  'Хочу записаться на маникюр к Марии завтра в 14:00',
  {
    phone: '+79991234567',
    companyId: '12345',
    client: { preferredStaff: 'Мария' }
  }
);

console.log(result);
// {
//   success: true,
//   intent: 'booking',
//   entities: {
//     service: 'маникюр',
//     staff: 'Мария',
//     date: '2024-01-10',
//     time: '14:00'
//   },
//   action: 'create_booking',
//   response: 'Записываю вас к Мария на 2024-01-10 в 14:00. Подтверждаю запись.',
//   confidence: 0.9,
//   provider: 'ai-nlu'
// }

// Get cache statistics
const stats = nluService.getCacheStats();
console.log(stats);
// { hits: 45, misses: 15, evictions: 5, size: 250, maxSize: 2000, hitRate: '75.00%' }

// Clean up when done
nluService.destroy();
```

## Entity Types

### Service Names
- `маникюр` - Manicure (includes variations: ногти, ноготочки)
- `педикюр` - Pedicure (includes variations: стопы, ножки)
- `стрижка` - Haircut (includes variations: подстричься, волосы)
- `окрашивание` - Hair coloring

### Staff Names
- Normalized to proper case: `мария` → `Мария`
- Common nicknames mapped: `маша` → `Мария`, `катя` → `Екатерина`
- Special value: `любой` for any available staff

### Dates
- Relative dates: `сегодня`, `завтра`, `послезавтра`
- ISO format: `2024-01-15`
- All normalized to YYYY-MM-DD format

### Times
- Time expressions: `утром` (09:00), `днем` (12:00), `вечером` (18:00)
- Hour patterns: `в 14`, `14 часов` → `14:00`
- Standard format: `14:30`
- All normalized to HH:MM format

## Actions

Based on intent and available entities, the service determines actions:

- `search_slots` - Search for available time slots (default for booking without complete data)
- `create_booking` - Create a booking (requires date, time, and staff)
- `reschedule_booking` - Reschedule existing booking
- `cancel_booking` - Cancel existing booking
- `get_info` - Provide information
- `none` - No specific action

## Response Behavior

**CRITICAL**: The service returns `null` response for `search_slots` action to prevent duplicate messages. The actual slot search response should be generated by the booking service after checking availability.

## Caching Strategy

- **AI Results**: Cached for 1 hour (high confidence)
- **Hybrid Results**: Cached for 30 minutes (medium confidence)
- **Fallback Results**: Cached for 15 minutes (low confidence)
- **Cache Key**: MD5 hash of normalized message + company ID + phone

## Error Handling

The service uses specialized error classes:

- `ValidationError` - Input validation failures
- `AIServiceError` - AI service communication errors
- `AIResponseParseError` - AI response parsing failures
- `ActionResolutionError` - Action determination failures

All errors include:
- Error code for identification
- Detailed context information
- Timestamp
- Stack trace

## Performance Considerations

1. **Prompt Optimization**: Static prompt parts are pre-built in constructor
2. **Caching**: Reduces AI calls for repeated queries
3. **Parallel Processing**: AI and pattern extraction can run in parallel
4. **Resource Cleanup**: Call `destroy()` to stop background tasks

## Testing

Comprehensive test coverage with 123+ unit tests covering:
- Entity extraction accuracy
- Caching behavior
- Input validation
- Error scenarios
- Edge cases

Run tests:
```bash
npm test -- src/__tests__/services/nlu/
```

## Configuration

Configure through environment variables or config file:
- AI service credentials
- Cache settings (size, TTL)
- Available services and staff lists
- Confidence thresholds