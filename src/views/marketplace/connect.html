<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ AI Admin - WhatsApp –±–æ—Ç –¥–ª—è —Å–∞–ª–æ–Ω–∞</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      max-width: 480px;
      width: 100%;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .company-info {
      background: #f8f9fa;
      padding: 20px 30px;
      border-bottom: 1px solid #e9ecef;
    }

    .company-info h2 {
      font-size: 20px;
      color: #333;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .company-info p {
      color: #6c757d;
      font-size: 14px;
      margin: 5px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .main-content {
      padding: 30px;
    }

    .qr-section {
      text-align: center;
    }

    .qr-section h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .qr-container {
      background: white;
      border: 3px solid #e9ecef;
      border-radius: 20px;
      padding: 20px;
      display: inline-block;
      margin-bottom: 20px;
      position: relative;
    }

    .qr-container.scanning {
      border-color: #667eea;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
      70% { box-shadow: 0 0 0 15px rgba(102, 126, 234, 0); }
      100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
    }

    #qr-canvas {
      display: block;
    }

    .qr-placeholder {
      width: 280px;
      height: 280px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #adb5bd;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #f3f4f6;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status {
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .status.waiting {
      background: #fef3c7;
      color: #92400e;
    }

    .status.connected {
      background: #d1fae5;
      color: #065f46;
    }

    .status.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .timer {
      color: #6b7280;
      font-size: 13px;
      text-align: center;
      margin-bottom: 20px;
    }

    .instructions {
      background: #f8f9fa;
      border-radius: 16px;
      padding: 20px;
      margin-top: 20px;
    }

    .instructions h4 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .instructions ol {
      list-style: none;
      counter-reset: step-counter;
      padding: 0;
    }

    .instructions li {
      counter-increment: step-counter;
      position: relative;
      padding-left: 40px;
      margin-bottom: 12px;
      color: #495057;
      font-size: 14px;
      line-height: 1.5;
    }

    .instructions li::before {
      content: counter(step-counter);
      position: absolute;
      left: 0;
      top: 0;
      width: 28px;
      height: 28px;
      background: #667eea;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
    }

    .instructions li strong {
      color: #333;
      font-weight: 600;
    }

    .success-container {
      text-align: center;
      padding: 40px;
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 40px;
    }

    .success-title {
      font-size: 24px;
      color: #333;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .success-description {
      color: #6b7280;
      font-size: 16px;
      margin-bottom: 20px;
    }

    .success-details {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
      text-align: left;
    }

    .success-details p {
      color: #495057;
      font-size: 14px;
      margin: 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .redirect-message {
      color: #6b7280;
      font-size: 14px;
      margin-top: 20px;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 480px) {
      .header h1 {
        font-size: 24px;
      }

      .container {
        border-radius: 0;
        max-width: 100%;
        margin: 0;
      }

      body {
        padding: 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>
        <span>ü§ñ</span>
        <span>AI Admin</span>
      </h1>
      <p>WhatsApp –±–æ—Ç –¥–ª—è –≤–∞—à–µ–≥–æ —Å–∞–ª–æ–Ω–∞</p>
    </div>

    <div class="company-info">
      <h2 id="company-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
      <p><span>üì±</span> <span id="company-phone">‚Äî</span></p>
      <p><span>üìß</span> <span id="company-email">‚Äî</span></p>
      <p><span>üìç</span> <span id="company-address">‚Äî</span></p>
    </div>

    <div class="main-content" id="main-content">
      <div class="qr-section">
        <h3>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ WhatsApp</h3>
        
        <div class="qr-container" id="qr-container">
          <canvas id="qr-canvas" style="display: none;"></canvas>
          <div class="qr-placeholder" id="qr-placeholder">
            <div class="spinner"></div>
          </div>
        </div>

        <div class="status waiting" id="status">
          <span>‚è≥</span>
          <span>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞...</span>
        </div>

        <div class="timer" id="timer" style="display: none;">
          QR-–∫–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑: <span id="countdown">20</span> —Å–µ–∫
        </div>
      </div>

      <div class="instructions">
        <h4>
          <span>üì±</span>
          <span>–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å:</span>
        </h4>
        <ol>
          <li>–û—Ç–∫—Ä–æ–π—Ç–µ <strong>WhatsApp</strong> –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ</li>
          <li>–ó–∞–π–¥–∏—Ç–µ –≤ <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</strong> (—Ç—Ä–∏ —Ç–æ—á–∫–∏ —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É)</li>
          <li>–í—ã–±–µ—Ä–∏—Ç–µ <strong>–°–≤—è–∑–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</strong></li>
          <li>–ù–∞–∂–º–∏—Ç–µ <strong>–ü—Ä–∏–≤—è–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</strong></li>
          <li>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ <strong>QR-–∫–æ–¥</strong> –≤—ã—à–µ</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- –§–æ—Ä–º–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ callback –≤ YClients (—Å–∫—Ä—ã—Ç–∞—è) -->
  <form id="callback-form" method="POST" action="" style="display: none;">
    <input type="hidden" name="salon_id" id="form-salon-id">
    <input type="hidden" name="application_id" id="form-app-id">
    <input type="hidden" name="api_key" id="form-api-key">
    <input type="hidden" name="webhook_urls[]" id="form-webhook-url">
  </form>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  
  <script>
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —à–∞–±–ª–æ–Ω–∞ (–±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ)
    const config = {
      token: '{{whatsapp_token}}',
      companyId: '{{company.id}}',
      companyName: '{{company.name}}',
      companyPhone: '{{company.phone}}',
      companyEmail: '{{company.email}}',
      companyAddress: '{{company.address}}',
      salonId: '{{salon_id}}',
      applicationId: '{{application_id}}',
      wsUrl: '{{ws_url}}'
    };

    let socket;
    let countdownInterval;
    let countdown = 20;
    let isConnected = false;

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏
    document.getElementById('company-name').textContent = config.companyName;
    document.getElementById('company-phone').textContent = config.companyPhone || '‚Äî';
    document.getElementById('company-email').textContent = config.companyEmail || '‚Äî';
    document.getElementById('company-address').textContent = config.companyAddress || '‚Äî';

    // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞
    async function generateQR() {
      try {
        const response = await fetch(`/marketplace/qr/${config.token}`);
        const data = await response.json();

        if (data.success && data.qr) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º canvas –∏ —Å–∫—Ä—ã–≤–∞–µ–º placeholder
          document.getElementById('qr-placeholder').style.display = 'none';
          const canvas = document.getElementById('qr-canvas');
          canvas.style.display = 'block';

          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥ –Ω–∞ canvas
          await QRCode.toCanvas(canvas, data.qr, {
            width: 280,
            margin: 1,
            color: {
              dark: '#000000',
              light: '#FFFFFF'
            }
          });

          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
          updateStatus('waiting', '‚è≥', '–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
          document.getElementById('timer').style.display = 'block';
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
          document.getElementById('qr-container').classList.add('scanning');
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
          countdown = 20;
        } else {
          throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å QR-–∫–æ–¥');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è QR-–∫–æ–¥–∞:', error);
        updateStatus('error', '‚ùå', '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞');
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    function updateStatus(type, icon, text) {
      const statusEl = document.getElementById('status');
      statusEl.className = `status ${type}`;
      statusEl.innerHTML = `<span>${icon}</span><span>${text}</span>`;
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
    function updateTimer() {
      countdown--;
      document.getElementById('countdown').textContent = countdown;

      if (countdown <= 0 && !isConnected) {
        generateQR();
        countdown = 20;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    function showSuccess(data) {
      isConnected = true;
      clearInterval(countdownInterval);

      const mainContent = document.getElementById('main-content');
      mainContent.innerHTML = `
        <div class="success-container">
          <div class="success-icon">‚úì</div>
          <div class="success-title">WhatsApp –ø–æ–¥–∫–ª—é—á–µ–Ω!</div>
          <div class="success-description">
            –í–∞—à –±–æ—Ç –≥–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
          </div>
          <div class="success-details">
            <p><span>üì±</span> –ù–æ–º–µ—Ä: <strong>+${data.phone}</strong></p>
            <p><span>üë§</span> –ò–º—è: <strong>${data.name || 'AI Admin Bot'}</strong></p>
            <p><span>üîó</span> –°—Ç–∞—Ç—É—Å: <strong>–ê–∫—Ç–∏–≤–µ–Ω</strong></p>
          </div>
          <div class="redirect-message">
            <div class="spinner"></div>
            <p>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...</p>
          </div>
        </div>
      `;

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º callback –≤ YClients —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        sendCallbackToYClients(data);
      }, 2000);
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ callback –≤ YClients
    function sendCallbackToYClients(data) {
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
      document.getElementById('form-salon-id').value = config.salonId;
      document.getElementById('form-app-id').value = config.applicationId;
      document.getElementById('form-api-key').value = data.api_key || '';
      document.getElementById('form-webhook-url').value = data.webhook_url || '';

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º action —Ñ–æ—Ä–º—ã
      const form = document.getElementById('callback-form');
      form.action = 'https://api.yclients.com/marketplace/partner/callback/redirect';
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
      form.submit();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
    function initWebSocket() {
      // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
      socket = io('/marketplace', {
        query: {
          token: config.token,
          companyId: config.companyId
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      socket.on('connect', () => {
        console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è QR-–∫–æ–¥–∞
      socket.on('qr-update', (data) => {
        if (!isConnected) {
          generateQR();
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WhatsApp
      socket.on('whatsapp-connected', (data) => {
        console.log('WhatsApp –ø–æ–¥–∫–ª—é—á–µ–Ω!', data);
        showSuccess(data);
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
      socket.on('error', (error) => {
        console.error('–û—à–∏–±–∫–∞ WebSocket:', error);
        updateStatus('error', '‚ùå', error.message || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
      socket.on('disconnect', () => {
        console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
      });
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π QR-–∫–æ–¥
      generateQR();

      // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
      countdownInterval = setInterval(updateTimer, 1000);

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebSocket
      initWebSocket();
    });
  </script>
</body>
</html>